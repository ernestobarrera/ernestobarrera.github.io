<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Protocolo de Renovaci√≥n Segura de Tratamientos Cr√≥nicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc;
      }
      .tab-button.active {
        border-color: #3b82f6;
        background-color: #3b82f6;
        color: white;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .decision-card {
        transition: all 0.3s ease-in-out;
      }
      /* Estilos para los checkboxes por color */
      .form-checkbox-red {
        accent-color: #ef4444;
      }
      .form-checkbox-yellow {
        accent-color: #f59e0b;
      }
      .form-checkbox-blue {
        accent-color: #3b82f6;
      }

      /* Estilo para el modal */
      .modal {
        transition: opacity 0.25s ease;
      }
      .modal-active {
        overflow-x: hidden;
        overflow-y: auto;
      }

      /* Tooltip para info de persistencia */
      .tooltip .tooltip-text {
        visibility: hidden;
        width: 280px;
        background-color: #262626;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 10;
        bottom: 125%;
        left: 50%;
        margin-left: -140px;
        opacity: 0;
        transition: opacity 0.3s;
        font-weight: normal;
      }
      .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }
      /* Estilos para la secci√≥n de ayuda y footer */
      dt {
        font-weight: 600;
        color: #1e3a8a; /* Un azul m√°s oscuro */
      }
      dd {
        margin-left: 1.5rem;
        margin-bottom: 1rem;
        color: #4b5563;
        border-left: 2px solid #dbeafe;
        padding-left: 1rem;
      }
      #ayuda ul li::before,
      footer ul li::before {
        content: "‚úì";
        position: absolute;
        left: 0;
        color: #3b82f6;
      }
      footer ul li {
        position: relative;
        padding-left: 1.25rem;
        margin-bottom: 0.5rem;
      }
    </style>
  </head>

  <body class="p-4 sm:p-6 md:p-8">
    <div
      class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-4 sm:p-6 md:p-8"
    >
      <header class="text-center mb-6 border-b pb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">
          Protocolo de Renovaci√≥n Segura
        </h1>
        <p class="text-sm sm:text-base text-gray-500 mt-2">
          Herramienta de Soporte a la Decisi√≥n para Atenci√≥n Primaria
        </p>
      </header>

      <div id="quick-guide" class="mb-6">
        <!-- Banner compacto por defecto -->
        <div
          class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-3 flex items-center justify-between"
        >
          <div class="flex items-center gap-3">
            <span class="text-2xl animate-pulse">üëâ</span>
            <div>
              <p class="font-semibold text-sm text-gray-800">
                Primera vez? Comienza por la pesta√±a "Universales"
              </p>
              <p class="text-xs text-gray-600">
                Marca los criterios que apliquen ‚Ä¢ La decisi√≥n aparecer√°
                autom√°ticamente a la derecha
              </p>
            </div>
          </div>
          <button
            onclick="toggleGuide()"
            id="toggle-guide-btn"
            class="text-blue-600 hover:text-blue-800 text-sm font-medium whitespace-nowrap"
          >
            Ver m√°s ‚ñº
          </button>
        </div>

        <!-- Gu√≠a expandida (oculta por defecto) -->
        <div
          id="expanded-guide"
          class="hidden mt-3 p-4 bg-white border border-gray-200 rounded-lg"
        >
          <h3 class="font-bold text-sm mb-3 text-gray-700">üìñ Gu√≠a Completa</h3>
          <div class="grid md:grid-cols-2 gap-3 text-xs">
            <div class="flex gap-2">
              <span class="text-green-500">‚ë†</span>
              <div>
                <b>Eval√∫a:</b> Revisa criterios universales + espec√≠ficos de
                cada patolog√≠a
              </div>
            </div>
            <div class="flex gap-2">
              <span class="text-blue-500">‚ë°</span>
              <div>
                <b>Decide:</b> La tarjeta mostrar√° NR (No Renovar), R6 (6 meses)
                o R12 (12 meses)
              </div>
            </div>
            <div class="flex gap-2">
              <span class="text-purple-500">‚ë¢</span>
              <div>
                <b>Documenta:</b> Usa "Juicio Cl√≠nico" si necesitas override
              </div>
            </div>
            <div class="flex gap-2">
              <span class="text-gray-500">‚ë£</span>
              <div><b>Reinicia:</b> "Limpiar" para nuevo paciente</div>
            </div>
          </div>
          <div class="mt-3 p-2 bg-yellow-50 rounded text-xs text-yellow-800">
            üí° <b>Tip:</b> Usa Ctrl+F para buscar f√°rmacos espec√≠ficos en la HCE
          </div>
        </div>
      </div>

      <script>
        function toggleGuide() {
          const expanded = document.getElementById("expanded-guide");
          const btn = document.getElementById("toggle-guide-btn");
          if (expanded.classList.contains("hidden")) {
            expanded.classList.remove("hidden");
            btn.textContent = "Ver menos ‚ñ≤";
          } else {
            expanded.classList.add("hidden");
            btn.textContent = "Ver m√°s ‚ñº";
          }
        }
      </script>

      <div class="lg:flex lg:gap-8">
        <main class="lg:w-2/3">
          <div class="mb-6">
            <div class="relative mb-4">
              <input
                type="text"
                id="search-box"
                placeholder="Buscar por patolog√≠a o f√°rmaco (ej. 'IECA', 'Asma'...)"
                class="w-full p-3 pl-10 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
              <svg
                class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                ></path>
              </svg>
            </div>
            <div class="overflow-x-auto">
              <div class="flex space-x-2 border-b" id="tabs-container">
                <button
                  class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200 active"
                  data-tab="universal"
                >
                  Universales
                </button>
                <button
                  class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200"
                  data-tab="interacciones"
                >
                  üö® Interacciones
                </button>
                <button
                  class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200"
                  data-tab="cardio"
                >
                  ü´Ä Cardio
                </button>
                <button
                  class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200"
                  data-tab="mental"
                >
                  üß† S. Mental
                </button>
                <button
                  class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200"
                  data-tab="respi"
                >
                  ü´Å Respi
                </button>
                <button
                  class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200"
                  data-tab="metabol"
                >
                  ü©∫ Metab√≥l.
                </button>
                <button
                  class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200"
                  data-tab="digest"
                >
                  üíä Digest.
                </button>
                <button
                  class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200"
                  data-tab="osteo"
                >
                  ü¶¥ Osteo.
                </button>
                <button
                  class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200"
                  data-tab="dolor"
                >
                  ‚ö° Dolor
                </button>
                <button
                  class="tab-button whitespace-nowrap py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200"
                  data-tab="ayuda"
                >
                  ‚ùî Ayuda
                </button>
              </div>
            </div>
          </div>

          <div id="tab-contents">
            <div
              class="tab-content active"
              id="universal"
              data-keywords="universal, general, adherencia, persistencia"
            >
              <h2 class="text-xl font-bold text-gray-700 mb-4">
                Criterios Universales
              </h2>
              <div class="space-y-3 text-gray-700">
                <h4 class="text-md font-semibold text-red-600 mt-3 mb-2">
                  Criterios de Alarma (Rojos)
                </h4>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  />
                  <span class="ml-3 flex items-center">
                    <b>Persistencia/Adherencia estimada < 50%</b>
                    <span class="ml-2 text-gray-400 tooltip relative">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      <span class="tooltip-text"
                        >T√©cnicamente, el ratio de dispensaci√≥n mide la
                        <b>persistencia</b> (continuidad en la retirada del
                        f√°rmaco). Se usa como el mejor indicador indirecto
                        disponible de la <b>adherencia</b> general.</span
                      >
                    </span>
                  </span>
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>Hospitalizaci√≥n</b> por la patolog√≠a en √∫ltimos 6
                    meses</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>‚â•2 visitas a urgencias</b> por descompensaci√≥n</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>Efectos adversos graves</b> documentados sin ajuste
                    posterior</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>Interacciones graves</b> no resueltas (ver pesta√±a
                    üö®)</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>Duplicidades</b> terap√©uticas activas</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>Contraindicaciones nuevas</b> documentadas</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>Medicaci√≥n hospitalaria sin conciliar >30 d√≠as</b></span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>‚â•3 solicitudes anticipadas</b> de
                    opioides/benzodiacepinas en 6 meses</span
                  >
                </div>

                <h4 class="text-md font-semibold text-yellow-600 mt-3 mb-2">
                  Criterios de Precauci√≥n (Amarillos)
                </h4>
                <div class="space-y-2">
                  <div class="flex items-start">
                    <input
                      type="checkbox"
                      class="form-checkbox-yellow h-5 w-5 rounded"
                      data-decision="yellow"
                    /><span class="ml-2"
                      >Persistencia/Adherencia entre 50-79%</span
                    >
                  </div>
                  <div class="flex items-start">
                    <input
                      type="checkbox"
                      class="form-checkbox-yellow h-5 w-5 rounded"
                      data-decision="yellow"
                    /><span class="ml-2"
                      >Sin anal√≠tica >12 meses en f√°rmaco que requiere
                      monitorizaci√≥n</span
                    >
                  </div>
                  <div class="flex items-start">
                    <input
                      type="checkbox"
                      class="form-checkbox-yellow h-5 w-5 rounded"
                      data-decision="yellow"
                    /><span class="ml-2"
                      >Patr√≥n de cascada: F√°rmaco A ‚Üí nuevo s√≠ntoma ‚Üí F√°rmaco B
                      a√±adido</span
                    >
                  </div>
                  <div class="flex items-start">
                    <input
                      type="checkbox"
                      class="form-checkbox-yellow h-5 w-5 rounded"
                      data-decision="yellow"
                    /><span class="ml-2"
                      >Cambio reciente de hospital/especialista sin
                      revisi√≥n</span
                    >
                  </div>
                </div>

                <h4 class="text-md font-semibold text-blue-600 mt-3 mb-2">
                  Oportunidades de Optimizaci√≥n (Azules)
                </h4>
                <div class="space-y-2">
                  <div class="flex items-start">
                    <input
                      type="checkbox"
                      class="form-checkbox-blue h-5 w-5 rounded"
                      data-decision="blue"
                    /><span class="ml-2"
                      >Mismo r√©gimen exacto >2 a√±os sin ning√∫n cambio</span
                    >
                  </div>
                  <div class="flex items-start">
                    <input
                      type="checkbox"
                      class="form-checkbox-blue h-5 w-5 rounded"
                      data-decision="blue"
                    /><span class="ml-2"
                      >Paciente >80 a√±os con polifarmacia (‚â•5 f√°rmacos)</span
                    >
                  </div>
                  <div class="flex items-start">
                    <input
                      type="checkbox"
                      class="form-checkbox-blue h-5 w-5 rounded"
                      data-decision="blue"
                    /><span class="ml-2"
                      >Medicaci√≥n "si precisa" dispensada regularmente</span
                    >
                  </div>
                  <div class="flex items-start">
                    <input
                      type="checkbox"
                      class="form-checkbox-blue h-5 w-5 rounded"
                      data-decision="blue"
                    />
                    <span class="ml-2"
                      >Medicaci√≥n de origen hospitalario pendiente de
                      conciliar</span
                    >
                  </div>
                </div>
              </div>
            </div>

            <div
              class="tab-content"
              id="interacciones"
              data-keywords="interacciones, triple whammy, sangrado, hiperpotasemia, sedacion, miopatia, serotoninergico"
            >
              <h2 class="text-xl font-bold text-gray-700 mb-4">
                Combinaciones de Alto Riesgo que Obligan a Revisi√≥n
              </h2>
              <div class="space-y-3 text-gray-700">
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>Triple Whammy:</b> IECA/ARA-II + Diur√©tico + AINE</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>Riesgo Sangrado:</b> Anticoagulante + Antiagregante +
                    AINE</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>Hiperpotasemia:</b> IECA + Espironolactona + Suplemento
                    K+</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>Sedaci√≥n Excesiva:</b> Benzodiacepinas + Opioides +
                    Antihistam√≠nicos</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>Miopat√≠a:</b> Estatina + Fibrato + Macr√≥lido</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded mt-1"
                    data-decision="red"
                  /><span class="ml-3"
                    ><b>Sd. Serotonin√©rgico:</b> ISRS + Tramadol +
                    Triptanes</span
                  >
                </div>
              </div>
            </div>

            <div
              class="tab-content"
              id="cardio"
              data-keywords="cardio, hipertension, hta, ieca, ara, anticoagulacion, avk, acod, inr, ttr"
            >
              <h3 class="text-lg font-semibold text-gray-700 mb-2">
                Hipertensi√≥n Arterial (HTA)
              </h3>
              <div class="space-y-2 mb-4">
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >TA >160/100 en √∫ltimas 2 determinaciones</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >Hipotensi√≥n sintom√°tica documentada</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >TFG <30 con IECA/ARA-II sin seguimiento nefro</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >K+ >5.5 con IECA/ARA-II/espironolactona</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2">TA 140-160/90-100 persistente</span>
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2">Sin anal√≠tica (Cr, K+) >12 meses</span>
                </div>
              </div>
              <h3 class="text-lg font-semibold text-gray-700 mb-2">
                Anticoagulaci√≥n Oral
              </h3>
              <div class="space-y-2">
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >INR >5 o <1.5 (AVK) / Sangrado mayor <3m</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2">Cirug√≠a programada <1 mes</span>
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2">Adherencia <80% en ACOD</span>
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >TTR <50% en √∫ltimos 3 controles (AVK)</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2"
                    >TTR 50-65% (AVK) / Sin INR >6 semanas</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2"
                    >ACOD sin control funci√≥n renal >18 meses</span
                  >
                </div>
              </div>
            </div>

            <div
              class="tab-content"
              id="mental"
              data-keywords="salud mental, depresion, ansiedad, isrs, benzodiacepinas, bzd, antipsicotico"
            >
              <h3 class="text-lg font-semibold text-gray-700 mb-2">
                Depresi√≥n/Ansiedad
              </h3>
              <div class="space-y-2">
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >Ideaci√≥n suicida activa o empeoramiento cl√≠nico</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >Combinaci√≥n ‚â•3 psicof√°rmacos sin revisi√≥n psiquiatr√≠a</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2"
                    >Sin mejor√≠a tras 6-8 semanas de tratamiento</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-blue h-5 w-5 rounded"
                    data-decision="blue"
                  /><span class="ml-2"
                    >Benzodiacepinas >3 meses (planificar retirada)</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-blue h-5 w-5 rounded"
                    data-decision="blue"
                  /><span class="ml-2"
                    >ISRS >12 meses en remisi√≥n (valorar retirada)</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >Antidepresivo iniciado >30 d√≠as sin NINGUNA
                    dispensaci√≥n</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >Escalada terap√©utica: >3 cambios antidepresivos en 1
                    a√±o</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >BZD + Opioide + Edad >75 a√±os (triple riesgo ca√≠das)</span
                  >
                </div>
              </div>
            </div>

            <div
              class="tab-content"
              id="respi"
              data-keywords="respiratorio, asma, epoc, saba, ics, laba"
            >
              <h3 class="text-lg font-semibold text-gray-700 mb-2">Asma</h3>
              <div class="space-y-2 mb-4">
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2">‚â•3 SABA dispensados/a√±o</span>
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2">‚â•2 ciclos corticoides orales/a√±o</span>
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2">2 SABA/a√±o</span>
                </div>
              </div>
              <h3 class="text-lg font-semibold text-gray-700 mb-2">EPOC</h3>
              <div class="space-y-2">
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >‚â•2 exacerbaciones moderadas/a√±o o ‚â•1 grave</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >Solo SABA como tratamiento de mantenimiento</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2">1 exacerbaci√≥n moderada/a√±o</span>
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2">Sin espirometr√≠a >2 a√±os</span>
                </div>
              </div>
            </div>

            <div
              class="tab-content"
              id="metabol"
              data-keywords="metabolico, diabetes, dm2, hba1c, dislipemia, estatinas, ldl, isglt2"
            >
              <h3 class="text-lg font-semibold text-gray-700 mb-2">
                Diabetes Tipo 2
              </h3>
              <div class="space-y-2 mb-4">
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2">HbA1c >9% persistente</span>
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >HbA1c >10% (fallo terap√©utico absoluto)</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >Hipoglucemias graves (<54 mg/dl) recurrentes</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2">TFG <30 con metformina / iSGLT2</span>
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2">HbA1c 8-9%</span>
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2"
                    >Sin anal√≠tica anual completa (HbA1c, p. lip√≠dico, Cr)</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2"
                    >Diab√©tico con IC sin iSGLT2 (oportunidad perdida)</span
                  >
                </div>
              </div>
              <h3 class="text-lg font-semibold text-gray-700 mb-2">
                Dislipemia
              </h3>
              <div class="space-y-2">
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >Miopat√≠a/rabdomiolisis o ALT >3x LSN con estatinas</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2">LDL no en objetivo tras 6 meses</span>
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2">Sin anal√≠tica lip√≠dica >18 meses</span>
                </div>
              </div>
            </div>

            <div
              class="tab-content"
              id="digest"
              data-keywords="digestivo, ibp, omeprazol, inhibidores bomba protones"
            >
              <h3 class="text-lg font-semibold text-gray-700 mb-2">
                IBP (Inhibidores Bomba Protones)
              </h3>
              <div class="space-y-2">
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >Hipomagnesemia o D√©ficit B12 documentado</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2"
                    >Uso >8 semanas sin indicaci√≥n clara de cronicidad</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2"
                    >IBP >1 a√±o sin indicaci√≥n clara documentada</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-blue h-5 w-5 rounded"
                    data-decision="blue"
                  /><span class="ml-2"
                    >IBP >2 a√±os (valorar deprescripci√≥n gradual)</span
                  >
                </div>
              </div>
            </div>

            <div
              class="tab-content"
              id="osteo"
              data-keywords="osteo, osteoporosis, bifosfonatos"
            >
              <h3 class="text-lg font-semibold text-gray-700 mb-2">
                Osteoporosis
              </h3>
              <div class="space-y-2">
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2">Hipocalcemia no corregida</span>
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2">TFG <30 (mayor√≠a bifosfonatos)</span>
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2"
                    >Bifosfonatos orales >5 a√±os continuos sin descanso</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2"
                    >Sin revisi√≥n anual de funci√≥n renal (Cr) y Calcio</span
                  >
                </div>
              </div>
            </div>

            <div
              class="tab-content"
              id="dolor"
              data-keywords="dolor, cronico, opioides, tramadol"
            >
              <h3 class="text-lg font-semibold text-gray-700 mb-2">
                Dolor Cr√≥nico (Opioides)
              </h3>
              <div class="space-y-2">
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >Se√±ales de mal uso/desv√≠o (p.ej. p√©rdida recetas)</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-red h-5 w-5 rounded"
                    data-decision="red"
                  /><span class="ml-2"
                    >‚â•3 solicitudes anticipadas de opioides en √∫ltimos 6
                    meses</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2"
                    >Dosis estables >3 meses (intentar reducci√≥n gradual)</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-yellow h-5 w-5 rounded"
                    data-decision="yellow"
                  /><span class="ml-2"
                    >Estre√±imiento inducido por opioides no tratado</span
                  >
                </div>
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    class="form-checkbox-blue h-5 w-5 rounded"
                    data-decision="blue"
                  /><span class="ml-2"
                    >Combinaci√≥n con BZD (revisar riesgo/beneficio)</span
                  >
                </div>
              </div>
            </div>

            <div
              class="tab-content"
              id="ayuda"
              data-keywords="ayuda, conceptos, definicion, conciliacion, persistencia, adherencia, deprescripcion, implementacion"
            >
              <h2 class="text-xl font-bold text-gray-700 mb-4">
                Ayuda y Documentaci√≥n
              </h2>
              <div
                class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg mb-6"
              >
                <h3 class="font-semibold text-blue-800 mb-2">
                  Prop√≥sito de esta Herramienta
                </h3>
                <p class="text-blue-900 text-sm">
                  En el contexto de una Atenci√≥n Primaria donde cada clic
                  cuenta, esta web no pretende ser una carga burocr√°tica m√°s. Su
                  prop√≥sito es fundamentalmente
                  <b>did√°ctico y de soporte cognitivo</b>: un ejercicio para
                  estructurar el pensamiento cl√≠nico y recordar, de forma visual
                  y √°gil, los puntos clave de seguridad y eficacia en la
                  renovaci√≥n de tratamientos. Es un compa√±ero formativo,
                  dise√±ado para reforzar y agilizar el proceso de revisi√≥n
                  farmacoterap√©utica sin sustituir jam√°s el insustituible juicio
                  cl√≠nico del profesional.
                </p>
              </div>

              <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-4">
                Definiciones Clave
              </h3>
              <dl>
                <dt>Conciliaci√≥n de la medicaci√≥n</dt>
                <dd>
                  Proceso formal y expl√≠cito de obtener la lista m√°s completa y
                  precisa posible de los medicamentos actuales de un paciente y
                  compararla con la prescripci√≥n activa para identificar y
                  resolver discrepancias.
                </dd>
                <dt>Persistencia vs. Adherencia</dt>
                <dd>
                  La <b>persistencia</b> mide la continuidad (si el paciente
                  sigue retirando el f√°rmaco), mientras que la
                  <b>adherencia</b> es un concepto m√°s amplio que incluye si
                  toma la dosis correcta, a la hora correcta, etc. Usamos la
                  persistencia como el mejor indicador indirecto de la
                  adherencia.
                </dd>
                <dt>Deprescripci√≥n</dt>
                <dd>
                  Proceso planificado y supervisado de retirada de un
                  medicamento que ya no es necesario o cuyo riesgo supera el
                  beneficio. Es una intervenci√≥n activa, no un abandono
                  terap√©utico.
                </dd>
              </dl>

              <div class="mt-8 border-t pt-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">
                  Propuestas para la Integraci√≥n en Sistemas de Salud
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                  Esta herramienta sirve como modelo conceptual. Su m√°ximo
                  potencial se alcanzar√≠a con su integraci√≥n en la historia
                  cl√≠nica electr√≥nica mediante:
                </p>
                <ul
                  class="text-gray-700 text-sm list-disc list-inside space-y-2"
                >
                  <li>C√°lculo autom√°tico del ratio de persistencia.</li>
                  <li>
                    Alertas visuales (sem√°foros) que se activen con los datos
                    del paciente (anal√≠ticas, diagn√≥sticos).
                  </li>
                  <li>Recordatorios proactivos de controles pendientes.</li>
                  <li>
                    Sistemas de bloqueo o alerta de alta visibilidad ante
                    interacciones graves.
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </main>

        <aside class="lg:w-1/3 mt-8 lg:mt-0 sticky top-8 self-start">
          <div
            id="decision-card"
            class="decision-card bg-gray-50 rounded-xl p-6 border-2 border-gray-200"
          >
            <h2 class="text-xl font-bold text-center text-gray-700 mb-4">
              Decisi√≥n de Renovaci√≥n
            </h2>
            <div id="decision-output" class="text-center">
              <div id="decision-placeholder" class="text-gray-400 py-10">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-12 w-12 mx-auto"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  />
                </svg>
                <p class="mt-2 text-sm">
                  Marque las casillas para evaluar al paciente.
                </p>
              </div>
              <div id="decision-result" class="hidden">
                <p id="decision-code" class="text-3xl font-bold mb-2"></p>
                <p id="decision-text" class="text-lg font-semibold mb-4"></p>
                <!-- NUEVO: Lista de criterios marcados -->
                <details
                  id="marked-criteria-details"
                  class="mb-3 bg-white rounded-lg border border-gray-200"
                >
                  <summary
                    class="cursor-pointer p-2 hover:bg-gray-50 text-sm font-medium text-gray-700"
                  >
                    üìã Ver criterios marcados (<span id="criteria-count">0</span
                    >)
                  </summary>
                  <div
                    id="marked-criteria-list"
                    class="p-3 text-xs space-y-1 max-h-40 overflow-y-auto"
                  >
                    <!-- Se llenar√° din√°micamente -->
                  </div>
                </details>
                <p
                  id="decision-reason"
                  class="text-sm text-gray-600 bg-gray-100 rounded-md p-3"
                ></p>
                <div id="override-section" class="mt-4 hidden">
                  <button
                    id="override-button"
                    class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors"
                  >
                    Aplicar Juicio Cl√≠nico
                  </button>
                </div>
              </div>
            </div>
            <button
              id="reset-button"
              class="mt-6 w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"
            >
              <span id="reset-button-text">Limpiar para nuevo paciente</span>
            </button>
          </div>
        </aside>
      </div>

      <footer class="mt-10 border-t-2 pt-6 text-gray-600">
        <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">
          Filosof√≠a del Protocolo: Los 4 Pilares de la Renovaci√≥n Segura
        </h3>
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 text-sm">
          <div class="p-4 bg-blue-50 rounded-lg">
            <h4 class="font-bold text-blue-800 mb-2">üî¢ Adherencia</h4>
            <p class="text-blue-900">
              ¬øEl paciente est√° retirando (y previsiblemente, tomando) la
              medicaci√≥n como se paut√≥? Una baja adherencia es el primer signo
              de que un tratamiento puede no ser efectivo o aceptado.
            </p>
          </div>
          <div class="p-4 bg-green-50 rounded-lg">
            <h4 class="font-bold text-green-800 mb-2">üéØ Control</h4>
            <p class="text-green-900">
              ¬øEl tratamiento est√° funcionando? Se eval√∫a si se alcanzan los
              objetivos terap√©uticos (cifras de tensi√≥n, HbA1c, etc.) o si hay
              signos de descompensaci√≥n (visitas a urgencias, ingresos). [cite:
              10]
            </p>
          </div>
          <div class="p-4 bg-yellow-50 rounded-lg">
            <h4 class="font-bold text-yellow-800 mb-2">üõ°Ô∏è Seguridad</h4>
            <p class="text-yellow-900">
              ¬øSigue siendo seguro el tratamiento? Se vigila la aparici√≥n de
              efectos adversos, interacciones con otros f√°rmacos o la necesidad
              de realizar controles anal√≠ticos para monitorizar su seguridad a
              largo plazo.
            </p>
          </div>
          <div class="p-4 bg-purple-50 rounded-lg">
            <h4 class="font-bold text-purple-800 mb-2">‚ùì Necesidad</h4>
            <p class="text-purple-900">
              ¬øSigue siendo necesario el tratamiento? Con el tiempo, las
              condiciones del paciente cambian. Este pilar nos obliga a
              cuestionar si el f√°rmaco todav√≠a aporta un beneficio que supere
              sus riesgos.
            </p>
          </div>
        </div>
        <div class="mt-8 pt-6 border-t border-gray-200 text-left">
          <h4 class="font-semibold text-gray-700 mb-2">
            ‚öñÔ∏è Descargo de Responsabilidad
          </h4>
          <p class="text-xs text-gray-500 max-w-1xl mx-auto">
            Esta herramienta se ofrece con fines exclusivamente educativos y
            como apoyo a la reflexi√≥n cl√≠nica. No sustituye en ning√∫n caso el
            juicio profesional, la anamnesis del paciente ni la consulta de
            gu√≠as cl√≠nicas oficiales y actualizadas del sistema sanitario
            correspondiente. El autor no asume ninguna responsabilidad por las
            decisiones tomadas bas√°ndose en su uso.
            <br />
            <strong class="font-semibold text-gray-600 mt-2 block"
              >Esta p√°gina no recopila, almacena ni transmite ning√∫n tipo de
              dato introducido.</strong
            >
          </p>
        </div>
      </footer>
    </div>

    <div
      id="override-modal"
      class="modal-active hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
        <h3 class="text-lg font-bold text-gray-800 mb-4">
          Documentar Juicio Cl√≠nico
        </h3>
        <p class="text-sm text-gray-600 mb-4">
          La herramienta sugiere <b id="modal-suggestion-text"></b>. Por favor,
          documente el motivo de la decisi√≥n final.
        </p>
        <div class="space-y-2 text-sm">
          <label class="flex items-center"
            ><input
              type="radio"
              name="override_reason"
              class="form-radio"
              value="Decisi√≥n consensuada con paciente"
            />
            <span class="ml-2">Decisi√≥n consensuada con paciente</span></label
          >
          <label class="flex items-center"
            ><input
              type="radio"
              name="override_reason"
              class="form-radio"
              value="Priorizaci√≥n de confort (fr√°gil/paliativo)"
            />
            <span class="ml-2"
              >Priorizaci√≥n de confort (fr√°gil/paliativo)</span
            ></label
          >
          <label class="flex items-center"
            ><input
              type="radio"
              name="override_reason"
              class="form-radio"
              value="Barrera socioecon√≥mica temporal"
            />
            <span class="ml-2">Barrera socioecon√≥mica temporal</span></label
          >
          <label class="flex items-center"
            ><input
              type="radio"
              name="override_reason"
              class="form-radio"
              value="otro"
            />
            <span class="ml-2">Otro motivo</span></label
          >
        </div>
        <textarea
          id="override-text"
          class="mt-3 w-full border rounded-md p-2 text-sm hidden"
          placeholder="Especifique el motivo..."
        ></textarea>
        <div class="mt-6 flex justify-end space-x-3">
          <button
            id="cancel-override"
            class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold"
          >
            Cancelar
          </button>
          <button
            id="confirm-override"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold"
          >
            Confirmar Decisi√≥n
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Elementos del DOM
        const tabsContainer = document.getElementById("tabs-container");
        const tabContents = document.getElementById("tab-contents");
        const checkboxes = document.querySelectorAll(
          'input[type="checkbox"][data-decision]'
        );
        const decisionCard = document.getElementById("decision-card");
        const decisionPlaceholder = document.getElementById(
          "decision-placeholder"
        );
        const decisionResult = document.getElementById("decision-result");
        const decisionCode = document.getElementById("decision-code");
        const decisionText = document.getElementById("decision-text");
        const decisionReason = document.getElementById("decision-reason");
        const resetButton = document.getElementById("reset-button");
        const searchBox = document.getElementById("search-box");

        // Elementos del override/juicio cl√≠nico
        const overrideSection = document.getElementById("override-section");
        const overrideButton = document.getElementById("override-button");
        const overrideModal = document.getElementById("override-modal");
        const cancelOverrideBtn = document.getElementById("cancel-override");
        const confirmOverrideBtn = document.getElementById("confirm-override");
        const overrideReasonRadios = document.querySelectorAll(
          'input[name="override_reason"]'
        );
        const overrideTextInput = document.getElementById("override-text");
        const modalSuggestionText = document.getElementById(
          "modal-suggestion-text"
        );

        // --- L√ìGICA DE PESTA√ëAS Y B√öSQUEDA ---
        function showActiveTab() {
          const activeTabButton =
            tabsContainer.querySelector(".tab-button.active");
          if (!activeTabButton) return;
          const activeTabId = activeTabButton.getAttribute("data-tab");

          tabContents.querySelectorAll(".tab-content").forEach((content) => {
            if (content.id === activeTabId) {
              content.classList.add("active");
            } else {
              content.classList.remove("active");
            }
          });
        }

        tabsContainer.addEventListener("click", function (e) {
          if (e.target.classList.contains("tab-button")) {
            searchBox.value = ""; // Limpiar b√∫squeda al cambiar de pesta√±a
            tabsContainer
              .querySelectorAll(".tab-button")
              .forEach((btn) => btn.classList.remove("active"));
            e.target.classList.add("active");
            showActiveTab();
          }
        });

        searchBox.addEventListener("keyup", function () {
          const searchTerm = searchBox.value.toLowerCase().trim();

          if (searchTerm === "") {
            showActiveTab(); // Restaurar vista de pesta√±a si la b√∫squeda est√° vac√≠a
            return;
          }

          // Desactivar el bot√≥n de pesta√±a activo para indicar que es una vista de b√∫squeda
          tabsContainer
            .querySelectorAll(".tab-button")
            .forEach((btn) => btn.classList.remove("active"));

          tabContents.querySelectorAll(".tab-content").forEach((content) => {
            const keywords = content.getAttribute("data-keywords") || "";
            const contentText = content.textContent.toLowerCase();

            if (
              keywords.includes(searchTerm) ||
              contentText.includes(searchTerm)
            ) {
              content.classList.add("active"); // Mostrar contenido que coincide
            } else {
              content.classList.remove("active"); // Ocultar el que no coincide
            }
          });
        });

        // --- L√ìGICA DE DECISI√ìN ---
        function updateDecision() {
          let redFlags = 0,
            yellowFlags = 0,
            blueFlags = 0;
          let redReasons = [],
            yellowReasons = [],
            blueReasons = [];
          let allMarkedCriteria = []; // NUEVO: Array para todos los criterios

          checkboxes.forEach((cb) => {
            if (cb.checked) {
              const decision = cb.getAttribute("data-decision");
              const reasonText =
                cb.nextElementSibling?.textContent?.trim() ||
                cb.parentElement.textContent.trim();

              // NUEVO: Guardar referencia al checkbox para poder desmarcarlo
              allMarkedCriteria.push({
                color: decision,
                text: reasonText,
                checkbox: cb,
              });

              if (decision === "red") {
                redFlags++;
                redReasons.push(reasonText);
              } else if (decision === "yellow") {
                yellowFlags++;
                yellowReasons.push(reasonText);
              } else if (decision === "blue") {
                blueFlags++;
                blueReasons.push(reasonText);
              }
            }
          });

          // NUEVO: Actualizar la lista de criterios marcados en la tarjeta
          updateMarkedCriteriaDisplay(allMarkedCriteria);

          const anyFlag = redFlags > 0 || yellowFlags > 0 || blueFlags > 0;
          // NUEVO: Actualizar texto del bot√≥n reset
          const totalChecked = redFlags + yellowFlags + blueFlags;
          const resetButtonText = document.getElementById("reset-button-text");
          if (resetButtonText) {
            if (totalChecked > 0) {
              resetButtonText.textContent = `Limpiar (${totalChecked} criterios marcados)`;
            } else {
              resetButtonText.textContent = "Limpiar para nuevo paciente";
            }
          }
          decisionPlaceholder.classList.toggle("hidden", anyFlag);
          decisionResult.classList.toggle("hidden", !anyFlag);
          overrideSection.classList.add("hidden"); // Ocultar bot√≥n de override por defecto

          // L√≥gica mejorada basada en evidencia
          if (redFlags >= 3) {
            setDecisionState(
              "red",
              "üî¥ NR",
              "No Renovar - Cita INMEDIATA",
              `M√∫ltiples se√±ales cr√≠ticas (${redFlags}). Requiere intervenci√≥n urgente.`
            );
            overrideSection.classList.remove("hidden");
            modalSuggestionText.textContent = "No Renovar - Cita INMEDIATA";
          } else if (redFlags >= 2) {
            setDecisionState(
              "red",
              "üî¥ NR",
              "No Renovar - Cita <1 semana",
              `${redFlags} se√±ales de alarma graves. Programar cita en menos de 1 semana.`
            );
            overrideSection.classList.remove("hidden");
            modalSuggestionText.textContent = "No Renovar - Cita <1 semana";
          } else if (redFlags === 1) {
            setDecisionState(
              "red",
              "üî¥ R1M",
              "Renovar 1 MES + Cita urgente",
              `Motivo: ${redReasons[0]}. Renovaci√≥n m√≠nima para garantizar continuidad.`
            );
            overrideSection.classList.remove("hidden");
            modalSuggestionText.textContent = "Renovar 1 MES + Cita urgente";
          } else if (yellowFlags >= 2) {
            setDecisionState(
              "yellow",
              "üü° R6",
              "Renovar 6 Meses + Seguimiento",
              `${yellowFlags} se√±ales de precauci√≥n. Requiere optimizaci√≥n.`
            );
            overrideSection.classList.remove("hidden");
            modalSuggestionText.textContent = "Renovar 6 Meses + Seguimiento";
          } else if (yellowFlags === 1 || blueFlags >= 2) {
            setDecisionState(
              "yellow",
              "üü° R6",
              "Renovar 6 Meses + Revisi√≥n",
              `Oportunidad de mejora identificada. Principal: ${
                yellowReasons[0] || blueReasons[0]
              }`
            );
            overrideSection.classList.remove("hidden");
            modalSuggestionText.textContent = "Renovar 6 Meses + Revisi√≥n";
          } else if (blueFlags === 1) {
            setDecisionState(
              "blue",
              "üîµ R12",
              "Renovar 12 Meses con nota",
              `Considerar: ${blueReasons[0]}`
            );
          } else {
            setDecisionState(
              "green",
              "üü¢ R12",
              "Renovar 12 Meses",
              "Tratamiento estable y bien controlado."
            );
          }
        }

        function setDecisionState(color, code, text, reason) {
          const colorMap = {
            red: {
              bg: "bg-red-50",
              border: "border-red-500",
              text: "text-red-600",
            },
            yellow: {
              bg: "bg-yellow-50",
              border: "border-yellow-500",
              text: "text-yellow-600",
            },
            blue: {
              bg: "bg-blue-50",
              border: "border-blue-500",
              text: "text-blue-600",
            },
            green: {
              bg: "bg-green-50",
              border: "border-green-500",
              text: "text-green-600",
            },
            gray: {
              bg: "bg-gray-50",
              border: "border-gray-200",
              text: "text-gray-700",
            },
            indigo: {
              bg: "bg-indigo-50",
              border: "border-indigo-500",
              text: "text-indigo-600",
            },
          };
          const colors = colorMap[color];
          decisionCard.className = `decision-card ${colors.bg} rounded-xl p-6 border-2 ${colors.border}`;
          decisionCode.textContent = code;
          decisionCode.className = `text-3xl font-bold mb-2 ${colors.text}`;
          decisionText.textContent = text;
          decisionReason.textContent = reason;
        }

        checkboxes.forEach((cb) =>
          cb.addEventListener("change", () => {
            updateDecision();
            updateTabBadges(); // NUEVO: Actualizar badges
          })
        );

        // NUEVO: Funci√≥n para actualizar badges en pesta√±as
        function updateTabBadges() {
          const tabs = document.querySelectorAll(".tab-button");

          tabs.forEach((tab) => {
            const tabName = tab.getAttribute("data-tab");
            const tabContent = document.getElementById(tabName);

            if (!tabContent) return;

            const checkedCount = tabContent.querySelectorAll(
              'input[type="checkbox"]:checked'
            ).length;

            // Eliminar badge existente si lo hay
            const existingBadge = tab.querySelector(".tab-badge");
            if (existingBadge) existingBadge.remove();

            // A√±adir nuevo badge si hay checks
            if (checkedCount > 0) {
              const badge = document.createElement("span");
              badge.className =
                "tab-badge ml-1 px-1.5 py-0.5 text-xs rounded-full bg-red-500 text-white";
              badge.textContent = checkedCount;
              tab.appendChild(badge);
            }
          });
        }

        // --- L√ìGICA DEL MODAL DE JUICIO CL√çNICO ---
        overrideButton.addEventListener("click", () =>
          overrideModal.classList.remove("hidden")
        );
        cancelOverrideBtn.addEventListener("click", () =>
          overrideModal.classList.add("hidden")
        );

        overrideReasonRadios.forEach((radio) => {
          radio.addEventListener("change", () => {
            overrideTextInput.classList.toggle(
              "hidden",
              radio.value !== "otro"
            );
          });
        });

        confirmOverrideBtn.addEventListener("click", () => {
          const selectedReasonRadio = document.querySelector(
            'input[name="override_reason"]:checked'
          );
          if (!selectedReasonRadio) {
            alert("Por favor, seleccione un motivo.");
            return;
          }
          let reason = selectedReasonRadio.value;
          if (reason === "otro") {
            if (overrideTextInput.value.trim() === "") {
              alert("Por favor, especifique el motivo 'otro'.");
              return;
            }
            reason = overrideTextInput.value.trim();
          }

          setDecisionState(
            "indigo",
            "üîµ JC",
            "Decisi√≥n Manual por Juicio Cl√≠nico",
            `Motivo documentado: "${reason}"`
          );
          overrideSection.classList.add("hidden");
          overrideModal.classList.add("hidden");
        });

        // --- L√ìGICA DEL BOT√ìN DE RESETEO ---
        // NUEVO: Funci√≥n para mostrar criterios marcados
        function updateMarkedCriteriaDisplay(criteria) {
          const listContainer = document.getElementById("marked-criteria-list");
          const countSpan = document.getElementById("criteria-count");
          const detailsElement = document.getElementById(
            "marked-criteria-details"
          );

          if (!listContainer || !countSpan) return;

          countSpan.textContent = criteria.length;

          if (criteria.length === 0) {
            listContainer.innerHTML =
              '<p class="text-gray-400">No hay criterios marcados</p>';
            if (detailsElement) detailsElement.style.display = "none";
            return;
          }

          if (detailsElement) detailsElement.style.display = "block";

          const colorEmojis = {
            red: "üî¥",
            yellow: "üü°",
            blue: "üîµ",
          };

          listContainer.innerHTML = criteria
            .map(
              (item, index) => `
            <div class="flex items-start justify-between p-1 hover:bg-gray-50 rounded">
              <span class="flex-1">${colorEmojis[item.color]} ${
                item.text
              }</span>
              <button 
                onclick="uncheckCriteria(${index})" 
                class="ml-2 text-gray-400 hover:text-red-500"
                title="Desmarcar"
              >‚úï</button>
            </div>
          `
            )
            .join("");
        }

        // NUEVO: Funci√≥n global para desmarcar desde la tarjeta
        window.uncheckCriteria = function (index) {
          const checkboxes = document.querySelectorAll(
            'input[type="checkbox"][data-decision]:checked'
          );
          if (checkboxes[index]) {
            checkboxes[index].checked = false;
            updateDecision();
          }
        };
        resetButton.addEventListener("click", function () {
          checkboxes.forEach((cb) => (cb.checked = false));

          setDecisionState("gray", "", "", "");
          decisionResult.classList.add("hidden");
          overrideSection.classList.add("hidden");
          decisionPlaceholder.classList.remove("hidden");

          // Volver a la pesta√±a universal
          searchBox.value = "";
          tabsContainer
            .querySelectorAll(".tab-button")
            .forEach((btn) => btn.classList.remove("active"));
          tabsContainer
            .querySelector('[data-tab="universal"]')
            .classList.add("active");
          showActiveTab();
          updateTabBadges();
        });

        // Estado inicial al cargar la p√°gina
        showActiveTab();
      });
    </script>
  </body>
</html>
