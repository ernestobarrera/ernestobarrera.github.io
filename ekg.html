<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ECG Interpreter v2.7 — Guía de interpretación (rev)</title>
    <meta
      name="description"
      content="Guía interactiva y educativa para la interpretación de ECG con glosario y ayudas clínicas."
    />

    <style>
      :root {
        --primario: #2563eb;
        --violeta: #7c3aed;
        --primario-osc: #1e40af;
        --primario-claro: #dbeafe;
        --exito: #10b981;
        --aviso: #f59e0b;
        --peligro: #ef4444;
        --g50: #f9fafb;
        --g100: #f3f4f6;
        --g200: #e5e7eb;
        --g300: #d1d5db;
        --g400: #9ca3af;
        --g500: #6b7280;
        --g600: #4b5563;
        --g700: #374151;
        --g800: #1f2937;
        --g900: #111827;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI",
          Roboto, sans-serif;
        background: var(--g50);
        color: var(--g900);
        line-height: 1.6;
        font-size: 14px;
      }
      .contenedor {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      .cabecera {
        background: #fff;
        border-radius: 12px;
        padding: 28px 24px;
        margin-bottom: 14px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: grid;
        gap: 8px;
        place-items: center;
        text-align: center;
      }
      .isotipo {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: var(--primario-claro);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primario-osc);
        font-weight: 800;
      }
      .h1 {
        font-size: 24px;
        font-weight: 800;
        line-height: 1.2;
      }
      .badge {
        background: var(--g100);
        border: 1px solid var(--g300);
        color: var(--g700);
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        vertical-align: middle;
      }
      .subtitulo {
        color: var(--g600);
        margin-top: 4px;
      }
      .acciones-cab {
        margin-top: 4px;
      }
      .btn-guia {
        background: #fff;
        color: var(--primario-osc);
        border: 1px solid var(--primario);
        padding: 8px 12px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-guia:hover {
        background: var(--primario-claro);
      }
      .resumen-cab {
        margin-top: 8px;
      }
      .label-resumen {
        font-size: 12px;
        font-weight: 700;
        color: var(--g600);
        text-transform: uppercase;
        letter-spacing: 0.02em;
        margin-bottom: 6px;
      }

      .cabecera h1 {
        font-size: 22px;
        font-weight: 800;
        margin: 0;
      }
      .cabecera p {
        color: var(--g600);
        margin-top: 4px;
      }
      .cab-izq {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .cab-der {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .btn-guia {
        background: #fff;
        color: var(--primario-osc);
        border: 1px solid var(--primario);
        padding: 8px 12px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-guia:hover {
        background: var(--primario-claro);
      }
      .chips {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 12px;
        border: 1px solid var(--g300);
        background: #fff;
        cursor: pointer;
      }
      .chip.ok {
        background: #ecfdf5;
        border-color: #a7f3d0;
        color: #065f46;
      }
      .chip.warn {
        background: #fffbeb;
        border-color: #fde68a;
        color: #92400e;
      }
      .chip.crit {
        background: #fef2f2;
        border-color: #fecaca;
        color: #991b1b;
      }

      .disclaimer {
        background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
        border: 1px solid var(--aviso);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 14px;
      }

      .rejilla {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 16px;
      }
      @media (max-width: 1024px) {
        .rejilla {
          grid-template-columns: 1fr;
        }
      }

      .tarjeta {
        background: #fff;
        border-radius: 8px;
        padding: 18px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }
      .titulo-tarjeta {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--g200);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .barra-controles {
        background: #fff;
        border-radius: 8px;
        padding: 14px;
        margin-bottom: 14px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 14px;
        align-items: flex-end;
        flex-wrap: wrap;
      }

      .grupo {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .grupo label {
        font-size: 13px;
        color: var(--g700);
        font-weight: 600;
      }
      .grupo select,
      .grupo input,
      #sokolow_box input,
      #cornell_box input {
        padding: 8px 10px;
        border: 1px solid var(--g300);
        border-radius: 6px;
        font-size: 13px;
        background: #fff;
        min-width: 130px;
      }
      /* === Unidades visibles dentro del input === */
      .input-unidad {
        position: relative;
        display: inline-block;
      }
      .input-unidad input {
        padding-right: 44px;
      } /* hueco para la pastilla */
      .unidad {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        color: var(--g600);
        background: var(--g100);
        border: 1px solid var(--g300);
        border-radius: 999px;
        padding: 2px 8px;
        pointer-events: none;
        line-height: 1;
      }

      .grupo select:focus,
      .grupo input:focus {
        outline: none;
        border-color: var(--primario);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
      }

      .fila {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .valor-calc {
        padding: 6px 10px;
        background: var(--g50);
        border-radius: 6px;
        font-size: 13px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .valor-ok {
        background: #d1fae5;
        color: #065f46;
      }
      .valor-warn {
        background: #fef3c7;
        color: #92400e;
      }
      .valor-danger {
        background: #fee2e2;
        color: #991b1b;
      }
      .oculto {
        display: none;
      }

      .radios,
      .checks {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .radio,
      .check {
        display: block;
      }
      .radio label,
      .check label {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border: 1px solid var(--g300);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 13px;
      }
      .radio label:hover,
      .check label:hover {
        border-color: var(--primario);
        background: var(--g50);
      }
      .radio input[type="radio"],
      .check input[type="checkbox"] {
        display: none;
      }
      .radio input:checked + label,
      .check input:checked + label {
        border-color: var(--primario);
        background: var(--primario-claro);
        color: var(--primario-osc);
        font-weight: 700;
      }
      .lbl-kb {
        outline: none;
      }
      .lbl-kb:focus {
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
        border-radius: 10px;
      }

      .pistas {
        background: var(--g50);
        border: 1px solid var(--g200);
        border-radius: 8px;
        padding: 12px;
        margin-top: 10px;
      }
      .pistas p {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .resultado {
        margin-top: 8px;
        padding: 8px;
        border-radius: 6px;
        font-weight: 700;
        text-align: center;
      }

      .tooltip {
        position: relative;
        display: inline-flex;
        align-items: center;
      }
      .tip {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--primario-osc);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 800;
        margin-left: 6px;
        cursor: help;
      }
      .tooltip .contenido-tip {
        position: absolute;
        bottom: 120%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--g900);
        color: #fff;
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 12px;
        width: 320px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      .tooltip:hover .contenido-tip {
        opacity: 1;
        visibility: visible;
      }
      .contenido-tip strong {
        color: #fbbf24;
        display: block;
        margin-bottom: 4px;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
        border-bottom: 2px solid var(--g200);
      }
      .tab {
        padding: 8px 14px;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--g600);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: -2px;
      }
      .tab:hover {
        color: var(--primario);
      }
      .tab.activa {
        color: var(--primario);
        border-bottom-color: var(--primario);
      }

      #hallazgos_vivos {
        border: 1px solid var(--primario-claro);
        background: #eff6ff;
      }
      #lista_hallazgos {
        list-style: none;
        padding: 0;
      }
      #lista_hallazgos li {
        padding: 6px 0;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      #lista_hallazgos li::before {
        content: "✓";
        color: var(--exito);
        font-weight: 700;
        font-size: 16px;
      }
      #lista_hallazgos li.warn::before {
        content: "⚠️";
        color: var(--aviso);
      }
      #lista_hallazgos li.crit::before {
        content: "🚨";
        color: var(--peligro);
      }

      .caja-edu {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        border: 1px solid var(--primario);
        border-radius: 8px;
        padding: 12px;
        margin-top: 10px;
        font-size: 12px;
        line-height: 1.55;
      }
      .caja-edu h4 {
        margin: 0 0 6px 0;
        color: var(--primario-osc);
      }

      .acciones {
        display: flex;
        gap: 12px;
        justify-content: center;
        padding: 16px;
        background: #fff;
        border-radius: 8px;
        margin-top: 14px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        flex-wrap: wrap;
      }
      .btn {
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .btn-prim {
        background: var(--primario);
        color: #fff;
      }
      .btn-prim:hover {
        background: var(--primario-osc);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
      }
      .btn-sec {
        background: var(--g100);
        color: var(--g700);
        border: 1px solid var(--g300);
      }
      .btn-sec:hover {
        background: var(--g200);
      }
      .btn-ok {
        background: var(--exito);
        color: #fff;
      }
      .btn-ok:hover {
        background: #059669;
      }

      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
      }
      .modal.activa {
        display: block;
      }
      .contenido-modal {
        max-width: 900px;
        margin: 40px auto;
        background: #fff;
        border-radius: 12px;
        padding: 26px;
        animation: deslizar 0.25s ease;
      }
      @keyframes deslizar {
        from {
          opacity: 0;
          transform: translateY(16px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .encabezado-modal {
        border-bottom: 2px solid var(--g200);
        padding-bottom: 12px;
        margin-bottom: 16px;
      }
      .encabezado-modal h2 {
        font-size: 20px;
        font-weight: 800;
      }
      .grid-param {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      @media (max-width: 640px) {
        .grid-param {
          grid-template-columns: 1fr;
        }
      }
      .param {
        padding: 10px;
        background: var(--g50);
        border-radius: 8px;
        border-left: 3px solid var(--primario);
      }
      .param .etq {
        font-size: 12px;
        color: var(--g600);
        margin-bottom: 3px;
      }
      .param .val {
        font-size: 15px;
        font-weight: 800;
      }

      .lista {
        list-style: none;
        padding: 0;
      }
      .item {
        padding: 10px;
        background: var(--g50);
        border-radius: 8px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .item.warn {
        background: #fef3c7;
        border-left: 3px solid var(--aviso);
      }
      .item.crit {
        background: #fee2e2;
        border-left: 3px solid var(--peligro);
      }

      .alerta-crit {
        background: var(--peligro);
        color: #fff;
        padding: 14px;
        border-radius: 10px;
        margin-bottom: 10px;
      }
      .alerta-crit h4 {
        margin: 0 0 8px 0;
      }

      .noti-copia {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--g900);
        color: #fff;
        padding: 12px 16px;
        border-radius: 8px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.25s;
      }
      .noti-copia.mostrar {
        opacity: 1;
        visibility: visible;
      }

      .divisor {
        height: 1px;
        background: var(--g200);
        margin: 12px 0;
      }
      .formula {
        display: inline-block;
        background: var(--primario-claro);
        color: var(--primario-osc);
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 6px;
        margin-left: 6px;
        font-family: monospace;
        vertical-align: middle;
      }

      details summary {
        cursor: pointer;
        font-weight: 700;
      }
      details {
        margin-top: 8px;
      }

      html {
        scroll-behavior: smooth;
      }
      .introjs-showElement {
        scroll-margin-top: 110px;
        scroll-margin-bottom: 80px;
      }
      .titulo-seccion {
        font-size: 16px;
        font-weight: 800;
        color: var(--g800);
        margin: 6px 0 8px 2px;
      }
      /* === SVG ECG — estilos de iconos pedagógicos === */
      .ecg-figure {
        display: inline-flex;
        flex-direction: column;
        gap: 6px;
        align-items: center;
      }
      .ecg-figure .legend {
        font-size: 12px;
        color: var(--g700);
        text-align: center;
      }
      .ecg-svg {
        width: 100%;
        max-width: 420px;
        height: auto;
      }
      .ecg-grid line {
        stroke: var(--g200);
        stroke-width: 1;
        opacity: 0.6;
      }
      .ecg-baseline {
        stroke: var(--g400);
        stroke-width: 1.5;
        stroke-dasharray: 2 2;
      }
      .trace {
        fill: none;
        stroke: var(--g700);
        stroke-width: 2;
      }
      .trace.muted {
        opacity: 0.45;
      }
      .trace.hl {
        stroke: var(--primario);
        stroke-width: 3;
      }
      .trace.hl.crit {
        stroke: var(--peligro);
      }
      .label-lead {
        font-size: 11px;
        fill: var(--g600);
      }
      @media (prefers-color-scheme: dark) {
        .ecg-grid line {
          stroke: #2a2f3a;
          opacity: 0.8;
        }
        .ecg-baseline {
          stroke: #4a5160;
        }
        .trace {
          stroke: #d1d5db;
        }
        .legend,
        .label-lead {
          color: #cbd5e1;
          fill: #cbd5e1;
        }
      }
    </style>

    <link
      rel="stylesheet"
      href="https://unpkg.com/intro.js/minified/introjs.min.css"
    />
    <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>

    <style>
      .introjs-tooltip {
        background: #fff7a8;
        color: #333;
        max-width: 380px;
        box-shadow: 5px 5px 7px rgba(33, 33, 33, 0.25);
        border-radius: 10px;
      }
      .introjs-button {
        background: #e5e7eb;
        border: 1px solid #9ca3af;
        color: #333;
      }
      .introjs-button:hover {
        background: #d1d5db;
      }
      .detalles-contexto {
        margin-top: 2px;
      }
      .detalles-contexto summary {
        display: inline-block;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        background: #fff;
        border: 1px solid var(--g300);
        border-radius: 999px;
        padding: 6px 10px;
      }
      .detalles-contexto[open] summary {
        background: var(--g100);
      }
    </style>

    <style>
      .mg-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
        margin-top: 8px;
      }
      .mg-thumb {
        background: #fff;
        border: 1px solid var(--g200);
        border-radius: 10px;
        padding: 8px;
        cursor: pointer;
        text-align: center;
      }
      .mg-thumb:focus-visible {
        outline: 2px solid var(--primario);
        outline-offset: 2px;
      }
      .mg-thumb:hover {
        border-color: var(--primario);
        box-shadow: 0 6px 18px rgba(37, 99, 235, 0.12);
      }
      .mg-thumb figure {
        margin: 0;
      }
      .mg-thumb figcaption {
        font-size: 12px;
        font-weight: 600;
        color: var(--g700);
        margin-top: 6px;
      }
      #mg_modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 1100;
        padding: 20px;
      }
      #mg_modal.activo {
        display: block;
      }
      .mg-dialog {
        max-width: 900px;
        margin: 40px auto;
        background: #fff;
        border-radius: 12px;
        padding: 22px;
      }
      .mg-titulo {
        font-size: 18px;
        font-weight: 800;
        margin: 0 0 8px 0;
      }
      .mg-cuerpo {
        display: flex;
        gap: 16px;
        align-items: flex-start;
        flex-wrap: wrap;
      }
      .mg-svg {
        flex: 1 1 520px;
      }
      .mg-svg svg {
        width: 100%;
        height: auto;
        display: block;
      }
      .mg-desc {
        flex: 1 1 240px;
        color: var(--g700);
        font-size: 14px;
        line-height: 1.5;
      }
      .mg-acciones {
        display: flex;
        gap: 10px;
        margin-top: 12px;
        justify-content: flex-end;
      }
      .mg-btn {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid var(--g300);
        background: #fff;
        cursor: pointer;
        font-weight: 600;
      }
      .mg-btn-prim {
        background: var(--primario);
        color: #fff;
        border-color: var(--primario);
      }
      .mg-btn-prim:hover {
        background: var(--primario-osc);
      }
      @media (max-width: 640px) {
        .mg-cuerpo {
          flex-direction: column;
        }
      }
      @media print {
        #mg_modal {
          display: none;
        }
      }
    </style>
  </head>

  <body>
    <div class="contenedor">
      <header class="cabecera" id="hdr">
        <div class="marca">
          <div class="isotipo">ECG</div>
        </div>

        <div class="titulos">
          <h1 class="h1">
            Guía de interpretación de ECG <span class="badge">v2.7</span>
          </h1>
          <p class="subtitulo">
            Herramienta educativa y de apoyo a la redacción del informe.
          </p>
        </div>

        <div class="acciones-cab">
          <button
            id="btn_tour"
            class="btn-guia"
            title="Mostrar guía paso a paso"
          >
            ❓ Guía interactiva
          </button>
        </div>

        <div class="resumen-cab">
          <div class="label-resumen">Resumen del ECG</div>
          <div
            class="chips"
            id="chips_resumen"
            aria-label="Resumen del ECG (pulsa para ir a la sección)"
          ></div>
        </div>
      </header>

      <h2 class="titulo-seccion" id="tit_param">Parámetros básicos</h2>

      <section class="barra-controles" id="controles">
        <div class="grupo" id="ctrl_vel">
          <label for="velocidad_papel">Velocidad</label>
          <select id="velocidad_papel">
            <option value="25">25 mm/s</option>
            <option value="50">50 mm/s</option>
          </select>
        </div>

        <details class="detalles-contexto">
          <summary>Contexto del paciente (opcional)</summary>
          <div class="fila" style="margin-top: 6px">
            <div class="grupo">
              <label for="edad_paciente">Edad (opcional)</label>
              <input
                id="edad_paciente"
                type="number"
                min="0"
                max="120"
                placeholder="años"
              />
            </div>
          </div>
        </details>

        <div class="grupo">
          <label for="sexo_paciente">Sexo</label>
          <select id="sexo_paciente">
            <option value="">-</option>
            <option value="M">Masculino</option>
            <option value="F">Femenino</option>
          </select>
        </div>

        <div class="grupo" id="ctrl_fuente_fc">
          <label for="fuente_fc">Fuente de FC</label>
          <select id="fuente_fc">
            <option value="manual">Entrada directa</option>
            <option value="rr_regular">Calcular por RR (regular)</option>
            <option value="qrs_6s">Conteo de QRS en 6 s (irregular)</option>
          </select>
        </div>

        <div class="grupo" id="bloque_fc_manual">
          <label for="fc_manual">FC (si la da el aparato)</label>
          <input
            id="fc_manual"
            type="number"
            min="15"
            max="250"
            placeholder="lpm"
          />
        </div>

        <div class="grupo oculto" id="bloque_fc_rr">
          <label class="lbl-kb" tabindex="0">
            RR en ritmo regular
            <span class="tooltip">
              <span class="tip">?</span>
              <span class="contenido-tip">
                <strong>Métodos (25 mm/s)</strong>
                • Cuadros grandes: FC = 300 ÷ RR<br />
                • Cuadritos: FC = 1500 ÷ RR<br /><br />
                <strong>Métodos (50 mm/s)</strong>
                • Cuadros grandes: FC = 600 ÷ RR<br />
                • Cuadritos: FC = 3000 ÷ RR
              </span>
            </span>
          </label>
          <div class="fila">
            <input
              id="rr_grandes"
              type="number"
              min="0.5"
              max="50"
              step="0.1"
              placeholder="cuad. grandes"
            />
            <span class="formula">FC = 300/600 ÷ RR (según 25/50 mm/s)</span>
          </div>
          <div class="fila">
            <input
              id="rr_pequenos"
              type="number"
              min="1"
              max="500"
              step="0.5"
              placeholder="cuad. pequeños"
            />
            <span class="formula">FC = 1500/3000 ÷ RR (según 25/50 mm/s)</span>
          </div>
        </div>

        <div class="grupo oculto" id="bloque_fc_6s">
          <label id="etq_qrs_6s">QRS en 6 s (30 cuad. grandes)</label>
          <input
            id="qrs_6s"
            type="number"
            min="1"
            max="50"
            placeholder="complejos"
          />
        </div>

        <div class="grupo" id="ctrl_qtc">
          <label for="formula_qtc">Fórmula QTc</label>
          <select id="formula_qtc">
            <option value="bazett">Bazett</option>
            <option value="fridericia">Fridericia</option>
            <option value="hodges">Hodges</option>
          </select>
        </div>

        <div class="grupo">
          <label>&nbsp;</label>
          <div
            id="fc_resultado"
            class="valor-calc oculto"
            aria-live="polite"
          ></div>
        </div>
      </section>

      <div class="rejilla">
        <div>
          <section class="tarjeta" id="sec_ritmo">
            <h3 class="titulo-tarjeta">❤️ Ritmo y patrones</h3>
            <div class="mini-galeria" data-ids="ritmo_normal,fa,ev"></div>

            <p style="font-size: 12px; color: var(--g600); margin-top: -6px">
              Consejos docentes: empieza por el
              <em>aspecto global del ritmo</em> y patrones
              regulares/irregulares, luego mide (PR, QRS, QTc) y finalmente
              integra eje, ST/T y voltajes.
            </p>

            <details class="caja-edu">
              <summary>Glosario esencial: letras, tamaños y primes (′)</summary>
              <ul style="margin-left: 16px">
                <li>
                  <strong>Mayúsculas (Q, R, S)</strong>: deflexiones de mayor
                  amplitud. Regla docente útil: ≥ 5&nbsp;mm con calibración
                  estándar (10&nbsp;mm&nbsp;=&nbsp;1&nbsp;mV) → mayúscula; es
                  una <em>convención</em>, no un corte fisiológico rígido.
                </li>
                <li>
                  <strong>Minúsculas (q, r, s)</strong>: deflexiones de menor
                  amplitud (&lt; 5&nbsp;mm) con la misma salvedad de
                  calibración.
                </li>
                <li>
                  <strong>Primes (′)</strong>: segunda deflexión de la misma
                  polaridad (R′ o r′).
                </li>
                <li>
                  <strong>rSr′ en V1–V2</strong>: con
                  <strong>QRS &lt; 120&nbsp;ms</strong> y r′ estrecha puede ser
                  variante normal o <em>BRD incompleto</em>; si
                  <strong>QRS ≥ 120&nbsp;ms</strong> y S ancha en I/V6, orienta
                  a <em>BRD</em> completo.
                </li>
                <li>
                  <strong>“R ancha” / “S empastada”</strong>: borde terminal
                  ensanchado o muescas (slurring), porción terminal &gt;
                  40&nbsp;ms; típico de BRI (R ancha sin q en I/V6) y de S ancha
                  en I/V6 en BRD.
                </li>
              </ul>
            </details>

            <div class="grupo">
              <label>Tipo de ritmo</label>
              <div class="radios">
                <div class="radio">
                  <input
                    id="ritmo_regular"
                    name="tipo_ritmo"
                    type="radio"
                    value="regular"
                    checked
                  />
                  <label for="ritmo_regular" class="lbl-kb" tabindex="0"
                    >Regular</label
                  >
                </div>
                <div class="radio">
                  <input
                    id="ritmo_irregular"
                    name="tipo_ritmo"
                    type="radio"
                    value="irregular"
                  />
                  <label for="ritmo_irregular" class="lbl-kb" tabindex="0"
                    >Irregular</label
                  >
                </div>
                <div class="radio">
                  <input
                    id="ritmo_bigeminismo"
                    name="tipo_ritmo"
                    type="radio"
                    value="bigeminismo"
                  />
                  <label for="ritmo_bigeminismo" class="lbl-kb" tabindex="0"
                    >Bigeminismo</label
                  >
                </div>
                <div class="radio">
                  <input
                    id="ritmo_trigeminismo"
                    name="tipo_ritmo"
                    type="radio"
                    value="trigeminismo"
                  />
                  <label for="ritmo_trigeminismo" class="lbl-kb" tabindex="0"
                    >Trigeminismo</label
                  >
                </div>
              </div>
            </div>

            <div id="ayuda_ectopias" class="pistas oculto">
              <p>
                ¿La ectopia parece supraventricular (ESA) o ventricular (EV)?
              </p>
              <div class="radios">
                <div class="radio">
                  <input
                    id="tipo_ecto_esa"
                    name="tipo_ecto"
                    type="radio"
                    value="esa"
                  />
                  <label for="tipo_ecto_esa" class="lbl-kb" tabindex="0"
                    >ESA (QRS estrecho, P anómala o retrógrada)</label
                  >
                </div>
                <div class="radio">
                  <input
                    id="tipo_ecto_ev"
                    name="tipo_ecto"
                    type="radio"
                    value="ev"
                  />
                  <label for="tipo_ecto_ev" class="lbl-kb" tabindex="0"
                    >EV (QRS ancho, sin P previa, pausa compensadora)</label
                  >
                </div>
              </div>
              <details class="caja-edu">
                <summary>
                  Referencia rápida: patrones regularmente irregulares
                </summary>
                Bigeminismo: sinusal + ectópico (acoplamiento fijo).
                Trigeminismo: 2 sinusales + ectópico. En EV: QRS ancho con T
                discordante; en ESA: QRS estrecho con P anómala/retrógrada.
              </details>
            </div>

            <div id="afib_box" class="pistas oculto">
              <p>
                Ritmo irregular. ¿Se identifican ondas P claras y consistentes?
              </p>
              <div class="radios">
                <div class="radio">
                  <input id="p_si" name="p_def" type="radio" value="si" />
                  <label for="p_si" class="lbl-kb" tabindex="0">Sí</label>
                </div>
                <div class="radio">
                  <input id="p_no" name="p_def" type="radio" value="no" />
                  <label for="p_no" class="lbl-kb" tabindex="0"
                    >No (línea de base caótica)</label
                  >
                </div>
              </div>
              <div id="afib_res" class="resultado oculto"></div>
            </div>
          </section>

          <section class="tarjeta" id="sec_intervalos">
            <h3 class="titulo-tarjeta">📏 Intervalos y bloqueos AV</h3>
            <div
              class="mini-galeria"
              data-ids="bav1,mobitz1,mobitz2,bav3"
            ></div>

            <div class="grupo">
              <label for="pr_cuad">
                Intervalo PR
                <span class="tooltip">
                  <span class="tip">?</span>
                  <span class="contenido-tip">
                    <strong>Normal</strong> 3–5 cuad. (120–200 ms). PR &lt; 120
                    ms con QRS ancho y delta sugiere preexcitación.
                  </span>
                </span>
              </label>
              <div class="fila">
                <input
                  id="pr_cuad"
                  type="number"
                  min="0"
                  max="20"
                  step="0.5"
                  placeholder="cuad. pequeños"
                />
                <span id="pr_res" class="valor-calc oculto"></span>
              </div>
            </div>

            <div class="grupo">
              <label for="qrs_cuad">
                Duración QRS
                <span class="tooltip">
                  <span class="tip">?</span>
                  <span class="contenido-tip">
                    <strong>Guía rápida</strong><br />
                    • &lt; 110 ms: estrecho (normal).<br />
                    • 110–119 ms: <em>limítrofe</em> (sugiere BRD incompleto si
                    rSR′ en V1–V2).<br />
                    • ≥ 120 ms: ancho (valorar BRD/BRI, marcapasos,
                    preexcitación, tóxicos).
                  </span>
                </span>
              </label>
              <div class="fila">
                <input
                  id="qrs_cuad"
                  type="number"
                  min="0"
                  max="20"
                  step="0.5"
                  placeholder="cuad. pequeños"
                />
                <span id="qrs_res" class="valor-calc oculto"></span>
              </div>
            </div>

            <div class="grupo">
              <label for="qt_cuad">
                Intervalo QT
                <span class="tooltip">
                  <span class="tip">?</span>
                  <span class="contenido-tip">
                    <strong>Medición</strong> inicio QRS → fin T (evitar
                    derivaciones con T plana o U prominente). Corrige por FC
                    (QTc).
                  </span>
                </span>
              </label>
              <div class="fila">
                <input
                  id="qt_cuad"
                  type="number"
                  min="0"
                  max="30"
                  step="0.5"
                  placeholder="cuad. pequeños"
                />
                <span id="qt_res" class="valor-calc oculto"></span>
              </div>
              <div id="qtc_res" class="fila" style="margin-top: 8px"></div>

              <details class="caja-edu">
                <summary>Referencia rápida: fórmulas de QTc</summary>
                Bazett sobrecorrige en taquicardia y subcorrige en bradicardia;
                Fridericia es más estable; Hodges no usa RR. Compara si hay
                dudas y aplica contexto clínico.
              </details>
            </div>

            <div id="bav_box" class="pistas oculto">
              <div id="bav_paso1" class="grupo">
                <p>
                  PR anómalo. ¿Es <strong>constante</strong> o
                  <strong>variable/ausente</strong>?
                </p>
                <div class="radios">
                  <div class="radio">
                    <input
                      id="pr_constante"
                      name="pr_comp"
                      type="radio"
                      value="const"
                    />
                    <label for="pr_constante" class="lbl-kb" tabindex="0"
                      >Constante</label
                    >
                  </div>
                  <div class="radio">
                    <input
                      id="pr_variable"
                      name="pr_comp"
                      type="radio"
                      value="var"
                    />
                    <label for="pr_variable" class="lbl-kb" tabindex="0"
                      >Variable</label
                    >
                  </div>
                </div>
              </div>
              <div id="bav_paso2" class="grupo oculto">
                <p>
                  PR variable. ¿Se alarga progresivamente hasta que una P no
                  conduce?
                </p>
                <div class="radios">
                  <div class="radio">
                    <input
                      id="wenckebach_si"
                      name="wenck"
                      type="radio"
                      value="si"
                    />
                    <label for="wenckebach_si" class="lbl-kb" tabindex="0"
                      >Sí</label
                    >
                  </div>
                  <div class="radio">
                    <input
                      id="wenckebach_no"
                      name="wenck"
                      type="radio"
                      value="no"
                    />
                    <label for="wenckebach_no" class="lbl-kb" tabindex="0"
                      >No</label
                    >
                  </div>
                </div>
              </div>
              <div id="bav_paso3" class="grupo oculto">
                <p>¿Hay disociación completa P–QRS?</p>
                <div class="radios">
                  <div class="radio">
                    <input
                      id="disocia_si"
                      name="disocia"
                      type="radio"
                      value="si"
                    />
                    <label for="disocia_si" class="lbl-kb" tabindex="0"
                      >Sí</label
                    >
                  </div>
                  <div class="radio">
                    <input
                      id="disocia_no"
                      name="disocia"
                      type="radio"
                      value="no"
                    />
                    <label for="disocia_no" class="lbl-kb" tabindex="0"
                      >No</label
                    >
                  </div>
                </div>
              </div>
              <div id="bav_res" class="resultado oculto"></div>

              <details class="caja-edu">
                <summary>Referencia rápida: claves de BAV</summary>
                BAV 1.º: PR &gt; 200 ms con todas las P conducidas. Mobitz I: PR
                se alarga hasta P bloqueada. Mobitz II: PR constante con P
                bloqueadas súbitas. BAV 3.º: disociación AV completa.
              </details>
            </div>

            <div class="caja-edu">
              <h4>Referencia rápida: rSR′ en V1–V2</h4>
              rSr′ (R′ estrecha) con QRS &lt; 120 ms puede ser variante/BRD
              incompleto. BRD completo requiere QRS ≥ 120 ms + R′ en V1–V2 y S
              ancha en I/V6. Si PR &lt; 120 ms + delta, considerar WPW.
            </div>
          </section>

          <section class="tarjeta" id="sec_eje">
            <h3 class="titulo-tarjeta">🧭 Eje eléctrico y hemibloqueos</h3>
            <div
              class="mini-galeria"
              data-ids="axis_normal,axis_izq,axis_der"
            ></div>

            <div class="grupo">
              <label>Método rápido (signo de QRS en DI y aVF)</label>
              <div class="fila">
                <div class="radios">
                  <span>DI:</span>
                  <div class="radio">
                    <input id="di_pos" name="qrs_di" type="radio" value="+" />
                    <label for="di_pos" class="lbl-kb" tabindex="0">+</label>
                  </div>
                  <div class="radio">
                    <input id="di_neg" name="qrs_di" type="radio" value="-" />
                    <label for="di_neg" class="lbl-kb" tabindex="0">-</label>
                  </div>
                </div>
                <div class="radios" style="margin-left: 12px">
                  <span>aVF:</span>
                  <div class="radio">
                    <input id="avf_pos" name="qrs_avf" type="radio" value="+" />
                    <label for="avf_pos" class="lbl-kb" tabindex="0">+</label>
                  </div>
                  <div class="radio">
                    <input id="avf_neg" name="qrs_avf" type="radio" value="-" />
                    <label for="avf_neg" class="lbl-kb" tabindex="0">-</label>
                  </div>
                </div>
              </div>
              <div
                id="eje_res"
                class="valor-calc oculto"
                style="width: 100%; justify-content: center; margin-top: 8px"
              ></div>
            </div>

            <div class="grupo" style="margin-top: 8px">
              <label>
                Cálculo en grados (opcional) por vector neto DI/aVF
                <span class="tooltip">
                  <span class="tip">?</span>
                  <span class="contenido-tip">
                    <strong>Cómo medir</strong> En DI y aVF, resta S a R (R−S)
                    en mm (negativo si S&gt;R). Ángulo = atan2(aVF, DI). Normal
                    ~ −30° a +90°.
                  </span>
                </span>
              </label>
              <div class="fila">
                <input
                  id="di_neto_mm"
                  type="number"
                  step="0.5"
                  min="-60"
                  max="60"
                  placeholder="DI neto (R−S) mm"
                />
                <input
                  id="avf_neto_mm"
                  type="number"
                  step="0.5"
                  min="-60"
                  max="60"
                  placeholder="aVF neto (R−S) mm"
                />
                <span id="eje_grados_res" class="valor-calc oculto"></span>
              </div>
              <div
                id="eje_consistencia"
                class="fila"
                style="font-size: 12px; color: var(--g600)"
              ></div>
            </div>

            <div class="grupo" style="margin-top: 8px">
              <label>
                Método alternativo: derivación más isodifásica
                <span class="tooltip">
                  <span class="tip">?</span>
                  <span class="contenido-tip">
                    <strong>Isodifásica</strong> derivación con R≈S. El eje es
                    perpendicular a ella. Si el QRS es positivo en la
                    perpendicular, el eje apunta hacia esa derivación; si es
                    negativo, hacia la opuesta (±90°).
                  </span>
                </span>
              </label>
              <div class="fila">
                <select id="iso_deriv">
                  <option value="">— elige derivación —</option>
                  <option value="I">DI (0°)</option>
                  <option value="II">DII (+60°)</option>
                  <option value="III">DIII (+120°)</option>
                  <option value="aVR">aVR (−150°)</option>
                  <option value="aVL">aVL (−30°)</option>
                  <option value="aVF">aVF (+90°)</option>
                </select>
                <div class="radios">
                  <div class="radio">
                    <input
                      id="iso_perp_pos"
                      name="iso_signo"
                      type="radio"
                      value="pos"
                    />
                    <label for="iso_perp_pos" class="lbl-kb" tabindex="0"
                      >QRS en derivación perpendicular: +</label
                    >
                  </div>
                  <div class="radio">
                    <input
                      id="iso_perp_neg"
                      name="iso_signo"
                      type="radio"
                      value="neg"
                    />
                    <label for="iso_perp_neg" class="lbl-kb" tabindex="0"
                      >QRS en derivación perpendicular: −</label
                    >
                  </div>
                </div>
                <span id="eje_iso_res" class="valor-calc oculto"></span>
              </div>
            </div>

            <div id="hemi_box" class="pistas oculto" style="margin-top: 8px">
              <p>
                Eje desviado a la izquierda. Comprobar morfología para HBAI:
              </p>
              <div class="checks">
                <div class="check">
                  <input id="qr_avl" type="checkbox" />
                  <label for="qr_avl" class="lbl-kb" tabindex="0"
                    >qR en aVL</label
                  >
                </div>
                <div class="check">
                  <input id="rs_inferior" type="checkbox" />
                  <label for="rs_inferior" class="lbl-kb" tabindex="0"
                    >rS en II/III/aVF</label
                  >
                </div>
              </div>
              <div id="hemi_res" class="resultado oculto"></div>
            </div>

            <details class="caja-edu">
              <summary>Referencia rápida: lectura del eje</summary>
              Usa <em>DI/aVF</em> por cuadrantes (cribado), el cálculo en
              <em>grados</em> por vector neto (R−S), y el método de
              <em>isodifásica</em> como confirmación: busca R≈S y aplica ±90° en
              la perpendicular según el signo. Adulto: normal ~ −30° a +90°;
              &lt; −30° izquierda; &gt; +90° derecha; &lt; −90° extrema.
            </details>
          </section>
        </div>

        <div>
          <section class="tarjeta" id="sec_conduccion">
            <h3 class="titulo-tarjeta">🔀 Trastornos de conducción IV</h3>
            <div class="mini-galeria" data-ids="rsr_v1,brd_v1v6,bri_v1v6"></div>

            <div
              id="bloque_conduccion_placeholder"
              class="fila"
              style="color: var(--g600)"
            >
              Introduce QRS en “Intervalos”. Si es ≥ 120 ms, se activa esta
              guía.
            </div>
            <div id="bloque_conduccion" class="pistas oculto">
              <p>QRS ancho (≥ 120 ms). Analiza morfología:</p>

              <div class="grupo">
                <label style="font-weight: 700">
                  V1/V2
                  <span class="tooltip"
                    ><span class="tip">?</span>
                    <span class="contenido-tip">
                      <strong>rSR′ (V1–V2)</strong> “orejas de conejo”: sugiere
                      BRD si <strong>QRS ≥ 120&nbsp;ms</strong>; con
                      <strong>110–119&nbsp;ms</strong> →
                      <em>BRD incompleto</em> (valorar contexto/edad).
                    </span>
                  </span>
                </label>
                <div class="radios">
                  <div class="radio">
                    <input
                      id="v1_rsr"
                      name="v1_morf"
                      type="radio"
                      value="rsr"
                    />
                    <label for="v1_rsr" class="lbl-kb" tabindex="0"
                      >rSR′ (orejas de conejo)</label
                    >
                  </div>
                  <div class="radio">
                    <input
                      id="v1_s_ancha"
                      name="v1_morf"
                      type="radio"
                      value="s_ancha"
                    />
                    <label for="v1_s_ancha" class="lbl-kb" tabindex="0"
                      >S ancha y profunda</label
                    >
                  </div>
                </div>
              </div>

              <div class="grupo">
                <label style="font-weight: 700">
                  I/V6
                  <span class="tooltip"
                    ><span class="tip">?</span>
                    <span class="contenido-tip">
                      <strong>R ancha sin q</strong> y muescas terminales →
                      orienta a <em>BRI</em> (discordancia de ST-T “apropiada”).
                      <strong>S ancha</strong> en I/V6 apoya <em>BRD</em>.
                    </span>
                  </span>
                </label>
                <div class="radios">
                  <div class="radio">
                    <input
                      id="v6_s_empastada"
                      name="v6_morf"
                      type="radio"
                      value="s_emp"
                    />
                    <label for="v6_s_empastada" class="lbl-kb" tabindex="0"
                      >S ancha y empastada</label
                    >
                  </div>
                  <div class="radio">
                    <input
                      id="v6_r_ancha"
                      name="v6_morf"
                      type="radio"
                      value="r_ancha"
                    />
                    <label for="v6_r_ancha" class="lbl-kb" tabindex="0"
                      >R ancha, sin Q</label
                    >
                  </div>
                </div>
              </div>

              <div id="bbb_res" class="resultado oculto"></div>

              <details class="caja-edu">
                <summary>Referencia rápida: BRD vs BRI</summary>
                <strong>BRD:</strong> R′ en V1–V2, S ancha en I/V6. Si QRS
                110–119 ms con rSR′ → BRD incompleto.<br />
                <strong>BRI:</strong> QS o R ancha en I/V6 sin q, con
                discordancia “apropiada” de ST-T (ST opuesto al vector QRS). Si
                discordancia es “excesiva”, sospecha isquemia.
              </details>
            </div>
          </section>

          <section class="tarjeta" id="sec_isquemia">
            <h3 class="titulo-tarjeta">📈 Isquemia, lesión e infarto</h3>
            <div
              class="mini-galeria"
              data-ids="ste_concava,ste_convexa,std_horiz"
            ></div>

            <div class="grupo">
              <label>
                Elevación ST en:
                <span class="tooltip">
                  <span class="tip">?</span>
                  <span class="contenido-tip">
                    <strong>IAMCEST</strong> ≥ 1&nbsp;mm en ≥ 2 derivaciones
                    contiguas.<br />
                    En <strong>V2–V3</strong>: ≳ 2&nbsp;mm (varón &gt;
                    40&nbsp;a) / ≳ 2.5&nbsp;mm (varón &lt; 40&nbsp;a) / ≳
                    1.5&nbsp;mm (mujer).<br />
                    Considera <strong>cara posterior</strong> (V7–V9) si hay
                    sospecha por clínica o expansión del territorio.
                  </span>
                </span>
              </label>
              <div
                class="checks"
                id="st_elev_grid"
                style="flex-wrap: wrap"
              ></div>
            </div>

            <div class="divisor"></div>

            <div class="grupo">
              <label>
                Depresión ST en:
                <span class="tooltip">
                  <span class="tip">?</span>
                  <span class="contenido-tip">
                    <strong>Isquemia</strong> ≥ 0.5&nbsp;mm en ≥ 2 contiguas.<br />
                    Puede ser <em>recíproco</em> (p. ej., depresión inferior con
                    elevación en I/aVL) o patrón
                    <strong>de&nbsp;Winter</strong> (descenso ascendente con T
                    altas en precordiales) como equivalente de IAM.
                  </span>
                </span>
              </label>
              <div
                class="checks"
                id="st_dep_grid"
                style="flex-wrap: wrap"
              ></div>
            </div>

            <div class="divisor"></div>

            <div class="grupo">
              <label>
                Ondas Q patológicas:
                <span class="tooltip">
                  <span class="tip">?</span>
                  <span class="contenido-tip">
                    <strong>Criterio clásico</strong> &gt; 40&nbsp;ms o &gt;
                    25&nbsp;% de R.<br />
                    <strong>Excepciones</strong>: aVR y, según eje/respiración,
                    III. Pequeñas q septales en I, aVL, V5–V6 pueden ser
                    <em>fisiológicas</em> con voltajes normales.<br />
                    Correlacionar con clínica, territorios y cronología.
                  </span>
                </span>
              </label>
              <div class="checks" id="q_grid" style="flex-wrap: wrap"></div>
            </div>

            <details class="caja-edu">
              <summary>
                Equivalentes de IAMCEST: posterior, de Winter y Sgarbossa
              </summary>
              <ul style="margin-left: 16px">
                <li>
                  <strong>Infarto posterior</strong>: R altas y ST↓ en V1–V3 →
                  colocar V7–V9 (ST↑ posterior).
                </li>
                <li>
                  <strong>Patrón de Winter</strong>: ST↓ ascendente + T altas
                  simétricas en precordiales (equivalente de activación).
                </li>
                <li>
                  <strong>Sgarbossa (BRI/marcapasos)</strong>: concordancia
                  ST/onda en la misma dirección (≥ 1&nbsp;mm) o discordancia
                  excesiva (ST/S ≤ −0.25) apoyan isquemia aguda.
                </li>
              </ul>
            </details>

            <details class="caja-edu">
              <summary>Referencia rápida: territorios y contiguidad</summary>
              Inferior: II, III, aVF. Lateral alta: I, aVL. Septal: V1–V2.
              Anterior: V3–V4. Lateral baja: V5–V6. Contiguas = mismas paredes o
              vecinas.
            </details>
          </section>

          <section class="tarjeta" id="sec_hipertrofia">
            <h3 class="titulo-tarjeta">❗ Hipertrofia y otros patrones</h3>
            <div
              class="mini-galeria"
              data-ids="lvh_sokolow,strain_lateral,brugada1,wpw"
            ></div>

            <div class="tabs">
              <button id="tab_sokolow" class="tab activa">Sokolow-Lyon</button>
              <button id="tab_cornell" class="tab">Cornell</button>
            </div>

            <div id="sokolow_box">
              <label>
                Criterio Sokolow-Lyon
                <span class="tooltip">
                  <span class="tip">?</span>
                  <span class="contenido-tip">
                    <strong>HVI</strong> S(V1) + R(V5/V6) ≥ 35 mm. Más sensible
                    en jóvenes; menor rendimiento en mayores/obesidad.
                  </span>
                </span>
              </label>
              <div class="fila" style="margin-top: 6px">
                <input
                  id="s_v1"
                  type="number"
                  min="0"
                  max="60"
                  step="0.5"
                  placeholder="mm S en V1"
                />
                <span style="font-weight: 800">+</span>
                <input
                  id="r_v5v6"
                  type="number"
                  min="0"
                  max="60"
                  step="0.5"
                  placeholder="mm R en V5/V6"
                />
              </div>
              <div id="sokolow_res" class="resultado oculto"></div>

              <details class="caja-edu">
                <summary>Referencia rápida: HVI — interpretación</summary>
                “Strain” lateral (I, aVL, V5–V6): ST descendido con T negativa
                <em>asimétrica</em> apoya HVI con sobrecarga. R en aVL ≥
                11&nbsp;mm sugiere HVI. Producto de Cornell: (R aVL + S V3) ×
                duración QRS ≥ 2440 mm·ms aumenta especificidad. Rendimiento
                menor en mayores/obesidad; QRS ancho o marcapasos alteran la
                valoración.
              </details>
            </div>

            <div id="cornell_box" class="oculto">
              <label>
                Criterio Cornell
                <span class="tooltip">
                  <span class="tip">?</span>
                  <span class="contenido-tip">
                    <strong>HVI</strong> R(aVL) + S(V3) &gt; 28 mm ♂ / &gt; 20
                    mm ♀. Mejor en adultos.
                  </span>
                </span>
              </label>
              <div class="fila" style="margin-top: 6px">
                <input
                  id="r_avl"
                  type="number"
                  min="0"
                  max="60"
                  step="0.5"
                  placeholder="mm R en aVL"
                />
                <span style="font-weight: 800">+</span>
                <input
                  id="s_v3"
                  type="number"
                  min="0"
                  max="60"
                  step="0.5"
                  placeholder="mm S en V3"
                />
              </div>
              <div id="cornell_res" class="resultado oculto"></div>

              <details class="caja-edu">
                <summary>Referencia rápida: matices de voltaje</summary>
                Voltaje menor en obesidad/edema EESS/hipotiroidismo. QRS ancho o
                marcapasos alteran la valoración. Si voltaje es negativo pero
                hay strain típico, sospecha HVI.
              </details>
            </div>

            <div class="divisor"></div>

            <div class="grupo">
              <label>Otros patrones sugestivos</label>
              <div class="radios">
                <div class="radio">
                  <input
                    id="patron_nada"
                    name="patron_otro"
                    type="radio"
                    value="ninguno"
                    checked
                  />
                  <label for="patron_nada" class="lbl-kb" tabindex="0"
                    >Ninguno</label
                  >
                </div>
                <div class="radio">
                  <input
                    id="patron_brugada"
                    name="patron_otro"
                    type="radio"
                    value="brugada"
                  />
                  <label for="patron_brugada" class="lbl-kb" tabindex="0"
                    >S. de Brugada</label
                  >
                </div>
                <div class="radio">
                  <input
                    id="patron_pericarditis"
                    name="patron_otro"
                    type="radio"
                    value="pericarditis"
                  />
                  <label for="patron_pericarditis" class="lbl-kb" tabindex="0"
                    >Pericarditis</label
                  >
                </div>
                <div class="radio">
                  <input
                    id="patron_wellens"
                    name="patron_otro"
                    type="radio"
                    value="wellens"
                  />
                  <label for="patron_wellens" class="lbl-kb" tabindex="0"
                    >S. de Wellens</label
                  >
                </div>
                <div class="radio">
                  <input
                    id="patron_hiperk"
                    name="patron_otro"
                    type="radio"
                    value="hiperk"
                  />
                  <label for="patron_hiperk" class="lbl-kb" tabindex="0"
                    >Hiperpotasemia</label
                  >
                </div>
                <div class="radio">
                  <input
                    id="patron_wpw"
                    name="patron_otro"
                    type="radio"
                    value="wpw"
                  />
                  <label for="patron_wpw" class="lbl-kb" tabindex="0"
                    >Preexcitación (WPW)</label
                  >
                </div>
              </div>
            </div>

            <div id="brugada_box" class="pistas oculto">
              <p>¿Qué tipo observa en V1–V2?</p>
              <div class="radios">
                <div class="radio">
                  <input
                    id="brug_tipo1"
                    name="brug_tipo"
                    type="radio"
                    value="1"
                  />
                  <label for="brug_tipo1" class="lbl-kb" tabindex="0"
                    >Tipo 1 (coved, ≥ 2 mm)</label
                  >
                </div>
                <div class="radio">
                  <input
                    id="brug_tipo2"
                    name="brug_tipo"
                    type="radio"
                    value="2"
                  />
                  <label for="brug_tipo2" class="lbl-kb" tabindex="0"
                    >Tipo 2 (saddle-back)</label
                  >
                </div>
              </div>
              <details class="caja-edu">
                <summary>Referencia rápida: patrón de Brugada</summary>
                <strong>Tipo 1 (diagnóstico):</strong> ST ≥ 2 mm “coved” y T
                negativa en V1–V2.<br />
                <strong>Tipo 2 (sugestivo):</strong> “silla de montar”; puede
                requerir prueba farmacológica. Recolocar V1–V2 en 2.º–3.º EIC si
                sospecha alta. Fiebre/fármacos clase I pueden desenmascararlo.
                Diferenciar de BRD.
              </details>
            </div>

            <div id="pericarditis_box" class="pistas oculto">
              <p>¿Elevación ST cóncava y difusa con infradesnivel de PR?</p>
              <details class="caja-edu">
                <summary>Referencia rápida: pericarditis</summary>
                Etapas: I) ST difuso cóncavo + PR descendido; II) normalización
                ST, T planas; III) T negativas difusas; IV) normalización. Signo
                de Spodick: descenso del TP en II/aVF.
              </details>
            </div>

            <div id="wellens_box" class="pistas oculto">
              <p>
                ¿T bifásicas o invertidas (&gt; 2 mm) en V2–V3 tras dolor
                reciente?
              </p>
              <details class="caja-edu">
                <summary>Referencia rápida: Wellens</summary>
                Tipo A: T bifásicas (↓ luego ↑) en V2–V3. Tipo B: T negativas
                profundas simétricas en V2–V3. R conservada, sin elevación ST.
                Sugiere lesión crítica ADA proximal.
              </details>
            </div>

            <div id="hiperk_box" class="pistas oculto">
              <p>¿Ondas T altas, picudas, base estrecha?</p>
              <details class="caja-edu">
                <summary>Referencia rápida: hiperpotasemia</summary>
                Progresión: T picudas → PR prolongado/QRS ancho → fusión sinusal
                (“sine wave”). Revisa fármacos (IECA/ARA-II/espironolactona) y
                función renal.
              </details>
            </div>

            <div id="wpw_box" class="pistas oculto">
              <p>
                ¿PR &lt; 120 ms + QRS ancho con ascenso inicial (onda delta)?
              </p>
              <details class="caja-edu">
                <summary>Referencia rápida: preexcitación</summary>
                PR corto, delta, QRS ancho. Puede simular IAM/HVI. En FA
                preexcitada: QRS irregulares anchos muy rápidos. Tipos A/B según
                polaridad en precordiales.
              </details>
            </div>
          </section>
        </div>
      </div>

      <section id="hallazgos_vivos" class="tarjeta oculto">
        <h3 class="titulo-tarjeta">💡 Hallazgos en tiempo real</h3>
        <ul id="lista_hallazgos"></ul>
      </section>

      <section class="acciones" id="sec_acciones">
        <button id="btn_informe" class="btn btn-prim">
          📊 Informe ampliado
        </button>
        <button id="btn_copiar_hce" class="btn btn-ok">
          📋 Copiar informe para la HCE
        </button>
        <button id="btn_limpiar" class="btn btn-sec">🔄 Limpiar todo</button>
      </section>
      <section class="disclaimer">
        <strong>⚠️ Herramienta educativa — no diagnóstica</strong><br />
        Para formación y estructurar el informe; no sustituye el juicio clínico.
        El análisis final debe ser revisado por un profesional sanitario.
      </section>
    </div>

    <div
      id="modal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-label="Informe ampliado"
    >
      <div class="contenido-modal">
        <div class="encabezado-modal">
          <h2>Informe de interpretación ECG — ampliado</h2>
          <p>
            Detalle educativo basado en los parámetros introducidos (el botón
            HCE genera el resumen para historia clínica).
          </p>
        </div>

        <div id="crit_box" class="alerta-crit oculto">
          <h4>⚠️ Hallazgos críticos</h4>
          <ul id="crit_lista"></ul>
        </div>

        <section>
          <h3>📊 Parámetros</h3>
          <div id="grid_param" class="grid-param"></div>
        </section>

        <section style="margin-top: 12px">
          <h3>🔍 Hallazgos</h3>
          <ul id="lista_resumen" class="lista"></ul>
        </section>

        <section style="margin-top: 12px">
          <h3>📝 Resumen narrativo</h3>
          <div
            id="narrativo"
            style="
              background: var(--g50);
              padding: 14px;
              border-radius: 8px;
              font-size: 14px;
            "
          ></div>
        </section>

        <div class="acciones" style="margin-top: 14px">
          <button id="btn_copiar_largo" class="btn btn-ok">
            📋 Copiar informe ampliado
          </button>
          <button id="btn_imprimir" class="btn btn-prim">
            🖨️ Imprimir PDF
          </button>
          <button id="btn_cerrar" class="btn btn-sec">✖️ Cerrar</button>
        </div>
      </div>
    </div>

    <div id="noti_copia" class="noti-copia" role="status" aria-live="polite">
      ✓ Copiado al portapapeles
    </div>

    <script>
      "use strict";

      const pr_min = 120,
        pr_max = 200;
      const qrs_max = 120;
      const qrs_lim_inf = 110;
      const fc_min = 60,
        fc_max = 100;
      const sokolow_umbral = 35;
      const cornell_m = 28,
        cornell_f = 20;
      const qtc_norm_m = 450,
        qtc_norm_f = 460;
      const angulos_deriv = {
        I: 0,
        II: 60,
        III: 120,
        aVR: -150,
        aVL: -30,
        aVF: 90,
      };

      let ecg = {
        fc: null,
        pr_ms: null,
        qrs_ms: null,
        qt_ms: null,
        qtc_ms: null,
        eje: null,
        eje_grados: null,
        hemibloqueo: null,
        hallazgos: [],
        criticos: [],
        diag_ritmo: null,
        diag_bav: null,
        bbb: null,
        lvh_sokolow: null,
        lvh_cornell: null,
        patron_otro: null,
      };

      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));
      function valor_radio(nombre) {
        const el = document.querySelector(`input[name="${nombre}"]:checked`);
        return el ? el.value : null;
      }
      function valores_check(name) {
        return Array.from(
          document.querySelectorAll(`input[name="${name}"]:checked`)
        ).map((x) => x.value);
      }
      function mostrar(id, si) {
        const el = typeof id === "string" ? document.getElementById(id) : id;
        if (!el) return;
        el.classList.toggle("oculto", !si);
      }

      document.addEventListener("DOMContentLoaded", () => {
        poblar_checkboxes();
        enganchar_eventos();
        cargar_estado();
        actualizar_todo();
        if (!localStorage.getItem("ecgTourVisto")) {
          setTimeout(() => {
            iniciar_tour();
            localStorage.setItem("ecgTourVisto", "true");
          }, 600);
        }
        ECGSVG.renderAll();
      });

      function poblar_checkboxes() {
        const deriv = [
          "I",
          "II",
          "III",
          "aVR",
          "aVL",
          "aVF",
          "V1",
          "V2",
          "V3",
          "V4",
          "V5",
          "V6",
        ];
        const deriv_q = [
          "I",
          "II",
          "III",
          "aVL",
          "aVF",
          "V1",
          "V2",
          "V3",
          "V4",
          "V5",
          "V6",
        ];
        const cont = (id, lista, nombre) => {
          const el = document.getElementById(id);
          el.innerHTML = lista
            .map(
              (d) =>
                `<div class="check"><input id="${nombre}_${d}" type="checkbox" name="${nombre}" value="${d}" /><label for="${nombre}_${d}" class="lbl-kb" tabindex="0">${d}</label></div>`
            )
            .join("");
        };
        cont("st_elev_grid", deriv, "st_elev");
        cont("st_dep_grid", deriv, "st_dep");
        cont("q_grid", deriv_q, "qpat");
      }

      function enganchar_eventos() {
        $$("input, select").forEach((el) =>
          el.addEventListener("input", () => {
            actualizar_todo();
            guardar_estado();
          })
        );

        $$(".lbl-kb").forEach((lbl) => {
          lbl.addEventListener("keydown", (e) => {
            if (e.key === " " || e.key === "Enter") {
              e.preventDefault();
              const forId = lbl.getAttribute("for");
              const input = forId
                ? document.getElementById(forId)
                : lbl.querySelector("input");
              if (!input) return;
              if (input.type === "radio") {
                input.checked = true;
                input.dispatchEvent(new Event("input", { bubbles: true }));
              }
              if (input.type === "checkbox") {
                input.checked = !input.checked;
                input.dispatchEvent(new Event("input", { bubbles: true }));
              }
            }
          });
        });

        $("#tab_sokolow")?.addEventListener("click", () => {
          $("#tab_sokolow").classList.add("activa");
          $("#tab_cornell").classList.remove("activa");
          mostrar("sokolow_box", true);
          mostrar("cornell_box", false);
        });
        $("#tab_cornell")?.addEventListener("click", () => {
          $("#tab_cornell").classList.add("activa");
          $("#tab_sokolow").classList.remove("activa");
          mostrar("sokolow_box", false);
          mostrar("cornell_box", true);
        });

        $("#btn_informe").addEventListener("click", generar_informe);
        $("#btn_limpiar").addEventListener("click", limpiar_todo);
        $("#btn_cerrar").addEventListener("click", () =>
          $("#modal").classList.remove("activa")
        );
        $("#btn_imprimir").addEventListener("click", () => window.print());
        $("#btn_copiar_largo").addEventListener("click", () => copiar("largo"));
        $("#btn_copiar_hce").addEventListener("click", copiar_hce);

        $("#chips_resumen").addEventListener("click", (e) => {
          const item = e.target.closest(".chip");
          if (!item) return;
          const destino = item.dataset.goto;
          if (destino) {
            document
              .getElementById(destino)
              ?.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });

        $("#btn_tour").addEventListener("click", iniciar_tour);
      }

      function actualizar_todo() {
        actualizar_fuente_fc_ui();
        calcular_fc();
        calcular_intervalos();
        calcular_qtc();
        calcular_eje_cuadrantes();
        calcular_eje_grados();
        calcular_lvh();

        actualizar_ayudas_ritmo();
        actualizar_ayuda_bav();
        actualizar_conduccion();
        actualizar_hemibloqueo();
        actualizar_patrones();

        actualizar_hallazgos_vivos();
        pintar_chips();
      }

      function actualizar_fuente_fc_ui() {
        const fuente = $("#fuente_fc").value;
        mostrar("bloque_fc_manual", fuente === "manual");
        mostrar("bloque_fc_rr", fuente === "rr_regular");
        mostrar("bloque_fc_6s", fuente === "qrs_6s");
        const vel = parseInt($("#velocidad_papel").value, 10);
        $("#etq_qrs_6s").textContent = `QRS en 6 s (${
          vel === 25 ? 30 : 60
        } cuad. grandes)`;
      }

      function calcular_fc() {
        const vel = parseInt($("#velocidad_papel").value, 10);
        const fuente = $("#fuente_fc").value;
        const fc_div = $("#fc_resultado");
        let fc = null,
          texto_met = "";

        if (fuente === "manual") {
          const v = parseFloat($("#fc_manual").value);
          if (!isNaN(v) && v > 0) {
            fc = v;
            texto_met = " (entrada directa)";
          }
        } else if (fuente === "rr_regular") {
          const rr_pq = parseFloat($("#rr_pequenos").value);
          const rr_gr = parseFloat($("#rr_grandes").value);
          if (!isNaN(rr_pq) && rr_pq > 0) {
            fc = (vel === 25 ? 1500 : 3000) / rr_pq;
            texto_met = " (cuadritos)";
          } else if (!isNaN(rr_gr) && rr_gr > 0) {
            fc = (vel === 25 ? 300 : 600) / rr_gr;
            texto_met = " (cuadros grandes)";
          }
        } else if (fuente === "qrs_6s") {
          const n = parseFloat($("#qrs_6s").value);
          if (!isNaN(n) && n > 0) {
            fc = n * 10;
            texto_met = " (conteo 6 s)";
          }
        }

        ecg.fc = fc ? Math.round(fc) : null;

        if (ecg.fc) {
          fc_div.textContent = `Frecuencia cardíaca: ${ecg.fc} lpm${texto_met}`;
          fc_div.className = "valor-calc";
          if (ecg.fc < fc_min || ecg.fc > fc_max)
            fc_div.classList.add("valor-warn");
          mostrar(fc_div, true);
        } else {
          mostrar(fc_div, false);
        }
      }

      function ms_por_cuad() {
        return parseInt($("#velocidad_papel").value, 10) === 25 ? 40 : 20;
      }

      function calcular_intervalos() {
        const msq = ms_por_cuad();
        const entradas = [
          {
            id: "pr_cuad",
            destino: "pr_ms",
            span: "pr_res",
            nombre: "PR",
            min: pr_min,
            max: pr_max,
          },
          {
            id: "qrs_cuad",
            destino: "qrs_ms",
            span: "qrs_res",
            nombre: "QRS",
            min: null,
            max: qrs_max,
          },
          {
            id: "qt_cuad",
            destino: "qt_ms",
            span: "qt_res",
            nombre: "QT",
            min: null,
            max: null,
          },
        ];

        entradas.forEach((e) => {
          const cuad = parseFloat(document.getElementById(e.id).value);
          const span = document.getElementById(e.span);
          if (!isNaN(cuad) && document.getElementById(e.id).value !== "") {
            const ms = Math.round(cuad * msq);
            ecg[e.destino] = ms;

            let extra = "";
            if (e.nombre === "PR" && ms > pr_max) extra = " (BAV 1°)";
            if (e.nombre === "QRS") {
              if (ms >= qrs_max) extra = " (ancho)";
              else if (ms >= qrs_lim_inf && ms < qrs_max)
                extra = " (limítrofe)";
            }

            span.textContent = `${ms} ms${extra}`;
            span.className = "valor-calc";
            if (e.max && ms > e.max) span.classList.add("valor-warn");
            if (e.min && ms < e.min) span.classList.add("valor-warn");
            mostrar(span, true);
          } else {
            ecg[e.destino] = null;
            mostrar(span, false);
          }
        });
      }

      function calcular_qtc() {
        const cont = $("#qtc_res");
        cont.innerHTML = "";
        if (!ecg.qt_ms || !ecg.fc) {
          ecg.qtc_ms = null;
          return;
        }

        const rr_seg = 60 / ecg.fc;
        const formula = $("#formula_qtc").value;
        let qtc = null,
          detalle = "";

        if (formula === "bazett") {
          qtc = Math.round(ecg.qt_ms / Math.sqrt(rr_seg));
          detalle = `QTc = QT / √RR → ${ecg.qt_ms} / ${
            Math.round(Math.sqrt(rr_seg) * 1000) / 1000
          }`;
        } else if (formula === "fridericia") {
          qtc = Math.round(ecg.qt_ms / Math.cbrt(rr_seg));
          detalle = `QTc = QT / RR^(1/3)`;
        } else if (formula === "hodges") {
          qtc = Math.round(ecg.qt_ms + 1.75 * (ecg.fc - 60));
          detalle = `QTc = QT + 1.75×(FC−60)`;
        }

        ecg.qtc_ms = qtc;
        const qtc_lim =
          $("#sexo_paciente").value === "F" ? qtc_norm_f : qtc_norm_m;
        const color =
          qtc > qtc_lim ? "color:var(--peligro)" : "color:var(--g700)";
        cont.innerHTML = `<span style="font-weight:800;${color}">QTc (${formula}): ${qtc} ms</span><br><span style="font-size:12px">RR=${
          Math.round(rr_seg * 1000) / 1000
        } s • ${detalle}</span>`;
      }

      function calcular_eje_cuadrantes() {
        const di = valor_radio("qrs_di");
        const avf = valor_radio("qrs_avf");
        const res = $("#eje_res");

        if (di && avf) {
          let texto = "",
            clase = "valor-calc";
          if (di === "+" && avf === "+") {
            texto = "Normal (0° a +90°)";
            clase += " valor-ok";
          } else if (di === "+" && avf === "-") {
            texto = "Desviación izquierda (0° a −90°)";
            clase += " valor-warn";
          } else if (di === "-" && avf === "+") {
            texto = "Desviación derecha (+90° a +180°)";
            clase += " valor-warn";
          } else {
            texto = "Desviación extrema (−90° a −180°)";
            clase += " valor-danger";
          }
          res.textContent = texto;
          res.className = clase;
          mostrar(res, true);
          ecg.eje = texto;
        } else {
          mostrar(res, false);
          ecg.eje = null;
        }
      }

      function normaliza_grados(g) {
        while (g > 180) g -= 360;
        while (g <= -180) g += 360;
        return g;
      }
      function clasifica_eje_grados(g) {
        if (g >= -30 && g <= 90) return { txt: "normal", clase: "ok" };
        if (g > 90) return { txt: "desviación derecha", clase: "warn" };
        if (g < -90) return { txt: "desviación extrema", clase: "crit" };
        return { txt: "desviación izquierda", clase: "warn" };
      }

      function calcular_eje_grados() {
        const di = parseFloat($("#di_neto_mm").value);
        const avf = parseFloat($("#avf_neto_mm").value);
        const res = $("#eje_grados_res");
        const cons = $("#eje_consistencia");

        if (!isNaN(di) && !isNaN(avf) && !(di === 0 && avf === 0)) {
          const ang = Math.atan2(avf, di) * (180 / Math.PI);
          const g = Math.round(normaliza_grados(ang));
          ecg.eje_grados = g;

          const clas = clasifica_eje_grados(g);
          res.textContent = `Eje: ${g}° (${clas.txt})`;
          res.className = `valor-calc ${
            clas.clase === "ok"
              ? "valor-ok"
              : clas.clase === "warn"
              ? "valor-warn"
              : "valor-danger"
          }`;
          mostrar(res, true);

          if (ecg.eje) {
            const coh =
              (ecg.eje.includes("Normal") && clas.txt === "normal") ||
              (ecg.eje.includes("derecha") &&
                clas.txt === "desviación derecha") ||
              (ecg.eje.includes("izquierda") &&
                clas.txt === "desviación izquierda") ||
              (ecg.eje.includes("extrema") &&
                clas.txt === "desviación extrema");
            cons.textContent = coh
              ? "✔ Consistente con el método rápido"
              : "⚠ No coincide con el método rápido (revisa medición/derivación).";
            cons.style.color = coh ? "var(--exito)" : "var(--peligro)";
          } else {
            cons.textContent = "";
          }
        } else {
          ecg.eje_grados = null;
          mostrar(res, false);
          cons.textContent = "";
        }

        const iso = $("#iso_deriv").value;
        const signo = valor_radio("iso_signo");
        const res_iso = $("#eje_iso_res");
        if (iso && signo) {
          const base = angulos_deriv[iso];
          const g2 = normaliza_grados(base + (signo === "pos" ? 90 : -90));
          const clas2 = clasifica_eje_grados(g2);
          res_iso.textContent = `Eje aprox. (isodifásico): ${Math.round(
            g2
          )}° (${clas2.txt})`;
          res_iso.className = `valor-calc ${
            clas2.clase === "ok"
              ? "valor-ok"
              : clas2.clase === "warn"
              ? "valor-warn"
              : "valor-danger"
          }`;
          mostrar(res_iso, true);
        } else {
          mostrar(res_iso, false);
        }
      }

      function actualizar_hemibloqueo() {
        const izq = ecg.eje && ecg.eje.toLowerCase().includes("izquierda");
        mostrar("hemi_box", !!izq);
        const res = $("#hemi_res");
        if (!izq) {
          ecg.hemibloqueo = null;
          mostrar(res, false);
          return;
        }
        const qr = $("#qr_avl").checked;
        const rs = $("#rs_inferior").checked;
        if (qr && rs) {
          res.textContent = "Hemibloqueo anterior izquierdo (HBAI)";
          res.className = "resultado";
          mostrar(res, true);
          ecg.hemibloqueo = "HBAI";
        } else {
          ecg.hemibloqueo = null;
          mostrar(res, false);
        }
      }

      function actualizar_conduccion() {
        const q = ecg.qrs_ms || 0;
        const mostrar_helper = q >= qrs_max;
        mostrar("bloque_conduccion_placeholder", !mostrar_helper);
        mostrar("bloque_conduccion", mostrar_helper);

        const res = $("#bbb_res");
        if (!mostrar_helper) {
          ecg.bbb = null;
          mostrar(res, false);
          return;
        }

        const v1 = valor_radio("v1_morf");
        const v6 = valor_radio("v6_morf");
        if (v1 === "rsr" && v6 === "s_emp") {
          res.textContent = "Bloqueo de rama derecha (BRDHH)";
          res.className = "resultado";
          ecg.bbb = "BRD";
          mostrar(res, true);
        } else if (v1 === "s_ancha" && v6 === "r_ancha") {
          res.textContent = "Bloqueo de rama izquierda (BRIHH)";
          res.className = "resultado";
          ecg.bbb = "BRI";
          mostrar(res, true);
        } else {
          ecg.bbb = null;
          mostrar(res, false);
        }
      }

      function calcular_lvh() {
        const sv1 = parseFloat($("#s_v1").value) || 0;
        const rv5v6 = parseFloat($("#r_v5v6").value) || 0;
        const suma_sok = sv1 + rv5v6;
        const sok_res = $("#sokolow_res");
        if (suma_sok > 0) {
          const pos = suma_sok >= sokolow_umbral;
          sok_res.textContent = `Suma = ${suma_sok} mm — criterio ${
            pos ? "positivo" : "negativo"
          }`;
          sok_res.className = "resultado";
          if (pos) sok_res.classList.add("warn");
          mostrar(sok_res, true);
          ecg.lvh_sokolow = { suma: suma_sok, positivo: pos };
        } else {
          mostrar(sok_res, false);
          ecg.lvh_sokolow = null;
        }

        const ravl = parseFloat($("#r_avl").value) || 0;
        const sv3 = parseFloat($("#s_v3").value) || 0;
        const suma_cor = ravl + sv3;
        const cor_res = $("#cornell_res");
        if (suma_cor > 0) {
          const umbral =
            $("#sexo_paciente").value === "F" ? cornell_f : cornell_m;
          const pos = suma_cor > umbral;
          cor_res.textContent = `Suma = ${suma_cor} mm — criterio ${
            pos ? "positivo" : "negativo"
          }`;
          cor_res.className = "resultado";
          if (pos) cor_res.classList.add("warn");
          mostrar(cor_res, true);
          ecg.lvh_cornell = { suma: suma_cor, positivo: pos };
        } else {
          mostrar(cor_res, false);
          ecg.lvh_cornell = null;
        }
      }

      function actualizar_ayudas_ritmo() {
        const tipo = valor_radio("tipo_ritmo");
        mostrar("afib_box", tipo === "irregular");
        mostrar(
          "ayuda_ectopias",
          tipo === "bigeminismo" || tipo === "trigeminismo"
        );

        const res = $("#afib_res");
        const pw = valor_radio("p_def");
        let diag = null;
        if (tipo === "irregular" && pw === "no") {
          diag = "Fibrilación auricular (probable)";
          res.textContent = diag;
          res.className = "resultado";
          res.classList.add("warn");
          mostrar(res, true);
        } else {
          mostrar(res, false);
        }
        ecg.diag_ritmo = diag;

        if (tipo === "bigeminismo" || tipo === "trigeminismo") {
          const ecto = valor_radio("tipo_ecto");
          if (ecto === "ev") ecg.diag_ritmo = `${tipo} con EV`;
          else if (ecto === "esa") ecg.diag_ritmo = `${tipo} con ESA`;
        }
      }

      function actualizar_ayuda_bav() {
        const pr = ecg.pr_ms;
        const fuera = pr !== null && (pr < pr_min || pr > pr_max);
        mostrar("bav_box", !!fuera);
        if (!fuera) {
          ecg.diag_bav = null;
          mostrar("bav_res", false);
          return;
        }

        const comp = valor_radio("pr_comp");
        mostrar("bav_paso2", comp === "var");
        mostrar("bav_paso3", comp === "var" && valor_radio("wenck") === "no");

        const wenck = valor_radio("wenck");
        const dis = valor_radio("disocia");
        const res = $("#bav_res");
        let diag = null,
          clase = "resultado";

        if (pr > pr_max) {
          if (comp === "const") {
            diag = "Bloqueo AV de 1er grado";
            clase += " warn";
          } else if (comp === "var" && wenck === "si") {
            diag = "BAV 2º grado Mobitz I (Wenckebach)";
            clase += " warn";
          }
        }
        if (comp === "var" && wenck === "no") {
          if (dis === "si") {
            diag = "BAV 3er grado (completo)";
            clase += " crit";
          } else if (dis === "no") {
            diag = "BAV 2º grado Mobitz II";
            clase += " crit";
          }
        }

        ecg.diag_bav = diag;
        if (diag) {
          res.textContent = diag;
          res.className = clase;
          mostrar(res, true);
        } else {
          mostrar(res, false);
        }
      }

      function actualizar_patrones() {
        const p = valor_radio("patron_otro");
        ecg.patron_otro = p && p !== "ninguno" ? p : null;
        mostrar("brugada_box", p === "brugada");
        mostrar("pericarditis_box", p === "pericarditis");
        mostrar("wellens_box", p === "wellens");
        mostrar("hiperk_box", p === "hiperk");
        mostrar("wpw_box", p === "wpw");
      }

      function territorio(leads) {
        const mapa = {
          Inferior: ["II", "III", "aVF"],
          "Lateral alta": ["I", "aVL"],
          Septal: ["V1", "V2"],
          Anterior: ["V3", "V4"],
          "Lateral baja": ["V5", "V6"],
        };
        const t = [];
        Object.entries(mapa).forEach(([nombre, lista]) => {
          if (lista.some((l) => leads.includes(l))) t.push(nombre);
        });
        return t.join(" y ") || "indeterminada";
      }

      function actualizar_hallazgos_vivos() {
        const lista = $("#lista_hallazgos");
        const carta = $("#hallazgos_vivos");
        const items = [];

        if (ecg.fc && ecg.fc < fc_min)
          items.push({ t: `Bradicardia (${ecg.fc} lpm)`, s: "warn" });
        if (ecg.fc && ecg.fc > fc_max)
          items.push({ t: `Taquicardia (${ecg.fc} lpm)`, s: "warn" });
        if (ecg.eje && !ecg.eje.includes("Normal"))
          items.push({ t: ecg.eje, s: "warn" });
        if (ecg.diag_ritmo) items.push({ t: ecg.diag_ritmo, s: "warn" });
        if (ecg.diag_bav) {
          const sev = /3er|Mobitz II/.test(ecg.diag_bav) ? "crit" : "warn";
          items.push({ t: ecg.diag_bav, s: sev });
        }
        if (ecg.bbb)
          items.push({
            t: `${
              ecg.bbb === "BRD"
                ? "Bloqueo de rama derecha"
                : "Bloqueo de rama izquierda"
            }`,
            s: "warn",
          });
        if (ecg.hemibloqueo) items.push({ t: ecg.hemibloqueo, s: "warn" });

        const elev = valores_check("st_elev");
        const dep = valores_check("st_dep");
        const qpat = valores_check("qpat");
        if (elev.length)
          items.push({
            t: `Elevación ST en cara ${territorio(elev)}`,
            s: "crit",
          });
        if (dep.length)
          items.push({
            t: `Depresión ST en cara ${territorio(dep)}`,
            s: "warn",
          });
        if (qpat.length)
          items.push({ t: `Ondas Q en cara ${territorio(qpat)}`, s: "warn" });

        const brug = valor_radio("brug_tipo");
        if (brug === "1") items.push({ t: "Patrón Brugada tipo 1", s: "crit" });

        if (items.length) {
          lista.innerHTML = items
            .map(
              (x) =>
                `<li class="${x.s === "crit" ? "crit" : "warn"}">${x.t}</li>`
            )
            .join("");
          mostrar(carta, true);
        } else {
          mostrar(carta, false);
          lista.innerHTML = "";
        }
      }

      function generar_informe() {
        analizar_hallazgos();

        const grid = $("#grid_param");
        grid.innerHTML = "";
        const param = {
          FC: ecg.fc ? `${ecg.fc} lpm` : "-",
          PR: ecg.pr_ms ? `${ecg.pr_ms} ms` : "-",
          QRS: ecg.qrs_ms ? `${ecg.qrs_ms} ms` : "-",
          QT: ecg.qt_ms ? `${ecg.qt_ms} ms` : "-",
          QTc: ecg.qtc_ms
            ? `${ecg.qtc_ms} ms (${$("#formula_qtc").value})`
            : "-",
          "Eje (cuadrantes)": ecg.eje || "-",
          "Eje (grados)":
            ecg.eje_grados !== null && ecg.eje_grados !== undefined
              ? `${ecg.eje_grados}°`
              : "-",
        };
        Object.entries(param).forEach(([k, v]) => {
          grid.innerHTML += `<div class="param"><div class="etq">${k}</div><div class="val">${v}</div></div>`;
        });

        const lista = $("#lista_resumen");
        lista.innerHTML = ecg.hallazgos.length
          ? ecg.hallazgos
              .map(
                (f) =>
                  `<li class="item ${f.sev === "crit" ? "crit" : "warn"}">${
                    f.txt
                  }</li>`
              )
              .join("")
          : `<li class="item">✓ Sin hallazgos patológicos en los parámetros analizados</li>`;

        const cl = $("#crit_lista");
        if (ecg.criticos.length) {
          cl.innerHTML = ecg.criticos.map((x) => `<li>${x}</li>`).join("");
          mostrar("crit_box", true);
        } else {
          mostrar("crit_box", false);
          cl.innerHTML = "";
        }

        $("#narrativo").textContent = narrativo();
        $("#modal").classList.add("activa");
      }

      function analizar_hallazgos() {
        ecg.hallazgos = [];
        ecg.criticos = [];

        if (ecg.fc && ecg.fc < fc_min)
          ecg.hallazgos.push({
            txt: `Bradicardia (${ecg.fc} lpm)`,
            sev: "warn",
          });
        if (ecg.fc && ecg.fc > fc_max)
          ecg.hallazgos.push({
            txt: `Taquicardia (${ecg.fc} lpm)`,
            sev: "warn",
          });

        if (ecg.diag_ritmo)
          ecg.hallazgos.push({ txt: ecg.diag_ritmo, sev: "warn" });

        if (ecg.pr_ms && ecg.pr_ms > pr_max && !ecg.diag_bav)
          ecg.hallazgos.push({
            txt: `BAV de 1er grado (PR ${ecg.pr_ms} ms)`,
            sev: "warn",
          });
        if (ecg.diag_bav) {
          const s = /3er|Mobitz II/.test(ecg.diag_bav) ? "crit" : "warn";
          ecg.hallazgos.push({ txt: ecg.diag_bav, sev: s });
        }

        const qlim =
          $("#sexo_paciente").value === "F" ? qtc_norm_f : qtc_norm_m;
        if (ecg.qtc_ms && ecg.qtc_ms > qlim)
          ecg.criticos.push(
            `QTc prolongado (${ecg.qtc_ms} ms) — riesgo de Torsades de Pointes`
          );

        if (ecg.eje && !ecg.eje.includes("Normal"))
          ecg.hallazgos.push({ txt: ecg.eje, sev: "warn" });
        if (ecg.hemibloqueo)
          ecg.hallazgos.push({ txt: ecg.hemibloqueo, sev: "warn" });
        if (ecg.bbb)
          ecg.hallazgos.push({
            txt: `${
              ecg.bbb === "BRD"
                ? "Bloqueo de rama derecha"
                : "Bloqueo de rama izquierda"
            }`,
            sev: "warn",
          });

        const elev = valores_check("st_elev");
        if (elev.length)
          ecg.criticos.push(
            `Elevación ST en ${elev.join(", ")} (${territorio(
              elev
            )}): compatible con IAMCEST`
          );
        const dep = valores_check("st_dep");
        if (dep.length)
          ecg.hallazgos.push({
            txt: `Depresión ST en ${dep.join(", ")} (${territorio(
              dep
            )}): compatible con isquemia subendocárdica`,
            sev: "warn",
          });
        const qpat = valores_check("qpat");
        if (qpat.length)
          ecg.hallazgos.push({
            txt: `Ondas Q patológicas en ${qpat.join(", ")} (${territorio(
              qpat
            )}): sugieren infarto antiguo`,
            sev: "warn",
          });

        if (ecg.lvh_sokolow?.positivo)
          ecg.hallazgos.push({
            txt: `Criterios Sokolow-Lyon positivos para HVI (suma ${ecg.lvh_sokolow.suma} mm)`,
            sev: "warn",
          });
        if (ecg.lvh_cornell?.positivo)
          ecg.hallazgos.push({
            txt: `Criterios Cornell positivos para HVI (suma ${ecg.lvh_cornell.suma} mm)`,
            sev: "warn",
          });

        const brug = valor_radio("brug_tipo");
        if (ecg.patron_otro === "brugada" && brug === "1")
          ecg.criticos.push("Patrón Brugada tipo 1: alto riesgo arrítmico");
        if (ecg.patron_otro === "brugada" && brug === "2")
          ecg.hallazgos.push({
            txt: "Patrón Brugada tipo 2: sugestivo, requiere valoración",
            sev: "warn",
          });
        if (ecg.patron_otro === "pericarditis")
          ecg.hallazgos.push({
            txt: "Signos sugerentes de pericarditis aguda",
            sev: "warn",
          });
        if (ecg.patron_otro === "wellens")
          ecg.criticos.push(
            "Patrón de Wellens: posible oclusión crítica de ADA"
          );
        if (ecg.patron_otro === "hiperk")
          ecg.criticos.push(
            "Signos de hiperpotasemia: correlacionar con analítica"
          );
        if (ecg.patron_otro === "wpw")
          ecg.hallazgos.push({
            txt: "Patrón de preexcitación (WPW) probable",
            sev: "warn",
          });
      }

      function narrativo() {
        const tipo = valor_radio("tipo_ritmo");
        const txt_ritmo =
          tipo === "irregular" ? "irregular" : tipo ? tipo : "sinusal regular";
        const base = `ECG con ritmo ${txt_ritmo} a ${ecg.fc ?? "N/A"} lpm.`;
        const otros = [];

        const todos = [
          ...ecg.criticos.map((t) => t.split(":")[0]),
          ...ecg.hallazgos.map((h) => h.txt),
        ].filter((x) => x);

        const filtrados = todos.filter((t) => {
          const s = t.toLowerCase();
          return (
            !s.includes("desviación") &&
            !s.startsWith("bradi") &&
            !s.startsWith("taqui")
          );
        });

        if (filtrados.length) otros.push(`Hallazgos: ${filtrados.join(", ")}.`);

        const contexto = [];
        if (ecg.pr_ms && ecg.qrs_ms)
          contexto.push(`PR ${ecg.pr_ms} ms y QRS ${ecg.qrs_ms} ms.`);
        if (ecg.eje_grados !== null && ecg.eje_grados !== undefined)
          contexto.push(`Eje ${ecg.eje_grados}°.`);
        else if (
          ecg.eje &&
          (ecg.eje_grados === null || ecg.eje_grados === undefined)
        )
          contexto.push(`Eje ${ecg.eje.toLowerCase()}.`);
        if (contexto.length) otros.push(contexto.join(" "));

        if (!ecg.hallazgos.length && !ecg.criticos.length)
          return "Interpretación dentro de límites normales según los datos introducidos.";
        return [base, ...otros].join(" ");
      }

      function texto_hce() {
        const ritmo_sel = valor_radio("tipo_ritmo");
        let ritmo_txt = "Sinusal regular";
        if (ritmo_sel === "irregular") ritmo_txt = "Irregular";
        if (ritmo_sel === "bigeminismo") ritmo_txt = "Bigeminismo";
        if (ritmo_sel === "trigeminismo") ritmo_txt = "Trigeminismo";

        const eje_txt =
          ecg.eje_grados !== null && ecg.eje_grados !== undefined
            ? `${ecg.eje_grados}°`
            : ecg.eje
            ? ecg.eje.replace(/\(.*\)/, "").trim()
            : "-";

        const hall = [];
        if (ecg.diag_bav) hall.push(ecg.diag_bav.replace("Bloqueo ", "B."));
        if (ecg.bbb) hall.push(ecg.bbb === "BRD" ? "BRD" : "BRI");
        if (ecg.hemibloqueo) hall.push(ecg.hemibloqueo);
        const elev = valores_check("st_elev");
        const dep = valores_check("st_dep");
        const qpat = valores_check("qpat");
        if (elev.length) hall.push(`ST↑ ${territorio(elev)}`);
        if (dep.length) hall.push(`ST↓ ${territorio(dep)}`);
        if (qpat.length) hall.push(`Q ${territorio(qpat)}`);
        if (ecg.lvh_sokolow?.positivo || ecg.lvh_cornell?.positivo)
          hall.push("HVI");
        if (ecg.patron_otro === "brugada" && valor_radio("brug_tipo") === "1")
          hall.push("Brugada 1");
        if (ecg.patron_otro === "wellens") hall.push("Wellens");
        if (ecg.patron_otro === "pericarditis") hall.push("Pericarditis");
        if (ecg.patron_otro === "hiperk") hall.push("HiperK");
        if (ecg.patron_otro === "wpw") hall.push("WPW");

        const hall_str = hall.length
          ? hall.join("; ")
          : "Sin hallazgos relevantes";

        const lineas = [
          "ECG",
          "--------------------------------------",
          `Ritmo: ${ritmo_txt}`,
          `FC: ${ecg.fc ?? "-"} lpm`,
          `PR: ${ecg.pr_ms ?? "-"} ms`,
          `QRS: ${ecg.qrs_ms ?? "-"} ms`,
          `QTc: ${ecg.qtc_ms ?? "-"} ms`,
          `Eje: ${eje_txt}`,
          `Hallazgos: ${hall_str}`,
        ];
        return lineas.join("\n");
      }

      function copiar(tipo) {
        let texto = "";
        if (tipo === "largo") {
          texto += "INFORME ECG (educativo, ampliado)\n\n";
          if (ecg.criticos.length)
            texto +=
              "HALLAZGOS CRÍTICOS:\n" +
              ecg.criticos.map((x) => "• " + x).join("\n") +
              "\n\n";
          if (ecg.hallazgos.length)
            texto +=
              "HALLAZGOS GENERALES:\n" +
              ecg.hallazgos.map((x) => "• " + x.txt).join("\n") +
              "\n\n";
          texto += "RESUMEN NARRATIVO:\n" + narrativo();
        }
        navigator.clipboard.writeText(texto).then(() => {
          toast("✓ Copiado al portapapeles");
        });
      }

      function copiar_hce() {
        const texto = texto_hce();
        navigator.clipboard.writeText(texto).then(() => {
          toast("✓ Formato HCE copiado");
        });
      }

      function toast(msg) {
        const n = $("#noti_copia");
        n.textContent = msg;
        n.classList.add("mostrar");
        setTimeout(() => n.classList.remove("mostrar"), 1600);
      }

      function guardar_estado() {
        const s = {};
        $$("input, select").forEach((el) => {
          if (!el.id) return;
          if (el.type === "checkbox" || el.type === "radio")
            s[el.id] = el.checked;
          else s[el.id] = el.value;
        });
        localStorage.setItem("ecg_interpreter_v27", JSON.stringify(s));
      }

      function cargar_estado() {
        const raw = localStorage.getItem("ecg_interpreter_v27");
        if (!raw) return;
        try {
          const s = JSON.parse(raw);
          Object.entries(s).forEach(([id, val]) => {
            const el = document.getElementById(id);
            if (!el) return;
            if (el.type === "checkbox" || el.type === "radio")
              el.checked = !!val;
            else el.value = val;
          });
        } catch (e) {
          localStorage.removeItem("ecg_interpreter_v27");
        }
      }

      function limpiar_todo() {
        if (!confirm("¿Seguro que desea borrar todos los datos?")) return;
        $$('input[type="number"], input[type="text"], select').forEach((el) => {
          if (el.tagName === "SELECT") el.selectedIndex = 0;
          else el.value = "";
        });
        $$('input[type="radio"], input[type="checkbox"]').forEach(
          (el) => (el.checked = false)
        );
        $("#ritmo_regular").checked = true;
        $("#patron_nada").checked = true;
        ecg = {
          fc: null,
          pr_ms: null,
          qrs_ms: null,
          qt_ms: null,
          qtc_ms: null,
          eje: null,
          eje_grados: null,
          hemibloqueo: null,
          hallazgos: [],
          criticos: [],
          diag_ritmo: null,
          diag_bav: null,
          bbb: null,
          lvh_sokolow: null,
          lvh_cornell: null,
          patron_otro: null,
        };
        localStorage.removeItem("ecg_interpreter_v27");
        actualizar_todo();
      }

      function pintar_chips() {
        const cont = $("#chips_resumen");
        const chips = [];

        const tipo = valor_radio("tipo_ritmo");
        const ritmo_txt =
          tipo === "irregular"
            ? "Ritmo: irregular"
            : tipo === "bigeminismo"
            ? "Ritmo: bigeminismo"
            : tipo === "trigeminismo"
            ? "Ritmo: trigeminismo"
            : "Ritmo: regular";
        chips.push({
          txt: ritmo_txt,
          clase: tipo === "regular" ? "ok" : "warn",
          goto: "sec_ritmo",
        });

        const qrs = ecg.qrs_ms;
        let qrs_txt = "QRS: —",
          qrs_cls = "warn";
        if (qrs !== null) {
          qrs_txt = `QRS: ${qrs} ms`;
          if (qrs >= qrs_max) qrs_cls = "warn";
          else if (qrs >= qrs_lim_inf) qrs_cls = "warn";
          else qrs_cls = "ok";
        }
        chips.push({ txt: qrs_txt, clase: qrs_cls, goto: "sec_intervalos" });

        let eje_txt = "Eje: —",
          eje_cls = "warn";
        if (ecg.eje_grados !== null && ecg.eje_grados !== undefined) {
          const c = clasifica_eje_grados(ecg.eje_grados);
          eje_txt = `Eje: ${ecg.eje_grados}°`;
          eje_cls = c.clase;
        } else if (ecg.eje) {
          eje_txt = `Eje: ${ecg.eje.split("(")[0].trim()}`;
          eje_cls = ecg.eje.includes("Normal") ? "ok" : "warn";
        }
        chips.push({ txt: eje_txt, clase: eje_cls, goto: "sec_eje" });

        let qtc_txt = "QTc: —",
          qtc_cls = "warn";
        if (ecg.qtc_ms) {
          const lim =
            $("#sexo_paciente").value === "F" ? qtc_norm_f : qtc_norm_m;
          qtc_txt = `QTc: ${ecg.qtc_ms} ms`;
          qtc_cls = ecg.qtc_ms > lim ? "crit" : "ok";
        }
        chips.push({ txt: qtc_txt, clase: qtc_cls, goto: "sec_intervalos" });

        cont.innerHTML = chips
          .map(
            (ch) =>
              `<span class="chip ${ch.clase}" data-goto="${ch.goto}" title="Ir a sección">${ch.txt}</span>`
          )
          .join("");
      }

      function iniciar_tour() {
        const pasos = [
          {
            element: document.querySelector("#controles"),
            intro:
              "Panel de entrada: velocidad de papel, datos básicos y método de cálculo de FC (directo, RR o conteo en 6 s).",
          },
          {
            element: document.querySelector("#sec_ritmo"),
            intro:
              "Empieza por el ritmo. Usa el glosario para comprender rSR′, mayúsculas/minúsculas y primes.",
          },
          {
            element: document.querySelector("#sec_intervalos"),
            intro:
              "PR/QRS/QT y corrección de QTc (elige fórmula). El QRS distingue <110, 110–119 y ≥120 ms.",
          },
          {
            element: document.querySelector("#sec_eje"),
            intro: "Eje por cuadrantes, en grados y método isodifásico.",
          },
          {
            element: document.querySelector("#sec_conduccion"),
            intro:
              "Si QRS ≥120 ms, guía morfológica para BRD/BRI (y recordatorio de BRD incompleto en 110–119 ms).",
          },
          {
            element: document.querySelector("#sec_isquemia"),
            intro:
              "Marca elevación/descenso de ST y ondas Q por territorios (contiguidad integrada).",
          },
          {
            element: document.querySelector("#sec_hipertrofia"),
            intro:
              "HVI por Sokolow/Cornell y patrones (Brugada, Wellens, etc.).",
          },
          {
            element: document.querySelector("#hallazgos_vivos"),
            intro:
              "Hallazgos en tiempo real: desviaciones, BAV, QRS ancho, ST, etc.",
          },
          {
            element: document.querySelector("#sec_acciones"),
            intro:
              "Acciones: informe ampliado (con narrativa) y botón directo para copiar el resumen para HCE.",
          },
        ].filter((p) => p.element && p.element.offsetParent !== null);

        const header = document.getElementById("hdr");
        const TOP_OFFSET = (header?.offsetHeight || 72) + 12;

        function scrollWithOffset(el) {
          if (!el) return;
          const y =
            el.getBoundingClientRect().top + window.pageYOffset - TOP_OFFSET;
          window.scrollTo({ top: Math.max(0, y), behavior: "smooth" });
        }

        function nudgeTooltipIntoView() {
          const layer = document.querySelector(
            ".introjs-tooltipReferenceLayer"
          );
          if (!layer) return;
          const r = layer.getBoundingClientRect();
          if (r.bottom > window.innerHeight)
            window.scrollBy({
              top: r.bottom - window.innerHeight + 12,
              behavior: "smooth",
            });
          if (r.top < 0)
            window.scrollBy({ top: r.top - 12, behavior: "smooth" });
        }

        const intro = introJs();
        intro.setOptions({
          steps: pasos,
          nextLabel: "Siguiente ›",
          prevLabel: "‹ Anterior",
          doneLabel: "¡Entendido!",
          exitOnOverlayClick: false,
          showStepNumbers: true,
          scrollToElement: false,
          positionPrecedence: ["bottom", "top", "right", "left"],
        });

        const START_Y = window.pageYOffset;

        intro.onbeforechange((target) => {
          scrollWithOffset(target);
        });
        intro.onafterchange((target) => {
          setTimeout(() => {
            scrollWithOffset(target);
            nudgeTooltipIntoView();
          }, 60);
        });
        intro.oncomplete(() => {
          setTimeout(() => {
            window.scrollTo({ top: 0, behavior: "smooth" });
          }, 60);
        });
        intro.onexit(() => {
          window.scrollTo({ top: START_Y, behavior: "smooth" });
        });

        try {
          intro.start();
        } catch (e) {
          console.warn("Intro.js no pudo iniciarse:", e);
        }
      }
    </script>
    <script>
      (function () {
        "use strict";

        // ---------- Catálogo corregido de patrones ECG (SVG deterministas) ----------
        const catalogo = {
          ritmo_normal: {
            title: "Ritmo sinusal",
            desc: "P positiva, QRS estrecho regular, T positiva.",
            render: function (size) {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="Ritmo sinusal">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid1" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid1" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid1)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid1)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Complejo 1 -->
  <g>
    <!-- Onda P -->
    <path d="M 30,70 Q 35,64 40,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- Segmento PR -->
    <line x1="40" y1="70" x2="48" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <!-- QRS -->
    <path d="M 48,70 L 49,73 L 51,25 L 53,85 L 55,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- Segmento ST -->
    <line x1="55" y1="70" x2="65" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <!-- Onda T -->
    <path d="M 65,70 Q 75,55 85,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Complejo 2 -->
  <g>
    <!-- Onda P -->
    <path d="M 110,70 Q 115,64 120,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- Segmento PR -->
    <line x1="120" y1="70" x2="128" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <!-- QRS -->
    <path d="M 128,70 L 129,73 L 131,25 L 133,85 L 135,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- Segmento ST -->
    <line x1="135" y1="70" x2="145" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <!-- Onda T -->
    <path d="M 145,70 Q 155,55 165,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Complejo 3 -->
  <g>
    <!-- Onda P -->
    <path d="M 190,70 Q 195,64 200,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- Segmento PR -->
    <line x1="200" y1="70" x2="208" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <!-- QRS -->
    <path d="M 208,70 L 209,73 L 211,25 L 213,85 L 215,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- Segmento ST -->
    <line x1="215" y1="70" x2="225" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <!-- Onda T -->
    <path d="M 225,70 Q 235,55 245,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
</svg>`;
            },
          },

          fa: {
            title: "Fibrilación auricular",
            desc: "RR irregular y ausencia de ondas P claras.",
            render: function (size) {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="Fibrilación auricular">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid2" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid2" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid2)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid2)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Línea base fibrilatoria (ondas f) -->
  <path d="M 10,70 q 3,-2 6,0 t 6,1 t 6,-1 t 6,0 q 3,2 6,0 t 6,-1 t 6,1 t 6,0 q 3,-2 6,0 t 6,1 t 6,-1 t 6,0" 
        stroke="#9ca3af" stroke-width="0.8" fill="none" opacity="0.7"/>
  
  <!-- QRS 1 (intervalo corto) -->
  <path d="M 35,70 L 36,73 L 38,25 L 40,85 L 42,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  <path d="M 42,70 q 3,-1 6,0 t 6,1 t 6,-1" stroke="#9ca3af" stroke-width="0.8" fill="none" opacity="0.7"/>
  
  <!-- QRS 2 (intervalo largo) -->
  <path d="M 95,70 L 96,73 L 98,25 L 100,85 L 102,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  <path d="M 102,70 q 3,1 6,0 t 6,-1 t 6,1 t 6,0" stroke="#9ca3af" stroke-width="0.8" fill="none" opacity="0.7"/>
  
  <!-- QRS 3 (intervalo medio) -->
  <path d="M 145,70 L 146,73 L 148,25 L 150,85 L 152,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  <path d="M 152,70 q 3,-1 6,0 t 6,1 t 6,-1 t 6,0" stroke="#9ca3af" stroke-width="0.8" fill="none" opacity="0.7"/>
  
  <!-- QRS 4 (intervalo muy corto) -->
  <path d="M 185,70 L 186,73 L 188,25 L 190,85 L 192,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  <path d="M 192,70 q 3,1 6,0 t 6,-1 t 6,1 t 6,0" stroke="#9ca3af" stroke-width="0.8" fill="none" opacity="0.7"/>
  
  <!-- QRS 5 (intervalo largo) -->
  <path d="M 250,70 L 251,73 L 253,25 L 255,85 L 257,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  <path d="M 257,70 q 3,-1 6,0 t 6,1 t 6,-1" stroke="#9ca3af" stroke-width="0.8" fill="none" opacity="0.7"/>
</svg>`;
            },
          },

          ev: {
            title: "Extrasístole ventricular (EV)",
            desc: "QRS ancho sin P previa, pausa compensadora.",
            render: function (size) {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="Extrasístole ventricular">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid3" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid3" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid3)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid3)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Complejo normal 1 -->
  <g>
    <path d="M 25,70 Q 30,64 35,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="35" y1="70" x2="43" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 43,70 L 44,73 L 46,25 L 48,85 L 50,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="50" y1="70" x2="60" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 60,70 Q 70,55 80,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Extrasístole ventricular (QRS ancho y bizarro) -->
  <g>
    <!-- No hay onda P -->
    <line x1="100" y1="70" x2="110" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <!-- QRS ancho y aberrante -->
    <path d="M 110,70 L 112,75 L 116,20 L 122,90 L 128,85 L 134,80 L 140,70" 
          stroke="var(--peligro)" stroke-width="2" fill="none"/>
    <!-- T discordante -->
    <path d="M 140,70 Q 150,85 160,70" stroke="var(--peligro)" stroke-width="2" fill="none"/>
  </g>
  
  <!-- Pausa compensadora -->
  <line x1="160" y1="70" x2="200" y2="70" stroke="currentColor" stroke-width="1.5"/>
  
  <!-- Complejo normal 2 -->
  <g>
    <path d="M 200,70 Q 205,64 210,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="210" y1="70" x2="218" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 218,70 L 219,73 L 221,25 L 223,85 L 225,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="225" y1="70" x2="235" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 235,70 Q 245,55 255,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
</svg>`;
            },
          },

          bav1: {
            title: "BAV 1.º grado",
            desc: "PR prolongado con todas las P conducidas.",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="BAV 1.º grado">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid4" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid4" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid4)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid4)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Complejo 1 con PR largo -->
  <g>
    <!-- Onda P -->
    <path d="M 30,70 Q 35,64 40,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- Segmento PR prolongado (>200ms = >5 cuadros pequeños) -->
    <line x1="40" y1="70" x2="70" y2="70" stroke="var(--aviso)" stroke-width="2" opacity="0.7"/>
    <!-- Marcador de intervalo -->
    <path d="M 40,78 L 40,82 M 70,78 L 70,82 M 40,80 L 70,80" stroke="#ff9800" stroke-width="1" opacity="0.7"/>
    <text x="55" y="92" font-size="8" fill="#ff9800" text-anchor="middle">PR largo</text>
    <!-- QRS -->
    <path d="M 70,70 L 71,73 L 73,25 L 75,85 L 77,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- ST-T -->
    <line x1="77" y1="70" x2="87" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 87,70 Q 97,55 107,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Complejo 2 con PR largo -->
  <g>
    <!-- Onda P -->
    <path d="M 140,70 Q 145,64 150,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- Segmento PR prolongado -->
    <line x1="150" y1="70" x2="180" y2="70" stroke="var(--aviso)" stroke-width="2" opacity="0.7"/>
    <!-- QRS -->
    <path d="M 180,70 L 181,73 L 183,25 L 185,85 L 187,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- ST-T -->
    <line x1="187" y1="70" x2="197" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 197,70 Q 207,55 217,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
</svg>`;
            },
          },

          mobitz1: {
            title: "BAV 2.º Mobitz I",
            desc: "PR se alarga progresivamente hasta P bloqueada.",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="Mobitz I">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid5" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid5" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid5)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid5)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Complejo 1: PR normal -->
  <g>
    <path d="M 20,70 Q 25,64 30,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="30" y1="70" x2="38" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 38,70 L 39,73 L 41,25 L 43,85 L 45,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="45" y1="70" x2="55" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 55,70 Q 65,55 75,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Complejo 2: PR más largo -->
  <g>
    <path d="M 85,70 Q 90,64 95,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="95" y1="70" x2="108" y2="70" stroke="var(--aviso)" stroke-width="1.8"/>
    <path d="M 108,70 L 109,73 L 111,25 L 113,85 L 115,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="115" y1="70" x2="125" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 125,70 Q 135,55 145,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Complejo 3: PR aún más largo -->
  <g>
    <path d="M 155,70 Q 160,64 165,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="165" y1="70" x2="185" y2="70" stroke="var(--aviso)" stroke-width="2"/>
    <path d="M 185,70 L 186,73 L 188,25 L 190,85 L 192,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="192" y1="70" x2="202" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 202,70 Q 212,55 222,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- P bloqueada (sin QRS) -->
  <g>
    <path d="M 235,70 Q 240,64 245,70" stroke="var(--peligro)" stroke-width="2" fill="none"/>
    <line x1="245" y1="70" x2="280" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <text x="260" y="85" font-size="8" fill="var(--peligro)" text-anchor="middle">P bloqueada</text>
  </g>
</svg>`;
            },
          },
          mobitz2: {
            title: "BAV 2.º Mobitz II",
            desc: "PR constante con QRS bloqueados súbitos (2:1, 3:1).",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="Mobitz II">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid17" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid17" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid17)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid17)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Complejo 1: P conducida -->
  <g>
    <path d="M 30,70 Q 35,64 40,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="40" y1="70" x2="50" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 50,70 L 51,73 L 53,25 L 55,85 L 57,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="57" y1="70" x2="67" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 67,70 Q 77,55 87,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- P no conducida (bloqueada) -->
  <g>
    <path d="M 100,70 Q 105,64 110,70" stroke="var(--peligro)" stroke-width="2" fill="none"/>
    <line x1="110" y1="70" x2="150" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <text x="125" y="85" font-size="8" fill="var(--peligro)" text-anchor="middle">P bloqueada</text>
  </g>
  
  <!-- Complejo 2: P conducida -->
  <g>
    <path d="M 170,70 Q 175,64 180,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="180" y1="70" x2="190" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 190,70 L 191,73 L 193,25 L 195,85 L 197,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <line x1="197" y1="70" x2="207" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 207,70 Q 217,55 227,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- P no conducida -->
  <g>
    <path d="M 240,70 Q 245,64 250,70" stroke="var(--peligro)" stroke-width="2" fill="none"/>
    <line x1="250" y1="70" x2="280" y2="70" stroke="currentColor" stroke-width="1.5"/>
  </g>
  
  <text x="150" y="110" font-size="8" fill="#6b7280" text-anchor="middle">Conducción 2:1 (PR constante cuando conduce)</text>
</svg>`;
            },
          },

          bav3: {
            title: "BAV 3.º grado",
            desc: "Disociación AV completa.",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="BAV completo">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid6" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid6" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid6)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid6)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Ondas P regulares (independientes) -->
  <g opacity="0.8">
    <path d="M 25,70 Q 30,64 35,70" stroke="var(--peligro)" stroke-width="1.3" fill="none"/>
    <path d="M 65,70 Q 70,64 75,70" stroke="var(--peligro)" stroke-width="1.3" fill="none"/>
    <path d="M 105,70 Q 110,64 115,70" stroke="var(--peligro)" stroke-width="1.3" fill="none"/>
    <path d="M 145,70 Q 150,64 155,70" stroke="var(--peligro)" stroke-width="1.3" fill="none"/>
    <path d="M 185,70 Q 190,64 195,70" stroke="var(--peligro)" stroke-width="1.3" fill="none"/>
    <path d="M 225,70 Q 230,64 235,70" stroke="var(--peligro)" stroke-width="1.3" fill="none"/>
    <path d="M 265,70 Q 270,64 275,70" stroke="var(--peligro)" stroke-width="1.3" fill="none"/>
  </g>
  
  <!-- QRS de escape (ritmo ventricular lento, independiente) -->
  <g>
    <!-- QRS 1 -->
    <path d="M 50,70 L 52,75 L 56,20 L 62,90 L 68,85 L 74,80 L 80,70" 
          stroke="currentColor" stroke-width="2" fill="none"/>
    <path d="M 80,70 Q 90,85 100,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- QRS 2 -->
    <path d="M 140,70 L 142,75 L 146,20 L 152,90 L 158,85 L 164,80 L 170,70" 
          stroke="currentColor" stroke-width="2" fill="none"/>
    <path d="M 170,70 Q 180,85 190,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- QRS 3 -->
    <path d="M 230,70 L 232,75 L 236,20 L 242,90 L 248,85 L 254,80 L 260,70" 
          stroke="currentColor" stroke-width="2" fill="none"/>
    <path d="M 260,70 Q 270,85 280,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <text x="150" y="110" font-size="8" fill="#6b7280" text-anchor="middle">P y QRS independientes</text>
</svg>`;
            },
          },

          axis_normal: {
            title: "Eje normal",
            desc: "Entre −30° y +90°.",
            render: function () {
              return `
<svg viewBox="0 0 180 120" role="img" aria-label="Eje normal">
  <!-- Fondo -->
  <rect x="0" y="0" width="180" height="120" rx="10" fill="#f9fafb"/>
  
  <!-- Sistema hexaaxial -->
  <g transform="translate(90,60)">
    <!-- Círculo de referencia -->
    <circle cx="0" cy="0" r="35" fill="none" stroke="#e5e7eb" stroke-width="1"/>
    
    <!-- Ejes de derivaciones -->
    <!-- I (0°) -->
    <line x1="-35" y1="0" x2="35" y2="0" stroke="#d1d5db" stroke-width="0.5"/>
    <text x="38" y="3" font-size="8" fill="#6b7280">I (0°)</text>
    
    <!-- II (60°) -->
    <line x1="-17.5" y1="-30.3" x2="17.5" y2="30.3" stroke="#d1d5db" stroke-width="0.5"/>
    <text x="20" y="35" font-size="8" fill="#6b7280">II</text>
    
    <!-- III (120°) -->
    <line x1="17.5" y1="-30.3" x2="-17.5" y2="30.3" stroke="#d1d5db" stroke-width="0.5"/>
    <text x="-25" y="35" font-size="8" fill="#6b7280">III</text>
    
    <!-- aVR (-150°) -->
    <line x1="30.3" y1="17.5" x2="-30.3" y2="-17.5" stroke="#d1d5db" stroke-width="0.5" stroke-dasharray="2,2"/>
    <text x="-38" y="-15" font-size="8" fill="#6b7280">aVR</text>
    
    <!-- aVL (-30°) -->
    <line x1="30.3" y1="-17.5" x2="-30.3" y2="17.5" stroke="#d1d5db" stroke-width="0.5" stroke-dasharray="2,2"/>
    <text x="-38" y="20" font-size="8" fill="#6b7280">aVL</text>
    
    <!-- aVF (90°) -->
    <line x1="0" y1="-35" x2="0" y2="35" stroke="#d1d5db" stroke-width="0.5" stroke-dasharray="2,2"/>
    <text x="3" y="42" font-size="8" fill="#6b7280">aVF</text>
    
    <!-- Zona normal sombreada (-30° a +90°) -->
    <path d="M 0,0 L 30.3,-17.5 A 35,35 0 0,1 0,35 Z" fill="#22c55e" opacity="0.15"/>
    
    <!-- Vector QRS normal (ejemplo a +60°) -->
    <line x1="0" y1="0" x2="17.5" y2="30.3" stroke="#22c55e" stroke-width="3" marker-end="url(#arrow1)"/>
    
    <!-- Flecha -->
    <defs>
      <marker id="arrow1" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto">
        <path d="M0,0 L8,4 L0,8 z" fill="#22c55e"/>
      </marker>
    </defs>
  </g>
  
  <text x="90" y="110" font-size="9" fill="#22c55e" text-anchor="middle" font-weight="600">Eje +60° (Normal)</text>
</svg>`;
            },
          },

          axis_izq: {
            title: "Eje izquierdo",
            desc: "Menor de −30°.",
            render: function () {
              return `
<svg viewBox="0 0 180 120" role="img" aria-label="Eje desviado a la izquierda">
  <!-- Fondo -->
  <rect x="0" y="0" width="180" height="120" rx="10" fill="#f9fafb"/>
  
  <!-- Sistema hexaaxial -->
  <g transform="translate(90,60)">
    <!-- Círculo de referencia -->
    <circle cx="0" cy="0" r="35" fill="none" stroke="#e5e7eb" stroke-width="1"/>
    
    <!-- Ejes de derivaciones -->
    <!-- I (0°) -->
    <line x1="-35" y1="0" x2="35" y2="0" stroke="#d1d5db" stroke-width="0.5"/>
    <text x="38" y="3" font-size="8" fill="#6b7280">I</text>
    
    <!-- II (60°) -->
    <line x1="-17.5" y1="-30.3" x2="17.5" y2="30.3" stroke="#d1d5db" stroke-width="0.5"/>
    <text x="20" y="35" font-size="8" fill="#6b7280">II</text>
    
    <!-- III (120°) -->
    <line x1="17.5" y1="-30.3" x2="-17.5" y2="30.3" stroke="#d1d5db" stroke-width="0.5"/>
    <text x="-25" y="35" font-size="8" fill="#6b7280">III</text>
    
    <!-- aVR (-150°) -->
    <line x1="30.3" y1="17.5" x2="-30.3" y2="-17.5" stroke="#d1d5db" stroke-width="0.5" stroke-dasharray="2,2"/>
    <text x="-38" y="-15" font-size="8" fill="#6b7280">aVR</text>
    
    <!-- aVL (-30°) -->
    <line x1="30.3" y1="-17.5" x2="-30.3" y2="17.5" stroke="#d1d5db" stroke-width="0.5" stroke-dasharray="2,2"/>
    <text x="-38" y="20" font-size="8" fill="#6b7280">aVL</text>
    
    <!-- aVF (90°) -->
    <line x1="0" y1="-35" x2="0" y2="35" stroke="#d1d5db" stroke-width="0.5" stroke-dasharray="2,2"/>
    <text x="3" y="42" font-size="8" fill="#6b7280">aVF</text>
    
    <!-- Zona de desviación izquierda sombreada (<-30°) -->
    <path d="M 0,0 L -30.3,17.5 A 35,35 0 0,1 -30.3,-17.5 Z" fill="#ef4444" opacity="0.15"/>
    
    <!-- Vector QRS desviado a la izquierda (ejemplo a -60°) -->
    <line x1="0" y1="0" x2="-17.5" y2="-30.3" stroke="#ef4444" stroke-width="3" marker-end="url(#arrow2)"/>
    
    <!-- Flecha -->
    <defs>
      <marker id="arrow2" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto">
        <path d="M0,0 L8,4 L0,8 z" fill="#ef4444"/>
      </marker>
    </defs>
  </g>
  
  <text x="90" y="110" font-size="9" fill="#ef4444" text-anchor="middle" font-weight="600">Eje −60° (Desviación izquierda)</text>
</svg>`;
            },
          },

          axis_der: {
            title: "Eje derecho",
            desc: "Mayor de +90°.",
            render: function () {
              return `
<svg viewBox="0 0 180 120" role="img" aria-label="Eje desviado a la derecha">
  <!-- Fondo -->
  <rect x="0" y="0" width="180" height="120" rx="10" fill="#f9fafb"/>
  
  <!-- Sistema hexaaxial -->
  <g transform="translate(90,60)">
    <!-- Círculo de referencia -->
    <circle cx="0" cy="0" r="35" fill="none" stroke="#e5e7eb" stroke-width="1"/>
    
    <!-- Ejes de derivaciones -->
    <!-- I (0°) -->
    <line x1="-35" y1="0" x2="35" y2="0" stroke="#d1d5db" stroke-width="0.5"/>
    <text x="38" y="3" font-size="8" fill="#6b7280">I</text>
    
    <!-- II (60°) -->
    <line x1="-17.5" y1="-30.3" x2="17.5" y2="30.3" stroke="#d1d5db" stroke-width="0.5"/>
    <text x="20" y="35" font-size="8" fill="#6b7280">II</text>
    
    <!-- III (120°) -->
    <line x1="17.5" y1="-30.3" x2="-17.5" y2="30.3" stroke="#d1d5db" stroke-width="0.5"/>
    <text x="-25" y="35" font-size="8" fill="#6b7280">III</text>
    
    <!-- aVR (-150°) -->
    <line x1="30.3" y1="17.5" x2="-30.3" y2="-17.5" stroke="#d1d5db" stroke-width="0.5" stroke-dasharray="2,2"/>
    <text x="-38" y="-15" font-size="8" fill="#6b7280">aVR</text>
    
    <!-- aVL (-30°) -->
    <line x1="30.3" y1="-17.5" x2="-30.3" y2="17.5" stroke="#d1d5db" stroke-width="0.5" stroke-dasharray="2,2"/>
    <text x="-38" y="20" font-size="8" fill="#6b7280">aVL</text>
    
    <!-- aVF (90°) -->
    <line x1="0" y1="-35" x2="0" y2="35" stroke="#d1d5db" stroke-width="0.5" stroke-dasharray="2,2"/>
    <text x="3" y="42" font-size="8" fill="#6b7280">aVF</text>
    
    <!-- Zona de desviación derecha sombreada (>90°) -->
    <path d="M 0,0 L 0,35 A 35,35 0 0,1 -30.3,17.5 Z" fill="#3b82f6" opacity="0.15"/>
    
    <!-- Vector QRS desviado a la derecha (ejemplo a +120°) -->
    <line x1="0" y1="0" x2="-17.5" y2="30.3" stroke="#3b82f6" stroke-width="3" marker-end="url(#arrow3)"/>
    
    <!-- Flecha -->
    <defs>
      <marker id="arrow3" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto">
        <path d="M0,0 L8,4 L0,8 z" fill="#3b82f6"/>
      </marker>
    </defs>
  </g>
  
  <text x="90" y="110" font-size="9" fill="#3b82f6" text-anchor="middle" font-weight="600">Eje +120° (Desviación derecha)</text>
</svg>`;
            },
          },

          rsr_v1: {
            title: "BRD incompleto",
            desc: "rSR′ en V1 con QRS < 120ms (patrón incompleto).",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="rSR′ en V1">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid7" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid7" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid7)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid7)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Complejo con patrón rSR' -->
  <g>
    <!-- Onda P -->
    <path d="M 80,70 Q 85,64 90,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- Segmento PR -->
    <line x1="90" y1="70" x2="100" y2="70" stroke="currentColor" stroke-width="1.5"/>
    
    <!-- Patrón rSR' característico "orejas de conejo" -->
    <!-- r pequeña -->
    <path d="M 100,70 L 102,65 L 104,70" stroke="currentColor" stroke-width="2" fill="none"/>
    <!-- S -->
    <path d="M 104,70 L 108,85 L 112,70" stroke="currentColor" stroke-width="2" fill="none"/>
    <!-- R' (segunda R, más alta) -->
    <path d="M 112,70 L 118,45 L 124,70" stroke="var(--primario)" stroke-width="2.5" fill="none"/>
    
    <!-- Etiquetas -->
    <text x="102" y="60" font-size="7" fill="#6b7280">r</text>
    <text x="108" y="95" font-size="7" fill="#6b7280">S</text>
    <text x="118" y="40" font-size="7" fill="var(--primario)">R′</text>
    
    <!-- Segmento ST y T -->
    <line x1="124" y1="70" x2="134" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 134,70 Q 144,80 154,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Segundo complejo para mostrar repetición del patrón -->
  <g>
    <!-- Onda P -->
    <path d="M 180,70 Q 185,64 190,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- Segmento PR -->
    <line x1="190" y1="70" x2="200" y2="70" stroke="currentColor" stroke-width="1.5"/>
    
    <!-- Patrón rSR' -->
    <!-- r pequeña -->
    <path d="M 200,70 L 202,65 L 204,70" stroke="currentColor" stroke-width="2" fill="none"/>
    <!-- S -->
    <path d="M 204,70 L 208,85 L 212,70" stroke="currentColor" stroke-width="2" fill="none"/>
    <!-- R' -->
    <path d="M 212,70 L 218,45 L 224,70" stroke="var(--primario)" stroke-width="2.5" fill="none"/>
    
    <!-- Segmento ST y T -->
    <line x1="224" y1="70" x2="234" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 234,70 Q 244,80 254,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <text x="150" y="110" font-size="8" fill="#6b7280" text-anchor="middle">"Orejas de conejo" en V1</text>
</svg>`;
            },
          },

          brd_v1v6: {
            title: "BRD",
            desc: "R′ en V1–V2 y S ancha en I/V6.",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="Bloqueo de rama derecha">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid8" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid8" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid8)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid8)" opacity="0.4"/>
  
  <!-- V1 con rSR' -->
  <g>
    <text x="40" y="20" font-size="9" fill="#6b7280" font-weight="600">V1</text>
    <line x1="10" y1="50" x2="140" y2="50" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
    
    <!-- Complejo V1 -->
    <path d="M 30,50 Q 35,46 40,50" stroke="currentColor" stroke-width="1.2" fill="none"/>
    <line x1="40" y1="50" x2="48" y2="50" stroke="currentColor" stroke-width="1.2"/>
    <!-- rSR' pattern -->
    <path d="M 48,50 L 50,46 L 52,50 L 55,60 L 58,50 L 63,35 L 68,50" 
          stroke="var(--peligro)" stroke-width="2" fill="none"/>
    <line x1="68" y1="50" x2="75" y2="50" stroke="currentColor" stroke-width="1.2"/>
    <path d="M 75,50 Q 83,58 91,50" stroke="currentColor" stroke-width="1.2" fill="none"/>
  </g>
  
  <!-- V6 con S ancha -->
  <g>
    <text x="40" y="95" font-size="9" fill="#6b7280" font-weight="600">V6</text>
    <line x1="10" y1="80" x2="140" y2="80" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
    
    <!-- Complejo V6 -->
    <path d="M 30,80 Q 35,76 40,80" stroke="currentColor" stroke-width="1.2" fill="none"/>
    <line x1="40" y1="80" x2="48" y2="80" stroke="currentColor" stroke-width="1.2"/>
    <!-- R alta con S ancha terminal -->
    <path d="M 48,80 L 53,60 L 58,80 L 62,88 L 68,88 L 72,80" 
          stroke="var(--peligro)" stroke-width="2" fill="none"/>
    <text x="65" y="95" font-size="7" fill="var(--peligro)">S ancha</text>
    <line x1="72" y1="80" x2="79" y2="80" stroke="currentColor" stroke-width="1.2"/>
    <path d="M 79,80 Q 87,72 95,80" stroke="currentColor" stroke-width="1.2" fill="none"/>
  </g>
  
  <!-- Duración QRS -->
  <g transform="translate(160,60)">
    <rect x="0" y="0" width="120" height="50" rx="5" fill="#f3f4f6" stroke="#d1d5db"/>
    <text x="60" y="20" font-size="10" fill="#6b7280" text-anchor="middle" font-weight="600">
      QRS > 120 ms
    </text>
    <text x="60" y="35" font-size="8" fill="#9ca3af" text-anchor="middle">
      (> 3 cuadros pequeños)
    </text>
  </g>
</svg>`;
            },
          },

          bri_v1v6: {
            title: "BRI",
            desc: "R ancha sin q en I/V6; discordancia apropiada de ST-T.",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="Bloqueo de rama izquierda">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid9" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid9" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid9)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid9)" opacity="0.4"/>
  
  <!-- V1 con QS profundo -->
  <g>
    <text x="40" y="25" font-size="9" fill="#6b7280" font-weight="600">V1</text>
    <line x1="10" y1="45" x2="140" y2="45" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
    
    <!-- Complejo V1 -->
    <path d="M 30,45 Q 35,41 40,45" stroke="currentColor" stroke-width="1.2" fill="none"/>
    <line x1="40" y1="45" x2="48" y2="45" stroke="currentColor" stroke-width="1.2"/>
    <!-- QS profundo y ancho -->
    <path d="M 48,45 L 50,47 L 54,65 L 60,65 L 66,63 L 70,45" 
          stroke="var(--peligro)" stroke-width="2.5" fill="none"/>
    <!-- ST-T discordante (elevado) -->
    <path d="M 70,45 Q 78,35 86,40" stroke="var(--aviso)" stroke-width="2" fill="none"/>
  </g>
  
  <!-- V6 con R ancha -->
  <g>
    <text x="40" y="95" font-size="9" fill="#6b7280" font-weight="600">V6</text>
    <line x1="10" y1="80" x2="140" y2="80" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
    
    <!-- Complejo V6 -->
    <path d="M 30,80 Q 35,76 40,80" stroke="currentColor" stroke-width="1.2" fill="none"/>
    <line x1="40" y1="80" x2="48" y2="80" stroke="currentColor" stroke-width="1.2"/>
    <!-- R ancha sin q inicial -->
    <path d="M 48,80 L 50,78 L 54,60 L 60,58 L 66,60 L 70,80" 
          stroke="var(--peligro)" stroke-width="2.5" fill="none"/>
    <text x="59" y="54" font-size="7" fill="var(--peligro)">R ancha</text>
    <!-- ST deprimido (discordancia) -->
    <path d="M 70,80 L 77,85" stroke="var(--aviso)" stroke-width="2" fill="none"/>
    <path d="M 77,85 Q 85,90 93,85" stroke="var(--aviso)" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Características -->
  <g transform="translate(160,60)">
    <rect x="0" y="0" width="120" height="50" rx="5" fill="#f3f4f6" stroke="#d1d5db"/>
    <text x="60" y="18" font-size="9" fill="#6b7280" text-anchor="middle" font-weight="600">
      QRS > 120 ms
    </text>
    <text x="60" y="32" font-size="8" fill="#9ca3af" text-anchor="middle">
      Sin q en I, V6
    </text>
    <text x="60" y="44" font-size="8" fill="#9ca3af" text-anchor="middle">
      Discordancia ST-T
    </text>
  </g>
</svg>`;
            },
          },

          ste_concava: {
            title: "ST elevación cóncava",
            desc: "Elevación con morfología cóncava (p. ej., pericarditis/benigna).",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="ST elevación cóncava">
  <!-- Fondo con cuadrícula ECG -->
  <defs>
    <pattern id="smallGrid10" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid10" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid10)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid10)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Primer complejo -->
  <g>
    <!-- Onda P -->
    <path d="M 40,70 Q 45,64 50,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- PR segment -->
    <line x1="50" y1="70" x2="58" y2="70" stroke="currentColor" stroke-width="1.5"/>
    
    <!-- QRS -->
    <path d="M 58,70 L 59,73 L 61,25 L 63,85 L 65,55" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- Punto J elevado -->
    <circle cx="65" cy="55" r="2.5" fill="var(--peligro)" opacity="0.8"/>
    
    <!-- ST cóncavo elevado (sonrisa) -->
    <path d="M 65,55 Q 80,52 95,55" stroke="var(--peligro)" stroke-width="2.5" fill="none"/>
    
    <!-- Onda T concordante -->
    <path d="M 95,55 Q 105,40 115,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Segundo complejo -->
  <g>
    <!-- Onda P -->
    <path d="M 140,70 Q 145,64 150,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- PR segment -->
    <line x1="150" y1="70" x2="158" y2="70" stroke="currentColor" stroke-width="1.5"/>
    
    <!-- QRS -->
    <path d="M 158,70 L 159,73 L 161,25 L 163,85 L 165,55" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- Punto J elevado -->
    <circle cx="165" cy="55" r="2.5" fill="var(--peligro)" opacity="0.8"/>
    
    <!-- ST cóncavo elevado -->
    <path d="M 165,55 Q 180,52 195,55" stroke="var(--peligro)" stroke-width="2.5" fill="none"/>
    
    <!-- Onda T -->
    <path d="M 195,55 Q 205,40 215,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Anotación -->
  <text x="150" y="110" font-size="8" fill="#6b7280" text-anchor="middle">
    Elevación cóncava ("sonrisa") - Pericarditis/Repolarización precoz
  </text>
</svg>`;
            },
          },

          ste_convexa: {
            title: "ST elevación convexa",
            desc: "Elevación convexo-domada (más sugerente de lesión/infarto).",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="ST elevación convexa">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid11" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid11" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid11)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid11)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Primer complejo -->
  <g>
    <!-- Onda P -->
    <path d="M 40,70 Q 45,64 50,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- PR segment -->
    <line x1="50" y1="70" x2="58" y2="70" stroke="currentColor" stroke-width="1.5"/>
    
    <!-- QRS -->
    <path d="M 58,70 L 59,73 L 61,25 L 63,85 L 65,55" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- Punto J elevado -->
    <circle cx="65" cy="55" r="2.5" fill="var(--peligro)"/>
    
    <!-- ST convexo elevado (lomo de delfín/tombstone) -->
    <path d="M 65,55 C 75,45 85,45 95,55" stroke="var(--peligro)" stroke-width="3" fill="none"/>
    
    <!-- Onda T invertida o fusionada -->
    <path d="M 95,55 L 105,75 L 115,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Segundo complejo -->
  <g>
    <!-- Onda P -->
    <path d="M 140,70 Q 145,64 150,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- PR segment -->
    <line x1="150" y1="70" x2="158" y2="70" stroke="currentColor" stroke-width="1.5"/>
    
    <!-- QRS -->
    <path d="M 158,70 L 159,73 L 161,25 L 163,85 L 165,55" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- Punto J elevado -->
    <circle cx="165" cy="55" r="2.5" fill="var(--peligro)"/>
    
    <!-- ST convexo elevado -->
    <path d="M 165,55 C 175,45 185,45 195,55" stroke="var(--peligro)" stroke-width="3" fill="none"/>
    
    <!-- Onda T -->
    <path d="M 195,55 L 205,75 L 215,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Anotación -->
  <text x="150" y="110" font-size="8" fill="var(--peligro)" text-anchor="middle" font-weight="600">
    Elevación convexa ("Tombstone") - IAMCEST
  </text>
</svg>`;
            },
          },

          std_horiz: {
            title: "ST depresión horizontal",
            desc: "Descenso desde J con meseta horizontal (isquemia subendocárdica).",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="ST depresión horizontal">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid12" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid12" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid12)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid12)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Primer complejo -->
  <g>
    <!-- Onda P -->
    <path d="M 40,70 Q 45,64 50,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- PR segment -->
    <line x1="50" y1="70" x2="58" y2="70" stroke="currentColor" stroke-width="1.5"/>
    
    <!-- QRS -->
    <path d="M 58,70 L 59,73 L 61,25 L 63,85 L 65,80" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- Punto J deprimido -->
    <circle cx="65" cy="80" r="2.5" fill="var(--primario)" opacity="0.8"/>
    
    <!-- ST horizontal deprimido -->
    <line x1="65" y1="80" x2="95" y2="80" stroke="var(--primario)" stroke-width="3"/>
    
    <!-- Onda T aplanada/negativa -->
    <path d="M 95,80 Q 105,82 115,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Segundo complejo -->
  <g>
    <!-- Onda P -->
    <path d="M 140,70 Q 145,64 150,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- PR segment -->
    <line x1="150" y1="70" x2="158" y2="70" stroke="currentColor" stroke-width="1.5"/>
    
    <!-- QRS -->
    <path d="M 158,70 L 159,73 L 161,25 L 163,85 L 165,80" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- Punto J deprimido -->
    <circle cx="165" cy="80" r="2.5" fill="var(--primario)" opacity="0.8"/>
    
    <!-- ST horizontal deprimido -->
    <line x1="165" y1="80" x2="195" y2="80" stroke="var(--primario)" stroke-width="3"/>
    
    <!-- Onda T -->
    <path d="M 195,80 Q 205,82 215,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Medición -->
  <g>
    <path d="M 165,70 L 165,80" stroke="#6b7280" stroke-width="0.5" stroke-dasharray="1,1"/>
    <text x="168" y="76" font-size="7" fill="#6b7280">≥1mm</text>
  </g>
  
  <!-- Anotación -->
  <text x="150" y="110" font-size="8" fill="#6b7280" text-anchor="middle">
    Depresión horizontal ≥1mm - Isquemia subendocárdica
  </text>
</svg>`;
            },
          },

          lvh_sokolow: {
            title: "HVI (Sokolow-Lyon)",
            desc: "S(V1) + R(V5/V6) ≥ 35 mm (criterio de voltaje).",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="HVI (Sokolow-Lyon)">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid13" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid13" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid13)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid13)" opacity="0.4"/>
  
  <!-- V1 con S profunda -->
  <g>
    <text x="30" y="20" font-size="9" fill="#6b7280" font-weight="600">V1</text>
    <line x1="10" y1="40" x2="140" y2="40" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
    
    <!-- Complejo V1 con r pequeña y S profunda -->
    <path d="M 40,40 L 43,35 L 46,40" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <path d="M 46,40 L 48,42 L 52,65 L 56,63 L 60,40" 
          stroke="var(--peligro)" stroke-width="2" fill="none"/>
    
    <!-- Medición S -->
    <line x1="80" y1="40" x2="80" y2="65" stroke="#ff5722" stroke-width="1"/>
    <text x="85" y="55" font-size="8" fill="#ff5722">S = 20mm</text>
  </g>
  
  <!-- V5/V6 con R alta -->
  <g>
    <text x="30" y="95" font-size="9" fill="#6b7280" font-weight="600">V5/V6</text>
    <line x1="10" y1="85" x2="140" y2="85" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
    
    <!-- Complejo V5/V6 con R alta -->
    <path d="M 40,85 L 45,50 L 50,85" 
          stroke="var(--peligro)" stroke-width="2" fill="none"/>
    
    <!-- Medición R -->
    <path d="M 45,85 L 45,50" stroke="#9ca3af" stroke-width="0.5" stroke-dasharray="1,1"/>
    <text x="53" y="65" font-size="7" fill="var(--peligro)">R = 25mm</text>
  </g>
  
  <!-- Cálculo Sokolow -->
  <g transform="translate(160,60)">
    <rect x="0" y="0" width="120" height="50" rx="5" fill="#fef2f2" stroke="var(--peligro)"/>
    <text x="60" y="20" font-size="10" fill="var(--peligro)" text-anchor="middle" font-weight="700">
      S(V1) + R(V5/V6)
    </text>
    <text x="60" y="35" font-size="11" fill="var(--peligro)" text-anchor="middle" font-weight="700">
      = 45 mm ≥ 35 mm
    </text>
    <text x="60" y="47" font-size="8" fill="#9ca3af" text-anchor="middle">
      HVI positiva
    </text>
  </g>
</svg>`;
            },
          },

          strain_lateral: {
            title: "Strain lateral",
            desc: "ST descendente con T negativa asimétrica (HVI con sobrecarga).",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="Strain lateral">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid14" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid14" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid14)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid14)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Complejo con patrón de strain -->
  <g>
    <!-- Onda P -->
    <path d="M 40,70 Q 45,64 50,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- PR segment -->
    <line x1="50" y1="70" x2="58" y2="70" stroke="currentColor" stroke-width="1.5"/>
    
    <!-- QRS con R alta (HVI) -->
    <path d="M 58,70 L 63,35 L 68,70" stroke="currentColor" stroke-width="2" fill="none"/>
    
    <!-- ST descendente oblicuo -->
    <path d="M 68,70 L 85,80" stroke="var(--aviso)" stroke-width="2.5" fill="none"/>
    
    <!-- T negativa asimétrica (descenso gradual, ascenso rápido) -->
    <path d="M 85,80 Q 95,88 105,86 L 115,70" stroke="var(--aviso)" stroke-width="2.5" fill="none"/>
  </g>
  
  <!-- Segundo complejo -->
  <g>
    <!-- Onda P -->
    <path d="M 140,70 Q 145,64 150,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- PR segment -->
    <line x1="150" y1="70" x2="158" y2="70" stroke="currentColor" stroke-width="1.5"/>
    
    <!-- QRS con R alta -->
    <path d="M 158,70 L 163,35 L 168,70" stroke="currentColor" stroke-width="2" fill="none"/>
    
    <!-- ST descendente -->
    <path d="M 168,70 L 185,80" stroke="var(--aviso)" stroke-width="2.5" fill="none"/>
    
    <!-- T negativa asimétrica -->
    <path d="M 185,80 Q 195,88 205,86 L 215,70" stroke="var(--aviso)" stroke-width="2.5" fill="none"/>
  </g>
  
  <!-- Anotación -->
  <text x="150" y="110" font-size="8" fill="#6b7280" text-anchor="middle">
    Patrón de sobrecarga ventricular izquierda
  </text>
</svg>`;
            },
          },

          brugada1: {
            title: "Brugada tipo 1",
            desc: "Elevación tipo 'coved' ≥ 2 mm en V1–V2 con T negativa.",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="Brugada tipo 1">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid15" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid15" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid15)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid15)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Complejo con patrón Brugada tipo 1 -->
  <g>
    <!-- Onda P -->
    <path d="M 40,70 Q 45,64 50,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- PR segment -->
    <line x1="50" y1="70" x2="58" y2="70" stroke="currentColor" stroke-width="1.5"/>
    
    <!-- QRS con r' inicial -->
    <path d="M 58,70 L 60,65 L 62,70 L 65,50" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- Punto J elevado ≥2mm -->
    <circle cx="65" cy="50" r="3" fill="var(--peligro)"/>
    
    <!-- ST tipo "coved" (tienda de campaña) -->
    <path d="M 65,50 C 75,48 85,52 95,65" stroke="var(--peligro)" stroke-width="3" fill="none"/>
    
    <!-- T negativa simétrica -->
    <path d="M 95,65 L 105,80 L 115,70" stroke="var(--peligro)" stroke-width="2.5" fill="none"/>
  </g>
  
  <!-- Segundo complejo -->
  <g>
    <!-- Onda P -->
    <path d="M 140,70 Q 145,64 150,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <!-- PR segment -->
    <line x1="150" y1="70" x2="158" y2="70" stroke="currentColor" stroke-width="1.5"/>
    
    <!-- QRS con r' inicial -->
    <path d="M 158,70 L 160,65 L 162,70 L 165,50" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- Punto J elevado -->
    <circle cx="165" cy="50" r="3" fill="var(--peligro)"/>
    
    <!-- ST tipo "coved" -->
    <path d="M 165,50 C 175,48 185,52 195,65" stroke="var(--peligro)" stroke-width="3" fill="none"/>
    
    <!-- T negativa -->
    <path d="M 195,65 L 205,80 L 215,70" stroke="var(--peligro)" stroke-width="2.5" fill="none"/>
  </g>
  
  <!-- Medición -->
  <g>
    <path d="M 65,70 L 65,50" stroke="#6b7280" stroke-width="0.5" stroke-dasharray="1,1"/>
    <text x="68" y="58" font-size="7" fill="var(--peligro)">≥2mm</text>
  </g>
  
  <!-- Anotación -->
  <text x="150" y="110" font-size="8" fill="var(--peligro)" text-anchor="middle" font-weight="600">
    Patrón Brugada Tipo 1 - "Coved" (Alto riesgo)
  </text>
</svg>`;
            },
          },

          wpw: {
            title: "Preexcitación (WPW)",
            desc: "PR corto y onda delta al inicio del QRS.",
            render: function () {
              return `
<svg viewBox="0 0 300 120" role="img" aria-label="Preexcitación (WPW)">
  <!-- Fondo papel ECG -->
  <defs>
    <pattern id="smallGrid16" width="2" height="2" patternUnits="userSpaceOnUse">
      <path d="M 2 0 L 0 0 0 2" fill="none" stroke="#fce4ec" stroke-width="0.3"/>
    </pattern>
    <pattern id="ecgGrid16" width="10" height="10" patternUnits="userSpaceOnUse">
      <rect width="10" height="10" fill="url(#smallGrid16)"/>
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#f8bbd0" stroke-width="0.4"/>
    </pattern>
  </defs>
  <rect x="0" y="0" width="300" height="120" rx="8" fill="#fff5f7"/>
  <rect x="5" y="5" width="290" height="110" fill="url(#ecgGrid16)" opacity="0.4"/>
  <line x1="10" y1="70" x2="290" y2="70" stroke="#e0e0e0" stroke-width="0.5" stroke-dasharray="3,2" opacity="0.5"/>
  
  <!-- Complejo con WPW -->
  <g>
    <!-- Onda P -->
    <path d="M 40,70 Q 45,64 50,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- PR corto (<120ms = <3 cuadros pequeños) -->
    <line x1="50" y1="70" x2="54" y2="70" stroke="var(--violeta)" stroke-width="2"/>
    
    <!-- Onda delta (empastamiento inicial del QRS) -->
    <path d="M 54,70 Q 58,68 62,62" stroke="var(--violeta)" stroke-width="3" fill="none"/>
    
    <!-- Resto del QRS (fusión) -->
    <path d="M 62,62 L 65,25 L 68,85 L 72,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- ST-T (puede tener cambios secundarios) -->
    <line x1="72" y1="70" x2="82" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 82,70 Q 92,55 102,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- Marcadores -->
    <text x="52" y="85" font-size="7" fill="var(--violeta)">PR corto</text>
    <text x="58" y="58" font-size="7" fill="var(--violeta)">Delta</text>
  </g>
  
  <!-- Segundo complejo -->
  <g>
    <!-- Onda P -->
    <path d="M 140,70 Q 145,64 150,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- PR corto -->
    <line x1="150" y1="70" x2="154" y2="70" stroke="var(--violeta)" stroke-width="2"/>
    
    <!-- Onda delta -->
    <path d="M 154,70 Q 158,68 162,62" stroke="var(--violeta)" stroke-width="3" fill="none"/>
    
    <!-- Resto del QRS -->
    <path d="M 162,62 L 165,25 L 168,85 L 172,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
    
    <!-- ST-T -->
    <line x1="172" y1="70" x2="182" y2="70" stroke="currentColor" stroke-width="1.5"/>
    <path d="M 182,70 Q 192,55 202,70" stroke="currentColor" stroke-width="1.5" fill="none"/>
  </g>
  
  <!-- Comparación con QRS normal -->
  <g transform="translate(230,60)">
    <text x="0" y="-5" font-size="7" fill="#6b7280">Normal</text>
    <path d="M 0,10 Q 5,6 10,10 L 15,10 L 18,10 L 19,8 L 21,-5 L 23,15 L 25,10 L 35,10" 
          stroke="#d1d5db" stroke-width="1" fill="none"/>
    
    <text x="0" y="25" font-size="7" fill="#6b7280">WPW</text>
    <path d="M 0,40 Q 5,36 10,40 L 12,40 Q 16,38 20,32 L 22,-5 L 24,15 L 28,40 L 38,40" 
          stroke="var(--violeta)" stroke-width="1" fill="none"/>
  </g>
  
  <!-- Anotación -->
  <text x="150" y="110" font-size="8" fill="#6b7280" text-anchor="middle">
    PR < 120ms + Onda Delta + QRS ancho
  </text>
</svg>`;
            },
          },
        };

        // ---------- render y modal accesible ----------
        function crear_modal_si_no() {
          if (document.getElementById("mg_modal")) return;
          const m = document.createElement("div");
          m.id = "mg_modal";
          m.setAttribute("role", "dialog");
          m.setAttribute("aria-modal", "true");
          m.innerHTML = `
      <div class="mg-dialog" role="document">
        <h2 class="mg-titulo" id="mg_titulo"></h2>
        <div class="mg-cuerpo">
          <div class="mg-svg" id="mg_svg"></div>
          <div class="mg-desc" id="mg_desc"></div>
        </div>
        <div class="mg-acciones">
          <button type="button" class="mg-btn" id="mg_cerrar">Cerrar</button>
          <button type="button" class="mg-btn mg-btn-prim" id="mg_descargar">Descargar SVG</button>
        </div>
      </div>
    `;
          document.body.appendChild(m);

          // cierre por clic fuera
          m.addEventListener("click", function (e) {
            if (e.target.id === "mg_modal") cerrar_modal();
          });

          // botones
          document
            .getElementById("mg_cerrar")
            .addEventListener("click", cerrar_modal);
          document
            .getElementById("mg_descargar")
            .addEventListener("click", descargar_svg);

          // teclas
          document.addEventListener("keydown", function (e) {
            if (!m.classList.contains("activo")) return;
            if (e.key === "Escape") {
              // si tu modal principal está activo, no interferir
              const modal_principal = document.getElementById("modal");
              if (
                modal_principal &&
                modal_principal.classList.contains("activa")
              )
                return;
              cerrar_modal();
            }
            if (e.key === "Tab") {
              // trap de foco dentro del diálogo
              const focusables = m.querySelectorAll(
                'button,[href],[tabindex]:not([tabindex="-1"])'
              );
              if (!focusables.length) return;
              const first = focusables[0],
                last = focusables[focusables.length - 1];
              if (e.shiftKey && document.activeElement === first) {
                e.preventDefault();
                last.focus();
              } else if (!e.shiftKey && document.activeElement === last) {
                e.preventDefault();
                first.focus();
              }
            }
          });
        }

        function abrir_modal_con(item) {
          crear_modal_si_no();
          const m = document.getElementById("mg_modal");
          const t = document.getElementById("mg_titulo");
          const s = document.getElementById("mg_svg");
          const d = document.getElementById("mg_desc");
          t.textContent = item.title;
          s.innerHTML = item.render(640);
          d.textContent = item.desc;
          m.classList.add("activo");
          // foco inicial
          document.getElementById("mg_cerrar").focus();
        }

        function cerrar_modal() {
          const m = document.getElementById("mg_modal");
          if (m) m.classList.remove("activo");
        }

        function descargar_svg() {
          const cont = document.getElementById("mg_svg");
          const svg = cont ? cont.querySelector("svg") : null;
          if (!svg) return;
          const ser = new XMLSerializer();
          const src = ser.serializeToString(svg);
          const blob = new Blob([src], { type: "image/svg+xml;charset=utf-8" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download =
            (document.getElementById("mg_titulo").textContent || "patron") +
            ".svg";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }

        function renderizar_galeria(el) {
          const ids = (el.dataset.ids || "")
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);
          el.classList.add("mg-grid");
          el.setAttribute("data-intro-skip", "true");
          el.innerHTML = ids
            .map((id) => {
              const it = catalogo[id];
              if (!it) return "";
              return `
        <button type="button" class="mg-thumb" data-id="${id}" aria-label="${
                it.title
              }">
          <figure>${it.render(180)}<figcaption>${it.title}</figcaption></figure>
        </button>
      `;
            })
            .join("");
          el.addEventListener("click", function (e) {
            const b = e.target.closest(".mg-thumb");
            if (!b) return;
            const it = catalogo[b.dataset.id];
            if (it) abrir_modal_con(it);
          });
          el.addEventListener("keydown", function (e) {
            if (
              (e.key === "Enter" || e.key === " ") &&
              e.target.closest(".mg-thumb")
            ) {
              e.preventDefault();
              const b = e.target.closest(".mg-thumb");
              const it = catalogo[b.dataset.id];
              if (it) abrir_modal_con(it);
            }
          });
        }

        function renderizar_todo() {
          document
            .querySelectorAll(".mini-galeria")
            .forEach(renderizar_galeria);
          crear_modal_si_no();
        }

        function registrar(id, item) {
          catalogo[id] = item;
        }

        // API pública en snake_case
        window.mini_galeria = {
          renderizar_todo: renderizar_todo,
          abrir: abrir_modal_con,
          registrar: registrar,
        };

        // auto-init
        document.addEventListener("DOMContentLoaded", function () {
          if (document.querySelector(".mini-galeria"))
            window.mini_galeria.renderizar_todo();
        });
      })();
    </script>
    <script>
      /* ====== Módulo de iconos ECG pedagógicos (no interfiere con tu app) ====== */
      (function () {
        const W = 420,
          H = 90,
          BASE = 58; // ancho, alto, línea isoeléctrica aprox.

        function gridLines(w = W, h = H, step = 20) {
          let g = "";
          for (let x = 0; x <= w; x += step)
            g += `<line x1="${x}" y1="0" x2="${x}" y2="${h}"/>`;
          for (let y = 0; y <= h; y += step)
            g += `<line x1="0" y1="${y}" x2="${w}" y2="${y}"/>`;
          return `<g class="ecg-grid" aria-hidden="true">${g}</g>`;
        }
        function baseline(y = BASE) {
          return `<path class="ecg-baseline" d="M0 ${y}H${W}" aria-hidden="true"/>`;
        }

        // Utilidad para empaquetar figura con leyenda opcional
        function wrapSVG(inner, title, desc, legend) {
          const a11y = `
      <title>${title}</title>
      <desc>${desc}</desc>
    `;
          return `
    <figure class="ecg-figure">
      <svg class="ecg-svg" viewBox="0 0 ${W} ${H}" role="img" aria-label="${title}">
        ${a11y}
        ${gridLines()}
        ${baseline()}
        ${inner}
      </svg>
      ${legend ? `<figcaption class="legend">${legend}</figcaption>` : ""}
    </figure>`;
        }

        // === ICONOS ===
        // 1) IAMCEST inferior (ST↑ en II–III). Segmento ST resaltado en rojo (crit).
        function icon_stemi_inferior() {
          const lead = (yOff, label) => {
            const y = BASE + yOff;
            // Trazado base (P pequeña, PR, QRS, ST elevado, T)
            const path = [
              `M 10 ${y}`, // baseline
              `l 12 0 l 4 -4 l 6 4`, // P
              `l 14 0`, // PR
              `l -4 5 l 8 -22 l 8 22 l -3 -5`, // QRS
              `l 0 0`, // J
              `l 22 -6`, // ST elevado (sube 6 px)
              `c 16 -6, 28 -6, 34 12`, // T (curva)
              `c -6 16, -30 16, -38 0`, // vuelve a baseline
              `l -49 0`,
            ].join(" ");
            // Segmento ST destacado (pequeño tramo tras J)
            const stHL = `M 65 ${y - 6} l 22 0`;
            return `
        <path class="trace muted" d="${path}" />
        <path class="trace hl crit" d="${stHL}" />
        <text x="6" y="${y - 10}" class="label-lead">${label}</text>
      `;
          };
          const inner = `
      ${lead(-14, "DII")}
      ${lead(+14, "DIII")}
    `;
          return wrapSVG(
            inner,
            "IAMCEST inferior (ST elevado en DII–DIII)",
            "Icono esquemático: ST elevado en derivaciones inferiores y segmento resaltado.",
            "Segmento ST resaltado (rojo) en DII–DIII"
          );
        }

        // 2) Isquemia anterior: ST descendido V2–V4 (segmento ST en azul primario)
        function icon_st_depression_anterior() {
          const lead = (x0, label, y = BASE) => {
            const path = [
              `M ${x0} ${y}`,
              `l 10 0 l 4 -3 l 6 3`, // P
              `l 12 0`, // PR
              `l -3 4 l 7 -16 l 7 16 l -2 -4`, // QRS
              `l 16 6`, // ST descendido (baja 6)
              `c 12 10, 26 10, 30 -8`, // T “pendiente”
              `l -81 0`,
            ].join(" ");
            const stHL = `M ${x0 + 55} ${y + 6} l 16 0`;
            return `
        <path class="trace muted" d="${path}" />
        <path class="trace hl" d="${stHL}" />
        <text x="${x0 - 18}" y="${y - 8}" class="label-lead">${label}</text>
      `;
          };
          const inner = `
      ${lead(18, "V2")}
      ${lead(18, "V3", BASE + 26)}
      ${lead(18, "V4", BASE - 26)}
    `;
          return wrapSVG(
            inner,
            "Isquemia anterior (ST descendido V2–V4)",
            "Icono esquemático: descenso de ST anterior con segmento resaltado.",
            "ST descendido (azul) en V2–V4"
          );
        }

        // 3) Brugada tipo 1 en V1 (coved, T negativa). Resalta porción cóncava.
        function icon_brugada_tipo1() {
          const y = BASE;
          const base = [
            `M 14 ${y}`,
            `l 12 0 l 4 -3 l 6 3`, // P
            `l 12 0`, // PR
            `l -3 4 l 7 -18 l 7 18 l -3 -4`, // QRS
            `l 10 -4`, // J con elevación
            `c 22 -10, 42 2, 28 16`, // coved (convexo hacia arriba que cae)
            `c -10 10, -22 12, -36 2`, // baja hacia T negativa
            `c -8 -10, -18 -6, -26 2`, // T negativa
            `l -38 0`,
          ].join(" ");
          // tramo "coved" resaltado
          const hl = `M 64 ${y - 4} c 22 -10, 42 2, 28 16`;
          const inner = `
      <path class="trace muted" d="${base}" />
      <path class="trace hl crit" d="${hl}" />
      <text x="6" y="${y - 10}" class="label-lead">V1</text>
    `;
          return wrapSVG(
            inner,
            "Brugada tipo 1 en V1",
            "Icono esquemático: elevación con morfología “coved” y T negativa.",
            "Cúpula “coved” (rojo) diagnóstica"
          );
        }

        // 4) Wellens tipo B (T profundas simétricas en V2–V3)
        function icon_wellens_tipoB() {
          const lead = (x0, label, y = BASE) => {
            const path = [
              `M ${x0} ${y}`,
              `l 10 0 l 3 -3 l 6 3`, // P
              `l 12 0`,
              `l -3 4 l 7 -16 l 7 16 l -2 -4`, // QRS
              `l 14 0`,
              `c 10 0, 16 -2, 18 -6`, // inicio T
              `c -6 20, -26 20, -32 0`, // T profunda simétrica
              `l -40 0`,
            ].join(" ");
            // resaltar porción inferior de la T
            const hl = `M ${x0 + 58} ${y + 8} c -6 20, -26 20, -32 0`;
            return `
        <path class="trace muted" d="${path}" />
        <path class="trace hl" d="${hl}" />
        <text x="${x0 - 18}" y="${y - 8}" class="label-lead">${label}</text>
      `;
          };
          const inner = `
      ${lead(18, "V2")}
      ${lead(18, "V3", BASE + 26)}
    `;
          return wrapSVG(
            inner,
            "Wellens tipo B (T negativas profundas V2–V3)",
            "Icono esquemático: T profundas y simétricas en V2–V3 tras dolor.",
            "Porción inferior de T resaltada"
          );
        }

        // 5) HVI por Sokolow (S V1 + R V5) y strain lateral
        function icon_hvi_sokolow() {
          const v1 = (() => {
            const y = BASE + 4,
              x0 = 18;
            const path = [
              `M ${x0} ${y}`,
              `l 10 0 l 3 -3 l 6 3`,
              `l 10 0`,
              `l -3 4 l 7 -14 l 7 14 l -2 -4`,
              `l 10 0`,
              `l -6 18`, // S profunda
              `l -42 0`,
            ].join(" ");
            const hl = `M ${x0 + 52} ${y + 18} l -6 0`;
            return `
        <path class="trace muted" d="${path}"/>
        <path class="trace hl" d="${hl}"/>
        <text x="${x0 - 18}" y="${y - 8}" class="label-lead">V1</text>
      `;
          })();

          const v5 = (() => {
            const y = BASE - 6,
              x0 = 210;
            const path = [
              `M ${x0} ${y}`,
              `l 10 0 l 3 -3 l 6 3`,
              `l 10 0`,
              `l -3 4 l 7 -14 l 7 14 l -2 -4`,
              `l 10 0`,
              `l 0 -20`, // R alta
              `c 18 8, 24 12, 28 0`, // inicio ST/strain
              `c 6 -10, -10 -14, -22 -8`,
              `l -54 18`,
            ].join(" ");
            const hl = `M ${x0 + 50} ${y - 20} l 0 20`; // resaltar R
            return `
        <path class="trace muted" d="${path}"/>
        <path class="trace hl" d="${hl}"/>
        <text x="${x0 - 18}" y="${y - 8}" class="label-lead">V5</text>
      `;
          })();

          const inner = `${v1}${v5}`;
          return wrapSVG(
            inner,
            "HVI (Sokolow-Lyon: S V1 + R V5)",
            "Icono esquemático: S profunda en V1 y R alta en V5 (strain opcional).",
            "Se resaltan S(V1) y R(V5) (azul). Criterio: S(V1)+R(V5) ≥ 35 mm"
          );
        }

        // 6) WPW: PR corto + onda delta
        function icon_wpw_delta() {
          const y = BASE,
            x0 = 18;
          const path = [
            `M ${x0} ${y}`,
            `l 10 0 l 3 -3 l 6 3`, // P
            `l 6 0`, // PR corto
            `l 8 -4`, // delta (ascenso lento)
            `l 6 -12 l 6 12 l -3 -4`, // resto QRS
            `l 14 0`, // ST-T neutro
            `c 16 0, 22 8, 0 16`, // T
            `l -54 0`,
          ].join(" ");
          const hl = `M ${x0 + 25} ${y} l 8 -4`; // resaltar delta
          return wrapSVG(
            `<path class="trace muted" d="${path}"/><path class="trace hl" d="${hl}"/><text x="${
              x0 - 18
            }" y="${y - 10}" class="label-lead">DII</text>`,
            "Preexcitación (WPW): onda delta y PR corto",
            "Icono esquemático: ascenso inicial lento (delta) con PR corto.",
            "Onda delta (azul) resaltada"
          );
        }

        // Catálogo público
        const ICONS = {
          stemi_inferior: icon_stemi_inferior,
          st_dep_anterior: icon_st_depression_anterior,
          brugada_tipo1: icon_brugada_tipo1,
          wellens_tipoB: icon_wellens_tipoB,
          hvi_sokolow: icon_hvi_sokolow,
          wpw_delta: icon_wpw_delta,
        };

        const ECGSVG = {
          icons: ICONS,
          render(el, id) {
            const fn = ICONS[id];
            el.innerHTML = fn
              ? fn()
              : `<div style="color:var(--g500);font-size:12px">Icono "${id}" no encontrado</div>`;
          },
          renderAll() {
            document
              .querySelectorAll(".ecg-icon[data-id]")
              .forEach((el) => ECGSVG.render(el, el.dataset.id));
          },
        };
        window.ECGSVG = ECGSVG;
      })();
    </script>
  </body>
</html>
