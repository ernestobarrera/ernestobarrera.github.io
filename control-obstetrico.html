<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Control Obstétrico - Guía Clínica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
        min-height: 100vh;
      }
      .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
      }
      .card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .timeline-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
      }
      .timeline-card {
        position: relative;
        padding: 1.25rem;
        transition: all 0.3s ease;
        border-left-width: 3px;
      }
      /* Colores base para las tarjetas de la cronología */
      .timeline-card-ap {
        background-color: #f0fdf4;
        border-left-color: #22c55e;
      }
      .timeline-card-hosp {
        background-color: #eff6ff;
        border-left-color: #3b82f6;
      }

      .timeline-card.completed {
        opacity: 0.7;
      }
      .timeline-card.current {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .filter-btn {
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        border: 1px solid transparent;
      }
      .filter-btn.active {
        background-color: #3b82f6;
        color: white;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
      }
      .filter-btn:not(.active) {
        background-color: #e5e7eb;
        color: #374151;
        border-color: #d1d5db;
      }
      .filter-btn:not(.active):hover {
        background-color: #d1d5db;
      }

      .progress-ring {
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
        transition: stroke-dashoffset 0.5s ease;
      }
      .pulse-dot {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .alert-banner {
        background: linear-gradient(90deg, #fef2f2 0%, #fee2e2 100%);
        border-left: 4px solid #ef4444;
        padding: 1rem;
        border-radius: 8px;
        animation: slideIn 0.3s ease;
      }
      .warning-banner {
        background: linear-gradient(90deg, #fffbeb 0%, #fef3c7 100%);
        border-left: 4px solid #f59e0b;
        padding: 1rem;
        border-radius: 8px;
        animation: slideIn 0.3s ease;
      }
      .info-banner {
        background: linear-gradient(90deg, #eff6ff 0%, #dbeafe 100%);
        border-left: 4px solid #3b82f6;
        padding: 1rem;
        border-radius: 8px;
        animation: slideIn 0.3s ease;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .spinner {
        border: 3px solid #e5e7eb;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @media print {
        body {
          background: white;
        }
        .no-print {
          display: none !important;
        }
        .timeline-grid {
          grid-template-columns: 1fr;
        }
        .card {
          box-shadow: none;
          border: 1px solid #e5e7eb;
        }
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <div id="loading" class="loading-overlay hidden">
      <div class="spinner"></div>
    </div>

    <div class="max-w-7xl mx-auto">
      <header class="mb-8">
        <div
          class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6"
        >
          <div class="flex items-center gap-4">
            <div
              class="bg-gradient-to-br from-blue-500 to-blue-600 p-3 rounded-2xl text-white shadow-lg"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M12 2c-5.523 0-10 4.477-10 10s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"
                />
                <path d="M12.5 8H11v6l5.25 3.15.75-1.23-4.5-2.67z" />
              </svg>
            </div>
            <div>
              <h1 class="text-3xl font-bold text-gray-800">Panel Obstétrico</h1>
              <p class="text-gray-500">
                Calculadora gestacional basada en guías clínicas
              </p>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
            <div class="card p-4 flex-grow">
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Método de Cálculo</label
              >
              <div class="flex items-center gap-4 mb-3">
                <label class="flex items-center gap-2 cursor-pointer"
                  ><input
                    type="radio"
                    name="calcMethod"
                    id="method-fur"
                    value="fur"
                    checked
                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                  /><span>FUR</span></label
                >
                <label class="flex items-center gap-2 cursor-pointer"
                  ><input
                    type="radio"
                    name="calcMethod"
                    id="method-eco"
                    value="eco"
                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                  /><span>Ecografía</span></label
                >
              </div>
              <div id="fur-inputs">
                <label
                  for="fur-date"
                  class="block text-xs font-medium text-gray-600 mb-1"
                  >Fecha Última Regla</label
                >
                <input
                  type="date"
                  id="fur-date"
                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
              <div id="eco-inputs" class="hidden">
                <label
                  for="eco-date"
                  class="block text-xs font-medium text-gray-600 mb-1"
                  >Fecha de la Ecografía</label
                >
                <input
                  type="date"
                  id="eco-date"
                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-2"
                />
                <label class="block text-xs font-medium text-gray-600 mb-1"
                  >EG en la ecografía</label
                >
                <div class="flex gap-2">
                  <input
                    type="number"
                    id="eco-weeks"
                    placeholder="Semanas"
                    class="w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <input
                    type="number"
                    id="eco-days"
                    placeholder="Días"
                    class="w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>
            </div>
            <div class="card p-4">
              <label
                for="calc-date"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Fecha de Cálculo</label
              >
              <input
                type="date"
                id="calc-date"
                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>
        </div>
      </header>

      <div id="messages-container" class="mb-6 space-y-3"></div>

      <main id="results-container" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
          <div class="card p-6">
            <p class="text-sm text-gray-500 mb-1">Edad Gestacional</p>
            <p
              id="gestational-age"
              class="text-2xl font-bold text-gray-800"
            ></p>
            <p id="gestational-days" class="text-xs text-gray-500 mt-1"></p>
          </div>
          <div class="card p-6">
            <p class="text-sm text-gray-500 mb-1">FPP (Fecha Probable)</p>
            <p id="edd" class="text-2xl font-bold text-gray-800"></p>
            <p id="days-to-edd" class="text-xs text-gray-500 mt-1"></p>
          </div>
          <div class="card p-6">
            <p class="text-sm text-gray-500 mb-1">Trimestre</p>
            <p id="trimester" class="text-2xl font-bold text-gray-800"></p>
            <p id="trimester-week" class="text-xs text-gray-500 mt-1"></p>
          </div>
          <div class="card p-6 flex flex-col items-center justify-center">
            <svg class="w-24 h-24" viewBox="0 0 100 100">
              <circle
                cx="50"
                cy="50"
                r="45"
                stroke="#e5e7eb"
                stroke-width="8"
                fill="transparent"
              />
              <circle
                id="progress-ring"
                class="progress-ring"
                cx="50"
                cy="50"
                r="45"
                stroke="#3b82f6"
                stroke-width="8"
                fill="transparent"
                stroke-linecap="round"
              />
            </svg>
            <p id="progress-text" class="text-2xl font-bold text-blue-600 mt-2">
              0%
            </p>
            <p class="text-xs text-gray-500">Progreso gestación</p>
          </div>
          <div class="card p-6 flex flex-col gap-2 no-print">
            <div class="flex gap-2">
              <button
                id="copy-brief-btn"
                class="flex-1 flex items-center justify-center gap-1 bg-slate-700 text-white px-2 py-2 rounded-lg hover:bg-slate-800 transition-all text-sm"
                title="Copiar resumen breve para historia clínica (Ctrl+C)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="9" y="9" width="13" height="13" rx="2" />
                  <path
                    d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                  /></svg
                ><span>Copiar Resumen</span>
              </button>
              <button
                id="copy-full-btn"
                class="flex-1 flex items-center justify-center gap-1 bg-slate-600 text-white px-2 py-2 rounded-lg hover:bg-slate-700 transition-all text-sm"
                title="Copiar informe completo con próximos controles"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="9" y="9" width="13" height="13" rx="2" />
                  <path
                    d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                  /></svg
                ><span>Copiar Informe</span>
              </button>
            </div>
            <button
              id="pdf-btn"
              class="flex items-center justify-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                />
                <polyline points="14 2 14 8 20 8" /></svg
              ><span>Generar PDF</span>
            </button>
            <button
              id="clear-btn"
              class="flex items-center justify-center gap-2 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"
                /></svg
              ><span>Limpiar</span>
            </button>
          </div>
        </div>

        <div id="next-appointment" class="hidden mb-6">
          <div class="info-banner">
            <div class="flex items-start gap-3">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-blue-600 mt-0.5"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                  clip-rule="evenodd"
                />
              </svg>
              <div>
                <p class="font-semibold text-gray-800">
                  Próxima cita recomendada
                </p>
                <p
                  id="next-appointment-text"
                  class="text-gray-600 text-sm mt-1"
                ></p>
              </div>
            </div>
          </div>
        </div>

        <div class="card p-6 mb-8">
          <div
            class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-6"
          >
            <h2 class="text-xl font-bold text-gray-800">
              Cronograma de Controles
            </h2>
            <div id="timeline-filters" class="flex items-center gap-2 no-print">
              <button data-filter="all" class="filter-btn active">Todos</button>
              <button data-filter="AP" class="filter-btn">At. Primaria</button>
              <button data-filter="Hosp" class="filter-btn">Hospital</button>
            </div>
          </div>
          <div
            class="flex flex-wrap gap-x-6 gap-y-2 text-xs text-gray-600 mb-6 p-3 bg-gray-50 rounded-lg no-print"
          >
            <span class="flex items-center gap-2"
              ><div
                class="w-3 h-3 rounded-full bg-emerald-100 border border-emerald-400"
              ></div>
              Atención Primaria</span
            >
            <span class="flex items-center gap-2"
              ><div
                class="w-3 h-3 rounded-full bg-blue-100 border border-blue-400"
              ></div>
              Atención Hospitalaria</span
            >
            <span class="flex items-center gap-1"
              ><strong class="text-red-500">★</strong>Control Esencial</span
            >
          </div>
          <div id="timeline" class="timeline-grid"></div>
        </div>

        <div class="card p-6 mb-8">
          <h2 class="text-xl font-bold text-gray-800 mb-6">
            Recomendaciones del Trimestre
          </h2>
          <div id="recommendations" class="space-y-4"></div>
        </div>
        <div class="card p-6 mb-8">
          <h2 class="text-xl font-bold text-gray-800 mb-6">
            Criterios de Derivación a Alto Riesgo
          </h2>
          <div class="text-sm text-gray-700 space-y-3">
            <p class="italic text-gray-600">
              Esta es una lista de recordatorio para el profesional, no una
              herramienta de autodiagnóstico. Si se cumple algún criterio, se
              debe valorar la derivación al circuito de alto riesgo obstétrico.
            </p>
            <ul class="list-disc list-inside space-y-2">
              <li>
                <b>Factores sociodemográficos:</b> IMC &gt; 35, edad &gt; 40 con
                patología, adicciones.
              </li>
              <li>
                <b>Malos antecedentes obstétricos:</b> Aborto de repetición, CIR
                precoz previo, preeclampsia previa, mortalidad perinatal previa.
              </li>
              <li>
                <b>Patología médica materna:</b> Diabetes, cardiopatías, VIH,
                nefropatía, enfermedades autoinmunes, patología psiquiátrica
                grave.
              </li>
              <li>
                <b>Situaciones en la gestación actual:</b> Gestación múltiple,
                hipertensión gestacional, crecimiento intrauterino retardado
                (CIR), placenta previa, isoinmunización.
              </li>
            </ul>
          </div>
        </div>
        <div class="card p-6 mb-8">
          <h2 class="text-xl font-bold text-gray-800 mb-6">
            Planificación del Postparto
          </h2>
          <div id="postpartum-recommendations" class="space-y-4">
            <div
              class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-5"
            >
              <ul class="space-y-2">
                <li class="flex items-start gap-3">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 text-indigo-500 mt-0.5 flex-shrink-0"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                      clip-rule="evenodd"
                    /></svg
                  ><span class="text-gray-700"
                    ><b>Cita para el recién nacido:</b> Recomendada a las 48-72h
                    tras el alta hospitalaria con Pediatría y Enfermería de
                    AP.</span
                  >
                </li>
                <li class="flex items-start gap-3">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 text-indigo-500 mt-0.5 flex-shrink-0"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                      clip-rule="evenodd"
                    /></svg
                  ><span class="text-gray-700"
                    ><b>Cita para la madre:</b> Recomendada revisión con la
                    matrona entre el 7º y 10º día postparto.</span
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div class="text-center text-xs text-gray-500 mt-8">
          <p>Basado en protocolos y guías de práctica clínica actualizadas.</p>
        </div>
      </main>

      <div id="initial-state" class="text-center py-16">
        <div class="card max-w-md mx-auto p-8">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="mx-auto h-16 w-16 text-blue-500 mb-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
            />
          </svg>
          <h2 class="text-2xl font-semibold text-gray-800">
            Calculadora Obstétrica
          </h2>
          <p class="mt-2 text-gray-600">
            Introduce la FUR o los datos de la ecografía para comenzar
          </p>
        </div>
      </div>
    </div>

    <script>
      let state = { fur: null, calcDate: null, results: null };
      let currentFilter = "all";

      // --- ICONOS ---
      const ICONS = {
        Hosp: `<span class="text-blue-600" title="Atención Hospitalaria">${'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.75M9 11.25h6.75M9 15.75h6.75M12 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21" /></svg>'}</span>`,
        AP: `<span class="text-emerald-600" title="Atención Primaria">${'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205l3 1m-3-1l-1.5.545m0 0l-1.5-1.091m1.5 1.091l1.5 1.091m0 0l-1.5 1.636m-1.5-1.636l1.5-1.636" /></svg>'}</span>`,
      };

      const pregnancyMilestones = [
        {
          name: "Ecografía de Datación (Selectiva)",
          idealWeek: 9,
          startMargin: 0,
          endMargin: 14,
          type: "ultrasound",
          description:
            "Recomendada en casos de ciclos irregulares, lactancia, antecedente de ectópico o FUR desconocida.",
          priority: "recommended",
          location: "Hosp",
        },
        {
          name: "Analítica 1er Trimestre",
          idealWeek: 10,
          startMargin: -14,
          endMargin: 14,
          type: "test",
          description: "Hemograma, bioquímica, serologías, TSH.",
          priority: "essential",
          location: "AP",
        },
        {
          name: "Ecografía 1er Trimestre",
          idealWeek: 12,
          startMargin: -7,
          endMargin: 7,
          type: "ultrasound",
          description: "Datación, TN, anatomía precoz.",
          priority: "essential",
          location: "Hosp",
        },
        {
          name: "Primera Visita Obstétrica",
          idealWeek: 12,
          startMargin: -14,
          endMargin: 14,
          type: "visit",
          description: "Historia clínica, exploración, plan de seguimiento.",
          priority: "essential",
          location: "AP",
        },
        {
          name: "Control 2º Trimestre",
          idealWeek: 16,
          startMargin: -7,
          endMargin: 14,
          type: "visit",
          description: "TA, peso, altura uterina, FCF.",
          priority: "recommended",
          location: "AP",
        },
        {
          name: "Vacuna Antigripal",
          idealWeek: 20,
          startMargin: -140,
          endMargin: 140,
          type: "visit",
          description: "Ofertar durante la campaña de vacunación.",
          priority: "recommended",
          location: "AP",
        },
        {
          name: "Ecografía Morfológica",
          idealWeek: 20,
          startMargin: -7,
          endMargin: 14,
          type: "ultrasound",
          description: "Anatomía fetal detallada, placenta.",
          priority: "essential",
          location: "Hosp",
        },
        {
          name: "Test O'Sullivan",
          idealWeek: 24,
          startMargin: -7,
          endMargin: 28,
          type: "test",
          description: "Cribado diabetes gestacional (50g glucosa).",
          priority: "essential",
          location: "AP",
        },
        {
          name: "Vacuna Tosferina (dTpa)",
          idealWeek: 28,
          startMargin: -7,
          endMargin: 56,
          type: "visit",
          description: "Vacunación contra la tosferina, desde la semana 27.",
          priority: "essential",
          location: "AP",
        },
        {
          name: "Control Prenatal y Anti-D",
          idealWeek: 28,
          startMargin: -7,
          endMargin: 7,
          type: "visit",
          description: "Resultados. Poner Gammaglobulina Anti-D si Rh-.",
          priority: "essential",
          location: "AP",
        },
        {
          name: "Control 3er Trimestre",
          idealWeek: 32,
          startMargin: -7,
          endMargin: 7,
          type: "visit",
          description: "Valoración bienestar fetal, presentación.",
          priority: "recommended",
          location: "AP",
        },
        {
          name: "Ecografía 3er Trimestre",
          idealWeek: 34,
          startMargin: -7,
          endMargin: 14,
          type: "ultrasound",
          description: "Crecimiento, líquido amniótico, placenta.",
          priority: "essential",
          location: "Hosp",
        },
        {
          name: "Analítica 3er Trimestre",
          idealWeek: 35,
          startMargin: -7,
          endMargin: 14,
          type: "test",
          description: "Hemograma, coagulación.",
          priority: "essential",
          location: "AP",
        },
        {
          name: "Cultivo SGB",
          idealWeek: 36,
          startMargin: -7,
          endMargin: 7,
          type: "test",
          description: "Exudado vagino-rectal para Estreptococo B.",
          priority: "essential",
          location: "AP",
        },
        {
          name: "Monitorización Fetal",
          idealWeek: 40,
          startMargin: 0,
          endMargin: 7,
          type: "test",
          description: "RCTG, valoración líquido amniótico.",
          priority: "essential",
          location: "Hosp",
        },
        {
          name: "Control Post-término",
          idealWeek: 41,
          startMargin: 0,
          endMargin: 5,
          type: "visit",
          description: "Valoración para finalización gestación.",
          priority: "essential",
          location: "Hosp",
        },
      ];

      const trimesterRecommendations = {
        1: {
          title: "Primer Trimestre (0-13 semanas)",
          items: [
            "Ácido fólico 400mcg/día (hasta sem 12) y Yodo 200mcg/día.",
            "Realizar exploración preventiva de la cavidad oral.",
            "Medidas higiénico-dietéticas para prevenir infecciones (toxoplasmosis, listeriosis).",
            "Evitar alcohol, tabaco y drogas.",
            "Signos de alarma: sangrado, dolor abdominal intenso.",
          ],
        },
        2: {
          title: "Segundo Trimestre (14-27 semanas)",
          items: [
            "Ejercicio moderado regular (caminar, natación).",
            "Iniciar control de movimientos fetales diarios desde la semana 28-30.",
            "Valorar suplementos de hierro según analítica.",
            "Acudir a las clases de educación maternal.",
            "Signos de alarma: pérdida de líquido, contracciones regulares.",
          ],
        },
        3: {
          title: "Tercer Trimestre (28-42 semanas)",
          items: [
            "Controlar movimientos fetales (contactar si hay disminución).",
            "Recibir información sobre el Plan de Parto.",
            "Informarse sobre la donación de sangre de cordón umbilical.",
            "Preparar la bolsa para el hospital.",
            "Signos de alarma: cefalea intensa, visión borrosa, T.A. elevada.",
          ],
        },
      };

      const furInput = document.getElementById("fur-date"),
        calcInput = document.getElementById("calc-date"),
        ecoDateInput = document.getElementById("eco-date"),
        ecoWeeksInput = document.getElementById("eco-weeks"),
        ecoDaysInput = document.getElementById("eco-days"),
        methodRadios = document.querySelectorAll('input[name="calcMethod"]'),
        furInputsDiv = document.getElementById("fur-inputs"),
        ecoInputsDiv = document.getElementById("eco-inputs"),
        resultsContainer = document.getElementById("results-container"),
        initialState = document.getElementById("initial-state"),
        messagesContainer = document.getElementById("messages-container"),
        loading = document.getElementById("loading"),
        filterButtons = document.querySelectorAll(
          "#timeline-filters .filter-btn"
        );

      document.addEventListener("DOMContentLoaded", function () {
        const today = dayjs().format("YYYY-MM-DD");
        calcInput.value = today;
        calcInput.max = today;
        ecoDateInput.max = today;
        loadSavedData();
        methodRadios.forEach((radio) =>
          radio.addEventListener("change", handleMethodChange)
        );
        filterButtons.forEach((btn) =>
          btn.addEventListener("click", () => setFilter(btn.dataset.filter))
        );
        [
          furInput,
          calcInput,
          ecoDateInput,
          ecoWeeksInput,
          ecoDaysInput,
        ].forEach((input) => {
          input.addEventListener("change", handleDateChange);
          input.addEventListener("input", handleDateChange);
        });
        document
          .getElementById("copy-brief-btn")
          .addEventListener("click", copyBriefToClipboard);
        document
          .getElementById("copy-full-btn")
          .addEventListener("click", copyFullToClipboard);
        document
          .getElementById("pdf-btn")
          .addEventListener("click", generatePDF);
        document
          .getElementById("clear-btn")
          .addEventListener("click", clearData);
        document.addEventListener("keydown", function (e) {
          if (
            (e.ctrlKey || e.metaKey) &&
            e.key === "c" &&
            !window.getSelection().toString()
          ) {
            e.preventDefault();
            copyBriefToClipboard();
          }
        });
      });

      function setFilter(filter) {
        currentFilter = filter;
        filterButtons.forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.filter === filter);
        });
        if (state.fur) {
          updateTimeline(state.fur, state.calcDate);
        }
      }

      function handleMethodChange() {
        const selectedMethod = document.querySelector(
          'input[name="calcMethod"]:checked'
        ).value;
        furInputsDiv.classList.toggle("hidden", selectedMethod !== "fur");
        ecoInputsDiv.classList.toggle("hidden", selectedMethod !== "eco");
        handleDateChange();
      }

      function handleDateChange() {
        clearMessages();
        const selectedMethod = document.querySelector(
          'input[name="calcMethod"]:checked'
        ).value;
        const calcDate = dayjs(calcInput.value);
        const today = dayjs();
        let fur;

        const errors = [];
        const warnings = [];

        if (selectedMethod === "fur") {
          if (!furInput.value) {
            showInitialState();
            return;
          }
          if (dayjs(furInput.value).isAfter(today))
            errors.push("La FUR no puede ser una fecha futura.");
          fur = dayjs(furInput.value);
        } else {
          if (!ecoDateInput.value || !ecoWeeksInput.value) {
            showInitialState();
            return;
          }
          if (dayjs(ecoDateInput.value).isAfter(today))
            errors.push("La fecha de la ecografía no puede ser futura.");
          const ecoDate = dayjs(ecoDateInput.value),
            ecoWeeks = parseInt(ecoWeeksInput.value) || 0,
            ecoDays = parseInt(ecoDaysInput.value) || 0;
          fur = ecoDate.subtract(ecoWeeks * 7 + ecoDays, "day");
        }

        if (fur.isAfter(calcDate))
          errors.push(
            "La fecha de partida (FUR o eco) no puede ser posterior a la fecha de cálculo."
          );
        const weeksDiff = calcDate.diff(fur, "week");
        if (weeksDiff > 42) errors.push("El embarazo supera las 42 semanas.");

        if (errors.length > 0) {
          showMessages(errors, "error");
          showInitialState();
          return;
        }

        if (weeksDiff < 4 && weeksDiff >= 0)
          warnings.push("EG < 4 semanas. Considerar confirmar con βhCG.");
        if (warnings.length > 0) showMessages(warnings, "warning");

        calculateAndDisplay(fur, calcDate);
        saveData();
      }

      function calculateAndDisplay(fur, calcDate) {
        const totalDays = calcDate.diff(fur, "day"),
          weeks = Math.floor(totalDays / 7),
          days = totalDays % 7,
          edd = fur.add(280, "day"),
          daysToEdd = edd.diff(calcDate, "day"),
          trimester = weeks < 14 ? 1 : weeks < 28 ? 2 : 3,
          progress = Math.min(Math.max((totalDays / 280) * 100, 0), 100),
          secondTrimesterStart = fur.add(14, "week"),
          thirdTrimesterStart = fur.add(28, "week");
        document.getElementById(
          "gestational-age"
        ).textContent = `${weeks}s ${days}d`;
        document.getElementById(
          "gestational-days"
        ).textContent = `${totalDays} días totales`;
        document.getElementById("edd").textContent = edd.format("DD/MM/YYYY");
        document.getElementById("days-to-edd").textContent =
          daysToEdd > 0
            ? `Faltan ${daysToEdd} días`
            : daysToEdd === 0
            ? `Hoy es la FPP`
            : `Pasado ${Math.abs(daysToEdd)} días`;
        document.getElementById(
          "trimester"
        ).textContent = `${trimester}º Trimestre`;
        document.getElementById(
          "trimester-week"
        ).textContent = `Semana ${weeks} de 40`;
        const progressRing = document.getElementById("progress-ring"),
          radius = 45,
          circumference = 2 * Math.PI * radius;
        progressRing.style.strokeDasharray = circumference;
        progressRing.style.strokeDashoffset =
          circumference - (progress / 100) * circumference;
        document.getElementById("progress-text").textContent = `${Math.round(
          progress
        )}%`;
        state = {
          fur,
          calcDate,
          results: {
            weeks,
            days,
            edd,
            trimester,
            progress,
            secondTrimesterStart,
            thirdTrimesterStart,
            totalDays,
          },
        };
        updateTimeline(fur, calcDate);
        updateRecommendations(trimester);
        findNextAppointment(fur, calcDate);
        resultsContainer.classList.remove("hidden");
        initialState.classList.add("hidden");
      }

      function updateTimeline(fur, calcDate) {
        const timeline = document.getElementById("timeline");
        timeline.innerHTML = "";
        const filteredMilestones =
          currentFilter === "all"
            ? [...pregnancyMilestones]
            : pregnancyMilestones.filter((m) => m.location === currentFilter);

        filteredMilestones
          .sort((a, b) => a.idealWeek - b.idealWeek)
          .forEach((milestone) => {
            const idealDate = fur.add(milestone.idealWeek * 7, "day"),
              startDate = idealDate.add(milestone.startMargin, "day"),
              endDate = idealDate.add(milestone.endMargin, "day");
            let status = "pending",
              statusBadge = "";
            if (calcDate.isAfter(endDate)) {
              status = "completed";
              statusBadge =
                '<span class="badge bg-green-100 text-green-800">✓ Completado</span>';
            } else if (
              calcDate.isAfter(startDate) &&
              calcDate.isBefore(endDate)
            ) {
              status = "current";
              statusBadge =
                '<span class="badge bg-blue-100 text-blue-800 pulse-dot">● Actual</span>';
            } else if (
              calcDate.add(7, "day").isAfter(startDate) &&
              calcDate.isBefore(endDate)
            ) {
              status = "next";
              statusBadge =
                '<span class="badge bg-amber-100 text-amber-800">→ Próximo</span>';
            } else {
              statusBadge =
                '<span class="badge bg-gray-100 text-gray-600">○ Pendiente</span>';
            }

            const locationColorClass =
              milestone.location === "AP"
                ? "timeline-card-ap"
                : "timeline-card-hosp";
            const priorityIcon =
              milestone.priority === "essential"
                ? '<span class="text-red-500 text-xs font-bold">★</span>'
                : "";
            const card = document.createElement("div");
            card.className = `timeline-card ${status} ${locationColorClass}`;
            card.innerHTML = `<div class="flex items-start justify-between mb-2"><div class="flex items-center gap-2"><span class="text-xs font-semibold text-gray-500">Semana ${
              milestone.idealWeek
            }</span>${priorityIcon}</div>${statusBadge}</div><h3 class="font-semibold text-gray-800 mb-2 flex items-center gap-2">${
              ICONS[milestone.location]
            } ${milestone.name}</h3><p class="text-sm text-gray-600 mb-3">${
              milestone.description
            }</p><div class="bg-white/60 rounded-lg p-2"><p class="text-xs text-gray-700"><span class="font-medium">Período:</span><br>${startDate.format(
              "DD/MM/YY"
            )} - ${endDate.format("DD/MM/YY")}</p></div>`;
            timeline.appendChild(card);
          });
      }

      function updateRecommendations(trimester) {
        const recommendations = document.getElementById("recommendations"),
          data = trimesterRecommendations[trimester];
        recommendations.innerHTML = `<div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-5"><h3 class="font-bold text-gray-800 mb-4">${
          data.title
        }</h3><ul class="space-y-2">${data.items
          .map(
            (item) =>
              `<li class="flex items-start gap-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 mt-0.5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg><span class="text-gray-700">${item}</span></li>`
          )
          .join("")}</ul></div>`;
      }
      function findNextAppointment(fur, calcDate) {
        const nextAppointmentDiv = document.getElementById("next-appointment"),
          nextAppointmentText = document.getElementById(
            "next-appointment-text"
          );
        const nextMilestone = [...pregnancyMilestones]
          .sort((a, b) => a.idealWeek - b.idealWeek)
          .find((m) => {
            const startDate = fur
              .add(m.idealWeek * 7, "day")
              .add(m.startMargin, "day");
            return startDate.isAfter(calcDate) && m.priority === "essential";
          });
        if (nextMilestone) {
          const startDate = fur
              .add(nextMilestone.idealWeek * 7, "day")
              .add(nextMilestone.startMargin, "day"),
            daysUntil = startDate.diff(calcDate, "day");
          nextAppointmentText.innerHTML = `<strong>${
            nextMilestone.name
          }</strong> en semana ${nextMilestone.idealWeek} (${
            nextMilestone.location === "AP"
              ? "At. Primaria"
              : "At. Hospitalaria"
          })<br>Fecha recomendada a partir de: <strong>${startDate.format(
            "DD/MM/YYYY"
          )}</strong> (en ${daysUntil} días)`;
          nextAppointmentDiv.classList.remove("hidden");
        } else {
          nextAppointmentDiv.classList.add("hidden");
        }
      }

      function copyBriefToClipboard() {
        if (!state.results) return;
        const text = `CÁLCULO OBSTÉTRICO\nFUR: ${state.fur.format(
          "DD-MM-YYYY"
        )}\nEdad Gestacional: ${state.results.weeks} sem y ${
          state.results.days
        } días\nFPP: ${state.results.edd.format(
          "DD-MM-YYYY"
        )}\n2º Trim: ${state.results.secondTrimesterStart.format(
          "DD-MM-YYYY"
        )}\n3º Trim: ${state.results.thirdTrimesterStart.format("DD-MM-YYYY")}`;
        copyWithFeedback(text, "copy-brief-btn");
      }

      function copyFullToClipboard() {
        if (!state.results) return;
        const nextControls = getUpcomingAppointments(),
          recommendations = getCurrentRecommendations();
        const text = `CÁLCULO OBSTÉTRICO - INFORME COMPLETO\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nFUR (corregida si aplica): ${state.fur.format(
          "DD-MM-YYYY"
        )}\nFecha de cálculo: ${state.calcDate.format(
          "DD-MM-YYYY"
        )}\n\nDATOS GESTACIONALES:\n• Edad gestacional: ${
          state.results.weeks
        } semanas + ${
          state.results.days
        } días\n• FPP: ${state.results.edd.format(
          "DD-MM-YYYY"
        )}\n• Trimestre: ${
          state.results.trimester
        }º\n\nPRÓXIMOS CONTROLES ESENCIALES:\n${nextControls}\n\nRECOMENDACIONES ACTUALES:\n${recommendations}`;
        copyWithFeedback(text, "copy-full-btn");
      }
      function copyWithFeedback(text, buttonId) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            const btn = document.getElementById(buttonId),
              originalHTML = btn.innerHTML,
              originalClass = btn.className;
            btn.innerHTML =
              '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Copiado';
            btn.className = btn.className.replace(
              /bg-slate-\d+/,
              "bg-green-600"
            );
            setTimeout(() => {
              btn.innerHTML = originalHTML;
              btn.className = originalClass;
            }, 2000);
          })
          .catch((err) => {
            console.error("Error al copiar:", err);
            alert("Error al copiar el texto");
          });
      }
      function getUpcomingAppointments() {
        if (!state.fur || !state.calcDate)
          return "• No hay controles pendientes";
        const appointments = [...pregnancyMilestones]
          .sort((a, b) => a.idealWeek - b.idealWeek)
          .filter((m) => {
            const startDate = state.fur
              .add(m.idealWeek * 7, "day")
              .add(m.startMargin, "day");
            return (
              startDate.isAfter(state.calcDate) && m.priority === "essential"
            );
          })
          .slice(0, 3)
          .map((m) => {
            const startDate = state.fur
              .add(m.idealWeek * 7, "day")
              .add(m.startMargin, "day");
            return `• ${m.name} (Sem ${
              m.idealWeek
            }): a partir de ${startDate.format("DD/MM/YYYY")}`;
          });
        return appointments.length > 0
          ? appointments.join("\n")
          : "• No hay controles esenciales pendientes";
      }
      function getCurrentRecommendations() {
        if (!state.results) return "";
        const recs = trimesterRecommendations[state.results.trimester];
        return recs.items
          .slice(0, 3)
          .map((item) => `• ${item}`)
          .join("\n");
      }
      function saveData() {
        const dataToSave = {
          method: document.querySelector('input[name="calcMethod"]:checked')
            .value,
          fur: furInput.value,
          calc: calcInput.value,
          ecoDate: ecoDateInput.value,
          ecoWeeks: ecoWeeksInput.value,
          ecoDays: ecoDaysInput.value,
        };
        localStorage.setItem("obstetric_data", JSON.stringify(dataToSave));
      }
      function loadSavedData() {
        const savedData = localStorage.getItem("obstetric_data");
        if (savedData) {
          const data = JSON.parse(savedData);
          document.querySelector(
            `input[name="calcMethod"][value="${data.method}"]`
          ).checked = true;
          furInput.value = data.fur || "";
          calcInput.value = data.calc || dayjs().format("YYYY-MM-DD");
          ecoDateInput.value = data.ecoDate || "";
          ecoWeeksInput.value = data.ecoWeeks || "";
          ecoDaysInput.value = data.ecoDays || "";
          handleMethodChange();
          handleDateChange();
        }
      }
      function clearData() {
        localStorage.removeItem("obstetric_data");
        document.getElementById("method-fur").checked = true;
        furInput.value = "";
        calcInput.value = dayjs().format("YYYY-MM-DD");
        ecoDateInput.value = "";
        ecoWeeksInput.value = "";
        ecoDaysInput.value = "";
        currentFilter = "all";
        setFilter("all");
        handleMethodChange();
        showInitialState();
        clearMessages();
      }
      function showInitialState() {
        resultsContainer.classList.add("hidden");
        initialState.classList.remove("hidden");
      }
      function showMessages(messages, type) {
        const container = messagesContainer;
        messages.forEach((message) => {
          const div = document.createElement("div");
          div.className = type === "error" ? "alert-banner" : "warning-banner";
          div.innerHTML = `<div class="flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${
            type === "error" ? "text-red-600" : "text-amber-600"
          }" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg><span class="font-medium ${
            type === "error" ? "text-red-800" : "text-amber-800"
          }">${message}</span></div>`;
          container.appendChild(div);
        });
      }
      function clearMessages() {
        messagesContainer.innerHTML = "";
      }
      function showLoading() {
        loading.classList.remove("hidden");
      }
      function hideLoading() {
        loading.classList.add("hidden");
      }
      function generatePDF() {
        /* PDF generation logic omitted for brevity */
      }
    </script>
  </body>
</html>
