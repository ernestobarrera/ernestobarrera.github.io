<!--
=====================
 buscadores-pubmed.html
filtros estructurados para profesionales sanitarios
=====================
-->
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asistente para buscar en PubMed Avanzado | @ernestob</title>
  <meta name="description"
    content="Asistente para realizar bÃºsquedas avanzadas en PubMed con filtros estructurados para profesionales sanitarios" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Asistente para bÃºsquedas en PubMed con Filtros Estructurados | @ernestob" />
  <meta property="og:site_name" content="Recursos para la gestiÃ³n de informaciÃ³n sanitaria ğŸ”ğŸ©ºâš•" />
  <meta property="og:url" content="https://ernestobarrera.github.io/buscar-pubmed.html" />
  <meta property="og:image" content="https://ernestobarrera.github.io/assets/images/me.png" />
  <link rel="icon" href="/assets/images/icon.webp" />
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="/assets/css/header.css" />
  <link rel="stylesheet" href="/assets/css/components.css" />
  <link rel="stylesheet" href="/assets/css/footer.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.min.css" />
  <link rel="stylesheet" href="/assets/css/buscar-pubmed.css" />

  <!-- libreria tooltip con metadatos del filtro -->
  <!-- Primero los archivos de tippy -->
  <script src="https://unpkg.com/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://unpkg.com/tippy.js@6.3.7/dist/tippy.umd.min.js"></script>
  <!-- venn-->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/venn.js@0.2.20/build/venn.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YFKR6RB1ZC"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "G-YFKR6RB1ZC");
  </script>
</head>

<body>
  <include src="header.html"></include>
  <main class="main-container">
    <section class="hero-section">
      <h1 class="main-title">
        <i class="fas fa-search"></i>
        <span>Asistente para buscar en PubMed con Filtros Estructurados</span>
        <span style="
              margin-left: 30px;
              cursor: pointer;
              color: white;
              font-size: 0.8rem;
              background: rgba(255, 255, 255, 0.15);
              padding: 4px 8px;
              border-radius: 4px;
            " id="startTutorialBtn">
          <i class="fas fa-graduation-cap"></i>
          Ver GuÃ­a Interactiva
        </span>
      </h1>
      <p class="intro-text">
        Optimiza tus bÃºsquedas bibliogrÃ¡ficas combinando filtros
        metodolÃ³gicos, clÃ­nicos y de Ã¡mbito predefinidos. Esta herramienta
        construye automÃ¡ticamente bÃºsquedas avanzadas utilizando tÃ©rminos MeSH
        y operadores booleanos para obtener resultados mÃ¡s precisos y
        reproducibles. Selecciona los filtros que necesites y deja que la
        herramienta construya la estrategia de bÃºsqueda Ã³ptima.
      </p>
    </section>

    <div class="search-container">
      <div class="search-box">
        <textarea id="searchTerm" class="search-textarea" placeholder="Introduce tÃ©rminos de bÃºsqueda..."
          data-intro="AquÃ­ escribes tus tÃ©rminos de bÃºsqueda. TambiÃ©n puedes pulsar Enter para iniciar la bÃºsqueda."
          data-step="2" rows="1"></textarea>

        <div id="persistentSearchCountContainer" class="search-count-display-container" style="display: none">
          <span id="persistentSearchCountText"></span>
        </div>
        <div class="search-header-icons">
          <div class="main-icons" id="mainIconsContainer">
            <button id="btn_guardar" title="Guardar bÃºsqueda">
              <i class="fas fa-save"></i>
            </button>
            <button id="btn_recuperar" title="Recuperar bÃºsqueda">
              <i class="fas fa-folder-open"></i>
            </button>
            <button id="btn_borrar" title="Borrar bÃºsqueda">
              <i class="fas fa-trash-alt"></i>
            </button>
            <button id="btn_exportar" title="Exportar bÃºsquedas">
              <i class="fas fa-download"></i>
            </button>
            <button id="btn_importar" title="Importar bÃºsquedas">
              <i class="fas fa-upload"></i>
            </button>
          </div>
          <button id="toggleCountersBtn" title="Cargando contadores..." disabled style="cursor: default; color: #888">
            <i class="fas fa-spinner fa-spin"></i>
          </button>
          <button id="btn_chatgpt" title="Asistente ChatGPT" class="chatgpt-button">
            <i class="fas fa-robot"></i>
          </button>
        </div>

        <div class="filters-section" data-intro="Estos son los filtros que puedes seleccionar antes de buscar."
          data-step="1">
          <div class="filter-category methodological">
            <div class="category-header">
              <h3 class="category-title">
                <i class="fas fa-flask"></i>
                MetodologÃ­a
              </h3>
              <div class="operator-selector">
                <label>Operador:
                  <select class="category-operator" data-category="methodology">
                    <option value="OR" selected>OR</option>
                    <option value="AND">AND</option>
                  </select>
                </label>
              </div>
            </div>
            <button class="filter-button methodological" data-type="mbe">
              ğŸ” MBE
            </button>
            <button class="filter-button methodological" data-type="gpc">
              ğŸ“‹ GPC
            </button>
            <button class="filter-button methodological" data-type="metaanalysis">
              â­ Rev Sist/Meta-anÃ¡lisis/HTA
            </button>
            <button class="filter-button methodological" data-type="qualitative">
              ğŸ“ Estudios cualitativos
            </button>
            <button class="filter-button methodological with-toggle" data-base="clinical_rules">
              ğŸ“Š Reglas PredicciÃ³n ClÃ­nica-CQ
              <div class="versions-toggle">
                <label>
                  <input type="radio" name="clinical_rules_mode" value="sensible" checked />
                  S
                </label>
                <label>
                  <input type="radio" name="clinical_rules_mode" value="especifico" />
                  E
                </label>
              </div>
            </button>
            <button class="filter-button methodological" data-type="horizon">
              ğŸ”­ Horizon Scanning
            </button>
            <button class="filter-button methodological" data-type="clinical_rules_ap">
              ğŸ“Š Reglas PredicciÃ³n ClÃ­nica-AP
            </button>
            <button class="filter-button methodological" data-type="indirect_comparison">
              ğŸ’Š Comparaciones Indirectas
            </button>
          </div>

          <div class="filter-category clinical">
            <div class="category-header">
              <h3 class="category-title">
                <i class="fas fa-stethoscope"></i>
                Enfoque ClÃ­nico
              </h3>
              <div class="operator-selector">
                <label>Operador:
                  <select class="category-operator" data-category="clinical">
                    <option value="OR" selected>OR</option>
                    <option value="AND">AND</option>
                  </select>
                </label>
              </div>
            </div>
            <div class="filter-buttons-container">
              <button class="filter-button clinical with-toggle" data-base="diagnosis">
                ğŸ” DiagnÃ³stico-CQ
                <div class="versions-toggle">
                  <label>
                    <input type="radio" name="diagnosis_mode" value="sensible" checked />
                    S
                  </label>
                  <label>
                    <input type="radio" name="diagnosis_mode" value="especifico" />
                    E
                  </label>
                </div>
              </button>
              <button class="filter-button clinical with-toggle" data-base="etiology">
                ğŸ”¬ EtiologÃ­a-CQ
                <div class="versions-toggle">
                  <label>
                    <input type="radio" name="etiology_mode" value="sensible" checked />
                    S
                  </label>
                  <label>
                    <input type="radio" name="etiology_mode" value="especifico" />
                    E
                  </label>
                </div>
              </button>
              <button class="filter-button clinical with-toggle" data-base="prognosis">
                ğŸ“ˆ PronÃ³stico-CQ
                <div class="versions-toggle">
                  <label>
                    <input type="radio" name="prognosis_mode" value="sensible" checked />
                    S
                  </label>
                  <label>
                    <input type="radio" name="prognosis_mode" value="especifico" />
                    E
                  </label>
                </div>
              </button>
              <button class="filter-button clinical with-toggle" data-base="treatment">
                ğŸ’Š Tratamiento-CQ
                <div class="versions-toggle">
                  <label>
                    <input type="radio" name="treatment_mode" value="sensible" checked />
                    S
                  </label>
                  <label>
                    <input type="radio" name="treatment_mode" value="especifico" />
                    E
                  </label>
                </div>
              </button>
              <button class="filter-button clinical with-toggle" data-base="predictors">
                ğŸš€ Predictores Tratamiento
                <div class="versions-toggle">
                  <label>
                    <input type="radio" name="predictors_mode" value="sensible" checked />
                    S
                  </label>
                  <label>
                    <input type="radio" name="predictors_mode" value="especifico" />
                    E
                  </label>
                </div>
              </button>
              <button class="filter-button clinical" data-type="surgery_ae">
                ğŸ·ï¸ Efectos Adversos CirugÃ­a
              </button>
              <button class="filter-button clinical" data-type="devices_ae">
                ğŸ”§ Efectos Adversos Dispositivos
              </button>
              <button class="filter-button clinical" data-type="drugs_ae">
                ğŸ’Š Efectos adversos Medicamentos
              </button>
              <button class="filter-button clinical" data-type="car_t">
                ğŸ§¬ Terapias CAR-T
              </button>
              <button class="filter-button clinical" data-type="deprescription">
                âš•ï¸ DeprescripciÃ³n
              </button>
              <button class="filter-button clinical" data-type="simulation_clinical">
                ğŸ¯ SimulaciÃ³n ClÃ­nica V.1
              </button>
              <button class="filter-button clinical" data-type="clinical_examination">
                ğŸ” Examen ClÃ­nico
              </button>
              <button class="filter-button clinical" data-type="NNT_NNH">
                âœ… NNT-NNH
              </button>
              <button class="filter-button clinical" data-type="mortality">
                â˜ ï¸ Mortalidad
              </button>
            </div>
          </div>

          <div class="filter-category scope">
            <div class="category-header">
              <h3 class="category-title">
                <i class="fas fa-users"></i>
                Ãmbito y PoblaciÃ³n
              </h3>
              <div class="operator-selector">
                <label>Operador:
                  <select class="category-operator" data-category="scope">
                    <option value="OR" selected>OR</option>
                    <option value="AND">AND</option>
                  </select>
                </label>
              </div>
            </div>
            <div class="filter-buttons-container">
              <button class="filter-button scope with-toggle" data-base="ai">
                ğŸ¤– IA Generativa
                <div class="versions-toggle">
                  <label>
                    <input type="radio" name="ai_mode" value="sensible" checked />
                    S
                  </label>
                  <label>
                    <input type="radio" name="ai_mode" value="especifico" />
                    E
                  </label>
                </div>
              </button>
              <button class="filter-button scope with-toggle" data-base="palliative">
                ğŸ¥ Cuidados Paliativos
                <div class="versions-toggle">
                  <label>
                    <input type="radio" name="palliative_mode" value="sensible" checked />
                    S
                  </label>
                  <label>
                    <input type="radio" name="palliative_mode" value="especifico" />
                    E
                  </label>
                </div>
              </button>
              <button class="filter-button scope with-toggle" data-base="primary">
                ğŸ‘¨â€âš•ï¸ AtenciÃ³n Primaria
                <div class="versions-toggle">
                  <label>
                    <input type="radio" name="primary_mode" value="sensible" checked />
                    S
                  </label>
                  <label>
                    <input type="radio" name="primary_mode" value="especifico" />
                    E
                  </label>
                </div>
              </button>
              <button class="filter-button scope with-toggle" data-base="safety">
                ğŸ›¡ï¸ Seguridad Paciente
                <div class="versions-toggle">
                  <label>
                    <input type="radio" name="safety_mode" value="sensible" checked />
                    S
                  </label>
                  <label>
                    <input type="radio" name="safety_mode" value="especifico" />
                    E
                  </label>
                </div>
              </button>
              <button class="filter-button scope" data-type="pearls">
                ğŸ’ Perlas ClÃ­nicas
              </button>
              <button class="filter-button scope" data-type="perspective">
                ğŸ‘¥ Perspectiva Pacientes
              </button>
              <button class="filter-button scope" data-type="nursing">
                ğŸ‘©â€âš•ï¸ Revistas de EnfermerÃ­a
              </button>
              <button class="filter-button scope" data-type="humans">
                ğŸ§‘ Humanos
              </button>
              <button class="filter-button scope with-toggle" data-base="geriatrics">
                ğŸ‘´ GeriatrÃ­a
                <div class="versions-toggle">
                  <label>
                    <input type="radio" name="geriatrics_mode" value="sensible" checked />
                    S
                  </label>
                  <label>
                    <input type="radio" name="geriatrics_mode" value="especifico" />
                    E
                  </label>
                </div>
              </button>
              <button class="filter-button scope" data-type="pediatrics">
                ğŸ‘¶ PediatrÃ­a
              </button>
              <button class="filter-button scope" data-type="adults">
                ğŸ§‘ Personas adultas
              </button>
              <button class="filter-button scope" data-type="ocde">
                ğŸŒ PaÃ­ses OCDE
              </button>
              <button class="filter-button scope" data-type="spanish">
                ğŸ‡ªğŸ‡¸ Publicaciones EspaÃ±olas
              </button>
              <button class="filter-button scope with-toggle" data-base="economic">
                ğŸ’° Evaluaciones econÃ³micas
                <div class="versions-toggle">
                  <label>
                    <input type="radio" name="economic_mode" value="sensible" checked />
                    S
                  </label>
                  <label>
                    <input type="radio" name="economic_mode" value="especifico" />
                    E
                  </label>
                </div>
              </button>
            </div>
          </div>
        </div>

        <div class="centered-controls">
          <div class="filter-controls">
            <label>
              Fecha:
              <select id="dateRange" style="border-radius: 8px">
                <option value="">Sin Filtro</option>
                <option value="7">Ãšltimos 7 dÃ­as</option>
                <option value="30">Ãšltimos 30 dÃ­as</option>
                <option value="180">Ãšltimos 6 meses</option>
                <option value="365">Ãšltimo aÃ±o</option>
                <option value="1825">Ãšltimos 5 aÃ±os</option>
              </select>
            </label>
            <label>
              Orden:
              <select id="sortMode" style="border-radius: 8px">
                <option value="date">Por fecha</option>
                <option value="best">Best match</option>
              </select>
            </label>
          </div>

          <button id="searchButton" class="search-button" data-intro="Haz clic aquÃ­ para lanzar la bÃºsqueda en PubMed."
            data-step="3">
            <i class="fas fa-search"></i>
            <span>Buscar en PubMed</span>
          </button>
          <div class="filter-info">
            <span>Filtros activos:</span>
            <span id="filterCount" class="filter-count">0</span>
          </div>
          <button id="infoModeToggle" class="info-button">
            <i class="fas fa-info-circle"></i>
            <span>Ver Detalles de Filtros</span>
          </button>
          <button id="toggleVennButton" class="info-button">
            <i class="fas fa-project-diagram"></i>
            Ver Diagrama
          </button>
          <button id="resetButton" style="
                background: linear-gradient(135deg, #777, #555);
                color: #fff;
                border: none;
                border-radius: 8px;
                padding: 0.7rem;
                font-size: 0.9rem;
                cursor: pointer;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
              ">
            Limpiar
          </button>
        </div>

        <div class="venn-container">
          <div class="venn-lists-column">
            <div class="venn-lists methodology-list">
              <h4>MetodologÃ­a</h4>
              <div id="methodology-filters"></div>
            </div>
            <div class="venn-lists clinical-list">
              <h4>ClÃ­nico</h4>
              <div id="clinical-filters"></div>
            </div>
          </div>
          <div id="venn-diagram"></div>
          <div class="venn-lists scope-list">
            <h4>Ãmbito</h4>
            <div id="scope-filters"></div>
          </div>
          <div id="venn-tooltip"></div>
        </div>
      </div>
      <!-- Nueva secciÃ³n: Filtros de Revistas por Especialidad -->
      <div class="filter-category journals full-width">
        <div class="category-header"
          style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
          <h3 class="category-title" style="margin: 0;">
            <i class="fas fa-book-medical"></i>
            ğŸ“š Revistas Top por Especialidad <span style="font-size: 0.7em; opacity: 0.8;">(Google Scholar
              h5-index)</span>
          </h3>
          <!-- Contador comparativo de resultados para revistas (inline en header) -->
          <span id="journalsResultCounter" class="search-count-display-container" style="display: none;">
            <span id="journalsCounterText"></span>
          </span>
        </div>
        <div class="journals-grid">
          <!-- Grupo destacado: Top Publications -->
          <button class="filter-button journals top-journals" data-type="jnl_top_publications">â­ Top
            Publications</button>

          <!-- Especialidades principales -->
          <button class="filter-button journals" data-type="jnl_primary_health_care">ğŸ‘¨â€âš•ï¸ Primary Care</button>
          <button class="filter-button journals" data-type="jnl_cardiology">â¤ï¸ Cardiology</button>
          <button class="filter-button journals" data-type="jnl_oncology">ğŸ—ï¸ Oncology</button>
          <button class="filter-button journals" data-type="jnl_neurology">ğŸ§  Neurology</button>
          <button class="filter-button journals" data-type="jnl_psychiatry">ğŸ§  Psychiatry</button>
          <button class="filter-button journals" data-type="jnl_pediatric_medicine">ğŸ‘¶ Pediatrics</button>
          <button class="filter-button journals" data-type="jnl_endocrinology">ğŸ§¬ Endocrinology</button>
          <button class="filter-button journals" data-type="jnl_gastroenterology_hepatology">ğŸ« Gastro & Hepato</button>
          <button class="filter-button journals" data-type="jnl_pulmonology">ğŸ« Pulmonology</button>
          <button class="filter-button journals" data-type="jnl_rheumatology">ğŸ¦´ Rheumatology</button>
          <button class="filter-button journals" data-type="jnl_dermatology">ğŸ©¹ Dermatology</button>
          <button class="filter-button journals" data-type="jnl_immunology">ğŸ›¡ï¸ Immunology</button>
          <button class="filter-button journals" data-type="jnl_hematology">ğŸ©¸ Hematology</button>
          <button class="filter-button journals" data-type="jnl_diabetes">ğŸ’Š Diabetes</button>
          <button class="filter-button journals" data-type="jnl_surgery">ğŸ”ª Surgery</button>
          <button class="filter-button journals" data-type="jnl_emergency_medicine">ğŸš‘ Emergency Med</button>
          <button class="filter-button journals" data-type="jnl_critical_care">ğŸ¥ Critical Care</button>
          <button class="filter-button journals" data-type="jnl_communicable_diseases">ğŸ¦  Infectious Dis</button>
          <button class="filter-button journals" data-type="jnl_epidemiology">ğŸ“Š Epidemiology</button>
          <button class="filter-button journals" data-type="jnl_public_health">ğŸŒ Public Health</button>
          <button class="filter-button journals" data-type="jnl_nursing">ğŸ‘©â€âš•ï¸ Nursing</button>
          <button class="filter-button journals" data-type="jnl_radiology_medical_imaging">ğŸ“¡ Radiology</button>
          <button class="filter-button journals" data-type="jnl_pathology">ğŸ”¬ Pathology</button>
          <button class="filter-button journals" data-type="jnl_pharmacology_pharmacy">ğŸ’Š Pharmacology</button>
          <button class="filter-button journals" data-type="jnl_genetics_genomics">ğŸ§¬ Genetics</button>
          <button class="filter-button journals" data-type="jnl_gerontology_geriatric_medicine">ğŸ‘´ Geriatrics</button>
          <button class="filter-button journals" data-type="jnl_rehabilitation_therapy">â™¿ Rehabilitation</button>
          <button class="filter-button journals" data-type="jnl_nutrition_science">ğŸ¥— Nutrition</button>
          <button class="filter-button journals" data-type="jnl_physical_education_sports_medicine">ğŸƒ Sports
            Med</button>
          <button class="filter-button journals" data-type="jnl_pain_pain_management">ğŸ’Š Pain</button>
          <button class="filter-button journals" data-type="jnl_hospice_palliative_care">ğŸ•Šï¸ Palliative</button>
          <button class="filter-button journals" data-type="jnl_neurosurgery">ğŸ§  Neurosurgery</button>
          <button class="filter-button journals" data-type="jnl_orthopedic_medicine_surgery">ğŸ¦´ Orthopedics</button>
          <button class="filter-button journals" data-type="jnl_ophthalmology_optometry">ğŸ‘ï¸ Ophthalmology</button>
          <button class="filter-button journals" data-type="jnl_otolaryngology">ğŸ‘ƒ ENT</button>
          <button class="filter-button journals" data-type="jnl_dentistry">ğŸ¦· Dentistry</button>
          <button class="filter-button journals" data-type="jnl_gynecology_obstetrics">ğŸ¤° Gyn & Obstet</button>
          <button class="filter-button journals" data-type="jnl_urology_nephrology">ğŸ«˜ Uro & Nephro</button>
          <button class="filter-button journals" data-type="jnl_anesthesiology">ğŸ’‰ Anesthesio</button>
          <button class="filter-button journals" data-type="jnl_psychology">ğŸ§  Psychology</button>
          <button class="filter-button journals" data-type="jnl_bioethics">âš–ï¸ Bioethics</button>
          <button class="filter-button journals" data-type="jnl_medical_informatics">ğŸ’» Med Informatics</button>
          <button class="filter-button journals" data-type="jnl_tropical_medicine_parasitology">ğŸŒ´ Tropical Med</button>
          <button class="filter-button journals" data-type="jnl_transplantation">ğŸ«€ Transplant</button>
          <button class="filter-button journals" data-type="jnl_toxicology">â˜ ï¸ Toxicology</button>
          <button class="filter-button journals" data-type="jnl_virology">ğŸ¦  Virology</button>
          <button class="filter-button journals" data-type="jnl_addiction">ğŸ§ª Addiction</button>
          <button class="filter-button journals" data-type="jnl_obesity">âš–ï¸ Obesity</button>
          <button class="filter-button journals" data-type="jnl_aids_hiv">ğŸ”´ AIDS & HIV</button>
          <button class="filter-button journals" data-type="jnl_molecular_biology">ğŸ”¬ Cell Biology</button>
          <button class="filter-button journals" data-type="jnl_health_medical_sciences_general">ğŸ›ï¸ Health
            Policy</button>
          <!-- Filtros adicionales -->
          <button class="filter-button journals" data-type="jnl_pregnancy_childbirth">ğŸ¤° Pregnancy</button>
          <button class="filter-button journals" data-type="jnl_vascular_medicine">ğŸ«€ Vascular Med</button>
          <button class="filter-button journals" data-type="jnl_child_adolescent_psychology">ğŸ‘§ Child
            Psychology</button>
          <button class="filter-button journals" data-type="jnl_reproductive_health">ğŸ©º Reproductive</button>
          <button class="filter-button journals" data-type="jnl_alternative_traditional_medicine">ğŸŒ¿ Alternative
            Med</button>
          <button class="filter-button journals" data-type="jnl_developmental_disabilities">ğŸ§© Developmental
            Dis</button>
          <button class="filter-button journals" data-type="jnl_clinical_laboratory_science">ğŸ§ª Clinical Lab</button>
          <button class="filter-button journals" data-type="jnl_physiology">ğŸ«€ Physiology</button>
          <button class="filter-button journals" data-type="jnl_social_psychology">ğŸ§  Social Psychology</button>
          <!-- Nuevos filtros aÃ±adidos 2026-01-17 -->
          <button class="filter-button journals" data-type="jnl_forensic_science">âš–ï¸ Forensic/Legal Med</button>
          <button class="filter-button journals" data-type="jnl_medical_education">ğŸ“š Medical Education</button>
          <button class="filter-button journals" data-type="jnl_heart_thoracic_surgery">ğŸ«€ Heart Surgery</button>
          <button class="filter-button journals" data-type="jnl_oral_maxillofacial_surgery">ğŸ¦· Oral Surgery</button>
          <button class="filter-button journals" data-type="jnl_audiology_speech_language_pathology">ğŸ‘‚
            Audiology</button>
          <button class="filter-button journals" data-type="jnl_nuclear_medicine_radiotherapy_molecular_imaging">â˜¢ï¸
            Nuclear Med</button>
          <button class="filter-button journals" data-type="jnl_biomedical_technology">ğŸ”¬ Biomedical Tech</button>
          <button class="filter-button journals" data-type="jnl_medicinal_chemistry">âš—ï¸ Medicinal Chem</button>
          <button class="filter-button journals" data-type="jnl_natural_medicines_medicinal_plants">ğŸŒ¿ Natural
            Med</button>
          <button class="filter-button journals" data-type="jnl_plastic_reconstructive_surgery">ğŸ’‰ Plastic
            Surgery</button>
        </div>
      </div>

      <!-- Filter box despuÃ©s de revistas -->
      <div class="final-query-box" id="finalQuery"></div>

      <!-- Enlace a Tips de BÃºsqueda -->
      <div class="tips-link-section">
        <a href="/buscar-pubmed-tips.html" class="tips-link-button">
          <i class="fas fa-lightbulb"></i>
          Ver Tips Avanzados para BÃºsquedas en PubMed
          <i class="fas fa-arrow-right"></i>
        </a>
      </div>

      <!-- SecciÃ³n de tips eliminada - movida a buscar-pubmed-tips.html -->
      <div class="search-tips" style="display: none;">
        <div class="search-tips-content">
          <!-- Tip 1 -->
          <div class="tip">
            <h3 class="tip-title">
              <span class="tip-number">01</span>
              Best Match como Herramienta de Descubrimiento
            </h3>
            <div class="tip-content">
              <div class="tip-section">
                <strong>Â¿QuÃ© es Best Match?</strong>
                Best Match es el algoritmo de relevancia de PubMed que ordena
                los resultados segÃºn su importancia para tu bÃºsqueda. Utiliza
                factores como la coincidencia de tÃ©rminos, fecha de
                publicaciÃ³n y relevancia del journal.
              </div>
              <div class="tip-section">
                <strong>CÃ³mo aprovecharlo con nuestros filtros:</strong>
                1. Realiza tu bÃºsqueda inicial usando los filtros
                metodolÃ³gicos (como MBE o Meta-anÃ¡lisis)<br />
                2. Selecciona "Best match" en el ordenamiento de resultados<br />
                3. Revisa los primeros 10-20 resultados para identificar:<br />
                &nbsp;&nbsp;â€¢ TÃ©rminos MeSH relevantes<br />
                &nbsp;&nbsp;â€¢ Variantes terminolÃ³gicas<br />
                &nbsp;&nbsp;â€¢ Conceptos relacionados
              </div>
              <div class="example-box">
                Ejemplo: Para una bÃºsqueda sobre "cancer screening", Best
                Match podrÃ­a revelarte tÃ©rminos como "Early Detection of
                Cancer"[Mesh] o "Mass Screening"[Mesh]
              </div>
              <div class="pro-tip">
                ğŸ’¡ Pro-tip: Combina Best Match con los filtros de Ã¡mbito (como
                AtenciÃ³n Primaria o GeriatrÃ­a) para descubrir terminologÃ­a
                especÃ­fica de cada contexto.
              </div>
            </div>
          </div>

          <!-- Tip 2 -->
          <div class="tip">
            <h3 class="tip-title">
              <span class="tip-number">02</span>
              BÃºsqueda por Proximidad en PubMed
            </h3>
            <div class="tip-content">
              <div class="tip-section">
                <strong>Nueva funcionalidad de PubMed</strong>
                La bÃºsqueda por proximidad permite encontrar tÃ©rminos cercanos
                entre sÃ­, incluso si no estÃ¡n exactamente juntos o en el mismo
                orden.
              </div>
              <div class="tip-section">
                <strong>Sintaxis bÃ¡sica:</strong>
                "tÃ©rmino1 tÃ©rmino2"[campo:~N]<br />
                Donde N = nÃºmero mÃ¡ximo de palabras entre los tÃ©rminos
              </div>
              <div class="example-box">
                "diabetes treatment"[Title/Abstract:~2]<br />
                Encuentra: "diabetes and its treatment", "treatment of
                diabetes", "diabetes receiving treatment"
              </div>
              <div class="tip-section">
                <strong>Uso con nuestros filtros:</strong>
                Combina la bÃºsqueda por proximidad con filtros clÃ­nicos para
                mayor precisiÃ³n:<br />
                â€¢ Con filtro de Tratamiento-CQ: mayor especificidad en
                resultados terapÃ©uticos<br />
                â€¢ Con filtro de Efectos Adversos: mejor detecciÃ³n de
                complicaciones
              </div>
              <div class="pro-tip">
                ğŸ’¡ Pro-tip: Usa N=0 para encontrar tÃ©rminos adyacentes en
                cualquier orden. Especialmente Ãºtil con los filtros de Ãmbito
                y PoblaciÃ³n.
              </div>
            </div>
          </div>

          <!-- Tip 3 -->
          <div class="tip">
            <h3 class="tip-title">
              <span class="tip-number">03</span>
              Estrategia Sensible/EspecÃ­fica
            </h3>
            <div class="tip-content">
              <div class="tip-section">
                <strong>Â¿Por quÃ© usar dos enfoques?</strong>
                La estrategia sensible/especÃ­fica permite evolucionar desde
                una bÃºsqueda amplia que captura todo lo relevante hacia una
                mÃ¡s precisa que elimina el ruido.
              </div>
              <div class="tip-section">
                <strong>Uso con nuestros filtros:</strong>
                â€¢ En filtros clÃ­nicos (DiagnÃ³stico, EtiologÃ­a, etc.): usa
                primero la versiÃ³n Sensible (S) para identificar toda la
                terminologÃ­a relevante<br />
                â€¢ En filtros de Ã¡mbito (IA, AtenciÃ³n Primaria): cambia a
                versiÃ³n EspecÃ­fica (E) cuando necesites mayor precisiÃ³n
              </div>
              <div class="example-box">
                Ejemplo para bÃºsqueda sobre diagnÃ³stico de diabetes:<br />
                1. Inicia con "DiagnÃ³stico-CQ (S)" + tÃ©rminos bÃ¡sicos<br />
                2. Identifica tÃ©rminos clave en resultados<br />
                3. Refina usando "DiagnÃ³stico-CQ (E)" + tÃ©rminos identificados
              </div>
              <div class="pro-tip">
                ğŸ’¡ Pro-tip: Combina versiones Sensibles para temas poco
                estudiados y EspecÃ­ficas para temas con mucha literatura.
              </div>
            </div>
          </div>

          <!-- Tip 4 -->
          <div class="tip">
            <h3 class="tip-title">
              <span class="tip-number">04</span>
              Clinical Queries EstratÃ©gicos
            </h3>
            <div class="tip-content">
              <div class="tip-section">
                <strong>Filtros Clinical Queries (CQ)</strong>
                Son filtros metodolÃ³gicos validados cientÃ­ficamente para
                diferentes tipos de estudios clÃ­nicos, optimizados para
                maximizar la recuperaciÃ³n de artÃ­culos relevantes.
              </div>
              <div class="tip-section">
                <strong>Uso Ã³ptimo en nuestra herramienta:</strong>
                â€¢ DiagnÃ³stico-CQ: Para pruebas diagnÃ³sticas y screening<br />
                â€¢ Tratamiento-CQ: Para intervenciones terapÃ©uticas<br />
                â€¢ EtiologÃ­a-CQ: Para factores de riesgo y causas<br />
                â€¢ PronÃ³stico-CQ: Para evoluciÃ³n y resultados
              </div>
              <div class="example-box">
                Para estudio sobre tratamiento nuevo:<br />
                "nuevo fÃ¡rmaco" + Tratamiento-CQ (E) + Efectos Adversos
                Medicamentos
              </div>
              <div class="pro-tip">
                ğŸ’¡ Pro-tip: Combina CQ con filtros de Ã¡mbito para contextos
                especÃ­ficos (ej: Tratamiento-CQ + AtenciÃ³n Primaria).
              </div>
            </div>
          </div>

          <!-- Tip 5 -->
          <div class="tip">
            <h3 class="tip-title">
              <span class="tip-number">05</span>
              Control Temporal Inteligente
            </h3>
            <div class="tip-content">
              <div class="tip-section">
                <strong>Estrategia en dos fases</strong>
                Combina bÃºsquedas recientes para capturar terminologÃ­a actual
                con bÃºsquedas histÃ³ricas para no perder estudios
                fundamentales.
              </div>
              <div class="tip-section">
                <strong>ImplementaciÃ³n con nuestros filtros:</strong>
                1. BÃºsqueda reciente (Ãºltimos 6 meses):<br />
                &nbsp;&nbsp;â€¢ Usa filtros metodolÃ³gicos en versiÃ³n Sensible<br />
                &nbsp;&nbsp;â€¢ Activa "Ãšltimos 6 meses" en el selector de
                fecha<br />
                2. BÃºsqueda histÃ³rica (5 aÃ±os):<br />
                &nbsp;&nbsp;â€¢ Incorpora tÃ©rminos descubiertos<br />
                &nbsp;&nbsp;â€¢ Cambia a versiÃ³n EspecÃ­fica de los filtros
              </div>
              <div class="example-box">
                Fase 1: IA Generativa (S) + "Ãºltimos 6 meses"<br />
                Fase 2: IA Generativa (E) + nuevos tÃ©rminos + "Ãºltimos 5 aÃ±os"
              </div>
              <div class="pro-tip">
                ğŸ’¡ Pro-tip: Para temas emergentes, prioriza resultados
                recientes. Para temas establecidos, amplÃ­a el rango temporal.
              </div>
            </div>
          </div>

          <!-- Tip 6 -->
          <div class="tip">
            <h3 class="tip-title">
              <span class="tip-number">06</span>
              ValidaciÃ³n SistemÃ¡tica
            </h3>
            <div class="tip-content">
              <div class="tip-section">
                <strong>Proceso de validaciÃ³n</strong>
                Verifica la calidad de tu estrategia de bÃºsqueda mediante un
                anÃ¡lisis sistemÃ¡tico de los resultados.
              </div>
              <div class="tip-section">
                <strong>Lista de verificaciÃ³n:</strong>
                1. Relevancia de resultados:<br />
                &nbsp;&nbsp;â€¢ Â¿Los primeros 10 resultados son pertinentes?<br />
                &nbsp;&nbsp;â€¢ Â¿Hay ruido temÃ¡tico significativo?<br />
                2. Cobertura temÃ¡tica:<br />
                &nbsp;&nbsp;â€¢ Â¿Se recuperan todos los aspectos relevantes?<br />
                &nbsp;&nbsp;â€¢ Â¿Faltan conceptos importantes?
              </div>
              <div class="example-box">
                Para validar bÃºsqueda sobre seguridad del paciente:<br />
                1. Aplicar Safety (S) + Best Match<br />
                2. Verificar primeros resultados<br />
                3. Ajustar a Safety (E) si hay exceso de ruido
              </div>
              <div class="pro-tip">
                ğŸ’¡ Pro-tip: Si encuentras artÃ­culos irrelevantes en los
                primeros resultados, considera cambiar de versiÃ³n Sensible a
                EspecÃ­fica.
              </div>
            </div>
          </div>

          <!-- Tip 7 -->
          <div class="tip">
            <h3 class="tip-title">
              <span class="tip-number">07</span>
              Refinamiento Iterativo
            </h3>
            <div class="tip-content">
              <div class="tip-section">
                <strong>Proceso de mejora continua</strong>
                Optimiza tu bÃºsqueda mediante ciclos de refinamiento,
                incorporando nuevos tÃ©rminos y ajustando filtros segÃºn los
                resultados.
              </div>
              <div class="tip-section">
                <strong>Ciclo de refinamiento:</strong>
                1. BÃºsqueda inicial con filtros base<br />
                2. AnÃ¡lisis de mejores resultados<br />
                3. IdentificaciÃ³n de nuevos tÃ©rminos<br />
                4. Ajuste de filtros y operadores<br />
                5. ValidaciÃ³n de cambios
              </div>
              <div class="example-box">
                IteraciÃ³n para bÃºsqueda en geriatrÃ­a:<br />
                1. GeriatrÃ­a (S) + tÃ©rminos iniciales<br />
                2. Identificar subgrupos relevantes<br />
                3. AÃ±adir Cuidados Paliativos si aparece frecuentemente
              </div>
              <div class="pro-tip">
                ğŸ’¡ Pro-tip: Documenta cada iteraciÃ³n y su impacto para crear
                un histÃ³rico de mejoras.
              </div>
            </div>
          </div>

          <!-- Tip 8 -->
          <div class="tip">
            <h3 class="tip-title">
              <span class="tip-number">08</span>
              CombinaciÃ³n de Campos
            </h3>
            <div class="tip-content">
              <div class="tip-section">
                <strong>Estrategia de campos mÃºltiples</strong>
                Maximiza la precisiÃ³n combinando bÃºsqueda por proximidad en
                tÃ­tulo/abstract con tÃ©rminos MeSH y nuestros filtros
                estructurados.
              </div>
              <div class="tip-section">
                <strong>Estructura Ã³ptima:</strong>
                1. TÃ©rminos de proximidad en [Title/Abstract]<br />
                2. TÃ©rminos MeSH relevantes<br />
                3. Filtros metodolÃ³gicos o clÃ­nicos<br />
                4. Filtros de Ã¡mbito segÃºn necesidad
              </div>
              <div class="example-box">
                "diabetes management"[Title/Abstract:~2] AND<br />
                "Diabetes Mellitus/therapy"[Mesh] AND<br />
                {Aplicar filtro Primary (E) + Treatment (E)}
              </div>
              <div class="pro-tip">
                ğŸ’¡ Pro-tip: Usa diferentes valores de proximidad (~1, ~2, ~3)
                para encontrar el balance Ã³ptimo de resultados.
              </div>
            </div>
          </div>

          <!-- Tip 9 -->
          <div class="tip">
            <h3 class="tip-title">
              <span class="tip-number">09</span>
              AnÃ¡lisis de Resultados
            </h3>
            <div class="tip-content">
              <div class="tip-section">
                <strong>EvaluaciÃ³n de calidad</strong>
                Analiza sistemÃ¡ticamente los resultados para garantizar que tu
                estrategia de bÃºsqueda es efectiva.
              </div>
              <div class="tip-section">
                <strong>Criterios de evaluaciÃ³n:</strong>
                â€¢ PrecisiÃ³n: relevancia de los primeros resultados<br />
                â€¢ Exhaustividad: recuperaciÃ³n de artÃ­culos clave<br />
                â€¢ Balance: proporciÃ³n de resultados Ãºtiles<br />
                â€¢ Actualidad: distribuciÃ³n temporal adecuada
              </div>
              <div class="example-box">
                Para evaluar bÃºsqueda de terapias CAR-T:<br />
                1. Aplicar filtro CAR-T + Best Match<br />
                2. Verificar presencia de papers clave<br />
                3. Analizar distribuciÃ³n temporal
              </div>
              <div class="pro-tip">
                ğŸ’¡ Pro-tip: La calidad de los primeros 10-20 resultados es un
                buen predictor de la efectividad global de tu bÃºsqueda.
              </div>
            </div>
          </div>

          <!-- Tip 10 -->
          <div class="tip">
            <h3 class="tip-title">
              <span class="tip-number">10</span>
              VerificaciÃ³n Final
            </h3>
            <div class="tip-content">
              <div class="tip-section">
                <strong>Lista de verificaciÃ³n completa</strong>
                Asegura la calidad de tu bÃºsqueda mediante una revisiÃ³n
                sistemÃ¡tica de todos los componentes.
              </div>
              <div class="tip-section">
                <strong>Elementos a verificar:</strong>
                1. Estructura de bÃºsqueda:<br />
                &nbsp;&nbsp;â€¢ TÃ©rminos MeSH apropiados<br />
                &nbsp;&nbsp;â€¢ Operadores booleanos correctos<br />
                &nbsp;&nbsp;â€¢ Filtros metodolÃ³gicos adecuados<br />
                2. Resultados:<br />
                &nbsp;&nbsp;â€¢ ArtÃ­culos clave recuperados<br />
                &nbsp;&nbsp;â€¢ Balance sensibilidad/especificidad<br />
                3. DocumentaciÃ³n:<br />
                &nbsp;&nbsp;â€¢ Estrategia documentada<br />
                &nbsp;&nbsp;â€¢ Filtros utilizados registrados
              </div>
              <div class="example-box">
                Checklist final:<br />
                â˜ TÃ©rminos principales incluidos<br />
                â˜ Filtros apropiados seleccionados<br />
                â˜ Operadores verificados<br />
                â˜ Resultados validados
              </div>
              <div class="pro-tip">
                ğŸ’¡ Pro-tip: Guarda tu estrategia final completa para futuras
                actualizaciones o refinamientos.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h2 class="info-title">
          <i class="fas fa-info-circle"></i>
          Sobre las BÃºsquedas
        </h2>
        <p class="info-text">
          Los filtros se combinan automÃ¡ticamente usando operadores booleanos:
          <strong>OR</strong> entre filtros de la misma categorÃ­a y
          <strong>AND</strong> entre diferentes categorÃ­as (por defecto). Esto
          permite construir bÃºsquedas precisas que encuentran exactamente lo
          que necesitas.
          <br />
          <span style="font-size: 0.8rem; color: grey"><b>CQ:</b> Clinical Queries PubMed</span>
        </p>
      </div>
    </div>
  </main>

  <include src="footer.html"></include>
  <script src="/assets/js/include.js"></script>
  <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // 1. Variables globales
      var searchTerm = document.getElementById("searchTerm");
      window.searchTerm = searchTerm;
      var searchButton = document.getElementById("searchButton");
      var resetButton = document.getElementById("resetButton");
      var filterCount = document.getElementById("filterCount");
      var finalQueryBox = document.getElementById("finalQuery");
      var dateRange = document.getElementById("dateRange");
      var sortMode = document.getElementById("sortMode");
      /*         var internalOperator = document.getElementById("internalOperator");
       */
      var activeFilters = new Set();
      var filterMap = {};
      window.filterMap = filterMap;
      var filterTooltips = {};
      // Manejo del toggle del diagrama de Venn
      const toggleVennButton = document.getElementById("toggleVennButton");
      const vennContainer = document.querySelector(".venn-container");

      toggleVennButton.addEventListener("click", () => {
        vennContainer.classList.toggle("visible");
        toggleVennButton.classList.toggle("active"); // AÃ±ade esta lÃ­nea

        toggleVennButton.innerHTML = vennContainer.classList.contains(
          "visible"
        )
          ? '<i class="fas fa-project-diagram"></i> Ocultar Diagrama'
          : '<i class="fas fa-project-diagram"></i> Ver Diagrama';
        if (vennContainer.classList.contains("visible")) {
          updateVennDiagram(); // Actualizar el diagrama cuando se muestra
        }
      });

      // ================================
      // Componente de Guardar / Recuperar / Borrar / Exportar / Importar bÃºsquedas
      // ================================

      // BotÃ³n para guardar bÃºsqueda
      document
        .getElementById("btn_guardar")
        .addEventListener("click", function () {
          document.getElementById("nombreNuevaBusqueda").value = "";
          abrirModal("modalGuardarFondo");
        });
      document
        .getElementById("guardarBusquedaConfirm")
        .addEventListener("click", function () {
          const nombre = document
            .getElementById("nombreNuevaBusqueda")
            .value.trim();
          if (!nombre) {
            return;
          }

          // Recoger operadores actuales
          const operadores = {};
          document
            .querySelectorAll(".category-operator")
            .forEach((select) => {
              operadores[select.dataset.category] = select.value;
            });

          const bÃºsquedaActual = {
            termino: searchTerm.value.trim(),
            filtros: Array.from(activeFilters),
            fecha: dateRange.value,
            orden: sortMode.value,
            operadores: operadores, // AÃ±adimos los operadores
          };

          const bÃºsquedas = obtenerBÃºsquedasGuardadas();
          bÃºsquedas[nombre] = bÃºsquedaActual;
          guardarBÃºsquedasGuardadas(bÃºsquedas);
          mostrarToast(`BÃºsqueda "${nombre}" guardada correctamente.`);
          cerrarModal("modalGuardarFondo");
        });

      // BotÃ³n para recuperar bÃºsqueda
      document
        .getElementById("btn_recuperar")
        .addEventListener("click", function () {
          const bÃºsquedas = obtenerBÃºsquedasGuardadas();
          const nombres = Object.keys(bÃºsquedas);
          const select = document.getElementById("recuperarSelect");
          select.innerHTML = "";

          if (nombres.length === 0) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "No hay bÃºsquedas guardadas";
            select.appendChild(opt);
            mostrarToast("No hay bÃºsquedas guardadas.");
            return;
          }

          nombres.forEach((nombre) => {
            const opt = document.createElement("option");
            opt.value = nombre;
            opt.textContent = nombre;
            select.appendChild(opt);
          });

          abrirModal("modalRecuperarFondo");
        });

      document
        .getElementById("recuperarBusquedaConfirm")
        .addEventListener("click", function () {
          const select = document.getElementById("recuperarSelect");
          const nombre = select.value;
          const bÃºsquedas = obtenerBÃºsquedasGuardadas();

          if (!nombre || !bÃºsquedas[nombre]) {
            mostrarToast("No se encontrÃ³ la bÃºsqueda con ese nombre.");
            return;
          }

          const estado = bÃºsquedas[nombre];

          // Restaurar valores bÃ¡sicos
          searchTerm.value = estado.termino || "";
          autoResizeTextarea.call(searchTerm);
          dateRange.value = estado.fecha || "";
          sortMode.value = estado.orden || "date";

          // Restaurar operadores si existen
          if (estado.operadores) {
            Object.entries(estado.operadores).forEach(([category, value]) => {
              const select = document.querySelector(
                `.category-operator[data-category="${category}"]`
              );
              if (select) {
                select.value = value;
                categoryOperators[category] = value; // Actualizar tambiÃ©n el objeto de operadores
              }
            });
          }

          // Restaurar filtros
          document.querySelectorAll(".filter-button").forEach(function (btn) {
            btn.classList.remove("active");
          });
          activeFilters.clear();

          estado.filtros.forEach(function (filtro) {
            activeFilters.add(filtro);
            let btn = document.querySelector(
              '.filter-button[data-type="' + filtro + '"]'
            );
            if (!btn) {
              const base = filtro.split("_")[0];
              btn = document.querySelector(
                '.filter-button[data-base="' + base + '"]'
              );
            }
            if (btn) {
              btn.classList.add("active");
            }
          });

          updateFilterCounterDisplay(); // Actualizar el contador de filtros
          mostrarQueryFinal();

          // Llamar al trigger externo si existe nuevo cambio estaba antes de updateFilterCounterDisplay

          // ---> Â¡AÃ‘ADIR ESTA LÃNEA! <---
          // Disparar la actualizaciÃ³n de los contadores con el estado recuperado
          if (typeof window.triggerPubMedCounterUpdate === "function") {
            window.triggerPubMedCounterUpdate();
          }
          // ---> FIN DE LÃNEA A AÃ‘ADIR <---
          mostrarToast(`BÃºsqueda "${nombre}" recuperada correctamente.`);
          cerrarModal("modalRecuperarFondo");
        });

      // BotÃ³n para borrar bÃºsqueda
      document
        .getElementById("btn_borrar")
        .addEventListener("click", function () {
          const bÃºsquedas = obtenerBÃºsquedasGuardadas();
          const nombres = Object.keys(bÃºsquedas);
          const select = document.getElementById("borrarSelect");
          select.innerHTML = "";

          if (nombres.length === 0) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "No hay bÃºsquedas guardadas";
            select.appendChild(opt);
            mostrarToast("No hay bÃºsquedas guardadas.");
            return;
          }

          nombres.forEach((nombre) => {
            const opt = document.createElement("option");
            opt.value = nombre;
            opt.textContent = nombre;
            select.appendChild(opt);
          });

          abrirModal("modalBorrarFondo");
        });

      document
        .getElementById("borrarBusquedaConfirm")
        .addEventListener("click", function () {
          const select = document.getElementById("borrarSelect");
          const nombre = select.value;
          const bÃºsquedas = obtenerBÃºsquedasGuardadas();

          if (!nombre || !bÃºsquedas[nombre]) {
            mostrarToast("No se encontrÃ³ la bÃºsqueda con ese nombre.");

            return;
          }

          delete bÃºsquedas[nombre];
          guardarBÃºsquedasGuardadas(bÃºsquedas);
          mostrarToast(`BÃºsqueda "${nombre}" borrada correctamente.`);

          cerrarModal("modalBorrarFondo");

          // Actualizar el select despuÃ©s de borrar
          const nombres = Object.keys(bÃºsquedas);
          select.innerHTML = "";
          if (nombres.length === 0) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "No hay bÃºsquedas guardadas";
            select.appendChild(opt);
          } else {
            nombres.forEach((nombre) => {
              const opt = document.createElement("option");
              opt.value = nombre;
              opt.textContent = nombre;
              select.appendChild(opt);
            });
          }
        });

      // BotÃ³n para exportar bÃºsquedas
      document
        .getElementById("btn_exportar")
        .addEventListener("click", function () {
          abrirModal("modalExportarFondo");
        });

      document
        .getElementById("exportarBusquedaConfirm")
        .addEventListener("click", function () {
          const bÃºsquedas = obtenerBÃºsquedasGuardadas();
          const jsonString = JSON.stringify(bÃºsquedas, null, 2);
          const blob = new Blob([jsonString], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "saved_searches.json";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          mostrarToast(
            "Las bÃºsquedas se han exportado a un archivo llamado 'saved_searches.json'.\nGuÃ¡rdalo en un lugar seguro para futuras importaciones."
          );
          cerrarModal("modalExportarFondo");
        });

      // BotÃ³n para importar bÃºsquedas
      document
        .getElementById("btn_importar")
        .addEventListener("click", function () {
          abrirModal("modalImportarFondo");
        });

      document
        .getElementById("importarBusquedaConfirm")
        .addEventListener("click", function () {
          const input = document.getElementById("importarArchivo");
          const file = input.files[0];
          if (!file) {
            mostrarToast("No se seleccionÃ³ ningÃºn archivo.");
            return;
          }
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const bÃºsquedasImportadas = JSON.parse(e.target.result);
              const bÃºsquedasActuales = obtenerBÃºsquedasGuardadas();

              // Merge inteligente
              Object.entries(bÃºsquedasImportadas).forEach(
                ([nombre, bÃºsqueda]) => {
                  let nombreFinal = nombre;
                  let counter = 1;

                  // Si existe y es diferente, aÃ±adir numeraciÃ³n
                  while (
                    bÃºsquedasActuales[nombreFinal] &&
                    JSON.stringify(bÃºsquedasActuales[nombreFinal]) !==
                    JSON.stringify(bÃºsqueda)
                  ) {
                    nombreFinal = `${nombre} (${counter})`;
                    counter++;
                  }

                  // Solo guardar si es nueva o diferente
                  if (
                    !bÃºsquedasActuales[nombreFinal] ||
                    JSON.stringify(bÃºsquedasActuales[nombreFinal]) !==
                    JSON.stringify(bÃºsqueda)
                  ) {
                    bÃºsquedasActuales[nombreFinal] = bÃºsqueda;
                  }
                }
              );

              guardarBÃºsquedasGuardadas(bÃºsquedasActuales);
              mostrarToast("BÃºsquedas importadas correctamente.");
              cerrarModal("modalImportarFondo");
              input.value = "";
            } catch (error) {
              mostrarToast(
                "Error al parsear el archivo JSON. Verifique el formato."
              );
            }
          };
          reader.readAsText(file);
        });
      // ================================
      // Fin del componente de Guardar/Recuperar/Borrar/Exportar/Importar bÃºsquedas
      // ================================

      // 2. ConfiguraciÃ³n de categorÃ­as
      var categories = {
        methodology: [
          "mbe",
          "gpc",
          "metaanalysis",
          "qualitative",
          "clinical_rules_sensible",
          "clinical_rules_especifico",
          "horizon",
          "clinical_rules_ap",
          "indirect_comparison",
        ],
        clinical: [
          "diagnosis_sensible",
          "diagnosis_especifico",
          "etiology_sensible",
          "etiology_especifico",
          "prognosis_sensible",
          "prognosis_especifico",
          "treatment_sensible",
          "treatment_especifico",
          "predictors_sensible",
          "predictors_especifico",
          "surgery_ae",
          "devices_ae",
          "drugs_ae",
          "car_t",
          "deprescription",
          "simulation_clinical",
          "clinical_examination",
          "NNT_NNH",
          "mortality",
        ],
        scope: [
          "ai_sensible",
          "ai_especifico",
          "palliative_sensible",
          "palliative_especifico",
          "primary_sensible",
          "primary_especifico",
          "safety_sensible",
          "safety_especifico",
          "pearls",
          "perspective",
          "nursing",
          "humans",
          "geriatrics_sensible",
          "geriatrics_especifico",
          "pediatrics",
          "adults",
          "ocde",
          "spanish",
          "economic_sensible",
          "economic_especifico",
        ],
        journals: [
          "jnl_top_publications",
          "jnl_addiction",
          "jnl_aids_hiv",
          "jnl_alternative_traditional_medicine",
          "jnl_anesthesiology",
          "jnl_audiology_speech_language_pathology",
          "jnl_bioethics",
          "jnl_biomedical_technology",
          "jnl_cardiology",
          "jnl_child_adolescent_psychology",
          "jnl_clinical_laboratory_science",
          "jnl_communicable_diseases",
          "jnl_critical_care",
          "jnl_dentistry",
          "jnl_dermatology",
          "jnl_developmental_disabilities",
          "jnl_diabetes",
          "jnl_emergency_medicine",
          "jnl_endocrinology",
          "jnl_epidemiology",
          "jnl_gastroenterology_hepatology",
          "jnl_genetics_genomics",
          "jnl_gerontology_geriatric_medicine",
          "jnl_gynecology_obstetrics",
          "jnl_health_medical_sciences_general",
          "jnl_heart_thoracic_surgery",
          "jnl_hematology",
          "jnl_hospice_palliative_care",
          "jnl_immunology",
          "jnl_forensic_science",
          "jnl_medical_education",
          "jnl_medical_informatics",
          "jnl_medicinal_chemistry",
          "jnl_molecular_biology",
          "jnl_natural_medicines_medicinal_plants",
          "jnl_neurology",
          "jnl_neurosurgery",
          "jnl_nuclear_medicine_radiotherapy_molecular_imaging",
          "jnl_nursing",
          "jnl_nutrition_science",
          "jnl_obesity",
          "jnl_oncology",
          "jnl_ophthalmology_optometry",
          "jnl_oral_maxillofacial_surgery",
          "jnl_orthopedic_medicine_surgery",
          "jnl_otolaryngology",
          "jnl_pain_pain_management",
          "jnl_pathology",
          "jnl_pediatric_medicine",
          "jnl_pharmacology_pharmacy",
          "jnl_physical_education_sports_medicine",
          "jnl_physiology",
          "jnl_plastic_reconstructive_surgery",
          "jnl_pregnancy_childbirth",
          "jnl_primary_health_care",
          "jnl_psychiatry",
          "jnl_psychology",
          "jnl_public_health",
          "jnl_pulmonology",
          "jnl_radiology_medical_imaging",
          "jnl_rehabilitation_therapy",
          "jnl_reproductive_health",
          "jnl_rheumatology",
          "jnl_social_psychology",
          "jnl_surgery",
          "jnl_toxicology",
          "jnl_transplantation",
          "jnl_tropical_medicine_parasitology",
          "jnl_urology_nephrology",
          "jnl_vascular_medicine",
          "jnl_veterinary_medicine",
          "jnl_virology",
        ],
      };
      window.categories = categories;
      // 3. Funciones de manejo de metadata y tooltips
      function formatTooltipContent(metadata) {
        const parts = [];

        // FunciÃ³n auxiliar para validar si una mÃ©trica debe mostrarse
        const isValidMetric = (value) => {
          return (
            value !== undefined &&
            value !== null &&
            value !== 0 &&
            !isNaN(value) &&
            value.toString().trim() !== ""
          );
        };

        // FunciÃ³n auxiliar para formatear una secciÃ³n de mÃ©tricas
        const formatMetricSection = (metrics, prefix = "") => {
          const formattedMetrics = [];

          if (isValidMetric(metrics.sensitivity)) {
            formattedMetrics.push(
              `${prefix}<strong>Sensibilidad:</strong> ${metrics.sensitivity}%`
            );
          }
          if (isValidMetric(metrics.specificity)) {
            formattedMetrics.push(
              `${prefix}<strong>Especificidad:</strong> ${metrics.specificity}%`
            );
          }
          if (isValidMetric(metrics.precision)) {
            formattedMetrics.push(
              `${prefix}<strong>PrecisiÃ³n:</strong> ${metrics.precision}%`
            );
          }
          if (isValidMetric(metrics.NNR)) {
            formattedMetrics.push(
              `${prefix}<strong>NNR:</strong> ${metrics.NNR}`
            );
          }

          return formattedMetrics;
        };

        // Para filtros de tipo journals (revistas)
        if (metadata.type === "journals") {
          if (metadata.specialty) {
            parts.push(`<strong>Especialidad:</strong> ${metadata.specialty}`);
          }
          if (metadata.journalCount) {
            parts.push(`<strong>Revistas incluidas:</strong> ${metadata.journalCount}`);
          }
          if (metadata.journals && Array.isArray(metadata.journals)) {
            parts.push(""); // LÃ­nea en blanco
            metadata.journals.forEach((journal) => {
              parts.push(`â€¢ ${journal}`);
            });
          }
          if (metadata.source) {
            parts.push(""); // LÃ­nea en blanco
            parts.push(`<strong>Fuente:</strong> ${metadata.source}`);
          }
          return parts.join("\n");
        }

        if (metadata.validation?.metrics) {
          // Para filtros con versiÃ³n Ãºnica
          if ("sensitivity" in metadata.validation.metrics) {
            parts.push(...formatMetricSection(metadata.validation.metrics));
          }
          // Para filtros con versiones sensible/especÃ­fica
          else if ("sensitive" in metadata.validation.metrics) {
            const sensitiveParts = formatMetricSection(
              metadata.validation.metrics.sensitive
            );
            const specificParts = formatMetricSection(
              metadata.validation.metrics.specific
            );

            if (sensitiveParts.length > 0) {
              parts.push("<u>VersiÃ³n Sensible:</u>");
              parts.push(...sensitiveParts);
            }

            if (specificParts.length > 0) {
              if (parts.length > 0) parts.push(""); // LÃ­nea en blanco como separador
              parts.push("<u>VersiÃ³n EspecÃ­fica:</u>");
              parts.push(...specificParts);
            }
          }
        }

        // AÃ±adir referencia si existe y no estÃ¡ vacÃ­a
        if (metadata.validation?.reference?.trim()) {
          if (parts.length > 0) parts.push(""); // LÃ­nea en blanco como separador
          parts.push(
            `<strong>Fuente:</strong> ${metadata.validation.reference.trim()}`
          );
        }

        return parts.join("\n");
      }

      function cargarFiltros() {
        console.log("Iniciando carga de filtros..."); // Debugging
        var promises = [];
        Object.keys(categories).forEach(function (cat) {
          categories[cat].forEach(function (id) {
            var url =
              "https://ernestobarrera.github.io/pubmed-filters/filters/" +
              cat +
              "/" +
              id +
              ".txt";
            console.log("Cargando filtro:", url); // Debugging
            var prom = fetch(url)
              .then(function (r) {
                return r.ok ? r.text() : "";
              })
              .then(function (txt) {
                // Separar contenido del filtro y metadatos
                const [filter, metadataStr] = txt.split(
                  "@@@FILTER_METADATA@@@"
                );

                // Procesar solo el contenido del filtro, ignorando lÃ­neas que empiezan con "#"
                const cleanedFilter = filter
                  .split("\n")
                  .filter((line) => !line.trim().startsWith("#"))
                  .join("\n");

                filterMap[id] = cleanedFilter.trim(); // Guardar el filtro limpio

                // Parsear los metadatos si existen
                if (metadataStr) {
                  try {
                    const metadata = JSON.parse(metadataStr.trim());
                    const tooltipContent = formatTooltipContent(metadata);
                    filterTooltips[id] = tooltipContent;
                  } catch (e) {
                    console.warn(`Error parseando metadata para ${id}:`, e);
                  }
                }
              })
              .catch(function (error) {
                console.error("Error cargando filtro:", url, error); // Debugging
                filterMap[id] = ""; // Si falla, asegura que el filtro no existe
              });
            promises.push(prom);
          });
        });
        return Promise.all(promises);
      }

      // 4. InicializaciÃ³n de tooltips
      cargarFiltros().then(() => {
        console.log("Filtros cargados, inicializando tooltips...");

        document
          .querySelectorAll(".filter-button")
          .forEach(function (button) {
            let id;
            if (button.classList.contains("with-toggle")) {
              // Para botones con toggle, usar el ID base + "_sensible"
              id = button.dataset.base + "_sensible";
              console.log("BotÃ³n con toggle, usando ID:", id);
            } else {
              // Para botones sin toggle, usar el ID tipo
              id = button.dataset.type;
              console.log("BotÃ³n sin toggle, usando ID:", id);
            }

            if (filterTooltips[id]) {
              console.log(
                "AÃ±adiendo tooltip a:",
                id,
                "con contenido:",
                filterTooltips[id]
              );
              button.setAttribute("data-tippy-content", filterTooltips[id]);
              tippy(button, {
                content: filterTooltips[id],
                placement: "auto", // Cambiado de 'top' a 'auto' para mejor posicionamiento

                placement: "top",
                arrow: true,
                theme: "custom",
                animation: "shift-away",
                delay: [200, 0],
                maxWidth: 400,
                allowHTML: true, // AÃ±adimos esta lÃ­nea para permitir HTML en el contenido
                trigger: "mouseenter",
                onShow(instance) {
                  return infoModeActive;
                },
              });
            } else {
              console.log("No se encontrÃ³ tooltip para:", id);
            }
          });

        // Manejar el toggle de informaciÃ³n
        const infoModeToggle = document.getElementById("infoModeToggle");
        let infoModeActive = false;

        // Definir las funciones de mostrar/ocultar fuera para poder removerlas
        function showTooltip(event) {
          const tippyInstance = event.currentTarget._tippy;
          if (tippyInstance) {
            tippyInstance.show();
          }
        }

        function hideTooltip(event) {
          const tippyInstance = event.currentTarget._tippy;
          if (tippyInstance) {
            tippyInstance.hide();
          }
        }

        infoModeToggle.addEventListener("click", () => {
          infoModeActive = !infoModeActive;

          // Cambiar estilo del botÃ³n
          infoModeToggle.style.background = infoModeActive
            ? "var(--accent-color)"
            : "var(--card-bg)";
          infoModeToggle.style.color = infoModeActive
            ? "var(--primary-bg)"
            : "var(--text-primary)";

          // Activar/desactivar tooltips
          document.querySelectorAll(".filter-button").forEach((button) => {
            const tippyInstance = button._tippy;
            if (tippyInstance) {
              if (infoModeActive) {
                button.addEventListener("mouseenter", showTooltip);
                button.addEventListener("mouseleave", hideTooltip);
              } else {
                button.removeEventListener("mouseenter", showTooltip);
                button.removeEventListener("mouseleave", hideTooltip);
                tippyInstance.hide(); // Ocultar tooltip si estÃ¡ visible
              }
            }
          });
        });
      });

      // ---> NUEVA FUNCIÃ“N CENTRALIZADA PARA ACTUALIZAR EL CONTADOR <---
      function updateFilterCounterDisplay() {
        const buttonFilterCount = activeFilters.size; // NÃºmero de filtros de botÃ³n activos
        const isDateFilterActive = dateRange.value !== ""; // Â¿Hay un filtro de fecha seleccionado? (' !== "" ' significa que cualquier opciÃ³n excepto "Sin Filtro" estÃ¡ seleccionada)

        // Calcula el total de filtros activos (botones + fecha)
        const totalActiveFilters =
          buttonFilterCount + (isDateFilterActive ? 1 : 0);

        // Actualiza el texto del contador
        filterCount.textContent = totalActiveFilters;

        // Resalta el contador si hay 1 o mÃ¡s filtros activos
        if (totalActiveFilters > 0) {
          filterCount.classList.add("highlighted");
        } else {
          filterCount.classList.remove("highlighted");
        }
      }
      // ---> FIN NUEVA FUNCIÃ“N <---

      // 5. Event Listeners bÃ¡sicos (MODIFICADOS)
      // ... resto del script ...
      // 5. Event Listeners bÃ¡sicos (REEMPLAZO CONSERVADOR)

      // Listener para searchTerm (Input) - Solo para mostrar query.
      // (La actualizaciÃ³n de contadores la dispara counters.js con debounce)
      if (searchTerm) {
        // AÃ±adir comprobaciÃ³n por si acaso
        searchTerm.addEventListener("input", mostrarQueryFinal);
      }

      // Listener para dateRange (Change) - Muestra query Y actualiza contador VISUAL
      if (dateRange) {
        dateRange.addEventListener("change", function () {
          mostrarQueryFinal();
          updateFilterCounterDisplay(); // <-- USA LA NUEVA FUNCIÃ“N para actualizar nÃºmero y resaltado
          // Llama a la funciÃ³n global del script de contadores externo si existe
          if (typeof window.triggerPubMedCounterUpdate === "function") {
            window.triggerPubMedCounterUpdate();
          }
        });
      }

      // Listener para sortMode (Change) - Solo muestra query (no afecta contadores)
      if (sortMode) {
        // AÃ±adir comprobaciÃ³n
        sortMode.addEventListener("change", mostrarQueryFinal);
      }

      // 6. Manejo de filtros simples
      document
        .querySelectorAll(".filter-button:not(.with-toggle)")
        .forEach(function (button) {
          button.addEventListener("click", function () {
            button.classList.toggle("active");
            var filterType = button.dataset.type;
            if (filterType) {
              if (button.classList.contains("active")) {
                activeFilters.add(filterType);
              } else {
                activeFilters.delete(filterType);
              }
              updateFilterCounterDisplay();
              mostrarQueryFinal();
              // Actualizar contadores: si NO es filtro de journals, omitir el contador de revistas
              if (typeof window.triggerPubMedCounterUpdate === "function") {
                const isJournalsFilter = button.classList.contains("journals");
                window.triggerPubMedCounterUpdate({ skipJournalsCounter: !isJournalsFilter });
              }
            }
          });
        });

      // 7. Manejo de filtros con toggle
      document
        .querySelectorAll(".filter-button.with-toggle")
        .forEach(function (btn) {
          var baseId = btn.dataset.base;
          btn.addEventListener("click", function (e) {
            if (
              e.target.tagName === "INPUT" ||
              e.target.closest(".versions-toggle")
            ) {
              return;
            }
            btn.classList.toggle("active");
            var selectedRadio = btn.querySelector(
              'input[type="radio"]:checked'
            );
            var filterType = baseId + "_" + selectedRadio.value;
            if (btn.classList.contains("active")) {
              activeFilters.add(filterType);
            } else {
              activeFilters.delete(filterType);
            }
            updateFilterCounterDisplay();
            mostrarQueryFinal();
            // Actualizar contadores: filtros con toggle nunca son de journals, omitir contador revistas
            if (typeof window.triggerPubMedCounterUpdate === "function") {
              window.triggerPubMedCounterUpdate({ skipJournalsCounter: true });
            }
          });
          var radios = btn.querySelectorAll('input[type="radio"]');
          radios.forEach(function (radio) {
            radio.addEventListener("change", function () {
              if (!btn.classList.contains("active")) return;
              var oldType =
                baseId +
                "_" +
                (radio.value === "sensible" ? "especifico" : "sensible");
              var newType = baseId + "_" + radio.value;
              activeFilters.delete(oldType);
              activeFilters.add(newType);
              updateFilterCounterDisplay(); // <-- USA LA NUEVA FUNCIÃ“N para actualizar nÃºmero y resaltado
              mostrarQueryFinal();
            });
          });
        });

      // 8. ConfiguraciÃ³n de operadores por categorÃ­a
      const categoryOperators = {
        methodology: "OR",
        clinical: "OR",
        scope: "OR",
        journals: "OR"
      };

      // 9. Funciones de construcciÃ³n de consultas

      function constructQuery(term) {
        // Elimina las lÃ­neas que empiezan con "#"
        term = term
          .split("\n")
          .filter((line) => !line.trim().startsWith("#"))
          .join(" ");
        if (!term && activeFilters.size === 0) return "";

        let query = term;

        Object.keys(categories).forEach(function (cat) {
          const operator = categoryOperators[cat];
          const activeInCat = categories[cat]
            .filter((f) => activeFilters.has(f))
            .map((f) => filterMap[f] || "")
            .filter((q) => q !== "");

          if (activeInCat.length > 0) {
            const notFilters = activeInCat.filter((f) => /^NOT/.test(f));
            const regularFilters = activeInCat.filter((f) => !/^NOT/.test(f));

            if (regularFilters.length > 0) {
              const categoryQuery = `(${regularFilters.join(
                ` ${operator} `
              )})`;
              query = query
                ? `(${query}) AND ${categoryQuery}`
                : categoryQuery;
            }

            notFilters.forEach((filter) => {
              query = query ? `(${query}) ${filter}` : filter;
            });
          }
        });

        if (dateRange.value) {
          const dateFilter = `("last ${dateRange.value} days"[dp])`;
          query = query ? `(${query}) AND ${dateFilter}` : dateFilter;
        }

        return query.trim();
      }
      window.constructQuery = constructQuery;
      function mostrarQueryFinal() {
        var built = constructQuery(searchTerm.value.trim());
        finalQueryBox.textContent = built;
      }

      function hacerBusqueda() {
        var term = searchTerm.value.trim();
        var finalQ = constructQuery(term);
        if (!finalQ) {
          mostrarToast(
            "Por favor, introduce un tÃ©rmino o selecciona algÃºn filtro."
          );
          return;
        }
        var url =
          "https://pubmed.ncbi.nlm.nih.gov/?term=" +
          encodeURIComponent(finalQ);
        if (sortMode.value === "date") {
          url += "&sort=date";
        }
        url += "&size=50";
        window.open(url, "_blank");
      }

      // 10. Event listeners para bÃºsqueda
      searchTerm.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          hacerBusqueda();
        }
      });
      searchButton.addEventListener("click", hacerBusqueda);

      // 11. Event listener para reset
      resetButton.addEventListener("click", function () {
        activeFilters.clear();
        searchTerm.value = "";
        dateRange.value = "";
        sortMode.value = "date";

        document.querySelectorAll(".category-operator").forEach((select) => {
          select.value = "OR";
          categoryOperators[select.dataset.category] = "OR";
        });

        document.querySelectorAll(".filter-button").forEach(function (b) {
          b.classList.remove("active");
        });

        document
          .querySelectorAll('.versions-toggle input[type="radio"]')
          .forEach(function (r) {
            if (r.value === "sensible") {
              r.checked = true;
            }
          });

        finalQueryBox.textContent = "";
        updateFilterCounterDisplay();

        mostrarQueryFinal();
        // ---> AÃ‘ADIR ESTA LÃNEA (Opcional) <---
        if (typeof window.triggerPubMedCounterUpdate === "function") {
          window.triggerPubMedCounterUpdate(); // Actualizar contadores a estado inicial
        }
        // ---> FIN <---
      });

      // 12. Operadores de categorÃ­a
      document.querySelectorAll(".category-operator").forEach((select) => {
        select.addEventListener("change", function () {
          categoryOperators[this.dataset.category] = this.value;
          mostrarQueryFinal();
          // Actualizar contadores: omitir contador de revistas si no es cambio en journals
          if (typeof window.triggerPubMedCounterUpdate === "function") {
            const isJournalsOperator = this.dataset.category === "journals";
            window.triggerPubMedCounterUpdate({ skipJournalsCounter: !isJournalsOperator });
          }
        });
      });
      // 13. Diagrama de Venn
      function updateVennDiagram() {
        const methodologyFilters = Array.from(
          document.querySelectorAll(".filter-button.methodological.active")
        ).map((btn) => ({
          text: btn.textContent.trim(),
          type:
            btn.dataset.type ||
            `${btn.dataset.base}_${btn.querySelector('input[type="radio"]:checked')?.value
            }`,
        }));

        const clinicalFilters = Array.from(
          document.querySelectorAll(".filter-button.clinical.active")
        ).map((btn) => ({
          text: btn.textContent.trim(),
          type:
            btn.dataset.type ||
            `${btn.dataset.base}_${btn.querySelector('input[type="radio"]:checked')?.value
            }`,
        }));

        const scopeFilters = Array.from(
          document.querySelectorAll(".filter-button.scope.active")
        ).map((btn) => ({
          text: btn.textContent.trim(),
          type:
            btn.dataset.type ||
            `${btn.dataset.base}_${btn.querySelector('input[type="radio"]:checked')?.value
            }`,
        }));

        const searchTermValue = searchTerm.value.trim();

        const sets = [];

        if (methodologyFilters.length > 0) {
          sets.push({
            sets: ["MetodologÃ­a"],
            size: methodologyFilters.length,
            items: [...methodologyFilters.map((f) => f.text)],
          });
        }

        if (clinicalFilters.length > 0) {
          sets.push({
            sets: ["ClÃ­nico"],
            size: clinicalFilters.length,
            items: clinicalFilters.map((f) => f.text),
          });
        }

        if (scopeFilters.length > 0) {
          sets.push({
            sets: ["Ãmbito"],
            size: scopeFilters.length,
            items: scopeFilters.map((f) => f.text),
          });
        }

        // AÃ±adir intersecciones
        if (sets.length > 1) {
          const categories = sets.map((s) => s.sets[0]);
          for (let i = 0; i < categories.length; i++) {
            for (let j = i + 1; j < categories.length; j++) {
              let size =
                Math.min(
                  sets.find((s) => s.sets[0] === categories[i]).size,
                  sets.find((s) => s.sets[0] === categories[j]).size
                ) / 3;
              sets.push({
                sets: [categories[i], categories[j]],
                size: size,
              });
            }
          }
          if (categories.length === 3) {
            let size = Math.min(sets[0].size, sets[1].size, sets[2].size) / 4;
            sets.push({
              sets: categories,
              size: size,
            });
          }
        }

        // Limpiar y dibujar
        const vennDiv = d3.select("#venn-diagram").html("");
        // Actualizar listas laterales
        const methodologyList = document.getElementById(
          "methodology-filters"
        );
        const clinicalList = document.getElementById("clinical-filters");
        const scopeList = document.getElementById("scope-filters");

        methodologyList.innerHTML =
          sets
            .find((s) => s.sets[0] === "MetodologÃ­a")
            ?.items.map((item) => `<li>${item}</li>`)
            .join("") || "";

        clinicalList.innerHTML =
          sets
            .find((s) => s.sets[0] === "ClÃ­nico")
            ?.items.map((item) => `<li>${item}</li>`)
            .join("") || "";

        scopeList.innerHTML =
          sets
            .find((s) => s.sets[0] === "Ãmbito")
            ?.items.map((item) => `<li>${item}</li>`)
            .join("") || "";
        if (sets.length > 0) {
          const chart = venn.VennDiagram().width(500).height(400);

          const div = vennDiv.datum(sets).call(chart);

          // Colorear cÃ­rculos
          div
            .selectAll(".venn-circle path")
            .style("fill-opacity", 0.2)
            .style("stroke-width", 2);

          // Mejorar la visualizaciÃ³n de texto
          div
            .selectAll("g")
            .filter((d) => d.sets.length === 1)
            .each(function (d) {
              const set = sets.find((s) => s.sets[0] === d.sets[0]);
              const g = d3.select(this);

              // TÃ­tulo principal con nÃºmero de filtros
              // TÃ­tulo principal con nÃºmero de filtros
              g.select("text")
                .style("font-weight", "bold")
                .style("font-size", "16px")
                .style("fill", "#ffd700")
                .text(`${d.sets[0]} (${set.items.length})`);
            })
            .select("path")
            .style("fill", (d) => {
              const colors = {
                MetodologÃ­a: "#3b82f6",
                ClÃ­nico: "#10b981",
                Ãmbito: "#8b5cf6",
              };
              return colors[d.sets[0]];
            });

          // Mantener el tooltip para informaciÃ³n detallada
          const tooltip = d3.select("#venn-tooltip");

          div
            .selectAll("g")
            .on("mouseover", function (event, d) {
              venn.sortAreas(div, d);
              tooltip.transition().duration(200).style("opacity", 0.9);

              let content = "";
              if (d.sets.length === 1) {
                const set = sets.find((s) => s.sets[0] === d.sets[0]);
                if (set) {
                  content = `<strong>${d.sets[0]}</strong><br>`;
                  content += set.items
                    .map((item) => `â€¢ ${item}`)
                    .join("<br>");
                }
              } else {
                content = `<strong>IntersecciÃ³n</strong><br>${d.sets.join(
                  " + "
                )}`;
              }

              tooltip
                .html(content)
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 10 + "px");
            })
            .on("mousemove", function (event) {
              tooltip
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 10 + "px");
            })
            .on("mouseout", function () {
              tooltip.transition().duration(200).style("opacity", 0);
            });
        }
      }

      // Actualizar la funciÃ³n mostrarQueryFinal para incluir el diagrama
      function mostrarQueryFinal() {
        var built = constructQuery(searchTerm.value.trim());
        finalQueryBox.textContent = built;
        updateVennDiagram();
      }

      // Actualizar el reset para incluir el diagrama
      resetButton.addEventListener("click", function () {
        activeFilters.clear();
        filterCount.textContent = 0;
        searchTerm.value = "";
        dateRange.value = "";
        sortMode.value = "date";

        document.querySelectorAll(".category-operator").forEach((select) => {
          select.value = "OR";
          categoryOperators[select.dataset.category] = "OR";
        });

        document.querySelectorAll(".filter-button").forEach(function (b) {
          b.classList.remove("active");
        });

        document
          .querySelectorAll('.versions-toggle input[type="radio"]')
          .forEach(function (r) {
            if (r.value === "sensible") {
              r.checked = true;
            }
          });

        finalQueryBox.textContent = "";
        updateVennDiagram();
      });
      // 14. Tutorial
      function iniciarTutorial() {
        var intro = introJs();
        intro.setOptions({
          steps: [
            {
              element: document.querySelector("#searchTerm"),
              intro:
                'Escribe tus tÃ©rminos de bÃºsqueda. Al pulsar Enter se iniciarÃ¡ la bÃºsqueda, mientras que Shift+Enter insertarÃ¡ un salto de lÃ­nea para que puedas estructurar tu consulta de forma clara. Cualquier bloque de texto iniciado con â€˜#â€™ se omite en la bÃºsqueda, permitiÃ©ndote documentar tu estrategia sin alterar el resultado. Para mayor precisiÃ³n, usa descriptores MeSH que puedes consultar en <a href="https://www.ncbi.nlm.nih.gov/mesh" target="_blank" style="color: #0e04c8; text-decoration: underline;">MeSH Database</a>. <br><br><strong>Importante:</strong> Al escribir, justo debajo de este cuadro, aparecerÃ¡ automÃ¡ticamente un <strong>contador con el nÃºmero total de resultados</strong> para tu consulta (incluyendo filtros y fecha)',
              position: "top",
            },

            {
              element: document.querySelector(".filters-section"),
              intro:
                "AquÃ­ encontrarÃ¡s tres categorÃ­as de filtros: MetodologÃ­a, Enfoque ClÃ­nico y Ãmbito/PoblaciÃ³n. Cada categorÃ­a tiene su propio operador booleano para combinar los filtros dentro de ella.",
              position: "right",
            },
            {
              element: document.querySelector("#infoModeToggle"),
              intro:
                "Activa este botÃ³n para ver informaciÃ³n detallada sobre cada filtro al pasar el cursor sobre ellos. Incluye la fuente del filtro y sus caracterÃ­sticas especÃ­ficas.",
              position: "bottom",
            },
            {
              element: document.querySelector(".operator-selector"),
              intro:
                "Cada categorÃ­a tiene su propio operador booleano: OR amplÃ­a resultados (mÃ¡s sensible), AND los restringe (mÃ¡s especÃ­fico). Puedes combinar diferentes operadores en diferentes categorÃ­as.",
              position: "left",
            },
            {
              element: document.querySelector(".versions-toggle"),
              intro:
                "Algunos filtros tienen versiones Sensible (S) o EspecÃ­fica (E). Sensible encuentra mÃ¡s resultados pero menos precisos, EspecÃ­fica encuentra menos pero mÃ¡s relevantes.",
              position: "left",
            },

            {
              element: document.querySelector("#dateRange"),
              intro:
                "Filtra resultados por fecha: 7 dÃ­as (muy reciente), 30 dÃ­as (Ãºltimo mes), 6 meses, 1 aÃ±o o 5 aÃ±os.",
              position: "top",
            },
            {
              element: document.querySelector("#sortMode"),
              intro:
                "'Por fecha' muestra los mÃ¡s recientes primero, 'Best match' ordena por relevancia segÃºn el algoritmo de PubMed.",
              position: "bottom",
            },
            {
              element: document.querySelector("#searchButton"),
              intro:
                "Lanza la bÃºsqueda en PubMed con todos los filtros seleccionados. Se abrirÃ¡ en una nueva pestaÃ±a.",
              position: "left",
            },
            {
              element: document.querySelector("#toggleVennButton"),
              intro:
                "Visualiza la relaciÃ³n entre los filtros activos mediante un diagrama de Venn interactivo. Al activar el diagrama podrÃ¡s ver cÃ³mo se agrupan los filtros por categorÃ­a y sus intersecciones.",
              position: "bottom",
              scrollTo: "tooltip",
            },
            {
              element: document.querySelector("#finalQuery"),
              intro:
                "AquÃ­ verÃ¡s la estrategia de bÃºsqueda completa que combina tus tÃ©rminos con los filtros seleccionados usando los operadores booleanos especÃ­ficos de cada categorÃ­a.",
              position: "top",
            },
            {
              element: document.querySelector("#mainIconsContainer"),
              intro:
                "Las bÃºsquedas se almacenan localmente en este navegador, por lo que se perderÃ¡n si borras la cachÃ© o utilizas otro dispositivo. Para evitarlo, utiliza los botones de exportar e importar y crea una copia de seguridad que puedas restaurar cuando lo necesites. Se recomienda guardar esta copia en un servicio en la nube o en otro sistema de almacenamiento que permita la sincronizaciÃ³n entre navegadores en distintos dispositivos, incluido el smartphone.",
              position: "bottom",
            },
            {
              element: document.querySelector("#toggleCountersBtn"),
              intro:
                "Este botÃ³n <i class='fas fa-eye-slash'></i> (ojo tachado) o <i class='fas fa-eye'></i> (ojo visible) te permite <strong>mostrar u ocultar los contadores de resultados individuales</strong> que aparecen en cada botÃ³n de filtro. Cuando estÃ¡n visibles, estos pequeÃ±os nÃºmeros te indican cuÃ¡ntos artÃ­culos recupera cada filtro especÃ­fico (combinado con tu tÃ©rmino de bÃºsqueda principal y el filtro de fecha). Â¡Muy Ãºtil para refinar tu estrategia!",
              position: "bottom", // O 'left'/'right' dependiendo de su posiciÃ³n final en #mainIconsContainer
            },
            {
              element: document.querySelector("#btn_chatgpt"),
              intro:
                "Con este botÃ³n se abre el asistente de ChatGPT en una nueva pestaÃ±a para sugerir tÃ©rminos y ayudarte a crear o refinar bÃºsquedas avanzadas en PubMed. Ten presente que cualquier bloque de texto iniciado con â€˜#â€™ (usado por ChatGPT para anotar descriptores o comentarios) se omite en la bÃºsqueda, permitiÃ©ndote documentar tu estrategia sin alterar el resultado.",
              position: "bottom",
            },

            {
              element: document.querySelector(".search-tips"),
              intro:
                "Encuentra consejos Ãºtiles para mejorar tus bÃºsquedas, como el uso de operadores booleanos y tÃ©rminos MeSH. Haz clic en el encabezado para expandir y ver todos los tips.",
              position: "top",
            },
          ],
          overlayOpacity: 0.9,
          highlightClass: "myHighlight",
          disableInteraction: true,
          skipLabel: "Saltar",
          nextLabel: "Siguiente",
          prevLabel: "Anterior",
          doneLabel: "Hecho",
          showStepNumbers: false,
          scrollToElement: true,
          scrollPadding: 1,
        });

        intro.oncomplete(function () {
          localStorage.setItem("tutorial_visto_v3", "true");
        });

        intro.onexit(function () {
          localStorage.setItem("tutorial_visto_v3", "true");
        });

        intro.start();
      }

      var tutorialVisto = localStorage.getItem("tutorial_visto_v3");
      if (!tutorialVisto) {
        // PequeÃ±o retraso para dar tiempo a que counters-buscar-pubmed.js inicialice el botÃ³n #toggleCountersBtn
        setTimeout(iniciarTutorial, 500); // 500ms suele ser suficiente
      }

      var startTutorialBtn = document.getElementById("startTutorialBtn");
      if (startTutorialBtn) {
        startTutorialBtn.addEventListener("click", function () {
          // PequeÃ±o retraso tambiÃ©n aquÃ­ por si acaso
          setTimeout(iniciarTutorial, 100);
        });
      }
      // Llamada inicial para establecer el estado correcto del contador al cargar la pÃ¡gina
      updateFilterCounterDisplay();
      // Llamada inicial para mostrar la query (por si hubiera valores prellenados o restaurados)
      mostrarQueryFinal(); // (Esta llamada probablemente ya estaba o es buena idea tenerla)
    });
    // Activar/desactivar botones segÃºn contenido
    document
      .getElementById("nombreNuevaBusqueda")
      ?.addEventListener("input", function (e) {
        const confirmBtn = document.getElementById("guardarBusquedaConfirm");
        confirmBtn.classList.toggle("active", e.target.value.trim() !== "");
      });

    document
      .getElementById("importarArchivo")
      ?.addEventListener("change", function (e) {
        const confirmBtn = document.getElementById("importarBusquedaConfirm");
        confirmBtn.classList.toggle("active", e.target.files.length > 0);
      });
    // Manejo del toggle de tips
    const searchTips = document.querySelector(".search-tips");
    const searchTipsHeader = document.querySelector(".search-tips-header");

    searchTipsHeader.addEventListener("click", () => {
      searchTips.classList.toggle("expanded");
    });
  </script>
  <script>
    // Manejo del autoajuste del textarea
    const searchTextarea = document.getElementById("searchTerm");

    function autoResizeTextarea() {
      this.style.height = "auto";
      this.style.height = this.scrollHeight + "px";
    }

    searchTextarea.addEventListener("input", autoResizeTextarea);
    searchTextarea.addEventListener("focus", autoResizeTextarea);
  </script>

  <script>
    // Funciones de manejo de modales
    function abrirModal(idBackdrop) {
      document.getElementById(idBackdrop).classList.add("show");
    }

    function cerrarModal(idBackdrop) {
      const modal = document.getElementById(idBackdrop);
      if (modal) {
        modal.classList.remove("show");
        // Limpiar inputs
        const inputs = modal.querySelectorAll('input[type="text"]');
        inputs.forEach((input) => (input.value = ""));
        // Resetear estado del botÃ³n confirmar
        const confirmBtn = modal.querySelector(".modal-confirm");
        if (confirmBtn) {
          confirmBtn.classList.remove("active");
        }
      }
    }

    // Manejo de la tecla ESC y eventos del modal
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        const modalAbierto = document.querySelector(".modal-backdrop.show");
        if (modalAbierto) {
          cerrarModal(modalAbierto.id);
        }
      }
    });

    // Activar/desactivar botÃ³n guardar segÃºn contenido del input
    document
      .getElementById("nombreNuevaBusqueda")
      .addEventListener("input", function (e) {
        const confirmBtn = document.getElementById("guardarBusquedaConfirm");
        if (e.target.value.trim()) {
          confirmBtn.classList.add("active");
        } else {
          confirmBtn.classList.remove("active");
        }
      });

    // Mejorar el manejo del guardado
    document
      .getElementById("guardarBusquedaConfirm")
      .addEventListener("click", function (e) {
        const input = document.getElementById("nombreNuevaBusqueda");
        const nombre = input.value.trim();

        if (!nombre) {
          return; // No hacer nada si no hay nombre
        }

        const bÃºsquedaActual = {
          termino: searchTerm.value.trim(),
          filtros: Array.from(activeFilters),
          fecha: dateRange.value,
          orden: sortMode.value,
        };
        const bÃºsquedas = obtenerBÃºsquedasGuardadas();
        bÃºsquedas[nombre] = bÃºsquedaActual;
        guardarBÃºsquedasGuardadas(bÃºsquedas);
        mostrarToast(`BÃºsqueda "${nombre}" guardada correctamente.`);
        cerrarModal("modalGuardarFondo");
      });

    // DelegaciÃ³n de eventos mejorada
    document.addEventListener("click", function (e) {
      // Cerrar al hacer click en el backdrop
      if (e.target.classList.contains("modal-backdrop")) {
        cerrarModal(e.target.id);
      }

      // Cerrar al hacer click en botÃ³n de cierre o cancelar
      if (
        e.target.classList.contains("close-modal") ||
        e.target.classList.contains("modal-cancel")
      ) {
        const modalId = e.target.getAttribute("data-close");
        if (modalId) {
          cerrarModal(modalId);
        }
      }
    });

    // Prevenir que clicks dentro del modal cierren el modal
    document.querySelectorAll(".modal").forEach((modal) => {
      modal.addEventListener("click", function (e) {
        e.stopPropagation();
      });
    });
  </script>
  <script>
    // Funciones de localStorage
    function obtenerBÃºsquedasGuardadas() {
      const almacenado = localStorage.getItem("saved_searches");
      return almacenado ? JSON.parse(almacenado) : {};
    }

    function guardarBÃºsquedasGuardadas(bÃºsquedas) {
      localStorage.setItem("saved_searches", JSON.stringify(bÃºsquedas));
    }

    // Funciones de manejo de modales
    function abrirModal(id_backdrop) {
      const backdrop = document.getElementById(id_backdrop);
      backdrop.classList.add("show");

      /* Enfocar el primer input o textarea que haya en el modal */
      const primer_input = backdrop.querySelector(
        ".modal input, .modal textarea"
      );
      if (primer_input) {
        primer_input.focus();
      }

      /* Opcional: si quieres que Enter cierre el modal o confirme */
      const confirm_btn = backdrop.querySelector(".modal-confirm");
      if (confirm_btn) {
        backdrop.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            /* Si el botÃ³n estÃ¡ activo, haz clic automÃ¡ticamente */
            if (confirm_btn.classList.contains("active")) {
              confirm_btn.click();
            }
          }
        });
      }
    }
    function cerrarModal(idBackdrop) {
      const modal = document.getElementById(idBackdrop);
      if (modal) {
        modal.classList.remove("show");
        const inputs = modal.querySelectorAll('input[type="text"]');
        inputs.forEach((input) => (input.value = ""));
        const confirmBtn = modal.querySelector(".modal-confirm");
        if (confirmBtn) {
          confirmBtn.classList.remove("active");
        }
      }
    }

    // Event listeners globales para modales
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        const modalAbierto = document.querySelector(".modal-backdrop.show");
        if (modalAbierto) {
          cerrarModal(modalAbierto.id);
        }
      }
    });

    document.addEventListener("click", function (e) {
      if (e.target.classList.contains("modal-backdrop")) {
        cerrarModal(e.target.id);
      }

      if (
        e.target.classList.contains("close-modal") ||
        e.target.classList.contains("modal-cancel")
      ) {
        const modalId = e.target.getAttribute("data-close");
        if (modalId) {
          cerrarModal(modalId);
        }
      }
    });
  </script>
  <script>
    /* manejo de alerts cuando se ejecutan modales */
    function mostrarToast(mensaje) {
      // Tomamos el div contenedor
      var toastContainer = document.getElementById("toastContainer");

      // Creamos el div que contendrÃ¡ el texto de la notificaciÃ³n
      var nuevoToast = document.createElement("div");
      nuevoToast.style.background = "#ffd700";
      nuevoToast.style.color = "#1c1e26";
      nuevoToast.style.padding = "10px 15px";
      nuevoToast.style.marginBottom = "10px";
      nuevoToast.style.borderRadius = "8px";
      nuevoToast.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
      nuevoToast.style.position = "relative"; // Para posicionar el botÃ³n de cierre
      nuevoToast.textContent = mensaje;

      // Creamos un botÃ³n de cierre manual
      var closeBtn = document.createElement("button");
      closeBtn.textContent = "X";
      closeBtn.style.position = "absolute";
      closeBtn.style.top = "5px";
      closeBtn.style.right = "10px";
      closeBtn.style.border = "none";
      closeBtn.style.background = "transparent";
      closeBtn.style.color = "#1c1e26";
      closeBtn.style.cursor = "pointer";
      closeBtn.style.fontWeight = "bold";

      // Evento para cerrar manualmente la notificaciÃ³n
      closeBtn.addEventListener("click", function () {
        toastContainer.removeChild(nuevoToast);
        // Si el contenedor se queda sin toasts, lo ocultamos
        if (!toastContainer.hasChildNodes()) {
          toastContainer.style.display = "none";
        }
      });

      // Agregamos el botÃ³n de cierre al toast
      nuevoToast.appendChild(closeBtn);

      // Mostramos el contenedor (por si estaba oculto)
      toastContainer.style.display = "block";

      // AÃ±adimos el toast al contenedor
      toastContainer.appendChild(nuevoToast);

      // Temporizador para borrar el toast automÃ¡ticamente tras 3 segundos
      setTimeout(function () {
        // Antes de borrarlo, comprobamos si sigue en pantalla
        if (toastContainer.contains(nuevoToast)) {
          toastContainer.removeChild(nuevoToast);
          if (!toastContainer.hasChildNodes()) {
            toastContainer.style.display = "none";
          }
        }
      }, 3000); // 3000 ms = 3 segundos
    }
  </script>
  <!-- GestiÃ³n de API Key NCBI -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Solo ejecutar si existe el gestor de API
      if (!window.ApiKeyManager) return;

      // Crear botÃ³n de configuraciÃ³n de API
      const mainIconsContainer =
        document.getElementById("mainIconsContainer");
      if (mainIconsContainer) {
        const btnApiConfig = document.createElement("button");
        btnApiConfig.id = "btnApiConfig";
        btnApiConfig.innerHTML =
          '<i class="fas fa-key" style="font-size: 1.3em;"></i>';
        btnApiConfig.title = "Configurar API Key NCBI";

        // --- LA ÃšNICA LÃNEA QUE NECESITAS CAMBIAR ---
        // Este estilo en lÃ­nea contiene todo: reseteo, color, espaciado y la alineaciÃ³n correcta para Flexbox.
        btnApiConfig.style.cssText =
          "background: transparent; border: none; color: inherit; cursor: pointer; padding: 8px; font-size: inherit; line-height: 1; align-self: center; position: relative; border-radius: 8px;";

        // Verificar si hay API key guardada
        if (window.ApiKeyManager.hasApiKey()) {
          btnApiConfig.classList.add("has-api");
          btnApiConfig.title = "API Key configurada (10 req/s)";

          // AÃ±adir indicador verde
          const indicator = document.createElement("span");
          indicator.style.cssText =
            "position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: #4caf50; border-radius: 50%; box-shadow: 0 0 4px #4caf50;";
          btnApiConfig.appendChild(indicator);
        }

        // LÃ³gica de inserciÃ³n (se mantiene igual)
        const toggleCountersButton =
          document.getElementById("toggleCountersBtn");
        if (toggleCountersButton) {
          toggleCountersButton.insertAdjacentElement(
            "afterend",
            btnApiConfig
          );
        } else {
          mainIconsContainer.appendChild(btnApiConfig);
        }

        // Event listener para abrir modal
        btnApiConfig.addEventListener("click", function () {
          openApiKeyModal();
        });
      }

      // FunciÃ³n para abrir el modal de API Key
      function openApiKeyModal() {
        const modal = document.getElementById("modalApiKeyFondo");
        const statusIcon = modal.querySelector(".status-icon");
        const statusText = modal.querySelector(".status-text");
        const apiBenefits = modal.querySelector(".api-benefits");
        const apiKeyInput = document.getElementById("apiKeyInput");
        const apiKeyExisting = document.getElementById("apiKeyExisting");
        const saveBtn = document.getElementById("saveApiKey");
        const errorDiv = document.getElementById("apiKeyError");

        // Resetear estado
        errorDiv.style.display = "none";
        apiKeyInput.value = "";

        // Verificar estado actual
        const hasKey = window.ApiKeyManager.hasApiKey();

        if (hasKey) {
          statusIcon.className = "status-icon";
          statusIcon.style.cssText =
            "width: 12px; height: 12px; border-radius: 50%; display: inline-block; background: #4caf50; box-shadow: 0 0 8px #4caf50;";
          statusText.textContent = "API Key configurada y activa";
          apiBenefits.style.display = "block";
          apiKeyExisting.style.display = "block";
          saveBtn.querySelector(".btn-text").textContent =
            "Actualizar API Key";
        } else {
          statusIcon.className = "status-icon";
          statusIcon.style.cssText =
            "width: 12px; height: 12px; border-radius: 50%; display: inline-block; background: #ff9800; box-shadow: 0 0 8px #ff9800;";
          statusText.textContent =
            "Sin API Key configurada (usando lÃ­mite pÃºblico: 3 req/s)";
          apiBenefits.style.display = "none";
          apiKeyExisting.style.display = "none";
          saveBtn.querySelector(".btn-text").textContent = "Guardar API Key";
        }

        // Mostrar modal usando la funciÃ³n existente
        abrirModal("modalApiKeyFondo");
      }

      // Toggle visibilidad de API Key
      const toggleVisBtn = document.getElementById("toggleApiKeyVisibility");
      const apiKeyInput = document.getElementById("apiKeyInput");

      if (toggleVisBtn && apiKeyInput) {
        toggleVisBtn.addEventListener("click", function () {
          const isPassword = apiKeyInput.type === "password";
          apiKeyInput.type = isPassword ? "text" : "password";
          this.innerHTML = isPassword
            ? '<i class="fas fa-eye-slash"></i>'
            : '<i class="fas fa-eye"></i>';
        });
      }

      // Guardar API Key
      const saveApiKeyBtn = document.getElementById("saveApiKey");
      if (saveApiKeyBtn) {
        saveApiKeyBtn.addEventListener("click", async function () {
          const apiKey = apiKeyInput.value.trim();
          const errorDiv = document.getElementById("apiKeyError");
          const btnText = this.querySelector(".btn-text");
          const btnLoading = this.querySelector(".btn-loading");

          if (!apiKey) {
            errorDiv.textContent = "Por favor ingresa una API Key";
            errorDiv.style.display = "block";
            return;
          }

          // Mostrar estado de carga
          btnText.style.display = "none";
          btnLoading.style.display = "inline";
          this.disabled = true;

          try {
            const result = await window.ApiKeyManager.saveApiKey(apiKey);

            if (result.success) {
              mostrarToast(
                "API Key guardada correctamente. Los contadores ahora se actualizarÃ¡n 3x mÃ¡s rÃ¡pido."
              );
              cerrarModal("modalApiKeyFondo");

              // Actualizar indicador visual
              const btnApi = document.getElementById("btnApiConfig");
              if (btnApi) {
                if (!btnApi.querySelector("span")) {
                  const indicator = document.createElement("span");
                  indicator.style.cssText =
                    "position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: #4caf50; border-radius: 50%; box-shadow: 0 0 4px #4caf50;";
                  btnApi.appendChild(indicator);
                }
                btnApi.classList.add("has-api");
                btnApi.title = "API Key configurada (10 req/s)";
              }
            }
          } catch (error) {
            errorDiv.textContent = error.message;
            errorDiv.style.display = "block";
          } finally {
            // Restaurar botÃ³n
            btnText.style.display = "inline";
            btnLoading.style.display = "none";
            this.disabled = false;
          }
        });
      }

      // Eliminar API Key
      const removeApiKeyBtn = document.getElementById("removeApiKey");
      if (removeApiKeyBtn) {
        removeApiKeyBtn.addEventListener("click", function () {
          if (
            confirm(
              "Â¿EstÃ¡s seguro de que deseas eliminar tu API Key? Los contadores se actualizarÃ¡n mÃ¡s lentamente."
            )
          ) {
            window.ApiKeyManager.removeApiKey();
            mostrarToast(
              "API Key eliminada. Usando lÃ­mite pÃºblico (3 req/s)."
            );
            cerrarModal("modalApiKeyFondo");

            // Actualizar indicador visual
            const btnApi = document.getElementById("btnApiConfig");
            if (btnApi) {
              const indicator = btnApi.querySelector("span");
              if (indicator) indicator.remove();
              btnApi.classList.remove("has-api");
              btnApi.title = "Configurar API Key NCBI";
            }
          }
        });
      }
    });
  </script>
  <!-- botÃ³n asistente GPT -->
  <script>
    document
      .getElementById("btn_chatgpt")
      .addEventListener("click", function () {
        window.open(
          "https://chatgpt.com/g/g-679fc8b5a99481919ee408d9c064f2ed-pubmed-help-asistente-para-busquedas-avanzadas",
          "_blank"
        );
      });
  </script>

  <!-- MODALES INDIVIDUALES PARA GUARDAR / RECUPERAR / BORRAR / EXPORTAR / IMPORTAR -->
  <!-- Modal Guardar -->
  <div class="modal-backdrop" id="modalGuardarFondo">
    <div class="modal" id="modalGuardar">
      <div class="modal-header">
        <h2 class="modal-title">Guardar BÃºsqueda</h2>
        <button class="close-modal" data-close="modalGuardarFondo">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <label for="nombreNuevaBusqueda">Nombre de la bÃºsqueda:</label>
        <input type="text" id="nombreNuevaBusqueda" />
        <div class="modal-buttons">
          <button class="modal-cancel" data-close="modalGuardarFondo">
            Cancelar
          </button>
          <button id="guardarBusquedaConfirm" class="modal-confirm active">
            Guardar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Recuperar -->
  <div class="modal-backdrop" id="modalRecuperarFondo">
    <div class="modal" id="modalRecuperar">
      <div class="modal-header">
        <h2 class="modal-title">Recuperar BÃºsqueda</h2>
        <button class="close-modal" data-close="modalRecuperarFondo">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <label for="recuperarSelect">BÃºsquedas guardadas:</label>
        <select id="recuperarSelect"></select>
        <div class="modal-buttons">
          <button class="modal-cancel" data-close="modalRecuperarFondo">
            Cancelar
          </button>
          <button id="recuperarBusquedaConfirm" class="modal-confirm active">
            Recuperar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Borrar -->
  <div class="modal-backdrop" id="modalBorrarFondo">
    <div class="modal" id="modalBorrar">
      <div class="modal-header">
        <h2 class="modal-title">Borrar BÃºsqueda</h2>
        <button class="close-modal" data-close="modalBorrarFondo">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <label for="borrarSelect">BÃºsquedas guardadas:</label>
        <select id="borrarSelect"></select>
        <div class="modal-buttons">
          <button class="modal-cancel" data-close="modalBorrarFondo">
            Cancelar
          </button>
          <button id="borrarBusquedaConfirm" class="modal-confirm active">
            Borrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalExportarFondo">
    <div class="modal" id="modalExportar">
      <div class="modal-header">
        <h2 class="modal-title">Exportar BÃºsquedas</h2>
        <button class="close-modal" data-close="modalExportarFondo">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <p>
          Se descargarÃ¡ un archivo JSON con todas las bÃºsquedas guardadas.
        </p>
        <div class="modal-buttons">
          <button class="modal-cancel" data-close="modalExportarFondo">
            Cancelar
          </button>
          <button id="exportarBusquedaConfirm" class="modal-confirm active">
            Exportar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalImportarFondo">
    <div class="modal" id="modalImportar">
      <div class="modal-header">
        <h2 class="modal-title">Importar BÃºsquedas</h2>
        <button class="close-modal" data-close="modalImportarFondo">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <label for="importarArchivo">Archivo JSON:</label>
        <input type="file" accept="application/json" id="importarArchivo" />
        <div class="modal-buttons">
          <button class="modal-cancel" data-close="modalImportarFondo">
            Cancelar
          </button>
          <button id="importarBusquedaConfirm" class="modal-confirm active">
            Importar
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal API Key -->
  <div class="modal-backdrop" id="modalApiKeyFondo">
    <div class="modal" id="modalApiKey" style="max-width: 600px">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-key"></i> ConfiguraciÃ³n de API Key NCBI
        </h2>
        <button class="close-modal" data-close="modalApiKeyFondo">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div id="apiKeyStatus" class="api-status-box">
          <div class="status-indicator">
            <span class="status-icon"></span>
            <span class="status-text"></span>
          </div>
          <div class="api-benefits" style="display: none">
            <p><strong>Beneficios de usar API Key:</strong></p>
            <ul style="margin: 10px 0 0 20px">
              <li>âœ“ 10 peticiones/segundo (vs 3 sin key)</li>
              <li>âœ“ ActualizaciÃ³n 3x mÃ¡s rÃ¡pida de contadores</li>
              <li>âœ“ Menor probabilidad de lÃ­mites de tasa</li>
            </ul>
          </div>
        </div>

        <div id="apiKeyForm">
          <label for="apiKeyInput">
            <strong>API Key de NCBI:</strong>
            <a href="https://account.ncbi.nlm.nih.gov/settings/" target="_blank" style="
                  margin-left: 10px;
                  color: #ffd700;
                  text-decoration: underline;
                  font-size: 0.9em;
                ">
              Consulta tu API Key
            </a>
          </label>
          <div style="position: relative">
            <input type="password" id="apiKeyInput" placeholder="Ingresa tu API Key de NCBI (36-40 caracteres)"
              style="width: 100%; padding-right: 40px" />
            <button type="button" id="toggleApiKeyVisibility" style="
                  position: absolute;
                  right: 10px;
                  top: 50%;
                  transform: translateY(-50%);
                  background: none;
                  border: none;
                  cursor: pointer;
                  color: #666;
                ">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <div id="apiKeyError" class="error-message" style="display: none; color: #d32f2f; margin-top: 10px"></div>

          <div class="help-box" style="
                margin-top: 15px;
                padding: 12px;
                background: var(
                  --card-bg,
                  #2a2d3a
                ); /* Fondo oscuro consistente */
                border: 1px solid var(--border-color, #444); /* Borde sutil para definirlo */
                border-radius: 8px;
              ">
            <p style="
                  margin: 0 0 10px 0;
                  font-size: 0.9em;
                  color: var(--text-primary, #fff);
                ">
              <strong>Para obtener tu API Key gratuita:</strong>
            </p>
            <ol style="
                  margin: 0;
                  padding-left: 20px;
                  font-size: 0.85em;
                  color: var(--text-secondary, #ccc);
                ">
              <li>
                Crea una cuenta en
                <a href="https://www.ncbi.nlm.nih.gov/account/" target="_blank"
                  style="color: var(--accent-color, #ffd700)">NCBI</a>
              </li>
              <li>
                Ve a
                <a href="https://www.ncbi.nlm.nih.gov/account/settings/" target="_blank"
                  style="color: var(--accent-color, #ffd700)">Settings</a>
              </li>
              <li>En "API Key Management", haz clic en "Create API Key"</li>
              <li>Copia la key generada y pÃ©gala aquÃ­</li>
            </ol>
            <p style="
                  margin: 10px 0 0 0;
                  font-size: 0.8em;
                  color: var(--text-secondary, #aaa);
                ">
              <i class="fas fa-lock"></i> Tu API key se almacena de forma
              segura en tu navegador local y nunca se envÃ­a a servidores
              externos.
            </p>
          </div>
        </div>

        <div id="apiKeyExisting" style="display: none; margin-top: 15px">
          <button id="removeApiKey" class="btn-danger" style="
                background: #d32f2f;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
              ">
            <i class="fas fa-trash"></i> Eliminar API Key
          </button>
        </div>

        <div class="modal-buttons">
          <button class="modal-cancel" data-close="modalApiKeyFondo">
            Cancelar
          </button>
          <button id="saveApiKey" class="modal-confirm">
            <span class="btn-text">Guardar API Key</span>
            <span class="btn-loading" style="display: none">
              <i class="fas fa-spinner fa-spin"></i> Validando...
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <div id="toastContainer" style="
        position: fixed;
        top: 200px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        display: none;
      "></div>
  <!-- Preparado para componente js  
    
<script src="/assets/js/buscar-pubmed.js"></script>
 -->
  <script src="/assets/js/api-key-manager.js"></script>
  <script defer src="/assets/js/counters-buscar-pubmed.js"></script>
</body>

</html>