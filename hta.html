<!--
=====================
  hta.html
  Ayuda para el An√°lisis de Registros de Hipertensi√≥n Arterial
=====================
-->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Asistente de An√°lisis de Registros de Hipertensi√≥n Arterial | @ernestob
    </title>
    <link rel="icon" href="/assets/images/icon.webp" />
    <link rel="stylesheet" href="/assets/css/main.css" />
    <link rel="stylesheet" href="/assets/css/header.css" />
    <link rel="stylesheet" href="/assets/css/components.css" />
    <link rel="stylesheet" href="/assets/css/footer.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <meta property="og:type" content="article" />
    <meta
      property="og:title"
      content="Asistente de An√°lisis de Registros de Hipertensi√≥n Arterial | ‚Äãüë®‚Äç‚öïÔ∏è ‚Äã@ernestob"
    />
    <meta
      property="og:site_name"
      content="Recursos para la gesti√≥n de informaci√≥n sanitaria üîéü©∫‚öï"
    />
    <meta
      property="og:url"
      content="https://ernestobarrera.github.io/hta.html"
    />
    <meta
      property="og:image"
      content="https://ernestobarrera.github.io/assets/images/me.png"
    />

    <!-- Precargar Chart.js para mejorar el rendimiento -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Fallback para Chart.js -->
    <script>
      window.addEventListener("load", function () {
        if (typeof Chart === "undefined") {
          const script = document.createElement("script");
          script.src =
            "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js";
          document.head.appendChild(script);
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Inter", sans-serif;
        background: #1c1e26;
      }
      .main-container {
        max-width: 1400px;
        margin-left: auto;
        margin-right: auto;
        padding: 0.5rem 0.5rem;
      }
      .hero-section {
        border-radius: 8px;
        padding: 0rem;
        margin-bottom: 0.1rem;
      }
      .intro-text {
        font-size: 1rem;
        line-height: 1.4;
        background: rgba(220, 38, 38, 0.15);
        border-radius: 6px;
        padding: 0.75rem;
        color: var(--text-secondary, #94a3b8);
        margin-bottom: 1rem;
      }
      .main-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.75rem;
        color: var(--text-primary, #fff);
      }
      .suite-content {
        background-color: #f8fafc;
        border-radius: 12px;
        padding: 24px;
        margin-top: 1rem;
      }
      .main-section {
        background-color: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        border: 1px solid #e2e8f0;
      }
      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #991b1b;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #fecaca;
      }
      .tool-card {
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1.5rem;
        height: fit-content;
      }
      .tool-button {
        background-color: #1e3a8a;
        color: white;
        font-weight: bold;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        transition: background-color 0.2s, box-shadow 0.2s;
        cursor: pointer;
        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        border: none;
      }
      .tool-button:hover:not(:disabled) {
        background-color: #1e40af;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      .tool-button:disabled {
        background-color: #94a3b8;
        cursor: not-allowed;
        opacity: 0.7;
      }
      .download-button {
        background-color: #047857;
      }
      .download-button:hover:not(:disabled) {
        background-color: #059669;
      }
      .clear-button {
        background-color: #be123c;
      }
      .clear-button:hover:not(:disabled) {
        background-color: #e11d48;
      }
      .print-button {
        background-color: #7c3aed;
      }
      .print-button:hover:not(:disabled) {
        background-color: #6d28d9;
      }

      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
      }
      .editable-log-table {
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
      }

      /* FIX: Estilos espec√≠ficos para el select y todos los inputs */
      .suite-content select {
        color: #1f2937 !important;
        background-color: #ffffff !important;
        font-weight: 500;
      }

      .suite-content select option {
        color: #1f2937 !important;
        background-color: #ffffff !important;
      }

      .suite-content input[type="text"],
      .suite-content input[type="number"] {
        color: #1f2937;
        font-weight: 500;
      }
      .suite-content ::placeholder {
        color: #9ca3af !important;
        opacity: 1 !important;
      }

      .editable-log-table input {
        width: 100%;
        min-width: 40px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        text-align: center;
        padding: 6px 8px;
        font-size: 0.875rem;
        transition: border-color 0.2s, box-shadow 0.2s;
        background-color: #ffffff;
      }

      input:focus,
      select:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        outline: none;
      }
      .editable-log-table input.invalid {
        border-color: #dc2626;
        background-color: #fef2f2;
      }
      .editable-log-table th,
      .editable-log-table td {
        font-size: 0.875rem;
        vertical-align: middle;
        text-align: center;
      }
      .editable-log-table td {
        padding: 4px;
        border-bottom: 1px solid #e5e7eb;
      }
      .editable-log-table th {
        background-color: #1e3a8a;
        color: white;
        padding: 10px 4px;
      }
      .editable-log-table thead th {
        border-bottom: 2px solid #1e40af;
      }
      .editable-log-table .day-label {
        font-weight: 600;
        text-align: left;
        padding-left: 1rem;
        width: 15%;
        color: #111827;
      }
      .editable-log-table .obs-column {
        width: 25%;
      }
      .editable-log-table tbody tr:nth-child(even) {
        background-color: #f9fafb;
      }

      .info-tooltip {
        position: relative;
        display: inline-block;
        cursor: pointer;
      }
      .info-tooltip .tooltip-text {
        visibility: hidden;
        width: 220px;
        background-color: #1f2937;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 10;
        bottom: 125%;
        left: 50%;
        margin-left: -110px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.75rem;
        font-weight: 400;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      .info-tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }
      .criteria-met {
        color: #16a34a;
        font-weight: 600;
      }
      .criteria-not-met {
        color: #dc2626;
        font-weight: 600;
      }

      @media print {
        body * {
          visibility: hidden;
        }
        .print-sheet,
        .print-sheet * {
          visibility: visible;
        }
        .print-sheet {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }
        .suite-content {
          display: none !important;
        }
        header,
        footer,
        .hero-section,
        .main-container {
          display: none !important;
        }
      }

      /* Estilos para la hoja de registro imprimible */
      .print-sheet {
        display: none;
        background: white;
        padding: 20mm;
        font-family: Arial, sans-serif;
      }

      @media print {
        .print-sheet {
          display: block;
        }
        @page {
          size: A4;
          margin: 0;
        }
      }
    </style>
  </head>
  <body>
    <include src="header.html"></include>
    <main class="main-container">
      <section class="hero-section">
        <h1 class="main-title">
          <i class="fas fa-heartbeat"></i>
          <span
            >Asistente de An√°lisis de Registros de Hipertensi√≥n Arterial</span
          >
        </h1>
        <p class="intro-text">
          Herramienta integral para el diagn√≥stico y seguimiento de la
          hipertensi√≥n arterial. Implementa las recomendaciones de las gu√≠as de
          la Sociedad Europea de Hipertensi√≥n (ESH 2023) y Cardiolog√≠a (ESC
          2024). Incluye registro AMPA (automedida de PA domiciliaria),
          clasificaci√≥n de fenotipos hipertensivos, calculadora de hipotensi√≥n
          ortost√°tica y an√°lisis avanzado con gr√°ficas evolutivas. Dise√±ada para
          profesionales sanitarios como apoyo a la toma de decisiones cl√≠nicas
          en Atenci√≥n Primaria.
        </p>
      </section>
      <div class="suite-content">
        <section id="patient-data" class="main-section">
          <h2 class="section-title">Datos del Informe</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label
                for="patientName"
                class="block text-sm font-medium text-gray-700"
                >Nombre del Paciente</label
              >
              <input
                type="text"
                id="patientName"
                placeholder="Introduzca el nombre completo"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
              />
            </div>
            <div>
              <label
                for="reportPeriod"
                class="block text-sm font-medium text-gray-700"
                >Periodo de Registro</label
              >
              <input
                type="text"
                id="reportPeriod"
                placeholder="Ej: 11/07/2025 - 17/07/2025"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
              />
            </div>
          </div>
        </section>
        <section id="herramientas" class="main-section">
          <h2 class="section-title">Panel de Control Interactivo</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
              <div class="tool-card">
                <h3 class="font-bold text-lg text-blue-900 mb-4">
                  Registro de PA Domiciliaria (AMPA)
                </h3>
                <div class="table-container">
                  <table class="w-full text-sm editable-log-table">
                    <thead>
                      <tr>
                        <th rowspan="2" class="day-label align-middle">D√≠a</th>
                        <th colspan="2" class="border-b border-blue-200">
                          Ma√±ana
                        </th>
                        <th colspan="2" class="border-b border-blue-200">
                          Tarde/Noche
                        </th>
                        <th rowspan="2" class="align-middle obs-column">
                          Observaciones
                        </th>
                      </tr>
                      <tr>
                        <th>Toma 1 (PAS/PAD/FC)</th>
                        <th>Toma 2 (PAS/PAD/FC)</th>
                        <th>Toma 1 (PAS/PAD/FC)</th>
                        <th>Toma 2 (PAS/PAD/FC)</th>
                      </tr>
                    </thead>
                    <tbody id="interactiveLogBody"></tbody>
                  </table>
                </div>
                <div
                  class="flex items-center justify-start mt-4 gap-4 flex-wrap"
                >
                  <div>
                    <label
                      for="startDaySelect"
                      class="text-sm font-medium text-gray-700"
                      >Empezar en:</label
                    ><select
                      id="startDaySelect"
                      class="rounded-md border-gray-300 shadow-sm text-sm p-2"
                    ></select>
                  </div>
                  <button id="addDayBtn" class="tool-button text-sm py-2">
                    A√±adir D√≠a
                  </button>
                </div>
                <div
                  id="summarySection"
                  class="mt-6 p-4 bg-white rounded-lg shadow-inner border"
                >
                  <h4 class="font-bold text-center text-blue-900 mb-3">
                    Resumen de Resultados
                  </h4>
                  <div
                    class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center"
                  >
                    <div id="weeklyAvgResult">
                      <p class="text-slate-700 text-sm">Promedio General</p>
                      <p class="font-bold text-2xl text-blue-900">-- / --</p>
                      <p class="text-xs text-slate-500">mmHg</p>
                    </div>
                    <div id="hrAvgResult">
                      <p class="text-slate-700 text-sm">
                        Promedio Frec. Card√≠aca
                      </p>
                      <p class="font-bold text-2xl text-blue-900">--</p>
                      <p class="text-xs text-slate-500">lpm</p>
                    </div>
                    <div id="variabilityResult">
                      <p class="text-slate-700 text-sm">
                        Variabilidad PAS (DE)
                        <span class="info-tooltip"
                          ><svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="12"
                            height="12"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="inline-block"
                          >
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line></svg
                          ><span class="tooltip-text"
                            >La Desviaci√≥n Est√°ndar (DE) mide la fluctuaci√≥n de
                            la PA. Una DE alta (>15 mmHg) es un factor de riesgo
                            cardiovascular independiente.</span
                          ></span
                        >
                      </p>
                      <p class="font-bold text-2xl text-blue-900">--</p>
                      <p class="text-xs text-slate-500">mmHg</p>
                    </div>
                  </div>
                  <p
                    id="weeklyAvgInfo"
                    class="text-center text-xs text-slate-500 mt-3"
                  >
                    Introduzca valores para calcular. El promedio se calcula
                    excluyendo el primer d√≠a, seg√∫n las gu√≠as cl√≠nicas.
                  </p>
                </div>
                <div class="mt-4 h-80" style="position: relative">
                  <canvas id="bpChart"></canvas>
                  <div
                    id="chartLoading"
                    style="
                      position: absolute;
                      top: 50%;
                      left: 50%;
                      transform: translate(-50%, -50%);
                      text-align: center;
                      color: #6b7280;
                    "
                  >
                    <div style="margin-bottom: 8px">
                      <svg
                        style="
                          display: inline-block;
                          width: 24px;
                          height: 24px;
                          animation: spin 1s linear infinite;
                        "
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                        />
                      </svg>
                    </div>
                    <p style="font-size: 0.875rem">Cargando gr√°fica...</p>
                  </div>
                  <div
                    id="chartError"
                    style="
                      display: none;
                      text-align: center;
                      padding: 40px;
                      color: #6b7280;
                    "
                  >
                    <p>La gr√°fica no se puede mostrar en este momento.</p>
                    <p style="font-size: 0.875rem">
                      Intente recargar la p√°gina.
                    </p>
                  </div>
                </div>
                <style>
                  @keyframes spin {
                    from {
                      transform: rotate(0deg);
                    }
                    to {
                      transform: rotate(360deg);
                    }
                  }
                </style>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mt-4">
                  <button id="clearLogBtn" class="tool-button clear-button">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path
                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                      ></path>
                      <line x1="10" y1="11" x2="10" y2="17"></line>
                      <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                    Limpiar Tabla
                  </button>
                  <button
                    id="downloadLogBtn"
                    class="tool-button download-button"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                      ></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Descargar PDF
                  </button>
                  <button id="printSheetBtn" class="tool-button print-button">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="6 9 6 2 18 2 18 9"></polyline>
                      <path
                        d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"
                      ></path>
                      <rect x="6" y="14" width="12" height="8"></rect>
                    </svg>
                    Hoja de Registro
                  </button>
                </div>
              </div>
            </div>
            <div class="lg:col-span-1 space-y-8">
              <div class="tool-card">
                <h3 class="font-bold text-lg text-blue-900 mb-2">
                  Clasificador de Fenotipo de HTA
                  <span class="info-tooltip"
                    ><svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="12"
                      height="12"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="inline-block"
                    >
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="12" y1="16" x2="12" y2="12"></line>
                      <line x1="12" y1="8" x2="12.01" y2="8"></line></svg
                    ><span class="tooltip-text"
                      >Compara la PA de consulta con la domiciliaria (AMPA) para
                      un diagn√≥stico preciso. Ayuda a identificar la HTA de Bata
                      Blanca y la HTA Enmascarada.</span
                    ></span
                  >
                </h3>
                <p class="text-sm text-slate-600 mb-4">
                  Compare la PA de consulta con la domiciliaria para un
                  diagn√≥stico preciso.
                </p>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700"
                      >1. PA en Consulta M√©dica</label
                    >
                    <div class="grid grid-cols-2 gap-2 mt-1">
                      <input
                        type="number"
                        id="officeSbp"
                        placeholder="PAS"
                        class="pheno-input block w-full rounded-md border-gray-300 shadow-sm text-sm p-2"
                      /><input
                        type="number"
                        id="officeDbp"
                        placeholder="PAD"
                        class="pheno-input block w-full rounded-md border-gray-300 shadow-sm text-sm p-2"
                      />
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700"
                      >2. Promedio PA Domiciliaria (Calculado)</label
                    >
                    <div
                      class="mt-1 p-2 bg-slate-200 border border-gray-300 rounded-md text-center cursor-not-allowed"
                    >
                      <span
                        id="ampaAvgForPheno"
                        class="font-bold text-lg text-slate-700"
                        >-- / --</span
                      ><span class="text-sm text-slate-500"> mmHg</span>
                    </div>
                  </div>
                </div>
                <div
                  id="phenotypeResult"
                  class="mt-4 text-center p-3 rounded-lg"
                >
                  <p class="font-bold text-lg text-blue-900">
                    Introduzca la PA de consulta...
                  </p>
                </div>
              </div>
              <div class="tool-card">
                <h3 class="font-bold text-lg text-blue-900 mb-4">
                  Calculadora de Hipotensi√≥n Ortost√°tica
                </h3>
                <div id="orthoCalculator" class="grid md:grid-cols-1 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700"
                      >PA en Reposo (Sentado)</label
                    >
                    <div class="grid grid-cols-2 gap-2 mt-1">
                      <input
                        type="number"
                        id="orthoSbpBase"
                        placeholder="PAS"
                        class="ortho-input block w-full rounded-md border-gray-300 shadow-sm text-sm p-2"
                      /><input
                        type="number"
                        id="orthoDbpBase"
                        placeholder="PAD"
                        class="ortho-input block w-full rounded-md border-gray-300 shadow-sm text-sm p-2"
                      />
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700"
                      >PA de Pie (tras 1-3 min)</label
                    >
                    <div class="grid grid-cols-2 gap-2 mt-1">
                      <input
                        type="number"
                        id="orthoSbpStand"
                        placeholder="PAS"
                        class="ortho-input block w-full rounded-md border-gray-300 shadow-sm text-sm p-2"
                      /><input
                        type="number"
                        id="orthoDbpStand"
                        placeholder="PAD"
                        class="ortho-input block w-full rounded-md border-gray-300 shadow-sm text-sm p-2"
                      />
                    </div>
                  </div>
                </div>
                <div
                  id="orthoResult"
                  class="mt-4 text-left p-4 rounded-lg bg-gray-100 border border-gray-200"
                >
                  <p
                    id="orthoDiagnosis"
                    class="font-bold text-lg mb-2 text-center text-gray-700"
                  >
                    Introduzca los 4 valores...
                  </p>
                  <div id="orthoDetails" class="text-sm space-y-1"></div>
                  <p
                    id="orthoClinicalNote"
                    class="text-xs text-gray-500 mt-3 border-t pt-2"
                  ></p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Hoja de registro imprimible (oculta en pantalla) -->
    <div class="print-sheet" id="printSheet"></div>

    <include src="footer.html"></include>

    <script src="/assets/js/include.js"></script>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-YFKR6RB1ZC"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-YFKR6RB1ZC");
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Funci√≥n para cargar Chart.js din√°micamente si no est√° disponible
        function loadChartJS(callback) {
          if (typeof Chart !== "undefined") {
            callback();
            return;
          }

          const script = document.createElement("script");
          script.src =
            "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js";
          script.onload = callback;
          script.onerror = () => {
            console.error("No se pudo cargar Chart.js");
            const canvas = document.getElementById("bpChart");
            const errorDiv = document.getElementById("chartError");
            const loadingDiv = document.getElementById("chartLoading");
            if (canvas) canvas.style.display = "none";
            if (loadingDiv) loadingDiv.style.display = "none";
            if (errorDiv) errorDiv.style.display = "block";
          };
          document.head.appendChild(script);
        }

        // Esperar a que todas las librer√≠as est√©n cargadas
        loadChartJS(() => {
          let checkLibraries = setInterval(() => {
            if (typeof Chart !== "undefined" && typeof jspdf !== "undefined") {
              clearInterval(checkLibraries);
              initializeHypertensionApp();
            }
          }, 50);
        });

        function initializeHypertensionApp() {
          const logBody = document.getElementById("interactiveLogBody");
          const addDayBtn = document.getElementById("addDayBtn");
          const startDaySelect = document.getElementById("startDaySelect");
          const days = [
            "Lunes",
            "Martes",
            "Mi√©rcoles",
            "Jueves",
            "Viernes",
            "S√°bado",
            "Domingo",
          ];
          let dayCounter = 0;
          let bpChartInstance = null;
          let chartInitAttempts = 0;
          const maxChartInitAttempts = 20;
          const LOCAL_STORAGE_KEY = "hypertensionSuiteData_v2";

          function initializeApp() {
            // Primero inicializar el select de d√≠as
            days.forEach((day, index) => {
              const option = document.createElement("option");
              option.value = index;
              option.textContent = day;
              startDaySelect.appendChild(option);
            });

            // Configurar event listeners
            setupEventListeners();

            // Inicializar el gr√°fico (con reintentos si es necesario)
            initializeChart();

            // Cargar datos despu√©s de un peque√±o delay para asegurar que todo est√© listo
            setTimeout(() => {
              loadDataFromLocalStorage();
            }, 100);
          }

          function setupEventListeners() {
            logBody.addEventListener("input", handleLogInput);
            addDayBtn.addEventListener("click", addDayRow);
            startDaySelect.addEventListener("change", handleDayChange);
            document
              .getElementById("clearLogBtn")
              .addEventListener("click", clearLog);
            document
              .getElementById("downloadLogBtn")
              .addEventListener("click", downloadPdf);
            document
              .getElementById("printSheetBtn")
              .addEventListener("click", printRegistrationSheet);
            document
              .getElementById("orthoCalculator")
              .addEventListener("input", calculateOrtho);
            document
              .querySelectorAll(".pheno-input")
              .forEach((input) =>
                input.addEventListener("input", classifyPhenotype)
              );
          }

          function initializeChart() {
            // Verificar que Chart.js est√© cargado
            if (typeof Chart === "undefined") {
              chartInitAttempts++;
              if (chartInitAttempts >= maxChartInitAttempts) {
                console.error(
                  "Chart.js no se pudo cargar despu√©s de m√∫ltiples intentos"
                );
                const canvas = document.getElementById("bpChart");
                const errorDiv = document.getElementById("chartError");
                const loadingDiv = document.getElementById("chartLoading");
                if (canvas) canvas.style.display = "none";
                if (loadingDiv) loadingDiv.style.display = "none";
                if (errorDiv) errorDiv.style.display = "block";
                return;
              }
              console.warn(
                "Chart.js no est√° cargado. Intento " +
                  chartInitAttempts +
                  " de " +
                  maxChartInitAttempts
              );
              setTimeout(initializeChart, 100);
              return;
            }

            try {
              const ctx = document.getElementById("bpChart").getContext("2d");
              bpChartInstance = new Chart(ctx, {
                type: "line",
                data: {
                  labels: [],
                  datasets: [
                    {
                      label: "Sist√≥lica (PAS)",
                      data: [],
                      borderColor: "rgb(220, 38, 38)",
                      tension: 0.2,
                      yAxisID: "y",
                    },
                    {
                      label: "Diast√≥lica (PAD)",
                      data: [],
                      borderColor: "rgb(37, 99, 235)",
                      tension: 0.2,
                      yAxisID: "y",
                    },
                    {
                      label: "Frec. Card√≠aca (FC)",
                      data: [],
                      borderColor: "rgb(22, 163, 74)",
                      tension: 0.2,
                      yAxisID: "y1",
                      hidden: false,
                    },
                  ],
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  interaction: { mode: "index", intersect: false },
                  plugins: {
                    legend: { position: "top" },
                    title: {
                      display: true,
                      text: "Evoluci√≥n de la Presi√≥n Arterial y Frecuencia Card√≠aca",
                    },
                    annotation: {
                      annotations: {
                        htaThresholdPAS: {
                          type: "line",
                          yMin: 135,
                          yMax: 135,
                          borderColor: "rgba(220, 38, 38, 0.5)",
                          borderWidth: 2,
                          borderDash: [6, 6],
                          label: {
                            content: "Umbral HTA (135)",
                            position: "start",
                            enabled: true,
                            font: { size: 10 },
                          },
                          scaleID: "y",
                        },
                        htaThresholdPAD: {
                          type: "line",
                          yMin: 85,
                          yMax: 85,
                          borderColor: "rgba(37, 99, 235, 0.5)",
                          borderWidth: 2,
                          borderDash: [6, 6],
                          label: {
                            content: "Umbral HTA (85)",
                            position: "start",
                            enabled: true,
                            font: { size: 10 },
                          },
                          scaleID: "y",
                        },
                      },
                    },
                  },
                  scales: {
                    y: {
                      position: "left",
                      title: { display: true, text: "mmHg" },
                    },
                    y1: {
                      position: "right",
                      title: { display: true, text: "lpm" },
                      grid: { drawOnChartArea: false },
                    },
                  },
                },
              });
              // Ocultar el mensaje de carga
              const loadingDiv = document.getElementById("chartLoading");
              if (loadingDiv) loadingDiv.style.display = "none";
            } catch (error) {
              console.error("Error al inicializar el gr√°fico:", error);
              const canvas = document.getElementById("bpChart");
              const errorDiv = document.getElementById("chartError");
              const loadingDiv = document.getElementById("chartLoading");
              if (canvas) canvas.style.display = "none";
              if (loadingDiv) loadingDiv.style.display = "none";
              if (errorDiv) errorDiv.style.display = "block";
            }
          }

          function updateChart(allData) {
            // Verificar que el gr√°fico exista y Chart.js est√© cargado
            if (!bpChartInstance || typeof Chart === "undefined") {
              console.warn("Chart no disponible a√∫n. Reintentando...");
              setTimeout(() => updateChart(allData), 100);
              return;
            }

            const labels = [],
              sbpData = [],
              dbpData = [],
              hrData = [];
            allData.forEach((d) => {
              labels.push(d.label);
              sbpData.push(d.sbp);
              dbpData.push(d.dbp);
              hrData.push(d.hr);
            });
            bpChartInstance.data.labels = labels;
            bpChartInstance.data.datasets[0].data = sbpData;
            bpChartInstance.data.datasets[1].data = dbpData;
            bpChartInstance.data.datasets[2].data = hrData;
            bpChartInstance.update();
          }

          function handleLogInput(e) {
            if (e.target.tagName === "INPUT") {
              if (e.target.type === "number") validateBPInput(e.target);
              runAllCalculations();
            }
          }

          function handleDayChange() {
            reorderTable();
            runAllCalculations();
          }

          function runAllCalculations() {
            const { avgSbp, avgDbp, avgHr, sbpVariability, chartData } =
              calculateAverages();
            updateSummaryUI(avgSbp, avgDbp, avgHr, sbpVariability);
            updateChart(chartData);
            classifyPhenotype();
            saveDataToLocalStorage();
          }

          function calculateAverages() {
            const rows = Array.from(logBody.querySelectorAll("tr"));
            const rowsToAverage = rows.length > 1 ? rows.slice(1) : rows;
            let sbpValues = [],
              dbpValues = [],
              hrValues = [];
            rowsToAverage.forEach((row) => {
              row.querySelectorAll(".sbp").forEach((i) => {
                if (i.value) sbpValues.push(parseFloat(i.value));
              });
              row.querySelectorAll(".dbp").forEach((i) => {
                if (i.value) dbpValues.push(parseFloat(i.value));
              });
              row.querySelectorAll(".hr").forEach((i) => {
                if (i.value) hrValues.push(parseFloat(i.value));
              });
            });
            const avgSbp =
              sbpValues.length > 0
                ? sbpValues.reduce((a, b) => a + b, 0) / sbpValues.length
                : null;
            const avgDbp =
              dbpValues.length > 0
                ? dbpValues.reduce((a, b) => a + b, 0) / dbpValues.length
                : null;
            const avgHr =
              hrValues.length > 0
                ? hrValues.reduce((a, b) => a + b, 0) / hrValues.length
                : null;
            const calculateSD = (arr) => {
              if (arr.length < 2) return 0;
              const mean = arr.reduce((a, b) => a + b) / arr.length;
              return Math.sqrt(
                arr.map((x) => Math.pow(x - mean, 2)).reduce((a, b) => a + b) /
                  arr.length
              );
            };
            const sbpVariability = calculateSD(sbpValues);
            const chartData = [];
            rows.forEach((row) => {
              const day = row
                .querySelector(".day-label")
                .textContent.substring(0, 3);
              const inputs = row.querySelectorAll('input[type="number"]');
              const morningAvg = getPeriodAverage(
                [inputs[0], inputs[1], inputs[2]],
                [inputs[3], inputs[4], inputs[5]]
              );
              const eveningAvg = getPeriodAverage(
                [inputs[6], inputs[7], inputs[8]],
                [inputs[9], inputs[10], inputs[11]]
              );
              if (morningAvg)
                chartData.push({ label: `${day}-M`, ...morningAvg });
              if (eveningAvg)
                chartData.push({ label: `${day}-T`, ...eveningAvg });
            });
            function getPeriodAverage(take1, take2) {
              const sbp = [
                parseFloat(take1[0].value),
                parseFloat(take2[0].value),
              ].filter((v) => !isNaN(v));
              const dbp = [
                parseFloat(take1[1].value),
                parseFloat(take2[1].value),
              ].filter((v) => !isNaN(v));
              const hr = [
                parseFloat(take1[2].value),
                parseFloat(take2[2].value),
              ].filter((v) => !isNaN(v));
              if (sbp.length === 0) return null;
              return {
                sbp: sbp.reduce((a, b) => a + b, 0) / sbp.length,
                dbp: dbp.reduce((a, b) => a + b, 0) / dbp.length,
                hr:
                  hr.length > 0
                    ? hr.reduce((a, b) => a + b, 0) / hr.length
                    : null,
              };
            }
            return { avgSbp, avgDbp, avgHr, sbpVariability, chartData };
          }

          function updateSummaryUI(avgSbp, avgDbp, avgHr, sbpVariability) {
            document
              .getElementById("weeklyAvgResult")
              .querySelector("p:nth-child(2)").textContent =
              avgSbp && avgDbp
                ? `${Math.round(avgSbp)} / ${Math.round(avgDbp)}`
                : "-- / --";
            document
              .getElementById("hrAvgResult")
              .querySelector("p:nth-child(2)").textContent = avgHr
              ? Math.round(avgHr)
              : "--";
            document
              .getElementById("variabilityResult")
              .querySelector("p:nth-child(2)").textContent = sbpVariability
              ? sbpVariability.toFixed(1)
              : "--";
            document.getElementById("ampaAvgForPheno").textContent =
              avgSbp && avgDbp
                ? `${Math.round(avgSbp)} / ${Math.round(avgDbp)}`
                : "-- / --";
          }

          function validateBPInput(input) {
            const value = parseFloat(input.value);
            const isInvalid =
              input.value !== "" && (isNaN(value) || value < 30 || value > 300);
            input.classList.toggle("invalid", isInvalid);
          }

          function addDayRow() {
            if (dayCounter >= 7) return;
            const startDayIndex = parseInt(startDaySelect.value, 10);
            const dayName = days[(startDayIndex + dayCounter) % 7];
            const row = document.createElement("tr");
            row.innerHTML = `
                <td class="day-label">${dayName}</td>
                <td><div class="measurement-group"><div><input type="number" class="bp-input sbp" placeholder="PAS" aria-label="PAS Ma√±ana Toma 1"><input type="number" class="bp-input dbp" placeholder="PAD" aria-label="PAD Ma√±ana Toma 1"><input type="number" class="bp-input hr" placeholder="FC" aria-label="FC Ma√±ana Toma 1"></div></div></td>
                <td><div class="measurement-group"><div><input type="number" class="bp-input sbp" placeholder="PAS" aria-label="PAS Ma√±ana Toma 2"><input type="number" class="bp-input dbp" placeholder="PAD" aria-label="PAD Ma√±ana Toma 2"><input type="number" class="bp-input hr" placeholder="FC" aria-label="FC Ma√±ana Toma 2"></div></div></td>
                <td><div class="measurement-group"><div><input type="number" class="bp-input sbp" placeholder="PAS" aria-label="PAS Tarde Toma 1"><input type="number" class="bp-input dbp" placeholder="PAD" aria-label="PAD Tarde Toma 1"><input type="number" class="bp-input hr" placeholder="FC" aria-label="FC Tarde Toma 1"></div></div></td>
                <td><div class="measurement-group"><div><input type="number" class="bp-input sbp" placeholder="PAS" aria-label="PAS Tarde Toma 2"><input type="number" class="bp-input dbp" placeholder="PAD" aria-label="PAD Tarde Toma 2"><input type="number" class="bp-input hr" placeholder="FC" aria-label="FC Tarde Toma 2"></div></div></td>
                <td><input type="text" class="obs-input" placeholder="S√≠ntomas, olvidos..." aria-label="Observaciones para ${dayName}"></td>
            `;
            logBody.appendChild(row);
            dayCounter++;
            addDayBtn.disabled = dayCounter >= 7;
          }

          function reorderTable() {
            const startDayIndex = parseInt(startDaySelect.value, 10);
            logBody.querySelectorAll("tr").forEach((row, index) => {
              row.querySelector(".day-label").textContent =
                days[(startDayIndex + index) % 7];
            });
          }

          function clearLog() {
            if (
              confirm(
                "¬øEst√° seguro de que desea borrar todos los datos de la tabla? Esta acci√≥n no se puede deshacer."
              )
            ) {
              localStorage.removeItem(LOCAL_STORAGE_KEY);
              startDaySelect.value = "0";
              logBody.innerHTML = "";
              dayCounter = 0;
              addDayRow();
              addDayBtn.disabled = false;
              runAllCalculations();
            }
          }

          function getPhenotypeClassification() {
            const officeSbp = parseFloat(
              document.getElementById("officeSbp").value
            );
            const officeDbp = parseFloat(
              document.getElementById("officeDbp").value
            );
            const { avgSbp, avgDbp } = calculateAverages();

            if (isNaN(officeSbp) || isNaN(officeDbp)) {
              return {
                name: "Datos de Consulta Incompletos",
                explanation:
                  "Introduzca los valores de Presi√≥n Arterial en consulta.",
              };
            }
            if (!avgSbp || !avgDbp) {
              return {
                name: "Datos Domiciliarios Incompletos",
                explanation:
                  "Introduzca los valores de Presi√≥n Arterial domiciliaria (AMPA).",
              };
            }

            const isOfficeHigh = officeSbp >= 140 || officeDbp >= 90;
            const isAmpaHigh = avgSbp >= 135 || avgDbp >= 85;

            if (isOfficeHigh && isAmpaHigh)
              return {
                name: "HTA Sostenida",
                explanation:
                  "La presi√≥n es alta tanto en la consulta como en casa. Es el tipo m√°s com√∫n y requiere tratamiento y seguimiento.",
              };
            if (isOfficeHigh && !isAmpaHigh)
              return {
                name: "HTA de Bata Blanca",
                explanation:
                  "La presi√≥n sube en el entorno m√©dico, pero es normal en casa. El riesgo es menor, pero necesita vigilancia.",
              };
            if (!isOfficeHigh && isAmpaHigh)
              return {
                name: "HTA Enmascarada",
                explanation:
                  "La presi√≥n es normal en consulta pero alta en casa. Es un fenotipo de alto riesgo porque puede pasar desapercibido.",
              };
            return {
              name: "Normotensi√≥n",
              explanation:
                "La presi√≥n es normal en ambos entornos. ¬°Excelente! Se recomienda mantener un estilo de vida saludable.",
            };
          }

          function classifyPhenotype() {
            const { name, explanation } = getPhenotypeClassification();
            const resultEl = document.getElementById("phenotypeResult");

            resultEl.className = "mt-4 p-4 rounded-lg";

            let cardBgClass = "bg-gray-100";
            let titleColorClass = "text-blue-900";
            let explanationColorClass = "text-slate-600";

            if (name === "HTA Sostenida") {
              cardBgClass = "bg-red-100 border border-red-300";
              titleColorClass = "text-red-800";
              explanationColorClass = "text-red-900";
            } else if (name === "HTA de Bata Blanca") {
              cardBgClass = "bg-yellow-100 border border-yellow-300";
              titleColorClass = "text-amber-800";
              explanationColorClass = "text-amber-900";
            } else if (name === "HTA Enmascarada") {
              cardBgClass = "bg-orange-100 border border-orange-300";
              titleColorClass = "text-orange-800";
              explanationColorClass = "text-orange-900";
            } else if (name === "Normotensi√≥n") {
              cardBgClass = "bg-green-100 border border-green-300";
              titleColorClass = "text-green-800";
              explanationColorClass = "text-green-900";
            } else {
              cardBgClass = "bg-yellow-100 border border-yellow-300";
              titleColorClass = "text-amber-800";
              explanationColorClass = "text-amber-900";
            }

            resultEl.innerHTML = `<p class="font-bold text-lg text-center mb-2 ${titleColorClass}">${name}</p><p class="text-xs ${explanationColorClass} text-center">${explanation}</p>`;
            resultEl.classList.add(...cardBgClass.split(" "));
          }

          function calculateOrtho() {
            const sbpBase = parseFloat(
              document.getElementById("orthoSbpBase").value
            );
            const dbpBase = parseFloat(
              document.getElementById("orthoDbpBase").value
            );
            const sbpStand = parseFloat(
              document.getElementById("orthoSbpStand").value
            );
            const dbpStand = parseFloat(
              document.getElementById("orthoDbpStand").value
            );

            const diagnosisEl = document.getElementById("orthoDiagnosis");
            const resultContainer = document.getElementById("orthoResult");
            const detailsEl = document.getElementById("orthoDetails");
            const noteEl = document.getElementById("orthoClinicalNote");

            resultContainer.className = "mt-4 text-left p-4 rounded-lg";
            detailsEl.innerHTML = "";
            noteEl.innerHTML = "";

            if (
              isNaN(sbpBase) ||
              isNaN(dbpBase) ||
              isNaN(sbpStand) ||
              isNaN(dbpStand)
            ) {
              diagnosisEl.textContent = "Introduzca los 4 valores...";
              diagnosisEl.className =
                "font-bold text-lg mb-2 text-center text-gray-700";
              resultContainer.classList.add(
                "bg-gray-100",
                "border",
                "border-gray-200"
              );
              return;
            }

            const sbpDrop = sbpBase - sbpStand;
            const dbpDrop = dbpBase - dbpStand;

            const sbpCriterionMet = sbpDrop >= 20;
            const dbpCriterionMet = dbpDrop >= 10;
            const isPositive = sbpCriterionMet || dbpCriterionMet;

            const sbpStatusHTML = sbpCriterionMet
              ? `<span class="text-xs font-semibold text-green-600">[CUMPLE]</span>`
              : `<span class="text-xs font-semibold text-red-600">[NO CUMPLE]</span>`;

            const dbpStatusHTML = dbpCriterionMet
              ? `<span class="text-xs font-semibold text-green-600">[CUMPLE]</span>`
              : `<span class="text-xs font-semibold text-red-600">[NO CUMPLE]</span>`;

            if (isPositive) {
              diagnosisEl.textContent = "Positivo para Hipotensi√≥n Ortost√°tica";
              diagnosisEl.className =
                "font-bold text-lg mb-2 text-center text-red-700";
              resultContainer.classList.add(
                "bg-red-100",
                "border",
                "border-red-300"
              );

              detailsEl.innerHTML = `
              <div class="flex justify-between items-center ${
                sbpCriterionMet ? "font-bold" : ""
              } text-red-800">
                  <span>Ca√≠da PAS: <strong class="text-base">${sbpDrop} mmHg</strong> <span class="text-xs text-red-700">(Criterio: &ge;20)</span></span>
                  ${sbpStatusHTML}
              </div>
              <div class="flex justify-between items-center ${
                dbpCriterionMet ? "font-bold" : ""
              } text-red-800">
                  <span>Ca√≠da PAD: <strong class="text-base">${dbpDrop} mmHg</strong> <span class="text-xs text-red-700">(Criterio: &ge;10)</span></span>
                  ${dbpStatusHTML}
              </div>
            `;

              let clinicalNoteText = "";
              if (sbpCriterionMet && dbpCriterionMet) {
                clinicalNoteText =
                  "Diagn√≥stico positivo por ca√≠da tanto sist√≥lica como diast√≥lica. Indica una respuesta ortost√°tica marcadamente anormal que requiere especial atenci√≥n en el manejo del paciente.";
              } else if (sbpCriterionMet) {
                clinicalNoteText =
                  "Diagn√≥stico positivo por ca√≠da aislada de la presi√≥n sist√≥lica. Este es el criterio cl√°sico y requiere una evaluaci√≥n cuidadosa del riesgo-beneficio antes de intensificar el tratamiento.";
              } else {
                clinicalNoteText =
                  "Diagn√≥stico positivo por ca√≠da aislada de la presi√≥n diast√≥lica. Este hallazgo es cl√≠nicamente significativo y debe ser considerado en el plan terap√©utico.";
              }
              noteEl.innerHTML = `<strong>Nota Cl√≠nica:</strong> ${clinicalNoteText} (Gu√≠a ESC 2024)`;
              noteEl.className =
                "text-xs text-red-800 mt-3 border-t border-red-200 pt-2";
            } else {
              diagnosisEl.textContent = "Negativo para Hipotensi√≥n Ortost√°tica";
              diagnosisEl.className =
                "font-bold text-lg mb-2 text-center text-green-700";
              resultContainer.classList.add(
                "bg-green-100",
                "border",
                "border-green-300"
              );

              detailsEl.innerHTML = `
              <div class="flex justify-between items-center text-green-800">
                  <span>Ca√≠da PAS: <strong class="text-base">${sbpDrop} mmHg</strong> <span class="text-xs text-green-700">(Criterio: &ge;20)</span></span>
                  ${sbpStatusHTML}
              </div>
              <div class="flex justify-between items-center text-green-800">
                  <span>Ca√≠da PAD: <strong class="text-base">${dbpDrop} mmHg</strong> <span class="text-xs text-green-700">(Criterio: &ge;10)</span></span>
                  ${dbpStatusHTML}
              </div>
            `;

              noteEl.innerHTML = `<strong>Nota Cl√≠nica:</strong> La respuesta hemodin√°mica al cambio postural est√° dentro de los l√≠mites normales.`;
              noteEl.className =
                "text-xs text-green-800 mt-3 border-t border-green-200 pt-2";
            }
          }

          function saveDataToLocalStorage() {
            const dataToSave = {
              startDay: startDaySelect.value,
              rows: Array.from(logBody.querySelectorAll("tr")).map((row) =>
                Array.from(row.querySelectorAll("input")).map(
                  (input) => input.value
                )
              ),
            };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
          }

          function loadDataFromLocalStorage() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!savedData) {
              addDayRow();
              return;
            }
            const data = JSON.parse(savedData);
            startDaySelect.value = data.startDay || "0";
            logBody.innerHTML = "";
            dayCounter = 0;
            if (data.rows.length === 0) {
              addDayRow();
            } else {
              data.rows.forEach((rowData) => {
                addDayRow();
                const newRow = logBody.lastElementChild;
                newRow.querySelectorAll("input").forEach((input, index) => {
                  input.value = rowData[index] || "";
                });
              });
            }
            reorderTable();
            runAllCalculations();
          }

          // Nueva funci√≥n para imprimir hoja de registro
          function printRegistrationSheet() {
            const printDiv = document.getElementById("printSheet");

            // Generar contenido HTML de la hoja de registro
            printDiv.innerHTML = `
            <style>
              @media print {
                body { margin: 0; }
.print-content {
  font-family: Arial, sans-serif;
  font-size: 9pt;
  line-height: 1.1;
  color: #000;
  padding: 1mm 10mm 10mm 1mm;
}
         h1 { 
  font-size: 13pt; 
  margin: 0 0 2mm 0;
  text-align: center;
  color: #1e3a8a;
  border-bottom: 1px solid #1e3a8a;
  padding-bottom: 1mm;
}
              h2 { 
  font-size: 11pt; 
  margin: 4mm 0 2mm 0;
  color: #1e3a8a;
}
h3 { 
  font-size: 10pt; 
  margin: 3mm 0 2mm 0;
  color: #374151;
}
              .header-info {
  margin-bottom: 3mm;
  display: flex;
  justify-content: space-between;
  padding: 2mm;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
  font-size: 9pt;
}
.instructions {
  background: #fef3c7;
  padding: 1mm;
  margin: 1mm 0;
  border: 1px solid #fbbf24;
  font-size: 9pt;
  line-height: 1.3;
}
                .instructions ul {
                  margin: 0.5mm 0;
                  padding-left: 0mm;
                }
                table {
                  width: 100%;
                  border-collapse: collapse;
                  margin: 3mm 0;
                  font-size: 10pt;
                }
                th {
                  background: #1e3a8a;
                  color: white;
                  padding: 2mm;
                  text-align: center;
                  font-weight: bold;
                  font-size: 9pt;
                }
        td {
  border: 1px solid #374151;
  padding: 1mm;
  height: 12mm;
  text-align: center;
  font-size: 9pt;
}
                .day-col {
                  background: #f3f4f6;
                  font-weight: bold;
                  text-align: left !important;
                  padding-left: 3mm !important;
                }
              .input-cell {
                  background: white;
                }
                .input-cell.evening-col {
                  background: #e8e8e8 !important;
                }
                .obs-col {
                  text-align: left !important;
                  font-size: 9pt;
                }
              .evening-col {
                  background: #e8e8e8 !important;
                  border-left: 2px solid #d0d0d0 !important;
                }
                .evening-header {
                  background: #1a3a52 !important;
                  border-left: 2px solid #0f2940 !important;
                }
              .reference-box {
  border: 2px solid #dc2626;
  padding: 2mm;
  margin: 3mm 0;
  background: #fee2e2;
  font-size: 9pt;
}
             .footer-notes {
  margin-top: 2mm;
  font-size: 8pt;
  color: #6b7280;
  border-top: 1px solid #d1d5db;
  padding-top: 1mm;
}
                .measurement-guide {
                  display: flex;
                  justify-content: space-between;
                  margin: 3mm 0;
                  font-size: 9pt;
                }
                .guide-item {
                  flex: 1;
                  text-align: center;
                  padding: 2mm;
                  border: 1px solid #d1d5db;
                  margin: 0 1mm;
                }
              }
            </style>
            
            <div class="print-content">
              <h1>REGISTRO DE AUTOMEDIDA DE PRESI√ìN ARTERIAL (AMPA)</h1>
              
              <div class="header-info">
                <div>
                  <strong>Paciente:</strong> _______________________________________
                </div>
                <div>
                  <strong>Fecha inicio:</strong> ____/____/______
                </div>
              </div>
              
              <div class="instructions">
                <h3>üìã INSTRUCCIONES PARA EL PACIENTE:</h3>
                <ul>
                  <li><strong>Horario:</strong> Realice las mediciones por la MA√ëANA (antes del desayuno y medicaci√≥n) y por la TARDE/NOCHE (antes de cenar)</li>
                  <li><strong>Preparaci√≥n:</strong> Reposo de 5 minutos sentado, sin hablar ni moverse durante la medici√≥n</li>
                  <li><strong>Posici√≥n:</strong> Brazo apoyado a la altura del coraz√≥n, espalda recta, pies en el suelo</li>
                  <li><strong>Mediciones:</strong> Realice 2 tomas con 1-2 minutos de intervalo. Anote ambas</li>
                  <li><strong>Duraci√≥n:</strong> Registre durante 7 d√≠as consecutivos (m√≠nimo 3 d√≠as)</li>
                </ul>
              </div>
              
              <div class="measurement-guide">
                <div class="guide-item">
                  <strong>PAS</strong><br>Presi√≥n Sist√≥lica<br>(n√∫mero mayor)
                </div>
                <div class="guide-item">
                  <strong>PAD</strong><br>Presi√≥n Diast√≥lica<br>(n√∫mero menor)
                </div>
                <div class="guide-item">
                  <strong>FC</strong><br>Frecuencia Card√≠aca<br>(pulsaciones)
                </div>
              </div>
              
              <div style="margin-top: 10mm;"></div>
<h2>üìä TABLA DE REGISTRO</h2>
              
              <table>
                <thead>
                  <tr>
              <th rowspan="2" style="width: 10%">D√çA</th>
<th rowspan="2" style="width: 8%">FECHA</th>
<th colspan="2" style="width: 32%">‚òÄÔ∏è MA√ëANA</th>
<th colspan="2" style="width: 32%" class="evening-header">üåô TARDE/NOCHE</th>
<th rowspan="2" style="width: 18%">OBSERVACIONES</th>
                  </tr>
                  <tr>
                  <th>1¬™ Toma<br>PAS/PAD/FC</th>
                    <th>2¬™ Toma<br>PAS/PAD/FC</th>
                    <th class="evening-header">1¬™ Toma<br>PAS/PAD/FC</th>
                    <th class="evening-header">2¬™ Toma<br>PAS/PAD/FC</th>
                  </tr>
                </thead>
                <tbody>
   ${["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"]
     .map(
       (day, index) => `
                    <tr>
                      <td class="day-col">${day}<br><span style="font-size: 8pt; color: #6b7280; font-weight: normal;">D√≠a ${
         index + 1
       }</span></td>
                      <td class="input-cell">____/____</td>
                    <td class="input-cell">____/____/____</td>
                      <td class="input-cell">____/____/____</td>
                      <td class="input-cell evening-col">____/____/____</td>
                      <td class="input-cell evening-col">____/____/____</td>
                      <td class="obs-col"></td>
                    </tr>
                  `
     )
     .join("")}
                </tbody>
              </table>
                            <div style="margin-top: 15mm;"></div>

              <div class="reference-box">
<h3>‚ö†Ô∏è VALORES DE REFERENCIA</h3>
                <div style="display: flex; justify-content: space-around; text-align: center;">
                  <div>
                    <strong>PA NORMAL en casa:</strong><br>
                    < 135/85 mmHg
                  </div>
                  <div>
                    <strong>PA ELEVADA en casa:</strong><br>
                    ‚â• 135/85 mmHg
                  </div>
                </div>
              </div>
           <!--    
            <h3>üíä MEDICACI√ìN ACTUAL</h3>
<div style="border: 1px solid #d1d5db; padding: 2mm; min-height: 15mm;">
  _________________________________________________________________________<br>
  _________________________________________________________________________<br>
  _________________________________________________________________________
</div>

<h3>üìù S√çNTOMAS O INCIDENCIAS</h3>
<div style="border: 1px solid #d1d5db; padding: 2mm; min-height: 15mm;">
                _________________________________________________________________________<br>
                _________________________________________________________________________<br>
                _________________________________________________________________________
              </div> -->
              
          <!--     <div class="footer-notes">
                <p><strong>Importante:</strong> Traiga este registro completo a su pr√≥xima consulta. El primer d√≠a de mediciones no se incluye en el c√°lculo del promedio.</p>
                <p style="text-align: center; margin-top: 1mm;">
                 <em>Registro de Automedida de Presi√≥n Arterial (AMPA)</em>
                </p>
              </div> -->
            </div>
          `;

            // Imprimir
            // Guardar t√≠tulo original
            const originalTitle = document.title;

            // Cambiar t√≠tulo temporalmente para el PDF
            document.title = "Registro_AMPA_Presion_Arterial";

            // Imprimir
            window.print();

            // Restaurar t√≠tulo original despu√©s de un peque√±o delay
            setTimeout(() => {
              document.title = originalTitle;
            }, 100);
          }

          // PDF mejorado con dise√±o profesional
          async function downloadPdf() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("p", "mm", "a4");
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - margin * 2;
            let yPos = margin;

            // Colores corporativos
            const primaryColor = [30, 58, 138]; // Azul oscuro
            const secondaryColor = [220, 38, 38]; // Rojo
            const grayColor = [107, 114, 128];
            const blackColor = [17, 24, 39];

            // Datos del informe
            const patientName =
              document.getElementById("patientName").value || "No especificado";
            const reportPeriod =
              document.getElementById("reportPeriod").value ||
              "No especificado";
            const { avgSbp, avgDbp, avgHr, sbpVariability } =
              calculateAverages();
            const phenotype = getPhenotypeClassification();

            // 1. ENCABEZADO PROFESIONAL
            pdf.setFillColor(...primaryColor);
            pdf.rect(0, 0, pageWidth, 30, "F");

            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(22);
            pdf.setFont("helvetica", "bold");
            pdf.text("INFORME DE PRESI√ìN ARTERIAL", pageWidth / 2, 15, {
              align: "center",
            });

            pdf.setFontSize(12);
            pdf.setFont("helvetica", "normal");
            pdf.text("Automedida Domiciliaria (AMPA)", pageWidth / 2, 22, {
              align: "center",
            });

            yPos = 40;

            // 2. INFORMACI√ìN DEL PACIENTE
            pdf.setTextColor(...blackColor);
            pdf.setFontSize(10);
            pdf.setFont("helvetica", "normal");

            // Cuadro de informaci√≥n
            pdf.setDrawColor(229, 231, 235);
            pdf.setLineWidth(0.5);
            pdf.rect(margin, yPos, contentWidth, 20, "S");

            pdf.text(`Paciente: ${patientName}`, margin + 5, yPos + 8);
            pdf.text(
              `Periodo de Registro: ${reportPeriod}`,
              margin + 5,
              yPos + 15
            );
            pdf.text(
              `Fecha del Informe: ${new Date().toLocaleDateString("es-ES", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })}`,
              pageWidth - margin - 5,
              yPos + 8,
              { align: "right" }
            );

            yPos += 30;

            // 3. RESUMEN EJECUTIVO
            pdf.setFillColor(248, 250, 252);
            pdf.rect(margin, yPos, contentWidth, 35, "F");

            pdf.setTextColor(...primaryColor);
            pdf.setFontSize(14);
            pdf.setFont("helvetica", "bold");
            pdf.text("RESUMEN DE RESULTADOS", margin + 5, yPos + 8);

            pdf.setTextColor(...blackColor);
            pdf.setFontSize(11);
            pdf.setFont("helvetica", "normal");

            const avgText = avgSbp
              ? `${Math.round(avgSbp)} / ${Math.round(avgDbp)} mmHg`
              : "No disponible";
            pdf.text(
              `Promedio PA Domiciliaria: ${avgText}`,
              margin + 5,
              yPos + 18
            );

            const hrText = avgHr ? `${Math.round(avgHr)} lpm` : "No disponible";
            pdf.text(
              `Frecuencia Card√≠aca Media: ${hrText}`,
              margin + 5,
              yPos + 25
            );

            const varText = sbpVariability
              ? `${sbpVariability.toFixed(1)} mmHg`
              : "No calculada";
            pdf.text(
              `Variabilidad PAS (DE): ${varText}`,
              margin + 5,
              yPos + 32
            );

            // Diagn√≥stico de Fenotipo en color
            pdf.setFont("helvetica", "bold");
            if (phenotype.name === "HTA Sostenida") {
              pdf.setTextColor(...secondaryColor);
            } else if (phenotype.name === "Normotensi√≥n") {
              pdf.setTextColor(22, 163, 74);
            } else {
              pdf.setTextColor(245, 158, 11);
            }
            pdf.text(
              `Diagn√≥stico: ${phenotype.name}`,
              pageWidth - margin - 5,
              yPos + 25,
              { align: "right" }
            );

            yPos += 45;

            // 4. GR√ÅFICA DE EVOLUCI√ìN
            pdf.setTextColor(...primaryColor);
            pdf.setFontSize(14);
            pdf.setFont("helvetica", "bold");
            pdf.text("EVOLUCI√ìN TEMPORAL", margin, yPos);
            yPos += 8;

            // Capturar y a√±adir gr√°fica con mejor calidad
            try {
              if (typeof html2canvas !== "undefined" && bpChartInstance) {
                const chartCanvas = document.getElementById("bpChart");
                const chartImage = await html2canvas(chartCanvas, {
                  scale: 2,
                  backgroundColor: "white",
                });
                const chartDataUrl = chartImage.toDataURL("image/png", 1.0);

                const chartWidth = contentWidth;
                const chartHeight = 60;
                pdf.addImage(
                  chartDataUrl,
                  "PNG",
                  margin,
                  yPos,
                  chartWidth,
                  chartHeight
                );
                yPos += chartHeight + 10;
              } else {
                // Si no se puede capturar la gr√°fica, a√±adir un texto explicativo
                pdf.setTextColor(...grayColor);
                pdf.setFontSize(10);
                pdf.text(
                  "(Gr√°fica no disponible en este momento)",
                  margin,
                  yPos + 20
                );
                yPos += 30;
              }
            } catch (error) {
              console.error("Error al capturar la gr√°fica:", error);
              yPos += 10;
            }

            // 5. TABLA DE REGISTROS DETALLADOS
            if (yPos > pageHeight - 80) {
              pdf.addPage();
              yPos = margin;
            }

            pdf.setTextColor(...primaryColor);
            pdf.setFontSize(14);
            pdf.setFont("helvetica", "bold");
            pdf.text("REGISTRO DETALLADO", margin, yPos);
            yPos += 8;

            // Preparar datos de la tabla
            const tableData = [];
            logBody.querySelectorAll("tr").forEach((row) => {
              const inputs = row.querySelectorAll("input");
              const formatReading = (s, d, h) => {
                if (!s.value && !d.value && !h.value) return "";
                return `${s.value || "-"}/${d.value || "-"}/${h.value || "-"}`;
              };

              tableData.push([
                row.querySelector(".day-label").textContent,
                formatReading(inputs[0], inputs[1], inputs[2]),
                formatReading(inputs[3], inputs[4], inputs[5]),
                formatReading(inputs[6], inputs[7], inputs[8]),
                formatReading(inputs[9], inputs[10], inputs[11]),
                inputs[12].value || "",
              ]);
            });

            pdf.autoTable({
              startY: yPos,
              head: [
                [
                  "D√≠a",
                  "Ma√±ana T1",
                  "Ma√±ana T2",
                  "Tarde T1",
                  "Tarde T2",
                  "Observaciones",
                ],
              ],
              body: tableData,
              theme: "grid",
              headStyles: {
                fillColor: [30, 58, 138],
                textColor: [255, 255, 255],
                fontStyle: "bold",
                fontSize: 9,
              },
              bodyStyles: {
                fontSize: 8,
                cellPadding: 2,
              },
              alternateRowStyles: {
                fillColor: [248, 250, 252],
              },
              columnStyles: {
                0: { cellWidth: 20, fontStyle: "bold" },
                5: { cellWidth: 40 },
              },
              margin: { left: margin, right: margin },
            });

            yPos = pdf.lastAutoTable.finalY + 10;

            // 6. INTERPRETACI√ìN CL√çNICA
            if (yPos > pageHeight - 50) {
              pdf.addPage();
              yPos = margin;
            }

            pdf.setFillColor(254, 243, 199);
            pdf.rect(margin, yPos, contentWidth, 25, "F");

            pdf.setTextColor(...primaryColor);
            pdf.setFontSize(12);
            pdf.setFont("helvetica", "bold");
            pdf.text("INTERPRETACI√ìN CL√çNICA", margin + 5, yPos + 8);

            pdf.setTextColor(...blackColor);
            pdf.setFontSize(9);
            pdf.setFont("helvetica", "normal");
            const lines = pdf.splitTextToSize(
              phenotype.explanation,
              contentWidth - 10
            );
            pdf.text(lines, margin + 5, yPos + 15);

            // 7. PIE DE P√ÅGINA
            pdf.setTextColor(...grayColor);
            pdf.setFontSize(8);
            pdf.setFont("helvetica", "italic");
            pdf.text(
              "Informe generado seg√∫n las Gu√≠as ESC 2024 y ESH 2023",
              pageWidth / 2,
              pageHeight - 10,
              { align: "center" }
            );

            // Guardar PDF
            const fileName =
              patientName === "No especificado"
                ? "Informe_Presion_Arterial.pdf"
                : `Informe_PA_${patientName.replace(/ /g, "_")}_${
                    new Date().toISOString().split("T")[0]
                  }.pdf`;
            pdf.save(fileName);
          }

          initializeApp();
        } // Fin de initializeHypertensionApp
      });
    </script>
  </body>
</html>
