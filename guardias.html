<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Sistema de Gesti√≥n de Avisos y Urgencias en Equipos de Atenci√≥n Primaria
      v1.1
    </title>
    <style>
      /* === ESTILOS CSS === */
      :root {
        --color-primary: #4a6fa5;
        --color-secondary: #6c757d;
        --color-success: #28a745;
        --color-warning: #ffc107;
        --color-danger: #dc3545;
        --color-info: #17a2b8;
        --color-light: #f8f9fa;
        --color-dark: #343a40;
        --color-bg: #f5f7fa;
        --color-card-bg: #ffffff;
        --border-radius: 5px;
        --box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--color-bg);
        color: var(--color-dark);
        line-height: 1.6;
        padding: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: var(--color-card-bg);
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
      }
      header {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e0e0e0;
      }
      h1 {
        color: var(--color-primary);
        margin-bottom: 10px;
      }
      h2,
      h3 {
        color: var(--color-dark);
        margin-top: 20px;
        margin-bottom: 15px;
      }
      p {
        margin-bottom: 10px;
      }
      small,
      .help-text {
        color: var(--color-secondary);
        font-size: 0.85em;
      }
      a {
        color: var(--color-primary);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        padding: 10px;
        background-color: var(--color-light);
        border-radius: var(--border-radius);
      }
      nav a {
        padding: 8px 12px;
        background-color: #343a40; /* Gris oscuro para mejor contraste */
        color: #f8f9fa; /* Blanco/gris muy claro para el texto */
        border-radius: var(--border-radius);
        transition: background-color 0.3s;
        text-decoration: none;
        display: inline-block;
      }
      nav a:hover {
        background-color: #212529; /* Negro/gris m√°s oscuro en hover */
        text-decoration: none;
      }
      .nav-right {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      select,
      input {
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: var(--border-radius);
      }
      .section {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: var(--border-radius);
      }
      .form-group {
        margin-bottom: 20px; /* Aumentar espacio entre grupos */
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px; /* Hacer campos de entrada m√°s grandes */
        border: 1px solid #ccc;
        border-radius: var(--border-radius);
        box-sizing: border-box; /* Asegurar padding dentro del width */
      }
      button {
        background-color: var(--color-primary);
        color: white;
        padding: 8px 16px;
        font-weight: bold;
        cursor: pointer;
        border: none;
        border-radius: var(--border-radius);
        transition: background-color 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }
      button:hover {
        background-color: #3a5a80;
      }
      button.secondary {
        background-color: var(--color-secondary);
      }
      button.success {
        background-color: var(--color-success);
      }
      button.danger {
        background-color: var(--color-danger);
      }
      button.warning {
        background-color: var(--color-warning);
        color: var(--color-dark);
      }
      button.info {
        background-color: var(--color-info);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 6px 8px; /* Reducir padding para tablas m√°s compactas */
        text-align: left;
        white-space: nowrap;
      }
      th {
        background-color: var(--color-primary);
        color: white;
        position: sticky;
        top: 0;
        font-size: 0.9em; /* Texto m√°s peque√±o en encabezados */
      }
      tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      .table-container {
        overflow-x: auto; /* Scroll horizontal para tablas */
        margin-top: 10px;
        max-height: 60vh; /* Limitar altura para scroll vertical interno */
        overflow-y: auto; /* Scroll vertical si es necesario */
      }
      /* Estilos espec√≠ficos para la tabla del calendario */
      #tablaCalendario th,
      #tablaCalendario td {
        padding: 4px 6px; /* A√∫n m√°s compacto */
        font-size: 0.85em;
      }
      #tablaCalendario .finde-festivo {
        background-color: #f0f0f0;
        text-align: center;
        font-style: italic;
      }
      .tabs {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 15px;
        border-bottom: 1px solid #ccc;
      }
      .tab-button {
        padding: 10px 20px;
        cursor: pointer;
        background-color: #e9ecef; /* Gris medio claro */
        color: #495057; /* Gris oscuro para el texto */
        font-weight: 500; /* Fuente m√°s fuerte */
        border: 1px solid #ccc;
        border-bottom: none;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        margin-right: 5px;
      }
      .tab-button.active {
        background-color: var(--color-primary);
        color: white;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .resultado {
        background-color: #e8f4fd;
        padding: 15px;
        border-radius: var(--border-radius);
      }
      .equidad-ok {
        color: var(--color-success);
        font-weight: bold;
      }
      .equidad-ko {
        color: var(--color-danger);
        font-weight: bold;
      }
      .badge {
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.75em; /* Badge m√°s peque√±o */
      }
      .badge-ma√±ana {
        background-color: #cce5ff; /* Azul claro */
        color: #004085; /* Azul oscuro */
      }
      .badge-tarde {
        background-color: #f8d7da; /* Rojo claro */
        color: #721c24; /* Rojo oscuro */
      }
      .badge-mixto {
        background-color: #fff3cd; /* Amarillo/Anaranjado claro */
        color: #856404; /* Anaranjado oscuro */
      }
      .highlight {
        background-color: #fff3cd;
        padding: 2px 4px;
        border-radius: 3px;
      }
      .footer {
        text-align: center;
        margin-top: 30px;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
        color: var(--color-secondary);
        font-size: 0.9em;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      .stat-card {
        background-color: #f1f3f5;
        border: 1px solid #dee2e6;
        border-radius: var(--border-radius);
        padding: 10px;
      }
      .stat-card h4 {
        margin-top: 0;
        color: var(--color-primary);
        border-bottom: 1px solid #ced4da;
        padding-bottom: 5px;
      }
      .stat-value {
        font-size: 1.2em;
        font-weight: bold;
      }
      @media (max-width: 768px) {
        nav {
          flex-direction: column;
          align-items: stretch;
        }
        .nav-right {
          justify-content: center;
        }
        table,
        thead,
        tbody,
        th,
        td,
        tr {
          display: block;
        }
        thead tr {
          position: absolute;
          top: -9999px;
          left: -9999px;
        }
        tr {
          border: 1px solid #ccc;
          margin-bottom: 10px;
        }
        td {
          border: none;
          position: relative;
          padding-left: 50% !important;
        }
        td:before {
          content: attr(data-label) ": ";
          position: absolute;
          left: 6px;
          width: 45%;
          font-weight: bold;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Sistema de Gesti√≥n de Avisos y Urgencias en AP v1.1</h1>
        <small>Round-Robin con MIXTOS como equilibradores del sistema</small>
      </header>
      <nav>
        <div>
          <a href="#" onclick="mostrarSeccion('configuracion')"
            >Configuraci√≥n</a
          >
          <a href="#" onclick="mostrarSeccion('calendario')">Calendario</a>
          <a href="#" onclick="mostrarSeccion('manual')">Manual de uso</a>
        </div>
        <div class="nav-right">
          <div style="display: flex; gap: 5px; align-items: center">
            <span style="font-size: 0.85em; color: #666">Config:</span>
            <button
              onclick="exportarConfiguracion()"
              title="Exportar configuraci√≥n (m√©dicos, festivos, etc.)"
            >
              üìÑ Exportar
            </button>
            <button
              onclick="document.getElementById('importarInput').click()"
              title="Importar configuraci√≥n"
            >
              üì• Importar
            </button>
          </div>
          <div style="display: flex; gap: 5px; align-items: center">
            <span style="font-size: 0.85em; color: #666">Hist√≥rico:</span>
            <button
              onclick="exportarHistorico()"
              class="warning"
              title="Exportar hist√≥rico de guardias"
            >
              üìä Exportar
            </button>
            <button
              onclick="document.getElementById('importarHistoricoInput').click()"
              class="warning"
              title="Importar hist√≥rico"
            >
              üìà Importar
            </button>
          </div>
          <input
            type="file"
            id="importarHistoricoInput"
            accept=".json"
            style="display: none"
            onchange="importarHistorico(event)"
          />
          <input
            type="file"
            id="importarInput"
            accept=".json"
            style="display: none"
            onchange="importarConfiguracion(event)"
          />
          <select id="selectorIdioma">
            <option value="es">ES</option>
            <option value="ca">CA</option>
            <option value="gl">GL</option>
            <option value="eu">EU</option>
            <option value="en">EN</option>
          </select>
          <button onclick="guardarEnMemoria()">Guardado</button>
        </div>
      </nav>
      <!-- === SECCI√ìN DE CONFIGURACI√ìN === -->
      <div id="configuracion" class="seccion">
        <h2>Configuraci√≥n del Sistema</h2>
        <div class="tabs">
          <button
            class="tab-button active"
            onclick="abrirTab(event, 'tabMedicos')"
          >
            M√©dicos
          </button>
          <button class="tab-button" onclick="abrirTab(event, 'tabJornada')">
            Jornada y Exclusiones
          </button>
          <button class="tab-button" onclick="abrirTab(event, 'tabFestivos')">
            Festivos
          </button>
          <button class="tab-button" onclick="abrirTab(event, 'tabAusencias')">
            Ausencias
          </button>
          <button class="tab-button" onclick="abrirTab(event, 'tabExclPunt')">
            Excl. Puntuales
          </button>
          <button class="tab-button" onclick="abrirTab(event, 'tabPlanTurnos')">
            Plan. Turnos (Mixtos)
          </button>
          <button class="tab-button" onclick="abrirTab(event, 'tabParametros')">
            Par√°metros Avanzados
          </button>
        </div>
        <!-- Tab M√©dicos -->
        <div id="tabMedicos" class="tab-content active">
          <div class="form-group">
            <label for="nuevoMedicoNombre">Nombre del M√©dico:</label>
            <input
              type="text"
              id="nuevoMedicoNombre"
              placeholder="Apellido, Nombre"
            />
          </div>
          <div class="form-group">
            <label for="nuevoMedicoTurno">Turno:</label>
            <select id="nuevoMedicoTurno">
              <option value="MA√ëANA">MA√ëANA</option>
              <option value="TARDE">TARDE</option>
              <option value="MIXTO" selected>MIXTO</option>
            </select>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="nuevoMedicoActivo" checked /> Activo
            </label>
          </div>
          <button onclick="agregarMedico()">Agregar M√©dico</button>
          <div
            class="form-group"
            style="
              margin-top: 20px;
              border-top: 1px solid #ddd;
              padding-top: 20px;
            "
          >
            <label for="importacionMasiva">
              <strong>Importaci√≥n r√°pida</strong> (pegar desde Excel):
            </label>
            <textarea
              id="importacionMasiva"
              placeholder="Formato: Nombre[TAB]Turno[TAB]Jornada%&#10;Ejemplo: GARCIA[TAB]MA√ëANA[TAB]100"
              style="width: 100%; height: 100px; font-family: monospace"
            ></textarea>
            <button onclick="procesarImportacionMasiva()">
              Procesar Importaci√≥n
            </button>
            <p class="help-text">
              Copia las columnas desde Excel y p√©galas aqu√≠. Columnas: Nombre |
              Turno (MA√ëANA/TARDE/MIXTO) | Jornada% (opcional, por defecto 100)
            </p>
          </div>
          <h3 style="margin-top: 20px">Lista de M√©dicos</h3>
          <div class="table-container">
            <table id="tablaMedicos">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Turno</th>
                  <th>Activo</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Se llena din√°micamente -->
              </tbody>
            </table>
          </div>
        </div>
        <!-- Tab Jornada y Exclusiones -->
        <div id="tabJornada" class="tab-content">
          <h3>Reducci√≥n de Jornada y D√≠as Excluidos</h3>
          <p class="help-text">
            Define el porcentaje de jornada y los d√≠as de la semana que un
            m√©dico no puede trabajar.
            <br /><strong>Efecto:</strong> Reduce el n√∫mero objetivo de guardias
            proporcionalmente al porcentaje de jornada. Los d√≠as excluidos
            tambi√©n reducen el objetivo y se consideran en la distribuci√≥n
            general.
          </p>
          <div class="form-group">
            <label for="reduccionMedico">Seleccionar M√©dico:</label>
            <select id="reduccionMedico"></select>
          </div>
          <div class="form-group">
            <label for="reduccionPorcentaje">Porcentaje de Jornada (%):</label>
            <input
              type="number"
              id="reduccionPorcentaje"
              min="0"
              max="100"
              value="100"
            />
          </div>
          <div class="form-group">
            <label>D√≠as Excluidos:</label><br />
            <label
              ><input type="checkbox" name="diasExcluidos" value="LUNES" />
              Lunes</label
            >
            <label
              ><input type="checkbox" name="diasExcluidos" value="MARTES" />
              Martes</label
            >
            <label
              ><input type="checkbox" name="diasExcluidos" value="MIERCOLES" />
              Mi√©rcoles</label
            >
            <label
              ><input type="checkbox" name="diasExcluidos" value="JUEVES" />
              Jueves</label
            >
            <label
              ><input type="checkbox" name="diasExcluidos" value="VIERNES" />
              Viernes</label
            >
          </div>
          <button onclick="guardarReduccion()">Guardar Reducci√≥n</button>
          <h3 style="margin-top: 20px">Configuraciones Guardadas</h3>
          <div class="table-container">
            <table id="tablaReducciones">
              <thead>
                <tr>
                  <th>M√©dico</th>
                  <th>Jornada (%)</th>
                  <th>D√≠as Excluidos</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Se llena din√°micamente -->
              </tbody>
            </table>
          </div>
        </div>
        <!-- Tab Festivos -->
        <div id="tabFestivos" class="tab-content">
          <h3>Festivos</h3>
          <p class="help-text">
            Lista de d√≠as festivos que no ser√°n laborables.
            <br /><strong>Efecto:</strong> Ning√∫n m√©dico ser√° asignado en estos
            d√≠as.
          </p>
          <div class="form-group">
            <label for="nuevoFestivo">Fecha del Festivo (YYYY-MM-DD):</label>
            <input type="date" id="nuevoFestivo" />
          </div>
          <button onclick="agregarFestivo()">Agregar Festivo</button>
          <h3 style="margin-top: 20px">Lista de Festivos</h3>
          <div class="table-container">
            <table id="tablaFestivos">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Se llena din√°micamente -->
              </tbody>
            </table>
          </div>
        </div>
        <!-- Tab Ausencias -->
        <div id="tabAusencias" class="tab-content">
          <h3>Ausencias (Vacaciones/Bajas)</h3>
          <p class="help-text">
            Periodos de tiempo donde un m√©dico no est√° disponible.
            <br /><strong>Efecto:</strong> Reduce el n√∫mero objetivo de
            guardias, ya que se considera que esos d√≠as no puede trabajar.
          </p>
          <div class="form-group">
            <label for="ausenciaMedico">Seleccionar M√©dico:</label>
            <select id="ausenciaMedico"></select>
          </div>
          <div class="form-group">
            <label for="ausenciaInicio">Fecha Inicio (YYYY-MM-DD):</label>
            <input type="date" id="ausenciaInicio" />
          </div>
          <div class="form-group">
            <label for="ausenciaFin">Fecha Fin (YYYY-MM-DD):</label>
            <input type="date" id="ausenciaFin" />
          </div>
          <button onclick="agregarAusencia()">Agregar Ausencia</button>
          <h3 style="margin-top: 20px">Lista de Ausencias</h3>
          <div class="table-container">
            <table id="tablaAusencias">
              <thead>
                <tr>
                  <th>M√©dico</th>
                  <th>Inicio</th>
                  <th>Fin</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Se llena din√°micamente -->
              </tbody>
            </table>
          </div>
        </div>
        <!-- Tab Exclusiones Puntuales -->
        <div id="tabExclPunt" class="tab-content">
          <h3>Exclusiones Puntuales</h3>
          <p class="help-text">
            Fechas espec√≠ficas donde un m√©dico no puede trabajar, pero su
            objetivo no se reduce.
            <br /><strong>Efecto:</strong> El m√©dico no ser√° asignado en esa
            fecha espec√≠fica. Otros m√©dicos deber√°n cubrir ese d√≠a.
          </p>
          <div class="form-group">
            <label for="exclPuntMedico">Seleccionar M√©dico:</label>
            <select id="exclPuntMedico"></select>
          </div>
          <div class="form-group">
            <label for="exclPuntFecha">Fecha (YYYY-MM-DD):</label>
            <input type="date" id="exclPuntFecha" />
          </div>
          <button onclick="agregarExclusionPuntual()">Agregar Exclusi√≥n</button>
          <h3 style="margin-top: 20px">Lista de Exclusiones Puntuales</h3>
          <div class="table-container">
            <table id="tablaExclPunt">
              <thead>
                <tr>
                  <th>M√©dico</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Se llena din√°micamente -->
              </tbody>
            </table>
          </div>
        </div>
        <!-- Tab Planificaci√≥n de Turnos (Mixtos) -->
        <div id="tabPlanTurnos" class="tab-content">
          <h3>Planificaci√≥n de Turnos (M√©dicos MIXTOS)</h3>
          <p class="help-text">
            Define la jornada semanal para los m√©dicos con turno MIXTO.
            <br /><strong>Efecto:</strong> Determina si el m√©dico har√° guardias
            de ma√±ana o de tarde en cada d√≠a laborable.
          </p>
          <div class="form-group">
            <label for="planTurnoMedico">Seleccionar M√©dico MIXTO:</label>
            <select id="planTurnoMedico"></select>
          </div>
          <table id="tablaPlanTurno">
            <thead>
              <tr>
                <th>D√≠a</th>
                <th>Turno</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Lunes</td>
                <td>
                  <select id="turnoL">
                    <option value="MA√ëANA">MA√ëANA</option>
                    <option value="TARDE" selected>TARDE</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Martes</td>
                <td>
                  <select id="turnoM">
                    <option value="MA√ëANA" selected>MA√ëANA</option>
                    <option value="TARDE">TARDE</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Mi√©rcoles</td>
                <td>
                  <select id="turnoX">
                    <option value="MA√ëANA">MA√ëANA</option>
                    <option value="TARDE" selected>TARDE</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Jueves</td>
                <td>
                  <select id="turnoJ">
                    <option value="MA√ëANA" selected>MA√ëANA</option>
                    <option value="TARDE">TARDE</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Viernes</td>
                <td>
                  <select id="turnoV">
                    <option value="MA√ëANA">MA√ëANA</option>
                    <option value="TARDE" selected>TARDE</option>
                  </select>
                </td>
              </tr>
            </tbody>
          </table>
          <button onclick="guardarPlanTurno()">Guardar Planificaci√≥n</button>
          <h3 style="margin-top: 20px">Planes Guardados</h3>
          <div class="table-container">
            <table id="tablaPlanesGuardados">
              <thead>
                <tr>
                  <th>M√©dico</th>
                  <th>L</th>
                  <th>M</th>
                  <th>X</th>
                  <th>J</th>
                  <th>V</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Se llena din√°micamente -->
              </tbody>
            </table>
          </div>
        </div>
        <!-- Tab Par√°metros Avanzados -->
        <div id="tabParametros" class="tab-content">
          <h3>Par√°metros Avanzados del Sistema</h3>
          <p class="help-text">
            Configuraci√≥n avanzada del algoritmo de asignaci√≥n y compensaci√≥n
            hist√≥rica.
          </p>

          <div class="form-group">
            <label for="factorCompensacion"
              >Factor de Compensaci√≥n Hist√≥rica:</label
            >
            <input
              type="range"
              id="factorCompensacion"
              min="0"
              max="100"
              value="50"
              oninput="document.getElementById('valorFactor').textContent = this.value + '%'"
            />
            <span id="valorFactor">50%</span>
            <p class="help-text">
              Determina qu√© porcentaje del desequilibrio hist√≥rico se compensa
              cada mes. 0% = Sin compensaci√≥n (sistema amn√©sico) 100% =
              Compensaci√≥n total (intenta equilibrar completamente cada mes)
            </p>
          </div>

          <div class="form-group">
            <label for="ventanaHistorico">Ventana de Hist√≥rico (meses):</label>
            <input
              type="number"
              id="ventanaHistorico"
              min="1"
              max="12"
              value="6"
            />
            <p class="help-text">
              N√∫mero de meses anteriores a considerar para el c√°lculo de
              compensaci√≥n.
            </p>
          </div>

          <button onclick="guardarParametrosAvanzados()">
            Guardar Par√°metros
          </button>
          <h3 style="margin-top: 30px">Configuraci√≥n del Algoritmo</h3>
          <div class="form-group">
            <label>
              <input
                type="checkbox"
                id="usarAleatoriedad"
                onchange="toggleAleatoriedad(this.checked)"
              />
              Usar desempate aleatorio controlado
            </label>
            <p class="help-text">
              Var√≠a las asignaciones en caso de empate manteniendo la equidad.
            </p>
          </div>

          <div id="opcionesAleatoriedad" style="display: none">
            <div class="form-group">
              <label for="semillaAleatoria"
                >Semilla (dejar vac√≠o para autom√°tica):</label
              >
              <input
                type="number"
                id="semillaAleatoria"
                placeholder="Ej: 12345"
              />
              <button onclick="generarSemillaAleatoria()">
                Generar Nueva Semilla
              </button>
              <p class="help-text">
                La misma semilla siempre produce el mismo resultado.
              </p>
            </div>
          </div>
          <div
            style="
              margin-top: 30px;
              padding: 15px;
              background-color: #f0f8ff;
              border-radius: 5px;
            "
          >
            <h4>üìä Resumen del Hist√≥rico</h4>
            <div id="resumenHistorico" style="margin-top: 10px">
              <!-- Se llena din√°micamente -->
            </div>
            <button
              onclick="mostrarDetalleHistorico()"
              class="info"
              style="margin-top: 10px"
            >
              Ver Detalle por Meses
            </button>
          </div>
          <h3 style="margin-top: 30px">Hist√≥rico de Saldos</h3>
          <div class="table-container">
            <table id="tablaHistorico">
              <thead>
                <tr>
                  <th>M√©dico</th>
                  <th>Saldo Acumulado</th>
                  <th>√öltimos 3 Meses</th>
                </tr>
              </thead>
              <tbody id="tbodyHistorico">
                <!-- Se llena din√°micamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- === SECCI√ìN DEL CALENDARIO === -->
      <div id="calendario" class="seccion" style="display: none">
        <h2>Generaci√≥n del Calendario de Guardias</h2>
        <div class="form-group">
          <label for="mes">Mes:</label>
          <select id="mes">
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9" selected>Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
        </div>
        <div class="form-group">
          <label for="anio">A√±o:</label>
          <input type="number" id="anio" value="2025" min="2024" max="2030" />
        </div>
        <button onclick="generarGuardias()">Generar Guardias</button>
        <div
          id="areaResultado"
          class="resultado"
          style="margin-top: 20px; display: none"
        >
          <h3>Calendario de Guardias</h3>
          <button class="info" onclick="copiarCalendarioAlPortapapeles()">
            <span>üìã</span> Copiar Calendario (HTML)
          </button>
          <button class="success" onclick="confirmarYGuardarHistorico()">
            <span>üíæ</span> Guardar en Hist√≥rico
          </button>
          <div class="table-container">
            <table id="tablaCalendario">
              <thead>
                <tr>
                  <th>D√≠a</th>
                  <th>Fecha</th>
                  <th>Avisos Ma√±ana</th>
                  <th>Urgencias Ma√±ana</th>
                  <th>Avisos Tarde</th>
                  <th>Urgencias Tarde</th>
                </tr>
              </thead>
              <tbody>
                <!-- Se llena din√°micamente -->
              </tbody>
            </table>
          </div>

          <h3 style="margin-top: 30px">Resumen de Asignaci√≥n</h3>
          <div class="table-container">
            <table id="tablaResumen">
              <thead>
                <tr>
                  <th>M√©dico</th>
                  <th>Turno</th>
                  <th>Jornada</th>
                  <th>Objetivo</th>
                  <th>Asignadas</th>
                  <th>Dif.</th>
                  <th>AVI</th>
                  <th>URG</th>
                  <th>%AVI</th>
                  <th>L</th>
                  <th>V</th>
                </tr>
              </thead>
              <tbody>
                <!-- Se llena din√°micamente -->
              </tbody>
            </table>
          </div>

          <h3 style="margin-top: 30px">Estad√≠sticas y An√°lisis</h3>
          <div id="estadisticasDetalladas">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>
      </div>
      <!-- === SECCI√ìN MANUAL DE USO === -->
      <div id="manual" class="seccion" style="display: none">
        <h2>Manual de Uso del Sistema v1.1</h2>

        <h3>1. Introducci√≥n</h3>
        <p>
          Este documento es la gu√≠a de referencia para el
          <strong>Sistema de Gesti√≥n de Avisos y Urgencias v1.1</strong>. El
          objetivo de la aplicaci√≥n es generar cuadrantes de guardias mensuales
          de forma equitativa, distribuyendo la carga de trabajo entre los
          profesionales.
        </p>
        <p>
          La caracter√≠stica principal de esta versi√≥n es su
          <strong>sistema de compensaci√≥n hist√≥rica</strong>, que tiene en
          cuenta la carga de trabajo de meses anteriores para garantizar un
          equilibrio justo a largo plazo.
        </p>

        <h3>2. Paso 1: Configuraci√≥n del Sistema</h3>
        <p>
          Antes de generar cualquier calendario, es imprescindible configurar
          correctamente todos los par√°metros del equipo. Esto se realiza a
          trav√©s de las pesta√±as de la secci√≥n "Configuraci√≥n".
        </p>
        <ul>
          <li>
            <strong>M√©dicos:</strong> Permite a√±adir, eliminar y gestionar la
            lista de profesionales. Cada m√©dico tiene un turno asignado (MA√ëANA,
            TARDE o MIXTO) y un estado (Activo/Inactivo).
            <p class="help-text">
              <strong>Nota:</strong> Se puede realizar una importaci√≥n masiva de
              profesionales pegando datos desde una hoja de c√°lculo en el campo
              "Importaci√≥n r√°pida". El formato es: `Nombre [TAB] Turno [TAB]
              %Jornada`.
            </p>
          </li>
          <li>
            <strong>Jornada y Exclusiones:</strong> Permite definir reducciones
            de jornada (en %) y exclusiones de d√≠as fijos de la semana (ej. no
            trabajar los viernes) para un m√©dico.
            <p class="help-text">
              <strong>Efecto en el c√°lculo:</strong> Ambos par√°metros reducen el
              n√∫mero de guardias "Objetivo" que el sistema calcula para ese
              m√©dico, de forma proporcional a los d√≠as que deja de estar
              disponible.
            </p>
          </li>
          <li>
            <strong>Festivos:</strong> Lista de fechas que se consideran no
            laborables para todo el equipo.
            <p class="help-text">
              <strong>Efecto en el c√°lculo:</strong> En estas fechas no se
              asignar√° ninguna guardia. El total de guardias a cubrir en el mes
              se reduce.
            </p>
          </li>
          <li>
            <strong>Ausencias (Vacaciones/Bajas):</strong> Permite registrar
            rangos de fechas en los que un m√©dico no est√° disponible.
            <p class="help-text">
              <strong>Efecto en el c√°lculo:</strong> Funciona de forma similar a
              "Jornada y Exclusiones", reduciendo el objetivo de guardias del
              m√©dico afectado.
            </p>
          </li>
          <li>
            <strong>Excl. Puntuales:</strong> Permite bloquear d√≠as espec√≠ficos
            para un m√©dico por motivos personales.
            <p class="help-text">
              <strong>Diferencia clave con Ausencias:</strong> Una exclusi√≥n
              puntual impide que al m√©dico se le asigne una guardia ese d√≠a,
              pero <strong>NO</strong> reduce su objetivo mensual. El sistema
              intentar√° asignarle esa guardia en otro d√≠a disponible.
            </p>
          </li>
          <li>
            <strong>Plan. Turnos (Mixtos):</strong> Define el turno (Ma√±ana o
            Tarde) que un m√©dico de turno MIXTO realizar√° cada d√≠a de la semana.
            <p class="help-text">
              <strong>Efecto en el c√°lculo:</strong> Un m√©dico MIXTO solo ser√°
              candidato para las guardias de la franja horaria que tenga
              asignada ese d√≠a de la semana.
            </p>
          </li>
          <li>
            <strong>Par√°metros Avanzados:</strong> Permite ajustar el
            comportamiento del sistema de compensaci√≥n hist√≥rica. Para un uso
            est√°ndar, no es necesario modificar los valores por defecto.
          </li>
        </ul>

        <h3>3. Paso 2: Generaci√≥n del Calendario Mensual</h3>
        <p>Este es el proceso principal que se realiza cada mes.</p>
        <ol>
          <li>Accede a la pesta√±a <strong>"Calendario"</strong>.</li>
          <li>
            Selecciona el <strong>Mes</strong> y el
            <strong>A√±o</strong> deseados.
          </li>
          <li>Pulsa el bot√≥n <strong>"Generar Guardias"</strong>.</li>
        </ol>
        <p>
          El sistema mostrar√° el calendario y la tabla de resumen con los
          resultados.
        </p>

        <h3>4. Paso 3: An√°lisis y Guardado de Resultados</h3>
        <p>Tras la generaci√≥n, se presentan dos bloques de informaci√≥n:</p>
        <ul>
          <li>
            <strong>Calendario de Guardias:</strong> La tabla principal que
            muestra qu√© m√©dico ha sido asignado a cada uno de los 4 puestos
            diarios (Avisos/Urgencias de Ma√±ana/Tarde).
          </li>
          <li>
            <strong>Resumen de Asignaci√≥n:</strong> Una tabla que desglosa por
            m√©dico el n√∫mero de guardias objetivo, las finalmente asignadas, la
            diferencia, y otros datos estad√≠sticos.
          </li>
        </ul>
        <h4>Acci√≥n Obligatoria: Guardar el Resultado en el Hist√≥rico</h4>
        <p>
          Una vez verificado y aprobado el calendario, es
          <strong>IMPRESCINDIBLE</strong> realizar la siguiente acci√≥n para el
          correcto funcionamiento del sistema de compensaci√≥n:
        </p>
        <p style="text-align: center; margin: 15px 0">
          <button class="success" style="pointer-events: none">
            <span>üíæ</span> Guardar en Hist√≥rico
          </button>
        </p>
        <p>
          Esta acci√≥n registra la columna "Dif." (Diferencia) de cada m√©dico en
          una base de datos interna. Este dato es el que se utilizar√° en meses
          futuros para aplicar la compensaci√≥n.
        </p>

        <h3>5. Funcionalidad Clave: El Sistema de Compensaci√≥n Hist√≥rica</h3>
        <h4>Principio de Funcionamiento</h4>
        <p>
          El sistema calcula un <strong>"saldo"</strong> para cada m√©dico, que
          es la suma de las "Diferencias" de todos los meses guardados en el
          hist√≥rico.
        </p>
        <ul>
          <li>
            Un <strong>saldo positivo</strong> (ej. `+3.5`) significa que el
            m√©dico ha realizado m√°s guardias de las que le correspond√≠an.
          </li>
          <li>
            Un <strong>saldo negativo</strong> (ej. `-2.0`) significa que ha
            realizado menos.
          </li>
        </ul>
        <p>
          Al calcular el "Objetivo" de un nuevo mes, el sistema primero calcula
          un objetivo base (proporcional a la disponibilidad) y luego le aplica
          un <strong>ajuste basado en el saldo</strong>. De esta forma, el
          reparto tiende a un equilibrio de `0` a largo plazo.
        </p>

        <h3>6. Gesti√≥n de Datos: Importar y Exportar</h3>
        <p>
          La aplicaci√≥n permite importar y exportar dos tipos de datos
          distintos:
        </p>
        <h4>Exportar/Importar Configuraci√≥n (Botones Azules üìÑ/üì•)</h4>
        <p>
          Guarda y carga el estado de la secci√≥n de
          <strong>Configuraci√≥n</strong> (lista de m√©dicos, festivos, ausencias,
          etc.). Es √∫til para tener una copia de seguridad de la estructura del
          equipo o para trasladarla a otro ordenador.
        </p>

        <h4>Exportar/Importar Hist√≥rico (Botones Amarillos üìä/üìà)</h4>
        <p>
          Guarda y carga la base de datos del
          <strong>hist√≥rico de saldos</strong>. Es fundamental para mantener una
          copia de seguridad de los datos de compensaci√≥n acumulados a lo largo
          del tiempo.
        </p>
      </div>
      <div
        id="toast"
        style="
          position: fixed;
          bottom: 20px;
          right: 20px;
          background-color: var(--color-dark);
          color: white;
          padding: 12px 20px;
          border-radius: 5px;
          box-shadow: var(--box-shadow);
          opacity: 0;
          visibility: hidden;
          transition: opacity 0.3s, transform 0.3s;
          transform: translateY(20px);
          z-index: 1000;
        "
      >
        <span id="toast-message"></span>
      </div>

      <div
        id="modal-overlay"
        style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          opacity: 0;
          visibility: hidden;
          transition: opacity 0.3s;
          z-index: 1000;
        "
      >
        <div
          id="modal-content"
          style="
            background: white;
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 400px;
            text-align: center;
          "
        >
          <p id="modal-message" style="margin-bottom: 20px"></p>
          <div style="display: flex; justify-content: center; gap: 10px">
            <button id="modal-cancel" class="secondary">Cancelar</button>
            <button id="modal-confirm" class="danger">Confirmar</button>
          </div>
        </div>
      </div>
      <div class="footer">
        <p>Sistema v1.1 - Septiembre 2025</p>
      </div>
    </div>
    <script>
      // === MODELO DE DATOS Y ESTADO GLOBAL ===
      const estado = {
        medicos: [],
        reducciones: [],
        festivos: [],
        ausencias: [],
        exclusionesPuntuales: [],
        planificacionesTurnos: [],
        calendarioGenerado: [],
        resumenAsignacion: {},
        resumenAsignacion: {},

        historico: {
          meses: {},
          saldoAcumulado: {},
          factorCompensacion: 0.5,
          ventanaHistorico: 6,
        },
        configuracionAlgoritmo: {
          usarAleatoriedad: false,
          semilla: null,
          rotacionInicial: 0,
        },
      };
      const MAX_DIFERENCIA_PERMITIDA = 2;
      const MIN_PORCENTAJE_TIPO = 0.35;
      const MAX_PORCENTAJE_TIPO = 0.65;
      // C√ìDIGO NUEVO A A√ëADIR AQU√ç
      let toastTimeout;
      function mostrarToast(mensaje) {
        const toast = document.getElementById("toast");
        const toastMessage = document.getElementById("toast-message");

        clearTimeout(toastTimeout);

        toastMessage.textContent = mensaje;
        toast.style.opacity = "1";
        toast.style.visibility = "visible";
        toast.style.transform = "translateY(0)";

        toastTimeout = setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.visibility = "hidden";
          toast.style.transform = "translateY(20px)";
        }, 3000);
      }

      function mostrarConfirmacion(mensaje, onConfirm) {
        const overlay = document.getElementById("modal-overlay");
        const messageEl = document.getElementById("modal-message");
        const confirmBtn = document.getElementById("modal-confirm");
        const cancelBtn = document.getElementById("modal-cancel");

        messageEl.textContent = mensaje;

        const close = () => {
          overlay.style.opacity = "0";
          overlay.style.visibility = "hidden";
        };

        const confirmHandler = () => {
          onConfirm();
          close();
        };

        // Limpiar listeners antiguos para evitar ejecuciones m√∫ltiples
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.addEventListener("click", confirmHandler);

        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        newCancelBtn.addEventListener("click", close);

        overlay.style.opacity = "1";
        overlay.style.visibility = "visible";
      }
      // === FUNCIONES DE GESTI√ìN DE DATOS ===
      function guardarEnMemoria() {
        localStorage.setItem("sistemaGuardias_v16", JSON.stringify(estado));
        mostrarToast("Configuraci√≥n guardada en memoria del navegador.");
      }
      // === FUNCIONES DE GESTI√ìN DE HIST√ìRICO ===
      function limpiarHistoricoAntiguo() {
        const ventana = estado.historico.ventanaHistorico || 6;
        const fechaActual = new Date();
        const mesActual = fechaActual.getMonth();
        const anioActual = fechaActual.getFullYear();

        // Calcular fecha l√≠mite
        let mesLimite = mesActual - ventana;
        let anioLimite = anioActual;
        while (mesLimite < 0) {
          mesLimite += 12;
          anioLimite--;
        }

        // Eliminar meses fuera de la ventana
        for (const claveMes in estado.historico.meses) {
          const [anio, mes] = claveMes.split("-").map(Number);
          if (anio < anioLimite || (anio === anioLimite && mes < mesLimite)) {
            delete estado.historico.meses[claveMes];
          }
        }

        // Recalcular saldos acumulados solo con los meses en ventana
        estado.historico.saldoAcumulado = {};
        for (const claveMes in estado.historico.meses) {
          const datosMes = estado.historico.meses[claveMes];
          for (const medico in datosMes) {
            if (!estado.historico.saldoAcumulado[medico]) {
              estado.historico.saldoAcumulado[medico] = 0;
            }
            estado.historico.saldoAcumulado[medico] +=
              datosMes[medico].diferencia;
          }
        }
      }

      function guardarHistoricoMes(mes, anio) {
        const claveMes = `${anio}-${String(mes).padStart(2, "0")}`;

        estado.historico.meses[claveMes] = {};

        for (const medico in estado.resumenAsignacion.objetivos) {
          const asignadas = estado.resumenAsignacion.asignaciones[medico] || 0;
          const objetivo = estado.resumenAsignacion.objetivos[medico] || 0;
          const diferencia = asignadas - objetivo;

          estado.historico.meses[claveMes][medico] = {
            asignadas,
            objetivo,
            diferencia,
          };

          if (!estado.historico.saldoAcumulado[medico]) {
            estado.historico.saldoAcumulado[medico] = 0;
          }
          estado.historico.saldoAcumulado[medico] += diferencia;
        }

        limpiarHistoricoAntiguo();
        guardarEnMemoria();
        mostrarToast(`Hist√≥rico del mes ${mes}/${anio} guardado.`);
      }
      function cargarDeMemoria() {
        const datosGuardados = localStorage.getItem("sistemaGuardias_v16");
        if (datosGuardados) {
          Object.assign(estado, JSON.parse(datosGuardados));
          console.log("Estado cargado desde memoria:", estado);
          actualizarTodasLasTablas();
          poblarSelects();
        }
      }
      function exportarConfiguracion() {
        const datosAExportar = {
          medicos: estado.medicos,
          reducciones: estado.reducciones,
          festivos: estado.festivos,
          ausencias: estado.ausencias,
          exclusionesPuntuales: estado.exclusionesPuntuales,
          planificacionesTurnos: estado.planificacionesTurnos,
        };
        const blob = new Blob([JSON.stringify(datosAExportar, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "configuracion_guardias_v15.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      function exportarHistorico() {
        const datosHistorico = {
          version: "1.0",
          fechaExportacion: new Date().toISOString(),
          historico: {
            meses: estado.historico?.meses || {},
            saldoAcumulado: estado.historico?.saldoAcumulado || {},
            factorCompensacion: estado.historico?.factorCompensacion || 0.5,
            ventanaHistorico: estado.historico?.ventanaHistorico || 6,
          },
          // Incluir resumen de meses guardados para referencia
          resumenMeses: Object.keys(estado.historico?.meses || {}).map(
            (mes) => ({
              mes: mes,
              totalGuardias: Object.values(estado.historico.meses[mes]).reduce(
                (sum, m) => sum + (m.asignadas || 0),
                0
              ),
            })
          ),
        };

        const blob = new Blob([JSON.stringify(datosHistorico, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;

        // Nombre descriptivo con fecha
        const fecha = new Date();
        const nombreArchivo = `historico_guardias_${fecha.getFullYear()}_${String(
          fecha.getMonth() + 1
        ).padStart(2, "0")}.json`;
        a.download = nombreArchivo;

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        mostrarToast(
          `Hist√≥rico exportado: ${
            Object.keys(datosHistorico.historico.meses).length
          } meses guardados`
        );
      }

      function importarHistorico(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const datosImportados = JSON.parse(e.target.result);

            // Validar estructura del hist√≥rico
            if (
              !datosImportados.historico ||
              !datosImportados.historico.meses
            ) {
              throw new Error("El archivo no contiene un hist√≥rico v√°lido.");
            }

            // Preguntar si fusionar o reemplazar
            const mesesExistentes = Object.keys(
              estado.historico?.meses || {}
            ).length;
            const mesesNuevos = Object.keys(
              datosImportados.historico.meses
            ).length;

            let mensaje = `El archivo contiene ${mesesNuevos} mes(es) de hist√≥rico.`;
            if (mesesExistentes > 0) {
              mensaje += ` Ya tienes ${mesesExistentes} mes(es) guardados. ¬øQuieres fusionar los datos (se mantendr√°n ambos) o reemplazar todo?`;

              // Crear di√°logo personalizado
              const modalContent = document.getElementById("modal-content");
              const originalContent = modalContent.innerHTML;

              modalContent.innerHTML = `
          <p>${mensaje}</p>
          <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
            <button onclick="procesarImportacionHistorico(${JSON.stringify(
              datosImportados
            ).replace(
              /"/g,
              "&quot;"
            )}, 'fusionar')" class="success">Fusionar</button>
            <button onclick="procesarImportacionHistorico(${JSON.stringify(
              datosImportados
            ).replace(
              /"/g,
              "&quot;"
            )}, 'reemplazar')" class="warning">Reemplazar</button>
            <button onclick="document.getElementById('modal-overlay').style.display='none'" class="secondary">Cancelar</button>
          </div>
        `;

              document.getElementById("modal-overlay").style.opacity = "1";
              document.getElementById("modal-overlay").style.visibility =
                "visible";
            } else {
              // No hay datos previos, importar directamente
              procesarImportacionHistorico(datosImportados, "reemplazar");
            }
          } catch (error) {
            console.error("Error al importar hist√≥rico:", error);
            mostrarToast(
              "Error al importar el archivo de hist√≥rico. Verifica que sea un archivo v√°lido."
            );
          }
        };
        reader.readAsText(file);

        // Limpiar el input para permitir reimportar el mismo archivo
        event.target.value = "";
      }

      function procesarImportacionHistorico(datosImportados, modo) {
        try {
          if (modo === "fusionar") {
            // Fusionar: mantener datos existentes y a√±adir/actualizar con los nuevos
            if (!estado.historico) {
              estado.historico = {
                meses: {},
                saldoAcumulado: {},
                factorCompensacion: 0.5,
                ventanaHistorico: 6,
              };
            }

            // Fusionar meses (los nuevos sobrescriben los existentes si hay conflicto)
            Object.assign(
              estado.historico.meses,
              datosImportados.historico.meses
            );

            // Recalcular saldos acumulados con todos los meses
            estado.historico.saldoAcumulado = {};
            for (const claveMes in estado.historico.meses) {
              const datosMes = estado.historico.meses[claveMes];
              for (const medico in datosMes) {
                if (!estado.historico.saldoAcumulado[medico]) {
                  estado.historico.saldoAcumulado[medico] = 0;
                }
                estado.historico.saldoAcumulado[medico] +=
                  datosMes[medico].diferencia || 0;
              }
            }

            mostrarToast(
              `Hist√≥rico fusionado: ${
                Object.keys(estado.historico.meses).length
              } meses totales`
            );
          } else {
            // Reemplazar todo el hist√≥rico
            estado.historico = datosImportados.historico;
            mostrarToast(
              `Hist√≥rico importado: ${
                Object.keys(datosImportados.historico.meses).length
              } meses cargados`
            );
          }

          // Actualizar interfaz
          actualizarTablaHistorico();
          guardarEnMemoria();

          // Cerrar modal si est√° abierto
          document.getElementById("modal-overlay").style.opacity = "0";
          document.getElementById("modal-overlay").style.visibility = "hidden";
        } catch (error) {
          console.error("Error procesando hist√≥rico:", error);
          mostrarToast("Error al procesar el hist√≥rico importado");
        }
      }
      function importarConfiguracion(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const datosImportados = JSON.parse(e.target.result);
            // Validar estructura b√°sica
            if (datosImportados.medicos && datosImportados.festivos) {
              Object.assign(estado, datosImportados);
              actualizarTodasLasTablas();
              poblarSelects();
              mostrarToast("Configuraci√≥n importada correctamente.");
            } else {
              throw new Error("Formato de archivo no v√°lido.");
            }
          } catch (error) {
            console.error("Error al importar:", error);
            mostrarToast(
              "Error al importar el archivo. Verifique que sea un archivo JSON v√°lido."
            );
          }
        };
        reader.readAsText(file);
      }
      // === FUNCIONES DE INTERFAZ DE USUARIO ===
      function mostrarSeccion(nombreSeccion) {
        document
          .querySelectorAll(".seccion")
          .forEach((sec) => (sec.style.display = "none"));
        document.getElementById(nombreSeccion).style.display = "block";
      }
      function abrirTab(evt, tabName) {
        var i, tabcontent, tabbuttons;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].className = tabcontent[i].className.replace(
            " active",
            ""
          );
        }
        tabbuttons = document.getElementsByClassName("tab-button");
        for (i = 0; i < tabbuttons.length; i++) {
          tabbuttons[i].className = tabbuttons[i].className.replace(
            " active",
            ""
          );
        }
        document.getElementById(tabName).className += " active";
        evt.currentTarget.className += " active";
      }
      function poblarSelects() {
        const medicosActivos = estado.medicos.filter((m) => m.activo);
        const selectsMedicos = [
          "reduccionMedico",
          "ausenciaMedico",
          "exclPuntMedico",
          "planTurnoMedico",
        ];
        selectsMedicos.forEach((id) => {
          const select = document.getElementById(id);
          if (select) {
            select.innerHTML = "";
            medicosActivos.forEach((medico) => {
              const option = document.createElement("option");
              option.value = medico.nombre;
              option.textContent = medico.nombre;
              select.appendChild(option);
            });
          }
        });
      }
      function actualizarTodasLasTablas() {
        actualizarTablaMedicos();
        actualizarTablaReducciones();
        actualizarTablaFestivos();
        actualizarTablaAusencias();
        actualizarTablaExclPunt();
        actualizarTablaPlanes();
      }
      // === FUNCIONES DE GESTI√ìN DE M√âDICOS ===
      function agregarMedico() {
        const nombre = document
          .getElementById("nuevoMedicoNombre")
          .value.trim()
          .toUpperCase();
        const turno = document.getElementById("nuevoMedicoTurno").value;
        const activo = document.getElementById("nuevoMedicoActivo").checked;
        if (!nombre) {
          mostrarToast("Por favor, introduce el nombre del m√©dico.");
          return;
        }
        if (estado.medicos.some((m) => m.nombre === nombre)) {
          mostrarToast("Ya existe un m√©dico con ese nombre.");
          return;
        }
        estado.medicos.push({ nombre, turno, activo });
        document.getElementById("nuevoMedicoNombre").value = "";
        actualizarTablaMedicos();
        poblarSelects(); // Actualizar selects que dependen de m√©dicos
      }
      function procesarImportacionMasiva() {
        const texto = document.getElementById("importacionMasiva").value;
        const lineas = texto.split("\n").filter((l) => l.trim());

        let importados = 0;
        let actualizados = 0;
        let errores = [];

        lineas.forEach((linea, index) => {
          const campos = linea.split("\t").map((c) => c.trim());
          if (campos.length >= 2) {
            const nombre = campos[0].toUpperCase();
            const turno = campos[1].toUpperCase();
            const jornada = campos[2] ? parseInt(campos[2]) : 100;

            if (!nombre) {
              errores.push(`L√≠nea ${index + 1}: Nombre vac√≠o`);
              return;
            }

            if (!["MA√ëANA", "TARDE", "MIXTO"].includes(turno)) {
              errores.push(`L√≠nea ${index + 1}: Turno inv√°lido "${turno}"`);
              return;
            }

            // Verificar si el m√©dico ya existe
            const medicoExistente = estado.medicos.find(
              (m) => m.nombre === nombre
            );

            if (medicoExistente) {
              // Actualizar m√©dico existente
              medicoExistente.turno = turno;
              actualizados++;
            } else {
              // A√±adir nuevo m√©dico
              estado.medicos.push({ nombre, turno, activo: true });
              importados++;
            }

            // Si tiene jornada reducida, gestionarla
            if (jornada < 100) {
              // Eliminar reducci√≥n existente si la hay
              estado.reducciones = estado.reducciones.filter(
                (r) => r.medico !== nombre
              );
              // A√±adir la nueva
              estado.reducciones.push({
                medico: nombre,
                porcentaje: jornada,
                diasExcluidos: "",
              });
            }
          } else {
            errores.push(
              `L√≠nea ${index + 1}: Formato incorrecto (faltan columnas)`
            );
          }
        });

        actualizarTodasLasTablas();
        poblarSelects();

        let mensaje = "";
        if (importados > 0) mensaje += `‚úì ${importados} m√©dicos importados\n`;
        if (actualizados > 0)
          mensaje += `‚úì ${actualizados} m√©dicos actualizados\n`;
        if (errores.length > 0)
          mensaje += `‚úó ${errores.length} errores:\n${errores
            .slice(0, 3)
            .join("\n")}`;

        mostrarToast(mensaje || "No se procesaron datos");
        document.getElementById("importacionMasiva").value = "";

        // Actualizar tambi√©n la tabla de reducciones
        actualizarTablaReducciones();
      }
      // C√ìDIGO NUEVO (para reemplazar)
      function eliminarMedico(nombre) {
        mostrarConfirmacion(
          `¬øEst√°s seguro de que quieres eliminar al m√©dico ${nombre}? Esto borrar√° tambi√©n todas sus configuraciones asociadas.`,
          () => {
            estado.medicos = estado.medicos.filter((m) => m.nombre !== nombre);
            // Tambi√©n eliminar configuraciones asociadas
            estado.reducciones = estado.reducciones.filter(
              (r) => r.medico !== nombre
            );
            estado.ausencias = estado.ausencias.filter(
              (a) => a.medico !== nombre
            );
            estado.exclusionesPuntuales = estado.exclusionesPuntuales.filter(
              (e) => e.medico !== nombre
            );
            estado.planificacionesTurnos = estado.planificacionesTurnos.filter(
              (p) => p.medico !== nombre
            );
            actualizarTodasLasTablas();
            poblarSelects();
            mostrarToast(`M√©dico ${nombre} eliminado.`);
          }
        );
      }
      function actualizarTablaMedicos() {
        const tbody = document.querySelector("#tablaMedicos tbody");
        tbody.innerHTML = "";
        estado.medicos.forEach((medico) => {
          const row = tbody.insertRow();
          row.insertCell(0).textContent = medico.nombre;
          const cellTurno = row.insertCell(1);
          cellTurno.textContent = medico.turno;
          cellTurno.innerHTML += ` <span class="badge badge-${medico.turno.toLowerCase()}">${medico.turno.charAt(
            0
          )}</span>`;
          const cellActivo = row.insertCell(2);
          cellActivo.innerHTML = medico.activo
            ? '<span class="highlight">S√≠</span>'
            : "No";
          const cellAcciones = row.insertCell(3);
          const btnEliminar = document.createElement("button");
          btnEliminar.textContent = "Eliminar";
          btnEliminar.className = "danger";
          btnEliminar.onclick = () => eliminarMedico(medico.nombre);
          cellAcciones.appendChild(btnEliminar);
        });
      }
      // === FUNCIONES DE GESTI√ìN DE REDUCCIONES ===
      function guardarReduccion() {
        const medico = document.getElementById("reduccionMedico").value;
        const porcentaje =
          parseInt(document.getElementById("reduccionPorcentaje").value) || 100;
        const checkboxes = document.querySelectorAll(
          'input[name="diasExcluidos"]:checked'
        );
        const diasExcluidos = Array.from(checkboxes).map((cb) => cb.value);
        if (!medico) {
          mostrarToast("Por favor, selecciona un m√©dico.");
          return;
        }
        // Eliminar entrada existente si la hay
        estado.reducciones = estado.reducciones.filter(
          (r) => r.medico !== medico
        );
        // Agregar la nueva
        estado.reducciones.push({
          medico,
          porcentaje,
          diasExcluidos: diasExcluidos.join(", "),
        });
        // Limpiar formulario
        document.getElementById("reduccionPorcentaje").value = "100";
        checkboxes.forEach((cb) => (cb.checked = false));
        actualizarTablaReducciones();
      }
      // C√ìDIGO NUEVO (para reemplazar)
      function eliminarReduccion(medico) {
        mostrarConfirmacion(
          `¬øSeguro que quieres eliminar la reducci√≥n de jornada para ${medico}?`,
          () => {
            estado.reducciones = estado.reducciones.filter(
              (r) => r.medico !== medico
            );
            actualizarTablaReducciones();
            mostrarToast(`Reducci√≥n para ${medico} eliminada.`);
          }
        );
      }
      function actualizarTablaReducciones() {
        const tbody = document.querySelector("#tablaReducciones tbody");
        tbody.innerHTML = "";
        estado.reducciones.forEach((item) => {
          const row = tbody.insertRow();
          row.insertCell(0).textContent = item.medico;
          row.insertCell(1).textContent = `${item.porcentaje}%`;
          row.insertCell(2).textContent = item.diasExcluidos || "Ninguno";
          const cellAcciones = row.insertCell(3);
          const btnEliminar = document.createElement("button");
          btnEliminar.textContent = "Eliminar";
          btnEliminar.className = "danger";
          btnEliminar.onclick = () => eliminarReduccion(item.medico);
          cellAcciones.appendChild(btnEliminar);
        });
      }
      // === FUNCIONES DE GESTI√ìN DE FESTIVOS ===
      function agregarFestivo() {
        const fechaInput = document.getElementById("nuevoFestivo").value;
        if (!fechaInput) {
          mostrarToast("Por favor, selecciona una fecha.");
          return;
        }
        const fecha = new Date(fechaInput);
        const fechaStr = fecha.toISOString().split("T")[0];
        if (estado.festivos.includes(fechaStr)) {
          mostrarToast("Esa fecha ya est√° en la lista de festivos.");
          return;
        }
        estado.festivos.push(fechaStr);
        estado.festivos.sort(); // Mantener ordenado
        document.getElementById("nuevoFestivo").value = "";
        actualizarTablaFestivos();
      }
      function eliminarFestivo(fecha) {
        mostrarConfirmacion(
          `¬øSeguro que quieres eliminar el festivo del ${fecha}?`,
          () => {
            estado.festivos = estado.festivos.filter((f) => f !== fecha);
            actualizarTablaFestivos();
            mostrarToast(`Festivo del ${fecha} eliminado.`);
          }
        );
      }
      function actualizarTablaFestivos() {
        const tbody = document.querySelector("#tablaFestivos tbody");
        tbody.innerHTML = "";
        estado.festivos.forEach((fecha) => {
          const row = tbody.insertRow();
          row.insertCell(0).textContent = fecha;
          const cellAcciones = row.insertCell(1);
          const btnEliminar = document.createElement("button");
          btnEliminar.textContent = "Eliminar";
          btnEliminar.className = "danger";
          btnEliminar.onclick = () => eliminarFestivo(fecha);
          cellAcciones.appendChild(btnEliminar);
        });
      }
      // === FUNCIONES DE GESTI√ìN DE AUSENCIAS ===
      function agregarAusencia() {
        const medico = document.getElementById("ausenciaMedico").value;
        const inicio = document.getElementById("ausenciaInicio").value;
        const fin = document.getElementById("ausenciaFin").value;
        if (!medico || !inicio || !fin) {
          mostrarToast("Por favor, completa todos los campos.");
          return;
        }
        const inicioDate = new Date(inicio);
        const finDate = new Date(fin);
        if (inicioDate > finDate) {
          mostrarToast(
            "La fecha de inicio no puede ser posterior a la fecha de fin."
          );
          return;
        }
        estado.ausencias.push({
          medico,
          inicio,
          fin,
        });
        // Limpiar formulario
        document.getElementById("ausenciaInicio").value = "";
        document.getElementById("ausenciaFin").value = "";
        actualizarTablaAusencias();
      }
      function eliminarAusencia(index) {
        const ausencia = estado.ausencias[index];
        if (!ausencia) return;

        mostrarConfirmacion(
          `¬øSeguro que quieres eliminar la ausencia de ${ausencia.medico} (${ausencia.inicio} a ${ausencia.fin})?`,
          () => {
            estado.ausencias.splice(index, 1);
            actualizarTablaAusencias();
            mostrarToast("Ausencia eliminada.");
          }
        );
      }
      function actualizarTablaAusencias() {
        const tbody = document.querySelector("#tablaAusencias tbody");
        tbody.innerHTML = "";
        estado.ausencias.forEach((ausencia, index) => {
          const row = tbody.insertRow();
          row.insertCell(0).textContent = ausencia.medico;
          row.insertCell(1).textContent = ausencia.inicio;
          row.insertCell(2).textContent = ausencia.fin;
          const cellAcciones = row.insertCell(3);
          const btnEliminar = document.createElement("button");
          btnEliminar.textContent = "Eliminar";
          btnEliminar.className = "danger";
          btnEliminar.onclick = () => eliminarAusencia(index);
          cellAcciones.appendChild(btnEliminar);
        });
      }
      // === FUNCIONES DE GESTI√ìN DE EXCLUSIONES PUNTUALES ===
      function agregarExclusionPuntual() {
        const medico = document.getElementById("exclPuntMedico").value;
        const fecha = document.getElementById("exclPuntFecha").value;
        if (!medico || !fecha) {
          mostrarToast("Por favor, selecciona un m√©dico y una fecha.");
          return;
        }
        const fechaStr = new Date(fecha).toISOString().split("T")[0];
        // Evitar duplicados
        if (
          estado.exclusionesPuntuales.some(
            (e) => e.medico === medico && e.fecha === fechaStr
          )
        ) {
          mostrarToast("Esa exclusi√≥n ya est√° registrada para ese m√©dico.");
          return;
        }
        estado.exclusionesPuntuales.push({
          medico,
          fecha: fechaStr,
        });
        document.getElementById("exclPuntFecha").value = "";
        actualizarTablaExclPunt();
      }
      function eliminarExclusionPuntual(index) {
        const exclusion = estado.exclusionesPuntuales[index];
        if (!exclusion) return;

        mostrarConfirmacion(
          `¬øSeguro que quieres eliminar la exclusi√≥n de ${exclusion.medico} para el d√≠a ${exclusion.fecha}?`,
          () => {
            estado.exclusionesPuntuales.splice(index, 1);
            actualizarTablaExclPunt();
            mostrarToast("Exclusi√≥n puntual eliminada.");
          }
        );
      }
      function actualizarTablaExclPunt() {
        const tbody = document.querySelector("#tablaExclPunt tbody");
        tbody.innerHTML = "";
        estado.exclusionesPuntuales.forEach((excl, index) => {
          const row = tbody.insertRow();
          row.insertCell(0).textContent = excl.medico;
          row.insertCell(1).textContent = excl.fecha;
          const cellAcciones = row.insertCell(2);
          const btnEliminar = document.createElement("button");
          btnEliminar.textContent = "Eliminar";
          btnEliminar.className = "danger";
          btnEliminar.onclick = () => eliminarExclusionPuntual(index);
          cellAcciones.appendChild(btnEliminar);
        });
      }
      // === FUNCIONES DE GESTI√ìN DE PLANIFICACI√ìN DE TURNOS ===
      function guardarPlanTurno() {
        const medico = document.getElementById("planTurnoMedico").value;
        if (!medico) {
          mostrarToast("Por favor, selecciona un m√©dico.");
          return;
        }
        const plan = {
          medico,
          L: document.getElementById("turnoL").value,
          M: document.getElementById("turnoM").value,
          X: document.getElementById("turnoX").value,
          J: document.getElementById("turnoJ").value,
          V: document.getElementById("turnoV").value,
        };
        // Eliminar plan existente si lo hay
        estado.planificacionesTurnos = estado.planificacionesTurnos.filter(
          (p) => p.medico !== medico
        );
        estado.planificacionesTurnos.push(plan);
        actualizarTablaPlanes();
      }
      function eliminarPlanTurno(medico) {
        mostrarConfirmacion(
          `¬øSeguro que quieres eliminar la planificaci√≥n de turnos para ${medico}?`,
          () => {
            estado.planificacionesTurnos = estado.planificacionesTurnos.filter(
              (p) => p.medico !== medico
            );
            actualizarTablaPlanes();
            mostrarToast(`Planificaci√≥n para ${medico} eliminada.`);
          }
        );
      }
      function actualizarTablaPlanes() {
        const tbody = document.querySelector("#tablaPlanesGuardados tbody");
        tbody.innerHTML = "";
        estado.planificacionesTurnos.forEach((plan) => {
          const row = tbody.insertRow();
          row.insertCell(0).textContent = plan.medico;
          row.insertCell(1).textContent = plan.L.charAt(0);
          row.insertCell(2).textContent = plan.M.charAt(0);
          row.insertCell(3).textContent = plan.X.charAt(0);
          row.insertCell(4).textContent = plan.J.charAt(0);
          row.insertCell(5).textContent = plan.V.charAt(0);
          const cellAcciones = row.insertCell(6);
          const btnEliminar = document.createElement("button");
          btnEliminar.textContent = "Eliminar";
          btnEliminar.className = "danger";
          btnEliminar.onclick = () => eliminarPlanTurno(plan.medico);
          cellAcciones.appendChild(btnEliminar);
        });
      }
      function guardarParametrosAvanzados() {
        estado.historico.factorCompensacion =
          parseInt(document.getElementById("factorCompensacion").value) / 100;
        estado.historico.ventanaHistorico = parseInt(
          document.getElementById("ventanaHistorico").value
        );

        guardarEnMemoria();
        mostrarToast("Par√°metros avanzados guardados.");
        actualizarTablaHistorico();
      }

      function actualizarTablaHistorico() {
        const tbody = document.getElementById("tbodyHistorico");
        if (!tbody) return;

        tbody.innerHTML = "";

        const medicosActivos = estado.medicos.filter((m) => m.activo);
        medicosActivos.forEach((medico) => {
          const row = tbody.insertRow();
          row.insertCell(0).textContent = medico.nombre;

          const saldo = estado.historico?.saldoAcumulado?.[medico.nombre] || 0;
          const cellSaldo = row.insertCell(1);
          cellSaldo.textContent = saldo.toFixed(1);
          cellSaldo.style.fontWeight = "bold";

          if (Math.abs(saldo) < 0.5) {
            cellSaldo.style.backgroundColor = "#c8e6c9";
          } else if (Math.abs(saldo) < 2) {
            cellSaldo.style.backgroundColor = "#fff9c4";
          } else {
            cellSaldo.style.backgroundColor = "#ffcdd2";
          }

          // Mostrar √∫ltimos 3 meses
          const ultimos3 = [];
          const mesesOrdenados = Object.keys(estado.historico?.meses || {})
            .sort()
            .slice(-3);
          mesesOrdenados.forEach((mes) => {
            const datosMes = estado.historico.meses[mes]?.[medico.nombre];
            if (datosMes) {
              ultimos3.push(
                `${mes}: ${
                  datosMes.diferencia > 0 ? "+" : ""
                }${datosMes.diferencia.toFixed(1)}`
              );
            }
          });
          row.insertCell(2).textContent = ultimos3.join(", ") || "Sin datos";
        });
      }
      function actualizarResumenHistorico() {
        const divResumen = document.getElementById("resumenHistorico");
        if (!divResumen) return;

        const mesesGuardados = Object.keys(estado.historico?.meses || {});

        if (mesesGuardados.length === 0) {
          divResumen.innerHTML = `
      <p style="color: #666;">No hay meses guardados en el hist√≥rico.</p>
      <p style="font-size: 0.85em; color: #999;">Genera calendarios y gu√°rdalos para comenzar a acumular hist√≥rico.</p>
    `;
        } else {
          const mesesOrdenados = mesesGuardados.sort();
          const primerMes = mesesOrdenados[0];
          const ultimoMes = mesesOrdenados[mesesOrdenados.length - 1];

          divResumen.innerHTML = `
      <p><strong>Meses en hist√≥rico:</strong> ${mesesGuardados.length}</p>
      <p><strong>Periodo:</strong> ${primerMes} a ${ultimoMes}</p>
      <p><strong>Total guardias registradas:</strong> <span id="totalGuardiasHistorico">calculando...</span></p>
    `;

          // Calcular total de guardias
          let totalGuardias = 0;
          for (const mes in estado.historico.meses) {
            for (const medico in estado.historico.meses[mes]) {
              totalGuardias +=
                estado.historico.meses[mes][medico].asignadas || 0;
            }
          }
          document.getElementById("totalGuardiasHistorico").textContent =
            totalGuardias;
        }
      }

      function mostrarDetalleHistorico() {
        const meses = Object.keys(estado.historico?.meses || {}).sort();

        if (meses.length === 0) {
          mostrarToast("No hay hist√≥rico para mostrar");
          return;
        }

        let htmlDetalle = "<h3>Detalle del Hist√≥rico por Mes</h3>";
        htmlDetalle += '<table style="width: 100%; margin-top: 10px;">';
        htmlDetalle +=
          "<thead><tr><th>Mes</th><th>Total Guardias</th><th>M√©dicos</th><th>Acciones</th></tr></thead>";
        htmlDetalle += "<tbody>";

        meses.forEach((mes) => {
          const datosMes = estado.historico.meses[mes];
          const totalMes = Object.values(datosMes).reduce(
            (sum, m) => sum + (m.asignadas || 0),
            0
          );
          const numMedicos = Object.keys(datosMes).length;

          htmlDetalle += `
      <tr>
        <td>${mes}</td>
        <td>${totalMes}</td>
        <td>${numMedicos}</td>
        <td>
          <button onclick="eliminarMesHistorico('${mes}')" class="danger" style="padding: 2px 6px; font-size: 0.85em;">
            Eliminar
          </button>
        </td>
      </tr>
    `;
        });

        htmlDetalle += "</tbody></table>";

        // Mostrar en un modal o √°rea espec√≠fica
        const modalContent = document.getElementById("modal-content");
        modalContent.innerHTML =
          htmlDetalle +
          `
    <button onclick="document.getElementById('modal-overlay').style.opacity='0'; document.getElementById('modal-overlay').style.visibility='hidden';" 
            class="secondary" style="margin-top: 15px;">
      Cerrar
    </button>
  `;

        document.getElementById("modal-overlay").style.opacity = "1";
        document.getElementById("modal-overlay").style.visibility = "visible";
      }

      function eliminarMesHistorico(mes) {
        mostrarConfirmacion(
          `¬øEliminar el mes ${mes} del hist√≥rico? Esto recalcular√° todos los saldos acumulados.`,
          () => {
            delete estado.historico.meses[mes];

            // Recalcular saldos
            estado.historico.saldoAcumulado = {};
            for (const claveMes in estado.historico.meses) {
              const datosMes = estado.historico.meses[claveMes];
              for (const medico in datosMes) {
                if (!estado.historico.saldoAcumulado[medico]) {
                  estado.historico.saldoAcumulado[medico] = 0;
                }
                estado.historico.saldoAcumulado[medico] +=
                  datosMes[medico].diferencia || 0;
              }
            }

            actualizarTablaHistorico();
            actualizarResumenHistorico();
            guardarEnMemoria();
            mostrarToast(`Mes ${mes} eliminado del hist√≥rico`);
            mostrarDetalleHistorico(); // Refrescar la vista si sigue abierta
          }
        );
      }
      function toggleAleatoriedad(activado) {
        estado.configuracionAlgoritmo.usarAleatoriedad = activado;
        document.getElementById("opcionesAleatoriedad").style.display = activado
          ? "block"
          : "none";
        guardarEnMemoria();
      }

      function generarSemillaAleatoria() {
        const semilla = Math.floor(Math.random() * 1000000);
        document.getElementById("semillaAleatoria").value = semilla;
        estado.configuracionAlgoritmo.semilla = semilla;
        guardarEnMemoria();
        mostrarToast(`Nueva semilla generada: ${semilla}`);
      }

      function cargarConfiguracionAlgoritmo() {
        if (estado.configuracionAlgoritmo) {
          document.getElementById("usarAleatoriedad").checked =
            estado.configuracionAlgoritmo.usarAleatoriedad;
          document.getElementById("semillaAleatoria").value =
            estado.configuracionAlgoritmo.semilla || "";
          document.getElementById("opcionesAleatoriedad").style.display = estado
            .configuracionAlgoritmo.usarAleatoriedad
            ? "block"
            : "none";
        }
      }
      // === FUNCIONES DE C√ÅLCULO Y GENERACI√ìN ===
      function esLaborable(fecha) {
        const diaSemana = fecha.getDay(); // 0 (Domingo) a 6 (S√°bado)
        if (diaSemana === 0 || diaSemana === 6) return false; // Fin de semana
        const fechaStr = fecha.toISOString().split("T")[0];
        if (estado.festivos.includes(fechaStr)) return false; // Festivo
        return true;
      }
      function estaAusente(medicoNombre, fecha) {
        return estado.ausencias.some(
          (ausencia) =>
            ausencia.medico === medicoNombre &&
            new Date(ausencia.inicio) <= fecha &&
            fecha <= new Date(ausencia.fin)
        );
      }
      function tieneDiaExcluido(medicoNombre, fecha) {
        const reduccion = estado.reducciones.find(
          (r) => r.medico === medicoNombre
        );
        if (!reduccion || !reduccion.diasExcluidos) return false;
        const diasExcluidos = reduccion.diasExcluidos
          .split(",")
          .map((d) => d.trim());
        const nombresDias = [
          "DOMINGO",
          "LUNES",
          "MARTES",
          "MIERCOLES",
          "JUEVES",
          "VIERNES",
          "SABADO",
        ];
        const nombreDia = nombresDias[fecha.getDay()];
        // Manejo especial para mi√©rcoles con/sin tilde
        if (nombreDia === "MIERCOLES") {
          return (
            diasExcluidos.includes("MIERCOLES") ||
            diasExcluidos.includes("MI√âRCOLES")
          );
        }
        return diasExcluidos.includes(nombreDia);
      }
      function tieneExclusionPuntual(medicoNombre, fecha) {
        const fechaStr = fecha.toISOString().split("T")[0];
        return estado.exclusionesPuntuales.some(
          (excl) => excl.medico === medicoNombre && excl.fecha === fechaStr
        );
      }
      function puedeTrabajar(medicoNombre, fecha) {
        if (estaAusente(medicoNombre, fecha)) return false;
        if (tieneDiaExcluido(medicoNombre, fecha)) return false;
        if (tieneExclusionPuntual(medicoNombre, fecha)) return false;
        return true;
      }
      // === C√ìDIGO NUEVO A A√ëADIR ===
      function puedeTrabajarParaObjetivo(medicoNombre, fecha) {
        // Esta funci√≥n es id√©ntica a puedeTrabajar pero IGNORA las exclusiones puntuales
        // para que no afecten al c√°lculo del objetivo.
        if (estaAusente(medicoNombre, fecha)) return false;
        if (tieneDiaExcluido(medicoNombre, fecha)) return false;
        // No se comprueba tieneExclusionPuntual
        return true;
      }
      function obtenerTurnoMixto(medicoNombre, fecha) {
        const plan = estado.planificacionesTurnos.find(
          (p) => p.medico === medicoNombre
        );
        if (plan) {
          const nombresDias = [, "L", "M", "X", "J", "V"]; // Domingo no se usa
          const diaISO = fecha.getDay(); // 0 (Domingo) a 6 (S√°bado)
          if (diaISO >= 1 && diaISO <= 5) {
            const claveDia = nombresDias[diaISO];
            return plan[claveDia] || "MA√ëANA"; // Por defecto MA√ëANA si no est√° definido
          }
        }
        // Por defecto: 60% tarde, 40% ma√±ana (3 tardes por semana)
        const diaSemanaISO = fecha.getDay(); // 0 (Domingo) a 6 (S√°bado)
        if ([1, 3, 5].includes(diaSemanaISO)) {
          // L, X, V
          return "TARDE";
        } else if ([2, 4].includes(diaSemanaISO)) {
          // M, J
          return "MA√ëANA";
        }
        return "MA√ëANA";
      }
      // C√ìDIGO NUEVO (para reemplazar)
      // C√ìDIGO NUEVO Y CORREGIDO (para reemplazar)
      // C√ìDIGO NUEVO Y CORRECTO (para reemplazar)
      function calcularObjetivos(mes, anio) {
        const ultimoDia = new Date(anio, mes, 0).getDate();
        const medicosActivos = estado.medicos.filter((m) => m.activo);
        const objetivosBase = {};
        const disponibilidadPonderada = {};
        let totalDisponibilidadPonderada = 0;
        let totalPuestosACubrir = 0;

        // 1. Contar el total de puestos a cubrir en el mes
        for (let dia = 1; dia <= ultimoDia; dia++) {
          const fecha = new Date(Date.UTC(anio, mes - 1, dia));
          if (esLaborable(fecha)) {
            totalPuestosACubrir += 4;
          }
        }

        // 2. Calcular la disponibilidad PONDERADA por jornada para cada m√©dico
        for (const medico of medicosActivos) {
          let slotsDisponibles = 0;
          for (let dia = 1; dia <= ultimoDia; dia++) {
            const fecha = new Date(Date.UTC(anio, mes - 1, dia));
            // Usamos la funci√≥n espec√≠fica para objetivos que ignora exclusiones puntuales
            if (
              esLaborable(fecha) &&
              puedeTrabajarParaObjetivo(medico.nombre, fecha)
            ) {
              const turnoMixto =
                medico.turno === "MIXTO"
                  ? obtenerTurnoMixto(medico.nombre, fecha)
                  : null;
              if (medico.turno === "MA√ëANA" || turnoMixto === "MA√ëANA") {
                slotsDisponibles += 2;
              }
              if (medico.turno === "TARDE" || turnoMixto === "TARDE") {
                slotsDisponibles += 2;
              }
            }
          }
          const reduccion = estado.reducciones.find(
            (r) => r.medico === medico.nombre
          );
          const porcentajeJornada = reduccion ? reduccion.porcentaje / 100 : 1;
          disponibilidadPonderada[medico.nombre] =
            slotsDisponibles * porcentajeJornada;
          totalDisponibilidadPonderada +=
            disponibilidadPonderada[medico.nombre];
        }

        // 3. Distribuir los puestos proporcionalmente
        if (totalDisponibilidadPonderada > 0) {
          medicosActivos.forEach((medico) => {
            const proporcion =
              disponibilidadPonderada[medico.nombre] /
              totalDisponibilidadPonderada;
            const objetivo = proporcion * totalPuestosACubrir;
            objetivosBase[medico.nombre] = objetivo;
          });
        }

        // 4. Aplicar compensaci√≥n hist√≥rica
        const objetivosAjustados = {};
        for (const medico of medicosActivos) {
          const nombre = medico.nombre;
          const objetivoBase = objetivosBase[nombre] || 0;
          const saldoAcumulado =
            estado.historico?.saldoAcumulado?.[nombre] || 0;
          const factorCompensacion =
            estado.historico?.factorCompensacion || 0.5;
          const ajusteHistorico = -saldoAcumulado * factorCompensacion;
          const ajusteMaximo = objetivoBase * 0.3;
          const ajusteLimitado = Math.max(
            -ajusteMaximo,
            Math.min(ajusteMaximo, ajusteHistorico)
          );
          objetivosAjustados[nombre] = Math.max(
            0,
            objetivoBase + ajusteLimitado
          );
        }

        // 5. Normalizar para mantener el total
        const totalOriginal = Object.values(objetivosBase).reduce(
          (a, b) => a + b,
          0
        );
        const totalAjustado = Object.values(objetivosAjustados).reduce(
          (a, b) => a + b,
          0
        );
        if (totalAjustado > 0) {
          const factor = totalOriginal / totalAjustado;
          for (const nombre in objetivosAjustados) {
            objetivosAjustados[nombre] = parseFloat(
              (objetivosAjustados[nombre] * factor).toFixed(2)
            );
          }
        }
        return objetivosAjustados;
      }
      // === FUNCI√ìN DE ASIGNACI√ìN MEJORADA (ROUND-ROBIN CON PONDERACI√ìN) ===
      // Generador de n√∫meros pseudoaleatorios con semilla (Mulberry32)
      function mulberry32(seed) {
        return function () {
          let t = (seed += 0x6d2b79f5);
          t = Math.imul(t ^ (t >>> 15), t | 1);
          t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
          return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };
      }

      function asignarPuesto(
        puestoKey,
        candidatos,
        asignacionesLocales,
        avisosLocales,
        urgenciasLocales,
        objetivosLocales,
        lunesPorMedico,
        viernesPorMedico,
        tipoGuardia,
        fecha,
        ultimoTipoPorMedico // NUEVO PAR√ÅMETRO
      ) {
        if (candidatos.length === 0) return "---";

        // Calcular puntuaciones para todos los candidatos
        const candidatosConPuntuacion = candidatos.map((candidato) => {
          let puntuacion = 0;

          // 1. Factor principal: Menos asignadas
          const asignadas = asignacionesLocales[candidato] || 0;
          puntuacion += 100 - asignadas;

          // 2. Factor secundario: Mayor d√©ficit
          const objetivo = objetivosLocales[candidato] || 0;
          const deficit = objetivo - asignadas;
          puntuacion += deficit * 10;

          // 3. NUEVO: Penalizaci√≥n fuerte por repetir tipo de guardia
          const ultimoTipo = ultimoTipoPorMedico[candidato];
          if (ultimoTipo === tipoGuardia && asignadas > 0) {
            puntuacion -= 50; // Penalizaci√≥n muy fuerte por repetir tipo
          } else if (ultimoTipo && ultimoTipo !== tipoGuardia) {
            puntuacion += 20; // Bonificaci√≥n por alternar
          }

          // 4. Factor terciario: Balance Avisos/Urgencias global
          if (asignadas > 0) {
            const porcAvisos = (avisosLocales[candidato] || 0) / asignadas;
            if (tipoGuardia === "AVISOS" && porcAvisos > 0.55) {
              puntuacion -= 10;
            } else if (tipoGuardia === "URGENCIAS" && porcAvisos < 0.45) {
              puntuacion -= 10;
            }
          }

          // 5. Factor cuarto: Penalizaci√≥n L/V
          const diaSemanaISO = fecha.getDay();
          if (diaSemanaISO === 1) {
            puntuacion -= (lunesPorMedico[candidato] || 0) * 3;
          } else if (diaSemanaISO === 5) {
            puntuacion -= (viernesPorMedico[candidato] || 0) * 3;
          }

          return { candidato, puntuacion };
        });

        // Ordenar por puntuaci√≥n
        candidatosConPuntuacion.sort((a, b) => b.puntuacion - a.puntuacion);

        // Manejo de empates con aleatoriedad opcional
        if (estado.configuracionAlgoritmo?.usarAleatoriedad) {
          const mejorPuntuacion = candidatosConPuntuacion[0].puntuacion;
          const empatados = candidatosConPuntuacion.filter(
            (c) => Math.abs(c.puntuacion - mejorPuntuacion) < 0.01
          );

          if (empatados.length > 1) {
            const semilla = estado.configuracionAlgoritmo.semilla || Date.now();
            const rng = mulberry32(semilla + fecha.getTime());

            for (let i = empatados.length - 1; i > 0; i--) {
              const j = Math.floor(rng() * (i + 1));
              [empatados[i], empatados[j]] = [empatados[j], empatados[i]];
            }

            return empatados[0].candidato;
          }
        }

        return candidatosConPuntuacion[0]?.candidato || "---";
      }
      function generarGuardias() {
        const mes = parseInt(document.getElementById("mes").value);
        const anio = parseInt(document.getElementById("anio").value);
        if (
          isNaN(mes) ||
          isNaN(anio) ||
          mes < 1 ||
          mes > 12 ||
          anio < 2024 ||
          anio > 2030
        ) {
          mostrarToast(
            "Por favor, introduce un mes (1-12) y un a√±o (2024-2030) v√°lidos."
          );
          return;
        }
        // 1. Inicializar estructuras para el c√°lculo
        const calendario = [];
        const asignacionesPorMedico = {};
        const avisosPorMedico = {};
        const urgenciasPorMedico = {};
        const lunesPorMedico = {};
        const viernesPorMedico = {};
        estado.medicos
          .filter((m) => m.activo)
          .forEach((m) => {
            asignacionesPorMedico[m.nombre] = 0;
            avisosPorMedico[m.nombre] = 0;
            urgenciasPorMedico[m.nombre] = 0;
            lunesPorMedico[m.nombre] = 0;
            viernesPorMedico[m.nombre] = 0;
          });
        // 2. Calcular objetivos
        const objetivos = calcularObjetivos(mes, anio);
        console.log("Objetivos calculados:", objetivos);
        // 3. Crear calendario
        const ultimoDia = new Date(anio, mes, 0).getDate();
        // NUEVO: Tracking del √∫ltimo tipo de guardia por m√©dico
        const ultimoTipoPorMedico = {};
        for (let dia = 1; dia <= ultimoDia; dia++) {
          const fecha = new Date(Date.UTC(anio, mes - 1, dia));
          const esLab = esLaborable(fecha);
          const diaSemanaISO = fecha.getDay(); // 0 (Domingo) a 6 (S√°bado)
          if (esLab) {
            calendario.push({
              dia: dia,
              fecha: fecha,
              esLaborable: true,
              avisos_manana: "---",
              urgencias_manana: "---",
              avisos_tarde: "---",
              urgencias_tarde: "---",
            });
          } else {
            calendario.push({
              dia: dia,
              fecha: fecha,
              esLaborable: false,
              tipo:
                diaSemanaISO === 0 || diaSemanaISO === 6
                  ? "Fin de semana"
                  : "Festivo",
            });
          }
        }

        // 4. Asignaci√≥n Round-Robin separada por tipo (L√ìGICA CORREGIDA)
        calendario.forEach((diaInfo) => {
          if (!diaInfo.esLaborable) return;

          const fecha = diaInfo.fecha;
          const fechaStr = fecha.toISOString().split("T")[0];
          let medicosAsignadosHoy = [];

          const candidatosManana = estado.medicos
            .filter(
              (m) =>
                m.activo &&
                puedeTrabajar(m.nombre, fecha) &&
                (m.turno === "MA√ëANA" ||
                  (m.turno === "MIXTO" &&
                    obtenerTurnoMixto(m.nombre, fecha) === "MA√ëANA"))
            )
            .map((m) => m.nombre);
          const candidatosTarde = estado.medicos
            .filter(
              (m) =>
                m.activo &&
                puedeTrabajar(m.nombre, fecha) &&
                (m.turno === "TARDE" ||
                  (m.turno === "MIXTO" &&
                    obtenerTurnoMixto(m.nombre, fecha) === "TARDE"))
            )
            .map((m) => m.nombre);

          // --- Funci√≥n auxiliar para procesar una asignaci√≥n (CORREGIDA) ---
          const procesarAsignacion = (medicoAsignado) => {
            if (medicoAsignado !== "---") {
              medicosAsignadosHoy.push(medicoAsignado);

              // LA CORRECCI√ìN EST√Å AQU√ç: Usamos (contador || 0) + 1 para inicializar si no existe
              asignacionesPorMedico[medicoAsignado] =
                (asignacionesPorMedico[medicoAsignado] || 0) + 1;

              const diaSemanaISO = fecha.getDay();
              if (diaSemanaISO === 1)
                lunesPorMedico[medicoAsignado] =
                  (lunesPorMedico[medicoAsignado] || 0) + 1;
              if (diaSemanaISO === 5)
                viernesPorMedico[medicoAsignado] =
                  (viernesPorMedico[medicoAsignado] || 0) + 1;
            }
          };

          let medico;

          // Puesto 1: Avisos Ma√±ana
          medico = asignarPuesto(
            `${fechaStr}|AM_AVISOS`,
            candidatosManana.filter((c) => !medicosAsignadosHoy.includes(c)),
            asignacionesPorMedico,
            avisosPorMedico,
            urgenciasPorMedico,
            objetivos,
            lunesPorMedico,
            viernesPorMedico,
            "AVISOS",
            fecha,
            ultimoTipoPorMedico // NUEVO PAR√ÅMETRO
          );
          if (medico !== "---") {
            diaInfo.avisos_manana = medico;
            avisosPorMedico[medico] = (avisosPorMedico[medico] || 0) + 1;
            ultimoTipoPorMedico[medico] = "AVISOS"; // NUEVO: Registrar tipo
            procesarAsignacion(medico);
          }

          // Puesto 2: Urgencias Ma√±ana
          medico = asignarPuesto(
            `${fechaStr}|AM_URGENCIAS`,
            candidatosManana.filter((c) => !medicosAsignadosHoy.includes(c)),
            asignacionesPorMedico,
            avisosPorMedico,
            urgenciasPorMedico,
            objetivos,
            lunesPorMedico,
            viernesPorMedico,
            "URGENCIAS",
            fecha,
            ultimoTipoPorMedico // NUEVO PAR√ÅMETRO
          );
          if (medico !== "---") {
            diaInfo.urgencias_manana = medico;
            urgenciasPorMedico[medico] = (urgenciasPorMedico[medico] || 0) + 1;
            ultimoTipoPorMedico[medico] = "URGENCIAS"; // NUEVO: Registrar tipo
            procesarAsignacion(medico);
          }

          // Puesto 3: Avisos Tarde
          medico = asignarPuesto(
            `${fechaStr}|PM_AVISOS`,
            candidatosTarde.filter((c) => !medicosAsignadosHoy.includes(c)),
            asignacionesPorMedico,
            avisosPorMedico,
            urgenciasPorMedico,
            objetivos,
            lunesPorMedico,
            viernesPorMedico,
            "AVISOS",
            fecha,
            ultimoTipoPorMedico // NUEVO PAR√ÅMETRO
          );
          if (medico !== "---") {
            diaInfo.avisos_tarde = medico;
            avisosPorMedico[medico] = (avisosPorMedico[medico] || 0) + 1;
            ultimoTipoPorMedico[medico] = "AVISOS"; // NUEVO: Registrar tipo
            procesarAsignacion(medico);
          }

          // Puesto 4: Urgencias Tarde
          medico = asignarPuesto(
            `${fechaStr}|PM_URGENCIAS`,
            candidatosTarde.filter((c) => !medicosAsignadosHoy.includes(c)),
            asignacionesPorMedico,
            avisosPorMedico,
            urgenciasPorMedico,
            objetivos,
            lunesPorMedico,
            viernesPorMedico,
            "URGENCIAS",
            fecha,
            ultimoTipoPorMedico // NUEVO PAR√ÅMETRO
          );
          if (medico !== "---") {
            diaInfo.urgencias_tarde = medico;
            urgenciasPorMedico[medico] = (urgenciasPorMedico[medico] || 0) + 1;
            ultimoTipoPorMedico[medico] = "URGENCIAS"; // NUEVO: Registrar tipo
            procesarAsignacion(medico);
          }
        });
        // 5. Guardar resultados y mostrar
        estado.calendarioGenerado = calendario;
        estado.resumenAsignacion = {
          asignaciones: asignacionesPorMedico,
          avisos: avisosPorMedico,
          urgencias: urgenciasPorMedico,
          lunes: lunesPorMedico,
          viernes: viernesPorMedico,
          objetivos: objetivos,
        };
        mostrarResultados();
      }
      function confirmarYGuardarHistorico() {
        const mes = parseInt(document.getElementById("mes").value);
        const anio = parseInt(document.getElementById("anio").value);

        mostrarConfirmacion(
          `¬øGuardar el calendario de ${mes}/${anio} en el hist√≥rico? Esto actualizar√° los saldos acumulados para la compensaci√≥n futura.`,
          () => {
            guardarHistoricoMes(mes, anio);
            actualizarTablaHistorico();
          }
        );
      }
      // === NUEVA FUNCI√ìN: Copiar Calendario al Portapapeles ===
      function copiarCalendarioAlPortapapeles() {
        const tabla = document.getElementById("tablaCalendario");
        if (!tabla) {
          mostrarToast("No se encontr√≥ la tabla del calendario.");
          return;
        }

        // Crear una copia del HTML de la tabla
        let htmlContent = '<table border="1" cellspacing="0" cellpadding="5">';
        const rows = tabla.rows;
        for (let i = 0; i < rows.length; i++) {
          htmlContent += "<tr>";
          const cells = rows[i].cells;
          for (let j = 0; j < cells.length; j++) {
            const cell = cells[j];
            const tag = i === 0 ? "th" : "td"; // Encabezado para la primera fila
            const bgColor = cell.style.backgroundColor
              ? ` bgcolor="${rgbToHex(cell.style.backgroundColor)}"`
              : "";
            htmlContent += `<${tag}${bgColor}>${cell.innerHTML}</${tag}>`;
          }
          htmlContent += "</tr>";
        }
        htmlContent += "</table>";

        // Copiar al portapapeles
        navigator.clipboard
          .writeText(htmlContent)
          .then(() => {
            mostrarToast("Calendario copiado al portapapeles como HTML.");
          })
          .catch((err) => {
            console.error("Error al copiar: ", err);
            mostrarToast(
              "Error al copiar el calendario. Por favor, int√©ntalo de nuevo."
            );
          });
      }

      // Funci√≥n auxiliar para convertir RGB a HEX (necesaria para el bgcolor)
      function rgbToHex(rgb) {
        if (!rgb) return "";
        // Si ya es hex, devolverlo
        if (rgb.startsWith("#")) return rgb;
        // Convertir rgb(r, g, b) a hex
        const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
        if (!match) return "";
        const r = parseInt(match[1], 10).toString(16).padStart(2, "0");
        const g = parseInt(match[2], 10).toString(16).padStart(2, "0");
        const b = parseInt(match[3], 10).toString(16).padStart(2, "0");
        return `#${r}${g}${b}`;
      }

      // === FUNCI√ìN PARA MOSTRAR RESULTADOS Y ESTAD√çSTICAS DETALLADAS ===
      function mostrarResultados() {
        document.getElementById("areaResultado").style.display = "block";
        // --- Mostrar Calendario ---
        const tbodyCalendario = document.querySelector(
          "#tablaCalendario tbody"
        );
        tbodyCalendario.innerHTML = "";
        estado.calendarioGenerado.forEach((diaInfo) => {
          const row = tbodyCalendario.insertRow();
          row.insertCell(0).textContent = diaInfo.dia;
          row.insertCell(1).textContent = diaInfo.fecha.toLocaleDateString(
            "es-ES",
            { weekday: "short", day: "numeric", month: "short" }
          );
          if (diaInfo.esLaborable) {
            row.insertCell(2).textContent = diaInfo.avisos_manana;
            row.insertCell(3).textContent = diaInfo.urgencias_manana;
            row.insertCell(4).textContent = diaInfo.avisos_tarde;
            row.insertCell(5).textContent = diaInfo.urgencias_tarde;
          } else {
            const cell = row.insertCell(2);
            cell.colSpan = 4;
            cell.textContent = diaInfo.tipo;
            cell.className = "finde-festivo"; // Clase CSS para estilo
            // cell.style.textAlign = "center";
            // cell.style.backgroundColor =
            //   diaInfo.tipo === "Fin de semana" ? "#e0e0e0" : "#ffe0cc";
          }
        });
        // --- Mostrar Resumen ---
        const tbodyResumen = document.querySelector("#tablaResumen tbody");
        tbodyResumen.innerHTML = "";
        let maxAsignadas = -Infinity;
        let minAsignadas = Infinity;
        estado.medicos
          .filter((m) => m.activo)
          .forEach((medico) => {
            const nombre = medico.nombre;
            const asignadas =
              estado.resumenAsignacion.asignaciones[nombre] || 0;
            const avisos = estado.resumenAsignacion.avisos[nombre] || 0;
            const urgencias = estado.resumenAsignacion.urgencias[nombre] || 0;
            const lunes = estado.resumenAsignacion.lunes[nombre] || 0;
            const viernes = estado.resumenAsignacion.viernes[nombre] || 0;
            const objetivo = estado.resumenAsignacion.objetivos[nombre] || 0;
            const diferencia = (asignadas - objetivo).toFixed(1);
            const porcAvisos =
              asignadas > 0 ? ((avisos / asignadas) * 100).toFixed(0) : "0";
            const row = tbodyResumen.insertRow();
            row.insertCell(0).textContent = nombre;
            row.insertCell(1).textContent = medico.turno;
            const cellJornada = row.insertCell(2);
            const reduccion = estado.reducciones.find(
              (r) => r.medico === nombre
            );
            const jornadaPorcentaje = reduccion ? reduccion.porcentaje : 100;
            cellJornada.textContent = `${jornadaPorcentaje}%`;
            if (jornadaPorcentaje < 100) cellJornada.style.fontWeight = "bold";
            row.insertCell(3).textContent = objetivo.toFixed(1);
            const cellAsignadas = row.insertCell(4);
            cellAsignadas.textContent = asignadas;
            cellAsignadas.style.fontWeight = "bold";
            const cellDif = row.insertCell(5);
            cellDif.textContent = diferencia;
            const difAbs = Math.abs(parseFloat(diferencia));
            if (difAbs <= 0.5) {
              cellDif.style.backgroundColor = "#c8e6c9";
            } else if (difAbs <= 1.5) {
              cellDif.style.backgroundColor = "#fff9c4";
            } else {
              cellDif.style.backgroundColor = "#ffcdd2";
            }
            row.insertCell(6).textContent = avisos;
            row.insertCell(7).textContent = urgencias;
            const cellPorcAvisos = row.insertCell(8);
            cellPorcAvisos.textContent = `${porcAvisos}%`;
            const porcAvisosNum = parseInt(porcAvisos);
            if (
              porcAvisosNum >= MIN_PORCENTAJE_TIPO * 100 &&
              porcAvisosNum <= MAX_PORCENTAJE_TIPO * 100
            ) {
              cellPorcAvisos.style.backgroundColor = "#c8e6c9";
            } else {
              cellPorcAvisos.style.backgroundColor = "#fff9c4";
            }
            row.insertCell(9).textContent = lunes;
            row.insertCell(10).textContent = viernes;
            if (asignadas > maxAsignadas) maxAsignadas = asignadas;
            if (asignadas < minAsignadas) minAsignadas = asignadas;
          });
        // --- Mostrar Estad√≠sticas y An√°lisis Detallados ---
        const contenedorEstadisticas = document.getElementById(
          "estadisticasDetalladas"
        );
        contenedorEstadisticas.innerHTML = ""; // Limpiar contenido previo

        // An√°lisis de Equidad (como antes)
        const diferenciaTotal = maxAsignadas - minAsignadas;
        const analisisEquidad = document.createElement("p");
        analisisEquidad.innerHTML = `La diferencia m√°xima de guardias entre m√©dicos es de <strong>${diferenciaTotal}</strong>. `;
        if (diferenciaTotal <= MAX_DIFERENCIA_PERMITIDA) {
          analisisEquidad.innerHTML += `<span class="equidad-ok">‚úì EQUIDAD LOGRADA</span>`;
        } else {
          analisisEquidad.innerHTML += `<span class="equidad-ko">‚ö† Revisar distribuci√≥n</span>`;
        }
        contenedorEstadisticas.appendChild(analisisEquidad);

        // Nuevas estad√≠sticas
        const statsGrid = document.createElement("div");
        statsGrid.className = "stats-grid";

        // Tarjeta: Total de Guardias Asignadas
        const totalGuardias = Object.values(
          estado.resumenAsignacion.asignaciones
        ).reduce((sum, val) => sum + val, 0);
        const cardTotal = document.createElement("div");
        cardTotal.className = "stat-card";
        cardTotal.innerHTML = `
            <h4>Total Guardias Asignadas</h4>
            <div class="stat-value">${totalGuardias}</div>
            <small>Puestos totales disponibles: ${totalGuardias}</small>
        `;
        statsGrid.appendChild(cardTotal);

        // Tarjeta: Distribuci√≥n Avisos/Urgencias
        const totalAvisos = Object.values(
          estado.resumenAsignacion.avisos
        ).reduce((sum, val) => sum + val, 0);
        const totalUrgencias = Object.values(
          estado.resumenAsignacion.urgencias
        ).reduce((sum, val) => sum + val, 0);
        const cardTipo = document.createElement("div");
        cardTipo.className = "stat-card";
        cardTipo.innerHTML = `
            <h4>Distribuci√≥n por Tipo</h4>
            <div>Avisos: <span class="stat-value">${totalAvisos}</span></div>
            <div>Urgencias: <span class="stat-value">${totalUrgencias}</span></div>
            <small>Porcentaje Avisos: ${
              totalGuardias > 0
                ? ((totalAvisos / totalGuardias) * 100).toFixed(1)
                : "0.0"
            }%</small>
        `;
        statsGrid.appendChild(cardTipo);

        // Tarjeta: Lunes y Viernes
        const totalLunes = Object.values(estado.resumenAsignacion.lunes).reduce(
          (sum, val) => sum + val,
          0
        );
        const totalViernes = Object.values(
          estado.resumenAsignacion.viernes
        ).reduce((sum, val) => sum + val, 0);
        const cardLV = document.createElement("div");
        cardLV.className = "stat-card";
        cardLV.innerHTML = `
            <h4>Guardias Lunes/Viernes</h4>
            <div>Lunes: <span class="stat-value">${totalLunes}</span></div>
            <div>Viernes: <span class="stat-value">${totalViernes}</span></div>
            <small>Total L+V: ${totalLunes + totalViernes}</small>
        `;
        statsGrid.appendChild(cardLV);

        // Tarjeta: M√©dicos por Turno
        const medicosPorTurno = { MA√ëANA: 0, TARDE: 0, MIXTO: 0 };
        estado.medicos
          .filter((m) => m.activo)
          .forEach((m) => medicosPorTurno[m.turno]++);
        const cardTurnos = document.createElement("div");
        cardTurnos.className = "stat-card";
        cardTurnos.innerHTML = `
            <h4>M√©dicos Activos por Turno</h4>
            <div>Ma√±ana: <span class="stat-value">${medicosPorTurno.MA√ëANA}</span></div>
            <div>Tarde: <span class="stat-value">${medicosPorTurno.TARDE}</span></div>
            <div>Mixto: <span class="stat-value">${medicosPorTurno.MIXTO}</span></div>
        `;
        statsGrid.appendChild(cardTurnos);

        contenedorEstadisticas.appendChild(statsGrid);
      }

      // === INICIALIZACI√ìN ===
      document.addEventListener("DOMContentLoaded", function () {
        mostrarSeccion("configuracion");
        cargarDeMemoria(); // Cargar datos guardados si existen
        poblarSelects();
        actualizarTodasLasTablas();
        // Cargar par√°metros avanzados si existen
        if (estado.historico) {
          document.getElementById("factorCompensacion").value =
            (estado.historico.factorCompensacion || 0.5) * 100;
          document.getElementById("valorFactor").textContent = `${
            (estado.historico.factorCompensacion || 0.5) * 100
          }%`;
          document.getElementById("ventanaHistorico").value =
            estado.historico.ventanaHistorico || 6;

          actualizarTablaHistorico();
          actualizarResumenHistorico();
        }
        // === MEJORAS UX: SOPORTE PARA TECLA ENTER ===
        // Formulario de M√©dicos
        document
          .getElementById("nuevoMedicoNombre")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              agregarMedico();
            }
          });

        document
          .getElementById("nuevoMedicoTurno")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              agregarMedico();
            }
          });

        // Formulario de Festivos
        document
          .getElementById("nuevoFestivo")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              agregarFestivo();
            }
          });

        // Formulario de Reducciones
        document
          .getElementById("reduccionPorcentaje")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              guardarReduccion();
            }
          });

        // Formulario de Ausencias
        document
          .getElementById("ausenciaInicio")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              document.getElementById("ausenciaFin").focus();
            }
          });

        document
          .getElementById("ausenciaFin")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              agregarAusencia();
            }
          });

        // Formulario de Exclusiones Puntuales
        document
          .getElementById("exclPuntFecha")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              agregarExclusionPuntual();
            }
          });

        // Cargar configuraci√≥n del algoritmo si existe
        if (typeof cargarConfiguracionAlgoritmo === "function") {
          cargarConfiguracionAlgoritmo();
        }
        // === MEJORAS UX: VALIDACI√ìN VISUAL ===
        const inputNombre = document.getElementById("nuevoMedicoNombre");
        inputNombre.addEventListener("input", (e) => {
          const valor = e.target.value.trim().toUpperCase();
          const existe = estado.medicos.some((m) => m.nombre === valor);

          if (existe && valor !== "") {
            inputNombre.style.borderColor = "#dc3545";
            inputNombre.style.backgroundColor = "#fff5f5";

            if (
              !inputNombre.nextElementSibling?.classList.contains("error-msg")
            ) {
              const errorMsg = document.createElement("small");
              errorMsg.className = "error-msg";
              errorMsg.style.color = "#dc3545";
              errorMsg.textContent = "Este m√©dico ya existe";
              inputNombre.parentNode.appendChild(errorMsg);
            }
          } else {
            inputNombre.style.borderColor = "";
            inputNombre.style.backgroundColor = "";

            const errorMsg = inputNombre.parentNode.querySelector(".error-msg");
            if (errorMsg) errorMsg.remove();
          }
        });

        // Validaci√≥n de rangos de fechas
        const validarRangoFechas = () => {
          const inicio = document.getElementById("ausenciaInicio");
          const fin = document.getElementById("ausenciaFin");

          if (inicio.value && fin.value) {
            if (new Date(inicio.value) > new Date(fin.value)) {
              fin.style.borderColor = "#dc3545";
              if (!fin.nextElementSibling?.classList.contains("error-msg")) {
                const errorMsg = document.createElement("small");
                errorMsg.className = "error-msg";
                errorMsg.style.color = "#dc3545";
                errorMsg.textContent =
                  "La fecha fin debe ser posterior al inicio";
                fin.parentNode.appendChild(errorMsg);
              }
            } else {
              fin.style.borderColor = "#28a745";
              const errorMsg = fin.parentNode.querySelector(".error-msg");
              if (errorMsg) errorMsg.remove();
            }
          }
        };
        // === MEJORAS UX: ATAJOS DE TECLADO ===
        document.addEventListener("keydown", (e) => {
          // Solo activar si no estamos en un campo de entrada
          if (
            document.activeElement.tagName === "INPUT" ||
            document.activeElement.tagName === "TEXTAREA" ||
            document.activeElement.tagName === "SELECT"
          ) {
            return;
          }

          // Alt + M: Ir a secci√≥n M√©dicos
          if (e.altKey && e.key === "m") {
            e.preventDefault();
            mostrarSeccion("configuracion");
            const primerTab = document.querySelector(".tab-button");
            abrirTab({ currentTarget: primerTab }, "tabMedicos");
          }

          // Alt + C: Ir a Calendario
          if (e.altKey && e.key === "c") {
            e.preventDefault();
            mostrarSeccion("calendario");
          }

          // Alt + G: Generar guardias (si estamos en calendario)
          if (e.altKey && e.key === "g") {
            e.preventDefault();
            const seccionActual = document.querySelector(
              '.seccion:not([style*="display: none"])'
            );
            if (seccionActual?.id === "calendario") {
              generarGuardias();
            }
          }

          // Alt + S: Guardar configuraci√≥n
          if (e.altKey && e.key === "s") {
            e.preventDefault();
            guardarEnMemoria();
            mostrarToast("Configuraci√≥n guardada (Alt+S)");
          }

          // Alt + H: Mostrar ayuda/manual
          if (e.altKey && e.key === "h") {
            e.preventDefault();
            mostrarSeccion("manual");
          }
        });

        // A√±adir tooltips con los atajos
        const tooltips = [
          { selector: 'a[onclick*="configuracion"]', atajo: "Alt+M" },
          { selector: 'a[onclick*="calendario"]', atajo: "Alt+C" },
          { selector: 'a[onclick*="manual"]', atajo: "Alt+H" },
          { selector: 'button[onclick="generarGuardias()"]', atajo: "Alt+G" },
          { selector: 'button[onclick="guardarEnMemoria()"]', atajo: "Alt+S" },
        ];

        tooltips.forEach(({ selector, atajo }) => {
          const elemento = document.querySelector(selector);
          if (elemento) {
            elemento.title = `${elemento.textContent} (${atajo})`;
          }
        });
        document
          .getElementById("ausenciaInicio")
          .addEventListener("change", validarRangoFechas);
        document
          .getElementById("ausenciaFin")
          .addEventListener("change", validarRangoFechas);
      });
    </script>
  </body>
</html>
