<!--
=====================
  retirada-antidepresivos.html
  P√°gina con herramienta de  ayuda para la retirada de antidepresivos
=====================
-->

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- SEO Meta Tags -->
    <meta
      name="description"
      content="Gu√≠a visual interactiva para la retirada segura de antidepresivos basada en evidencia cient√≠fica. Herramienta para profesionales sanitarios."
    />
    <meta name="author" content="Ernesto Barrera" />
    <link rel="icon" href="assets/images/icon.webp" />
    <title>Gu√≠a Visual: Retirada Segura de Antidepresivos | @ernestob</title>

    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="article" />
    <meta
      property="og:title"
      content="Gu√≠a Visual para la Retirada Segura de Antidepresivos | @ernestob"
    />
    <meta
      property="og:site_name"
      content="Herramientas cl√≠nicas para profesionales sanitarios"
    />
    <meta
      property="og:url"
      content="https://ernestobarrera.github.io/guia-retirada-antidepresivos.html"
    />
    <meta
      property="og:image"
      content="https://ernestobarrera.github.io/assets/images/me.png"
    />

    <!-- CSS Base para header/footer -->
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/header.css" />
    <link rel="stylesheet" href="assets/css/footer.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- CSS externo -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css"
    />

    <!-- Scripts para la herramienta -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Estilos espec√≠ficos de la herramienta - manteniendo el dise√±o original -->
    <style>
      :root {
        --c-primary: #0ea5e9; /* sky-500 */
        --c-primary-dark: #0369a1; /* sky-700 */
        --c-warn: #fbbf24; /* amber-500 */
        --c-error: #dc2626; /* red-600 */
        --c-bg: #f8fafc; /* slate-50 */
      }
      :root {
        --toc-width: 220px; /* cambia aqu√≠ y se ajusta todo */
      }

      body {
        font-size: 1rem;
      } /* 16 px base */
      h1 {
        font-size: 2.25rem;
        line-height: 1.2;
      } /* 36 px */
      h2 {
        font-size: 1.5rem;
        line-height: 1.3;
      } /* 24 px */
      h3 {
        font-size: 1.125rem;
      } /* 18 px */
      .text-sm {
        font-size: 0.875rem;
      } /* 14 px - era 12 */

      /* Override del tema oscuro para esta p√°gina espec√≠fica */
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--c-bg) !important;
        color: #102a43 !important;
        margin: 0;
        padding: 0;
      }

      /* Contenedor principal adaptado */
      .clinical-main-container {
        max-width: 1400px;
        margin-left: auto;
        margin-right: auto;
        padding: 0.5rem 0.5rem;
        margin-top: calc(var(--header-height) + 0.5rem);
        margin-bottom: 1.5rem;
      }

      /* Estilos espec√≠ficos de la herramienta */
      .chart-container {
        position: relative;
        width: 100%;
        max-width: 900px; /* <-- nuevo */

        margin-left: auto;
        margin-right: auto;
        height: 280px;
        max-height: 350px;
      }

      @media (min-width: 768px) {
        .chart-container {
          height: 320px;
        }
      }

      .flowchart-step {
        border: 2px solid var(--c-primary);
        background-color: white;
        padding: 0.75rem;
        border-radius: 0.5rem;
        text-align: center;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        flex-grow: 1;
        position: relative;
        padding-top: 2.5rem; /* espacio para badge */
      }
      .flowchart-step::before {
        content: attr(data-step);
        position: absolute;
        top: -15px;
        left: 50%;
        transform: translateX(-50%);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--c-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      .flowchart-arrow {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: var(--c-primary);
        margin: 0.25rem 0;
        transform: rotate(90deg);
      }

      @media (min-width: 1024px) {
        .flowchart-arrow {
          transform: rotate(0deg);
          margin: 0 0.75rem;
        }
      }

      .export-btn:disabled {
        background-color: #94a3b8;
        cursor: not-allowed;
      }

      .reference-link {
        color: #3b82f6;
        text-decoration: underline;
      }

      .reference-link:hover {
        color: #1d4ed8;
      }

      /* Hero section con el estilo original */
      .hero-section {
        border-radius: 8px;
        padding: 0rem;
        margin-bottom: 0.1rem;
      }

      .intro-text {
        font-size: 1rem;
        line-height: 1.4;
        background: rgba(59, 130, 246, 0.15);
        border-radius: 6px;
        padding: 0.75rem;
        color: #64748b;
        margin-bottom: 1rem;
      }

      .main-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.75rem;
        color: var(--c-primary-dark);
      }

      /* Estilos para secciones de atenci√≥n y emergencia */

      .attention-section {
        background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
        border-left: 4px solid var(--c-warn); /* amber-500 */
      }

      .emergency-section {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-left: 4px solid var(--c-error); /* red-600 */
      }

      /* Optimizaci√≥n de tabla */
      .differential-table {
        min-width: 100%;
      }

      .differential-table th:first-child,
      .differential-table td:first-child {
        width: 20%;
        min-width: 120px;
      }

      .differential-table th:nth-child(2),
      .differential-table td:nth-child(2),
      .differential-table th:nth-child(3),
      .differential-table td:nth-child(3) {
        width: 40%;
      }

      @media (max-width: 768px) {
        .clinical-main-container {
          width: 99%;
          padding: 0 0.75rem;
          margin-top: calc(var(--header-height) + 0.5rem);
        }
      }
      .toc-link {
        display: block;
        padding: 0.4rem 0.5rem;
        border-left: 3px solid transparent;
      }
      .toc-link.active {
        font-weight: 600;
        border-color: var(--c-primary);
      }
      /* ===================  TOC fijo a la izquierda  =================== */
      /* ===== TOC fijo lateral ===== */
      #toc {
        position: fixed;
        top: calc(var(--header-height) + 1rem);
        left: 0;
        width: var(--toc-width);
        padding: 0.5rem 1rem;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(4px);
        z-index: 40;
        display: none; /* se muestra en ‚â•lg */
      }

      @media (min-width: 1024px) {
        #toc {
          display: block;
        }
        /* ‚¨á desplaza TODO el contenido para que no quede debajo */
        .clinical-main-container {
          margin-left: calc(var(--toc-width) + 1rem);
        }
      }

      .toc-link {
        display: block;
        padding: 0.35rem 0.25rem;
        white-space: nowrap;
        border-left: 3px solid transparent;
        transition: border-color 0.2s, font-weight 0.2s;
      }

      .toc-link:hover {
        border-color: var(--c-primary);
      }

      .toc-link.active {
        font-weight: 600;
        border-color: var(--c-primary);
      }
      .bibliografia {
        background: rgba(14, 165, 233, 0.05); /* azul muy tenue */
        border-left: 4px solid var(--c-primary);
        padding: 0.75rem 1rem;
        margin-top: 1rem;
      }
    </style>
  </head>

  <body class="antialiased">
    <script src="/assets/js/include.js"></script>
    <include src="header.html"></include>
    <aside id="toc">
      <a href="#section4" class="toc-link">Calculadora</a>
      <a href="#section1" class="toc-link">Problema</a>
      <a href="#section2" class="toc-link">Curva</a>
      <a href="#section3" class="toc-link">Proceso</a>
      <a href="#section5" class="toc-link">Recaida vs Abstinencia</a>
      <a href="#section6" class="toc-link">Efectos</a>
      <a href="#section7" class="toc-link">üö® Cu√°ndo Contactar</a>
      <a href="#section8" class="toc-link">Bibliograf√≠a</a>
    </aside>

    <div class="clinical-main-container">
      <header class="text-center mb-8">
        <h1
          class="text-3xl md:text-4xl font-bold text-sky-800 mb-3 leading-tight"
        >
          Gu√≠a Visual para la Retirada Segura de Antidepresivos
        </h1>
        <p class="text-base text-slate-600 max-w-4xl mx-auto mb-3">
          Un enfoque pr√°ctico basado en evidencia para minimizar el s√≠ndrome de
          abstinencia en el contexto cl√≠nico.
        </p>
        <div
          class="attention-section text-amber-800 py-2 px-4 rounded-md max-w-4xl mx-auto text-sm"
          role="alert"
        >
          <p>
            <strong>Atenci√≥n:</strong> Herramienta exclusivamente dise√±ada para
            profesionales sanitarios.
          </p>
        </div>
      </header>

      <section id="section4" class="bg-white rounded-lg shadow-lg p-6 md:p-7">
        <h2 class="text-2xl font-bold text-center mb-5 text-sky-700">
          Calculadora de Pauta de Reducci√≥n Hiperb√≥lica
        </h2>
        <div id="calculator" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-slate-50 p-5 rounded-lg border border-slate-200">
            <h3 class="font-bold text-lg mb-3 text-sky-800">
              1. Introducir Datos del F√°rmaco
            </h3>
            <div class="space-y-3">
              <div>
                <label
                  for="drug"
                  class="block text-sm font-medium text-slate-700"
                  >F√°rmaco</label
                >
                <select
                  id="drug"
                  name="drug"
                  class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                >
                  <option value="Sertralina">Sertralina</option>
                  <option value="Citalopram">Citalopram</option>
                  <option value="Escitalopram">Escitalopram</option>
                  <option value="Paroxetina">Paroxetina</option>
                  <option value="Fluoxetina">Fluoxetina</option>
                  <option value="Venlafaxina">Venlafaxina</option>
                </select>
                <label
                  for="presentation"
                  class="block text-sm font-medium text-slate-700 mt-3"
                >
                  Presentaci√≥n inicial
                </label>
                <select
                  id="presentation"
                  name="presentation"
                  class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                ></select>
              </div>
              <div>
                <label
                  for="currentDose"
                  class="block text-sm font-medium text-slate-700"
                  >Dosis Actual (mg)</label
                >
                <input
                  type="number"
                  id="currentDose"
                  value="100"
                  class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                />
              </div>
              <div>
                <label
                  for="reductionPercentage"
                  class="block text-sm font-medium text-slate-700"
                  >Reducci√≥n por Paso (%)</label
                >
                <input
                  type="number"
                  id="reductionPercentage"
                  value="10"
                  min="1"
                  max="50"
                  class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                />
              </div>
              <div class="flex gap-2">
                <button
                  id="calculateBtn"
                  class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500"
                >
                  Calcular Pauta
                </button>
                <button
                  id="calculateSlowBtn"
                  class="w-full bg-sky-200 text-sky-800 font-bold py-2 px-4 rounded-md hover:bg-sky-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500"
                >
                  Pauta Lenta (5%)
                </button>
              </div>
            </div>
          </div>
          <div
            class="bg-slate-50 p-5 rounded-lg border border-slate-200 flex flex-col"
          >
            <h3 class="font-bold text-lg mb-3 text-sky-800">
              2. Pauta de Reducci√≥n Sugerida
            </h3>
            <div id="taperingSchedule" class="overflow-auto max-h-80 flex-grow">
              <p class="text-slate-500 text-sm">
                Introduzca los datos y haga clic en "Calcular Pauta" para ver el
                resultado.
              </p>
            </div>
            <div id="exportButtons" class="mt-3 flex gap-3">
              <button
                id="copyBtn"
                disabled
                class="export-btn flex-1 bg-indigo-600 text-white font-bold py-2 px-3 text-sm rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              >
                Copiar para resumen cl√≠nico
              </button>
              <button
                id="pdfBtn"
                disabled
                class="export-btn flex-1 bg-teal-600 text-white font-bold py-2 px-3 text-sm rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500"
              >
                Generar PDF
              </button>
            </div>
          </div>
        </div>
        <div
          class="mt-6 bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-3 rounded-md"
          role="alert"
        >
          <p class="font-bold text-base">Nota sobre el Uso de Formulaciones</p>
          <p class="mt-2 text-sm">
            Para realizar una reducci√≥n de dosis precisa y segura, las
            <span class="font-semibold">soluciones orales comerciales</span>
            son siempre la primera opci√≥n. La preparaci√≥n de suspensiones a
            partir de comprimidos o c√°psulas es una pr√°ctica "off-label" que
            debe considerarse √∫nicamente como una
            <span class="font-semibold">alternativa secundaria</span> cuando no
            existen preparados comerciales adecuados. Su implementaci√≥n debe ser
            una decisi√≥n consensuada entre el profesional sanitario y el
            paciente.
          </p>
        </div>
        <div
          class="mt-4 emergency-section text-red-700 p-3 rounded-md"
          role="alert"
        >
          <h3 class="font-bold text-base" style="color: var(--c-primary-dark)">
            Advertencias Cl√≠nicas Esenciales
          </h3>
          <ul class="list-disc list-inside mt-2 space-y-1 text-sm">
            <li>
              <span class="font-semibold">NUNCA</span> utilice la dosificaci√≥n
              en d√≠as alternos. Provoca fluctuaciones dr√°sticas en los niveles
              del f√°rmaco.
            </li>
            <li>
              Las dosis finales antes de suspender deben ser
              <span class="font-semibold">muy peque√±as</span> (ej. 0.5 - 2 mg)
              para evitar una ca√≠da brusca.
            </li>
            <li>
              El proceso de retirada puede ser largo, durando
              <span class="font-semibold">meses o incluso m√°s de un a√±o</span>.
            </li>
            <li>
              Las suspensiones preparadas artesanalmente deben
              <span class="font-semibold">elaborarse cada d√≠a</span> para
              garantizar su estabilidad y seguridad.
            </li>
          </ul>
          <h4
            class="font-bold text-sm mt-3"
            style="color: var(--c-primary-dark)"
          >
            Consideraciones Adicionales:
          </h4>
          <ul class="list-disc list-inside mt-2 space-y-1 text-sm">
            <li>
              La velocidad de reducci√≥n puede requerir ajustes individuales
              seg√∫n tolerancia.
            </li>
            <li>
              Las formulaciones l√≠quidas comerciales o de farmacia comunitaria
              son preferibles a las suspensiones caseras siempre que est√©n
              disponibles.
            </li>
            <li>
              Algunos pacientes pueden necesitar reducciones m√°s lentas (5% o
              menos por paso).
            </li>
            <li>
              El proceso puede extenderse m√°s all√° de los pasos mostrados si es
              necesario.
            </li>
            <li>
              Para dosis finales muy peque√±as (&lt;5mg), se requiere supervisi√≥n
              especial.
            </li>
          </ul>
        </div>
      </section>
      <main class="space-y-12">
        <section id="section1" class="bg-white rounded-lg shadow-lg p-6 md:p-7">
          <h2 class="text-2xl font-bold text-center mb-5 text-sky-700">
            El Problema Oculto: La Abstinencia es Com√∫n y Severa
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
            <div class="chart-container mx-auto">
              <canvas id="prevalenceChart"></canvas>
            </div>
            <div>
              <p class="text-base mb-3 text-slate-700">
                Al contrario de lo que se pensaba, el s√≠ndrome de abstinencia de
                antidepresivos no es raro. La evidencia actual muestra que
                aproximadamente la mitad de los pacientes que intentan dejar la
                medicaci√≥n experimentar√°n s√≠ntomas, que pueden ser graves y
                prolongados durante meses o incluso a√±os.
              </p>
              <div
                class="flex items-center bg-amber-100 border-l-4 border-amber-500 text-amber-700 p-3 rounded-md"
              >
                <span class="text-4xl font-bold mr-3">~50%</span>
                <p class="text-sm">
                  de los pacientes sufren s√≠ntomas de abstinencia, a menudo mal
                  diagnosticados como una reca√≠da de su condici√≥n original.
                </p>
              </div>
            </div>
          </div>
        </section>

        <section id="section2" class="bg-white rounded-lg shadow-lg p-6 md:p-7">
          <h2 class="text-2xl font-bold text-center mb-2 text-sky-700">
            Por Qu√© Falla la Pauta Lineal: La Curva Hiperb√≥lica
          </h2>
          <p class="text-center text-slate-600 mb-5 max-w-4xl mx-auto text-sm">
            El error m√°s com√∫n es reducir la dosis de forma lineal. Esto ignora
            la relaci√≥n hiperb√≥lica entre la dosis de un ISRS y su efecto en los
            receptores de serotonina (SERT). A dosis bajas, peque√±os recortes
            provocan ca√≠das masivas en el efecto, desencadenando la abstinencia.
          </p>
          <div class="chart-container mx-auto">
            <canvas id="hyperbolicChart"></canvas>
          </div>
          <p class="text-center text-sm text-slate-500 mt-3">
            <strong>C√≥mo leer la figura:</strong>
            Cada punto de la curva azul indica la ocupaci√≥n de SERT a esa
            dosis.<br />
            Los recortes lineales <em>(20 ‚Üí 10 mg, 10 ‚Üí 0 mg)</em> bajan la
            ocupaci√≥n ‚àí13 y ‚àí58 p.p. respectivamente.<br />
            Con recortes <em>hiperb√≥licos</em> (verde) la ca√≠da se mantiene casi
            constante (~5‚Äì10 p.p.), lo que reduce el riesgo de abstinencia.
          </p>
        </section>

        <section
          id="section3"
          class="bg-slate-50 rounded-lg shadow-inner p-6 md:p-7"
        >
          <h2 class="text-2xl font-bold text-center mb-5 text-sky-700">
            La Soluci√≥n: Proceso de Reducci√≥n Hiperb√≥lica
          </h2>
          <p class="text-center text-slate-600 mb-6 max-w-4xl mx-auto text-sm">
            El proceso debe ser gradual, flexible y colaborativo, adapt√°ndose
            siempre a la respuesta individual del paciente. Puede durar meses o
            m√°s de un a√±o.
          </p>
          <div
            class="flex flex-col lg:flex-row justify-center items-stretch gap-3"
          >
            <div class="flowchart-step" data-step="1">
              <h3 class="font-bold text-base text-indigo-700 mb-2">
                1. Di√°logo y Planificaci√≥n
              </h3>
              <p class="text-sm text-slate-600">
                Explicar el proceso hiperb√≥lico y acordar un plan inicial.
                Informar sobre s√≠ntomas para no confundir con reca√≠da.
              </p>
            </div>
            <div class="flowchart-arrow">‚ûú</div>
            <div class="flowchart-step" data-step="2">
              <h3 class="font-bold text-base text-indigo-700 mb-2">
                2. Reducir y Esperar
              </h3>
              <p class="text-sm text-slate-600">
                Realizar una peque√±a reducci√≥n porcentual (ej. 10% de la dosis
                actual). Esperar 2-4 semanas para estabilizar y evaluar.
              </p>
            </div>
            <div class="flowchart-arrow">‚ûú</div>
            <div class="flowchart-step" data-step="3">
              <h3 class="font-bold text-base text-indigo-700 mb-2">
                3. Evaluar Tolerancia
              </h3>
              <p class="text-sm text-slate-600">
                Si los s√≠ntomas son tolerables, proceder a la siguiente
                reducci√≥n. Si no, pausar o volver a la dosis anterior.
              </p>
            </div>
            <div class="flowchart-arrow">‚ûú</div>
            <div class="flowchart-step" data-step="4">
              <h3 class="font-bold text-base text-indigo-700 mb-2">
                4. Repetir hasta Dosis M√≠nima
              </h3>
              <p class="text-sm text-slate-600">
                Continuar el ciclo de "reducir-esperar-evaluar". Las reducciones
                ser√°n cada vez m√°s peque√±as en mg.
              </p>
            </div>
          </div>
        </section>

        <section id="section5" class="bg-white rounded-lg shadow-lg p-6 md:p-7">
          <h2 class="text-2xl font-bold text-center mb-5 text-sky-700">
            ¬øAbstinencia o Reca√≠da? Gu√≠a de Diagn√≥stico Diferencial
          </h2>
          <p class="text-center text-slate-600 mb-6 max-w-4xl mx-auto text-sm">
            Distinguir entre el s√≠ndrome de abstinencia y una reca√≠da es crucial
            para evitar la medicalizaci√≥n innecesaria a largo plazo. La clave
            est√° en el momento de aparici√≥n y en la naturaleza de los s√≠ntomas.
          </p>
          <div class="w-full">
            <table class="differential-table w-full text-left border-collapse">
              <thead>
                <tr class="bg-sky-100">
                  <th
                    class="p-3 border-b-2 border-sky-200 font-bold text-sky-800 text-sm"
                  >
                    Caracter√≠stica
                  </th>
                  <th
                    class="p-3 border-b-2 border-sky-200 font-bold text-sky-800 text-sm"
                  >
                    S√≠ndrome de Abstinencia
                  </th>
                  <th
                    class="p-3 border-b-2 border-sky-200 font-bold text-sky-800 text-sm"
                  >
                    Reca√≠da de la Depresi√≥n
                  </th>
                </tr>
              </thead>
              <tbody class="text-slate-700">
                <tr class="hover:bg-slate-50">
                  <td
                    class="p-3 border-b border-slate-200 font-semibold text-sm"
                  >
                    Inicio
                  </td>
                  <td class="p-3 border-b border-slate-200 text-sm">
                    R√°pido (d√≠as-semanas tras reducir dosis) o
                    <span class="font-bold">retardado</span> (hasta 4 meses
                    despu√©s, esp. con fluoxetina).
                  </td>
                  <td class="p-3 border-b border-slate-200 text-sm">
                    Generalmente m√°s gradual y tard√≠o, semanas o meses despu√©s
                    de la suspensi√≥n.
                  </td>
                </tr>
                <tr class="hover:bg-slate-50">
                  <td
                    class="p-3 border-b border-slate-200 font-semibold text-sm"
                  >
                    S√≠ntomas
                  </td>
                  <td class="p-3 border-b border-slate-200 text-sm">
                    Aparecen
                    <span class="font-bold">nuevos s√≠ntomas f√≠sicos</span>:
                    mareos, "brain zaps", n√°useas, parestesias.
                  </td>
                  <td class="p-3 border-b border-slate-200 text-sm">
                    Predominan los s√≠ntomas an√≠micos originales: tristeza,
                    anhedonia.
                  </td>
                </tr>
                <tr class="hover:bg-slate-50">
                  <td
                    class="p-3 border-b border-slate-200 font-semibold text-sm"
                  >
                    Respuesta al F√°rmaco
                  </td>
                  <td class="p-3 border-b border-slate-200 text-sm">
                    Mejora <span class="font-bold">r√°pidamente</span> al
                    reinstaurar la dosis previa.
                  </td>
                  <td class="p-3 border-b border-slate-200 text-sm">
                    Mejora lentamente (semanas) al reinstaurar la medicaci√≥n.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <section id="section6" class="bg-white rounded-lg shadow-lg p-6 md:p-7">
          <h2 class="text-2xl font-bold text-center mb-5 text-sky-700">
            Efectos Adversos Comunes que Motivan la Retirada
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
            <div>
              <p class="text-base mb-3 text-slate-700">
                Muchos pacientes desean dejar los antidepresivos debido a
                efectos adversos que afectan su calidad de vida. La disfunci√≥n
                sexual y el embotamiento emocional son dos de las quejas m√°s
                frecuentes, y su prevalencia es significativamente alta.
              </p>
              <ul
                class="list-disc list-inside space-y-1 text-slate-600 text-sm"
              >
                <li>
                  El <span class="font-bold">embotamiento emocional</span> se
                  describe como una incapacidad para sentir emociones, tanto
                  positivas como negativas.
                </li>
                <li>
                  La <span class="font-bold">disfunci√≥n sexual</span> puede
                  incluir p√©rdida de la libido, anorgasmia o disfunci√≥n er√©ctil.
                </li>
              </ul>
            </div>
            <div class="chart-container mx-auto">
              <canvas id="sideEffectsChart"></canvas>
            </div>
          </div>
        </section>

        <section id="section7" class="emergency-section rounded-lg p-5 md:p-6">
          <h2 class="text-2xl font-bold text-center mb-5 text-rose-700">
            üö® Cu√°ndo Contactar con el M√©dico
          </h2>
          <p class="text-center text-red-600 mb-6 max-w-4xl mx-auto text-sm">
            El proceso de retirada debe ser supervisado. Contacte con su
            profesional sanitario sin demora si experimenta cualquiera de los
            siguientes s√≠ntomas:
          </p>
          <ul
            class="grid grid-cols-1 md:grid-cols-2 gap-3 text-red-800 list-disc list-inside text-sm"
          >
            <li>
              S√≠ntomas graves de abstinencia (mareos intensos, "descargas
              cerebrales" severas).
            </li>
            <li>Pensamientos de autolesi√≥n o suicidio.</li>
            <li>
              S√≠ntomas que no mejoran tras 1-2 semanas manteniendo la misma
              dosis.
            </li>
            <li>Incapacidad para realizar actividades diarias normales.</li>
            <li>
              S√≠ntomas f√≠sicos preocupantes (palpitaciones, temblores severos).
            </li>
          </ul>
        </section>
      </main>

      <footer
        class="text-center mt-12 pt-6 border-t border-slate-300 text-sm text-slate-600"
      >
        <div class="max-w-1xl mx-auto" style="text-align: left">
          <p class="mb-3">
            Esta infograf√≠a se fundamenta en las evidencias cient√≠ficas sobre
            reducci√≥n hiperb√≥lica de antidepresivos, especialmente el trabajo
            pionero de Horowitz & Taylor (2019)¬π, validado posteriormente por
            estudios prospectivos en m√°s de 3,900 pacientes (van Os & Groot,
            2023)¬≤ y oficialmente adoptado por las gu√≠as NICE (NG222, 2022)¬≥. La
            herramienta tiene fines educativos para facilitar la comunicaci√≥n
            cl√≠nico-paciente y no sustituye el juicio cl√≠nico individualizado ni
            la supervisi√≥n m√©dica obligatoria durante todo el proceso de
            reducci√≥n.
          </p>

          <aside id="section8" class="bibliografia">
            <h4 class="font-bold text-sm text-slate-700 mb-2">
              Referencias Bibliogr√°ficas Fundamentales
            </h4>
            <ol class="list-decimal list-inside text-left text-sm space-y-1">
              <ol class="list-decimal list-inside text-left text-sm space-y-1">
                <li>
                  Horowitz MA, Taylor D. Tapering of SSRI treatment to mitigate
                  withdrawal symptoms. <i>Lancet Psychiatry</i>.
                  2019;6(6):538-546. doi:10.1016/S2215-0366(19)30032-X.
                  <a
                    href="https://www.thelancet.com/journals/lanpsy/article/PIIS2215-0366(19)30032-X/fulltext"
                    target="_blank"
                    class="reference-link"
                    >Ver art√≠culo</a
                  >
                </li>
                <li>
                  van Os J, Groot PC. Outcomes of hyperbolic tapering of
                  antidepressants.
                  <i>Therapeutic Advances in Psychopharmacology</i>.
                  2023;13:20451253231171518. doi:10.1177/20451253231171518.
                  <a
                    href="https://journals.sagepub.com/doi/10.1177/20451253231171518"
                    target="_blank"
                    class="reference-link"
                    >Ver art√≠culo</a
                  >
                </li>
                <li>
                  National Institute for Health and Care Excellence. Depression
                  in adults: treatment and management. NICE guideline NG222.
                  London: NICE; 2022.
                  <a
                    href="https://www.nice.org.uk/guidance/ng222"
                    target="_blank"
                    class="reference-link"
                    >Ver gu√≠a</a
                  >
                </li>
                <li>
                  Horowitz M, Taylor D. Case-based learning: safe withdrawal and
                  tapering of antidepressants. <i>Pharm J</i>. 2023;311(7977).
                  doi:10.1211/PJ.2023.1.196471.
                  <a
                    href="https://pharmaceutical-journal.com/article/ld/case-based-learning-safe-withdrawal-and-tapering-of-antidepressants"
                    target="_blank"
                    class="reference-link"
                    >Ver art√≠culo</a
                  >
                </li>
              </ol>
            </ol>
          </aside>
          <div class="my-4">
            <h4 class="font-bold text-sm text-slate-700 mb-2">
              Limitaciones y Responsabilidades
            </h4>
            <p class="text-sm">
              Esta pauta es orientativa, y se presenta solo con finalidad
              educativa. Su uso es responsabilidad del profesional sanitario con
              formaci√≥n y juicio cl√≠nico, quien debe adaptar cada caso
              individualmente. No todos los pacientes toleran la misma velocidad
              de reducci√≥n. Las suspensiones caseras tienen limitaciones de
              precisi√≥n y estabilidad. La supervisi√≥n m√©dica es obligatoria
              durante todo el proceso.
            </p>
          </div>
        </div>
      </footer>
    </div>

    <include src="footer.html"></include>
    <script src="/assets/js/utils.js"></script>

    <!-- Google Analytics -->
    <!--   <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-YFKR6RB1ZC"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-YFKR6RB1ZC");
    </script> -->

    <!-- JavaScript funcional de la herramienta -->
    <script>
      const { jsPDF } = window.jspdf;

      let lastCalculatedSchedule = [];
      let lastCalculatedDrug = "";
      let lastCalculatedInitialDose = 0;

      const wrapLabel = (str, maxWidth) => {
        if (str.length <= maxWidth) {
          return str;
        }
        const words = str.split(" ");
        let lines = [];
        let currentLine = words[0];
        for (let i = 1; i < words.length; i++) {
          if ((currentLine + " " + words[i]).length > maxWidth) {
            lines.push(currentLine);
            currentLine = words[i];
          } else {
            currentLine += " " + words[i];
          }
        }
        lines.push(currentLine);
        return lines;
      };

      const tooltipTitleCallback = (tooltipItems) => {
        const item = tooltipItems[0];
        let label = item.chart.data.labels[item.dataIndex];
        return Array.isArray(label) ? label.join(" ") : label;
      };

      const defaultChartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "top",
          },
          tooltip: {
            callbacks: {
              title: tooltipTitleCallback,
            },
          },
        },
      };

      // Inicializar cuando la p√°gina se carga
      document.addEventListener("DOMContentLoaded", function () {
        initializeCharts();
        initializeCalculator();
      });

      function initializeCharts() {
        // registra el plugin chartjs-plugin-annotation (necesario una vez)
        if (window["chartjs-plugin-annotation"]) {
          if (typeof ChartAnnotation !== "undefined") {
            Chart.register(ChartAnnotation);
          }
        }

        const prevalenceCtx = document.getElementById("prevalenceChart");
        if (prevalenceCtx) {
          new Chart(prevalenceCtx, {
            type: "doughnut",
            data: {
              labels: [
                "Pacientes con S√≠ntomas de Abstinencia",
                "Pacientes sin S√≠ntomas de Abstinencia",
              ],
              datasets: [
                {
                  label: "Prevalencia de S√≠ntomas de Abstinencia",
                  data: [50, 50],
                  backgroundColor: ["#3366CC", "#D6EAF8"],
                  borderColor: ["#FFFFFF"],
                  borderWidth: 2,
                },
              ],
            },
            options: {
              ...defaultChartOptions,
              cutout: "60%",
            },
          });
        }

        const hyperbolicCtx = document.getElementById("hyperbolicChart");
        if (hyperbolicCtx) {
          const hyperbolicData = Array.from(
            { length: 41 },
            (_, i) => 85 * (i / (15 + i))
          );
          new Chart(hyperbolicCtx, {
            type: "line",
            data: {
              labels: Array.from({ length: 41 }, (_, i) => i.toString()),
              datasets: [
                {
                  label: "Ocupaci√≥n de SERT (%)",
                  data: hyperbolicData,
                  borderColor: "#3366CC",
                  backgroundColor: "rgba(51,102,204,0.05)",
                  fill: true,

                  tension: 0.4,
                  pointRadius: 0,
                },
                {
                  label: "Reducci√≥n Lineal",
                  data: [
                    { x: 20, y: hyperbolicData[20] },
                    { x: 10, y: hyperbolicData[10] },
                    { x: 0, y: hyperbolicData[0] },
                  ],
                  borderColor: "#E53E3E",
                  borderDash: [6, 4],

                  backgroundColor: "#E53E3E",
                  pointRadius: 4,
                  pointHoverRadius: 8,
                  type: "line",
                },
                {
                  label: "Reducci√≥n Hiperb√≥lica (Ejemplo)",
                  data: [
                    { x: 20, y: hyperbolicData[20] },
                    { x: 18, y: hyperbolicData[18] },
                    { x: 16, y: hyperbolicData[16] },
                    { x: 14, y: hyperbolicData[14] },
                    { x: 12, y: hyperbolicData[12] },
                    { x: 10, y: hyperbolicData[10] },
                    { x: 8, y: hyperbolicData[8] },
                    { x: 6, y: hyperbolicData[6] },
                    { x: 4, y: hyperbolicData[4] },
                    { x: 2, y: hyperbolicData[2] },
                    { x: 1, y: hyperbolicData[1] },
                    { x: 0.5, y: hyperbolicData[0.5] || 0 },
                  ],
                  borderColor: "#38A169",
                  backgroundColor: "#38A169",
                  pointRadius: 4,
                  type: "line",
                },
              ],
            },
            options: {
              // hereda responsive, legend y tooltip de tus opciones base
              ...defaultChartOptions,

              plugins: {
                ...defaultChartOptions.plugins,

                // === sombreado 70-100 % ===
                annotations: {
                  riesgo_alto: {
                    type: "box",
                    yMin: 0,
                    yMax: 25,
                    backgroundColor: "rgba(229,62,62,0.15)",
                    borderWidth: 0,
                    label: {
                      display: true,
                      content: "Riesgo\nALTO",
                      color: "#7f1d1d",
                      font: { weight: "bold" },
                      position: "center",
                    },
                  },
                  riesgo_moderado: {
                    type: "box",
                    yMin: 25,
                    yMax: 50,
                    backgroundColor: "rgba(250,204,21,0.10)",
                    borderWidth: 0,
                    label: {
                      display: true,
                      content: "Riesgo\nModerado",
                      color: "#92400e",
                      font: { weight: "bold" },
                      position: "center",
                    },
                  },
                },
              },

              scales: {
                x: {
                  title: { display: true, text: "Dosis de ISRS (mg)" },
                },
                y: {
                  title: {
                    display: true,
                    text: "Ocupaci√≥n de Receptores SERT (%)",
                  },
                  beginAtZero: true,
                  max: 100, // ‚Üê imprescindible para que se vea la franja
                },
              },
            },
          });
        }

        const sideEffectsCtx = document.getElementById("sideEffectsChart");
        if (sideEffectsCtx) {
          new Chart(sideEffectsCtx, {
            type: "bar",
            data: {
              labels: [
                wrapLabel("Disfunci√≥n Sexual", 16),
                wrapLabel("Embotamiento Emocional", 16),
              ],
              datasets: [
                {
                  label: "Prevalencia de Efectos Adversos (%)",
                  data: [52.5, 50],
                  backgroundColor: ["#4BC0C0", "#0ea5e9"],
                  borderColor: ["#4BC0C0", "#0ea5e9"],
                  borderColor: ["#4BC0C0", "var(--c-primary)"],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              ...defaultChartOptions,
              indexAxis: "y",
              scales: {
                x: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    callback: function (value) {
                      return value + "%";
                    },
                  },
                },
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      if (context.label.includes("Sexual")) {
                        return "Prevalencia: 25-80% (media 52.5%)";
                      }
                      return "Prevalencia: ~" + context.raw + "%";
                    },
                    title: tooltipTitleCallback,
                  },
                },
              },
            },
          });
        }
      }

      function initializeCalculator() {
        const drugData = {
          Sertralina: {
            presentations: ["50 mg comp.", "100 mg comp.", "20 mg/ml sol."],
            liquid: { concentration: 20, unit: "mg/ml" },
          },
          Citalopram: {
            presentations: ["20 mg comp.", "40 mg comp."],
            tablets: [20, 40], // ‚Üê A√ëADE ESTA L√çNEA
            liquid: null,
          },
          Escitalopram: {
            presentations: ["10 mg comp.", "20 mg comp.", "20 mg/ml gotas"],
            liquid: { concentration: 20, unit: "mg/ml" },
          },
          Paroxetina: {
            presentations: ["20 mg comp.", "33 mg/ml gotas"],
            liquid: { concentration: 33, unit: "mg/ml" },
          },
          Fluoxetina: {
            presentations: ["20 mg comp.", "20 mg/5 ml sol."],
            liquid: { concentration: 4, unit: "mg/ml" },
          },
          Venlafaxina: {
            presentations: [
              "37.5 mg XR c√°ps.",
              "75 mg XR c√°ps.",
              "150 mg XR c√°ps.",
            ],
            beadTotalWeight: { 37.5: 125, 75: 250, 150: 500 }, // peso total gr√°nulos (mg)
            liquid: null,
          },
        };

        const drugSelect = document.getElementById("drug");
        const presSelect = document.getElementById("presentation");
        function setDoseFromPresentation() {
          const txt = presSelect.value || ""; // ej. "37.5 mg XR c√°ps."
          const m = txt.match(/([\d.,]+)\s*mg/i); // extrae "37.5"
          if (m) {
            document.getElementById("currentDose").value = parseFloat(
              m[1].replace(",", ".")
            );
          }
        }
        function updatePresentations() {
          const pres = drugData[drugSelect.value].presentations || [];
          presSelect.innerHTML = pres
            .map((p) => `<option value="${p}">${p}</option>`)
            .join("");

          // autocompleta dosis con la primera presentaci√≥n
          setDoseFromPresentation();
        }
        drugSelect.addEventListener("change", updatePresentations);
        presSelect.addEventListener("change", setDoseFromPresentation);
        updatePresentations();

        const calculateBtn = document.getElementById("calculateBtn");
        const calculateSlowBtn = document.getElementById("calculateSlowBtn");
        const copyBtn = document.getElementById("copyBtn");
        const pdfBtn = document.getElementById("pdfBtn");

        function performCalculation(isSlow) {
          const drug = document.getElementById("drug").value;
          const currentDose = parseFloat(
            document.getElementById("currentDose").value
          );
          const reductionInput = document.getElementById("reductionPercentage");
          const reductionPercentage = isSlow
            ? 5
            : parseFloat(reductionInput.value);
          if (isSlow) reductionInput.value = 5;

          const scheduleDiv = document.getElementById("taperingSchedule");

          if (
            isNaN(currentDose) ||
            isNaN(reductionPercentage) ||
            currentDose <= 0 ||
            reductionPercentage <= 0
          ) {
            scheduleDiv.innerHTML =
              '<p class="text-red-500">Por favor, introduzca valores v√°lidos.</p>';
            copyBtn.disabled = true;
            pdfBtn.disabled = true;
            return;
          }

          let schedule = [];
          let dose = currentDose;
          let step = 1;

          while (dose > 0.5) {
            let nextDose = dose * (1 - reductionPercentage / 100);
            if (nextDose < 0.5) {
              schedule.push({
                step: step,
                dose: nextDose.toFixed(2),
                instruction: getPracticalInstruction(drug, nextDose, dose),
              });
              dose = nextDose;
              step++;
              break;
            }
            schedule.push({
              step: step,
              dose: nextDose.toFixed(2),
              instruction: getPracticalInstruction(drug, nextDose, dose),
            });
            dose = nextDose;
            step++;
          }
          if (dose > 0) {
            schedule.push({
              step: step,
              dose: "0.00",
              instruction: "Suspender medicaci√≥n.",
            });
          }

          lastCalculatedSchedule = schedule;
          lastCalculatedDrug = drug;
          lastCalculatedInitialDose = currentDose;

          let html = `<table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-sm text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th scope="col" class="px-3 py-2">Paso</th>
                            <th scope="col" class="px-3 py-2">Dosis (mg)</th>
                            <th scope="col" class="px-3 py-2">Instrucci√≥n Pr√°ctica</th>
                        </tr>
                    </thead><tbody>`;

          schedule.forEach((item) => {
            html += `<tr class="bg-white border-b hover:bg-slate-50">
                        <td class="px-3 py-2 font-medium text-slate-900">${item.step}</td>
                        <td class="px-3 py-2">${item.dose}</td>
                        <td class="px-3 py-2">${item.instruction}</td>
                    </tr>`;
          });

          html += `</tbody></table>`;
          scheduleDiv.innerHTML = html;
          copyBtn.disabled = false;
          pdfBtn.disabled = false;
        }

        calculateBtn.addEventListener("click", () => performCalculation(false));
        calculateSlowBtn.addEventListener("click", () =>
          performCalculation(true)
        );

        // Y REEMPLAZARLA POR ESTA NUEVA VERSI√ìN
        function getPracticalInstruction(drug, dose, lastDose) {
          const data = drugData[drug];
          dose = parseFloat(dose);
          if (dose <= 0) return "Suspender medicaci√≥n.";

          // PRIORIDAD 1: Usar soluci√≥n oral comercial si existe.
          if (data.liquid) {
            const volume = (dose / data.liquid.concentration).toFixed(2);
            return `Usar soluci√≥n oral comercial (${data.liquid.concentration} mg/ml): tomar ${volume} ml.`;
          }

          // PRIORIDAD 2 (SOLO SI NO HAY L√çQUIDO): Casos especiales como Venlafaxina
          if (drug === "Venlafaxina") {
            /* ---------------------------------------------------------------
     Instrucci√≥n basada en PESO (mg), no en recuento de gr√°nulos
  --------------------------------------------------------------- */
            const strengths = Object.keys(data.beadTotalWeight) // [37.5, 75, 150]
              .map(Number)
              .sort((a, b) => a - b);

            // c√°psula de referencia = la m√°s peque√±a ‚â• dosis m√°s alta usada (lastDose)
            let refCaps =
              strengths.find((s) => s >= lastDose) ||
              strengths[strengths.length - 1];

            // si la dosis actual es menor, intenta una c√°psula m√°s peque√±a
            if (dose < refCaps) {
              const smaller = strengths.find((s) => s >= dose);
              if (smaller) refCaps = smaller;
            }

            const totalWt = data.beadTotalWeight[refCaps]; // peso total de gr√°nulos (mg)
            const targetWt = ((dose / refCaps) * totalWt).toFixed(1); // peso a pesar (mg)

            return (
              `De 1 c√°psula de ${refCaps} mg (‚âà${totalWt} mg de gr√°nulos) ` +
              `pesar ${targetWt} mg en una balanza de precisi√≥n (0.001 g).`
            );
          }

          // PRIORIDAD 3 (√öLTIMO RECURSO): F√°rmacos sin l√≠quido ni m√©todo especial
          const smallestTablet = Math.min(...data.tablets);

          if (dose > smallestTablet) {
            const wholeTablets = Math.floor(dose / smallestTablet);
            const remainingDose = dose - wholeTablets * smallestTablet;
            if (remainingDose.toFixed(2) === "0.00") {
              return `Tomar ${wholeTablets} comprimido(s) de ${smallestTablet} mg.`;
            }
            const suspensionInstruction = `triturar 1 comp. de ${smallestTablet} mg en ${smallestTablet} ml de agua y tomar ${remainingDose.toFixed(
              2
            )} ml.`;
            return `Tomar ${wholeTablets} comp. de ${smallestTablet} mg y, adicionalmente, preparar suspensi√≥n para los ${remainingDose.toFixed(
              2
            )} mg restantes (${suspensionInstruction})`;
          }

          if (dose > smallestTablet / 4) {
            if (data.tablets.includes(dose))
              return `Usar 1 comprimido de ${dose} mg.`;
            const halfDose = dose * 2;
            if (data.tablets.some((t) => Math.abs(t - halfDose) < 0.01))
              return `Usar 1/2 comprimido de ${halfDose.toFixed(2)} mg.`;
            const quarterDose = dose * 4;
            if (data.tablets.some((t) => Math.abs(t - quarterDose) < 0.01))
              return `Usar 1/4 comprimido de ${quarterDose.toFixed(2)} mg.`;
          }

          return `Hacer suspensi√≥n: triturar 1 comp. de ${smallestTablet} mg en ${smallestTablet} ml de agua y tomar ${dose.toFixed(
            2
          )} ml.`;
        }
        function generatePatientText(schedule, drug, initialDose) {
          let text = `PLAN DE REDUCCI√ìN DE DOSIS: ${drug}\n`;
          text += `=======================================\n\n`;
          text += `Dosis inicial: ${initialDose} mg.\n\n`;
          text += `Instrucciones: Siga cada paso de la pauta, esperando de 2 a 4 semanas entre cada cambio para evaluar su respuesta. Anote la fecha de cada cambio.\n\n`;

          schedule.forEach((item) => {
            text += `Paso ${item.step}: Nueva dosis de ${item.dose} mg.\n   ‚Ü≥ Instrucci√≥n: ${item.instruction}\n\n`;
          });

          text += `NOTAS IMPORTANTES:\n`;
          text += `- La adherencia al plan es clave para minimizar s√≠ntomas de abstinencia.\n`;
          text += `- No realice la toma en d√≠as alternos.\n`;
          text += `- Las suspensiones deben prepararse cada d√≠a.\n`;
          text += `- Contacte con su profesional sanitario si experimenta s√≠ntomas intolerables antes de realizar nuevos cambios.\n`;
          text += `- Nota sobre uso 'off-label': La preparaci√≥n de suspensiones es una estrategia acordada para facilitar dosis peque√±as y seguras. Debe ser una decisi√≥n conjunta con su m√©dico.`;
          return text;
        }

        copyBtn.addEventListener("click", () => {
          const patientText = generatePatientText(
            lastCalculatedSchedule,
            lastCalculatedDrug,
            lastCalculatedInitialDose
          );
          const textArea = document.createElement("textarea");
          textArea.value = patientText;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand("copy");
            copyBtn.textContent = "¬°Copiado!";
            setTimeout(() => {
              copyBtn.textContent = "Copiar para Paciente";
            }, 2000);
          } catch (err) {
            console.error("Error al copiar texto: ", err);
          }
          document.body.removeChild(textArea);
        });

        pdfBtn.addEventListener("click", () => {
          /* Elimina acentos para que jsPDF no muestre ÔøΩ */
          function stripAccents(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
          }

          const doc = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });
          const drug = lastCalculatedDrug;
          const initialDose = lastCalculatedInitialDose;
          const schedule = lastCalculatedSchedule;

          doc.setFont("Helvetica", "bold");
          doc.setFontSize(16);
          doc.text(`Plan de Reducci√≥n de Dosis: ${drug}`, 14, 20);

          doc.setFont("Helvetica", "normal");
          doc.setFontSize(11);
          doc.setTextColor(50);
          doc.text(`Dosis inicial: ${initialDose} mg`, 14, 28);

          const introText = `Este documento detalla su pauta de reducci√≥n personalizada. Es fundamental seguir cada paso seg√∫n lo prescrito, manteniendo un intervalo de 2 a 4 semanas entre cada cambio para monitorizar la tolerancia. Si se requiere preparar una suspensi√≥n, esta debe elaborarse diariamente. Utilice la columna 'Fecha' para registrar el inicio de cada nuevo paso.`;
          const splitIntro = doc.splitTextToSize(introText, 180);
          doc.text(splitIntro, 14, 38);

          const tableColumn = [
            "Paso",
            "Nueva Dosis (mg)",
            "Instrucci√≥n de Toma",
            "Fecha (a rellenar)",
          ];
          const tableRows = [];

          //========== NUEVO schedule.forEach para PDF ==========
          // 1. Funci√≥n de saneo: quita acentos y reemplaza s√≠mbolos incompatibles
          const sanitizePDFText = (str) => {
            const cleaned = stripAccents(str); // sin tildes/√±/√ß
            return cleaned
              .replace(/‚Üí|‚ûî|‚ûú|‚ü∂|‚áí/g, "->")
              .replace(/‚Üê|‚üµ|‚áê/g, "<-")
              .replace(/‚âà/g, "~") // aproximado
              .replace(/[‚â•]/g, ">=")
              .replace(/[‚â§]/g, "<=")
              .replace(/[‚Ä¢¬∑]/g, "-") // vi√±etas
              .replace(/[|]/g, "/") // evita barras verticales
              .replace(/[‚Äú‚Äù¬´¬ª]/g, '"') // comillas tipogr√°ficas
              .replace(/[‚Äî‚Äì]/g, "-"); // guiones largos
          };

          schedule.forEach((item) => {
            const instr = sanitizePDFText(item.instruction);
            const wrapped = doc.splitTextToSize(instr, 92); // 92 mm = ancho celda
            tableRows.push([item.step, item.dose, wrapped, ""]);
          });
          // ========== FIN NUEVO schedule.forEach ===============

          doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 55,
            theme: "grid",
            styles: {
              font: "Helvetica",
              fontSize: 9,
              cellPadding: 2,
              overflow: "linebreak",
            },
            headStyles: {
              fillColor: [41, 128, 185],
              textColor: 255,
              fontStyle: "bold",
            },
            columnStyles: {
              0: { halign: "center", cellWidth: 12 }, // Paso
              1: { halign: "center", cellWidth: 25 }, // Dosis
              2: { cellWidth: 92, overflow: "linebreak" }, // Instrucci√≥n
              3: { cellWidth: 35 }, // Fecha
            },
            margin: { left: 14, right: 14 },
          });

          let finalY = doc.lastAutoTable.finalY + 15;

          doc.setFont("Helvetica", "bold");
          doc.setFontSize(10);
          doc.text(
            "Acuerdo sobre Uso Fuera de Ficha T√©cnica (Off-Label):",
            14,
            finalY
          );
          doc.setFont("Helvetica", "normal");
          doc.setFontSize(9);
          const offLabelText = `La preparaci√≥n de suspensiones es una pr√°ctica 'off-label' propuesta como estrategia para permitir reducciones de dosis muy peque√±as y seguras. Su uso representa una decisi√≥n cl√≠nica consensuada para minimizar el riesgo de s√≠ntomas de abstinencia, siguiendo las recomendaciones de gu√≠as cl√≠nicas internacionales.`;
          const splitOffLabel = doc.splitTextToSize(offLabelText, 180);
          doc.text(splitOffLabel, 14, finalY + 5);

          finalY =
            doc.lastAutoTable.finalY + 30 > finalY + 25
              ? doc.lastAutoTable.finalY + 25
              : finalY + 25;

          doc.setFont("Helvetica", "bold");
          doc.setFontSize(12);
          doc.text(
            "Cu√°ndo Contactar Inmediatamente con su M√©dico:",
            14,
            finalY
          );
          doc.setFont("Helvetica", "normal");
          doc.setFontSize(10);
          doc.setTextColor(50);
          const contactReasons = [
            "- S√≠ntomas graves de abstinencia (mareos intensos, 'descargas cerebrales' severas).",
            "- Pensamientos de autolesi√≥n o suicidio.",
            "- S√≠ntomas que no mejoran tras 1-2 semanas manteniendo la misma dosis.",
            "- Incapacidad para realizar actividades diarias normales.",
          ];
          doc.text(contactReasons, 14, finalY + 7);

          finalY += 30;

          doc.setFont("Helvetica", "bold");
          doc.setFontSize(12);
          doc.text("Aviso M√©dico Importante:", 14, finalY);
          doc.setFont("Helvetica", "normal");
          doc.setFontSize(10);
          const warningText = [
            `Este plan debe ejecutarse √öNICAMENTE bajo supervisi√≥n m√©dica continua.`,
            `No inicie, modifique o suspenda el tratamiento sin consultar a su profesional sanitario.`,
            `Este documento es una gu√≠a. El seguimiento cl√≠nico es fundamental durante todo el proceso.`,
          ];
          doc.text(warningText, 14, finalY + 7);

          doc.save(`pauta_reduccion_${drug.toLowerCase()}.pdf`);
        });
      }
    </script>
    <script>
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((e) => {
            if (e.isIntersecting) {
              document
                .querySelectorAll(".toc-link")
                .forEach((l) => l.classList.remove("active"));
              const id = e.target.getAttribute("id");
              document
                .querySelector('.toc-link[href="#' + id + '"]')
                ?.classList.add("active");
            }
          });
        },
        { rootMargin: "-40% 0px -40% 0px", threshold: 0.1 }
      );
      document
        .querySelectorAll("main section[id]")
        .forEach((s) => observer.observe(s));
    </script>
  </body>
</html>
