<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Asistente de Espirometría Clínico (con Tutorial y Modales)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/intro.js/minified/introjs.min.css"
    />
    <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>

    <style>
      body {
        font-family: "Inter", sans-serif;
        scroll-behavior: smooth;
      }
      .step-card {
        background-color: white;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        margin-bottom: 2rem;
      }
      .step-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .step-number {
        background-color: #3b82f6;
        color: white;
        border-radius: 9999px;
        width: 2.25rem;
        height: 2.25rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 0.75rem;
        font-size: 1.25rem;
      }
      .input-mode-toggle label {
        padding: 0.5rem 1rem;
        border: 2px solid #d1d5db;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .input-mode-toggle input:checked + label {
        background-color: #eff6ff;
        border-color: #3b82f6;
        color: #1e40af;
        font-weight: 600;
      }
      .input-mode-toggle input {
        display: none;
      }
      .quality-inspector {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 1.5rem;
        align-items: center;
        border: 1px solid #e5e7eb;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-top: 1rem;
      }
      .quality-feedback {
        background-color: #f3f4f6;
        border-left: 4px solid;
        padding: 0.75rem;
        border-radius: 0.25rem;
        margin-top: 0.75rem;
        font-size: 0.875rem;
      }
      .feedback-correct {
        border-color: #10b981;
      }
      .feedback-incorrect {
        border-color: #f59e0b;
      }
      .interpretation {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 1rem 0;
        padding: 1rem;
        border-radius: 0.5rem;
        text-align: center;
      }
      .pattern-normal {
        background-color: #d1fae5;
        color: #065f46;
      }
      .pattern-obstructive {
        background-color: #fef3c7;
        color: #92400e;
      }
      .pattern-restrictive {
        background-color: #dbeafe;
        color: #1e40af;
      }
      .pattern-mixed {
        background-color: #fee2e2;
        color: #991b1b;
      }
      .quality-warning {
        background-color: #fffbeb;
        color: #b45309;
        border: 1px solid #fde68a;
        padding: 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
      }
      .curve-container {
        background: #f8fafc;
        border-radius: 12px;
        box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
      }
      .curve-grid {
        background-image: linear-gradient(
            rgba(203, 213, 225, 0.5) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(203, 213, 225, 0.5) 1px, transparent 1px);
        background-size: 20px 20px;
      }
      .curve-path {
        transition: d 0.4s ease-in-out;
      }
      .axis-label {
        font-size: 10px;
        fill: #4b5563;
      }
      .clinical-pearl {
        background-color: #eff6ff;
        border-left: 4px solid #3b82f6;
        padding: 1rem;
        margin-top: 1.5rem;
        border-radius: 0.25rem;
      }
      .case-description {
        font-size: 0.9rem;
        color: #4b5563;
        background-color: #f9fafb;
        padding: 0.75rem;
        border-radius: 0.5rem;
        min-height: 80px;
      }
      .data-input.w-full,
      .data-input.rounded-md {
        background-color: #f9fafb;
        border-color: #d1d5db;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .data-input.w-full:focus,
      .data-input.rounded-md:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px #3b82f6;
        outline: none;
      }
      /* --- ESTILOS PARA VALIDACIÓN --- */
      .input-normal {
        border-color: #10b981 !important;
      }
      .input-borderline {
        border-color: #f59e0b !important;
      }
      /* --- FIN ESTILOS --- */
      .tooltip-container {
        position: relative;
        display: inline-flex;
        align-items: center;
      }
      .tooltip-icon {
        cursor: help;
        margin-left: 8px;
        color: #9ca3af;
        border: 1px solid #d1d5db;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        font-style: normal;
        font-weight: bold;
        font-size: 12px;
      }
      .tooltip-text {
        visibility: hidden;
        width: 240px;
        background-color: #1f2937;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 10;
        bottom: 125%;
        left: 50%;
        margin-left: -120px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8rem;
        font-weight: normal;
      }
      .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #1f2937 transparent transparent transparent;
      }
      .tooltip-container:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }
      /* --- ESTILOS PARA MODALES ELEGANTES --- */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(17, 24, 39, 0.6);
        z-index: 50;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      .modal-backdrop.show {
        opacity: 1;
        visibility: visible;
      }
      .modal {
        background-color: white;
        padding: 1.5rem 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
        width: 90%;
        max-width: 500px;
        transform: scale(0.95);
        transition: transform 0.3s ease;
      }
      .modal-backdrop.show .modal {
        transform: scale(1);
      }
      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 0.75rem;
      }
      .modal-body {
        color: #4b5563;
        margin-bottom: 1.5rem;
      }
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
      }
      .modal-footer button {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .modal-btn-secondary {
        background-color: #e5e7eb;
        color: #374151;
      }
      .modal-btn-secondary:hover {
        background-color: #d1d5db;
      }
      .modal-btn-danger {
        background-color: #ef4444;
        color: white;
      }
      .modal-btn-danger:hover {
        background-color: #dc2626;
      }
      /* --- ESTILOS PARA QUE EL TUTORIAL PAREZCA UN POST-IT (MEJORADO) --- */
      /* --- ESTILOS PARA QUE EL TUTORIAL PAREZCA UN POST-IT (INCLINACIÓN FIJA) --- */
      .introjs-tooltip {
        background-color: #fefabc; /* Color amarillo pálido */
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 12px; /* Solo la esquina inferior derecha redondeada */
        box-shadow: 5px 5px 7px rgba(33, 33, 33, 0.7); /* Sombra para dar efecto de relieve */
        transform: rotate(2deg); /* Rotación fija para todos los tooltips */
        border: none;
        font-family: "Comic Sans MS", "Chalkboard SE", "Marker Felt", sans-serif; /* Fuente manuscrita */
        color: #333;
        max-width: 350px;
      }

      /* Opcional: Estilo de los botones para que encajen mejor */
      .introjs-button {
        background-color: #dcdcdc;
        border: 1px solid #a9a9a9;
        color: #333;
        text-shadow: none;
        border-radius: 3px;
      }

      .introjs-button:hover {
        background-color: #c0c0c0;
      }

      /* Opcional: Cambiar el color de la flecha del tooltip */
      .introjs-arrow.top {
        border-bottom-color: #fefabc;
      }
      .introjs-arrow.bottom {
        border-top-color: #fefabc;
      }
      .introjs-arrow.left {
        border-right-color: #fefabc;
      }
      .introjs-arrow.right {
        border-left-color: #fefabc;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
      <header class="text-center mb-10">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900">
          Asistente de Espirometría Clínico
        </h1>
        <p class="text-lg text-gray-600 mt-2">
          Herramienta educativa y de diagnóstico para Atención Primaria
        </p>
        <button
          id="startTutorialBtn"
          class="mt-4 bg-white hover:bg-gray-50 text-blue-600 font-semibold py-2 px-4 border border-blue-300 rounded-lg shadow-sm"
        >
          <i class="fa-solid fa-circle-question mr-2"></i>Guía Interactiva
        </button>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <div class="step-card">
            <div class="step-title">
              <div class="flex items-center">
                <span class="step-number">1</span>Introducción de Datos
              </div>
              <button
                id="reset_button"
                class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-lg flex items-center gap-2"
              >
                <i class="fa-solid fa-rotate-right"></i> Reiniciar
              </button>
            </div>

            <div
              class="flex items-center space-x-4 mb-6"
              data-step="1"
              data-intro="¡Bienvenido! Empieza seleccionando cómo introducirás los datos: 'Vía Rápida' si tienes los porcentajes, o 'Absolutos' si tienes los valores en litros."
            >
              <div class="input-mode-toggle flex space-x-4">
                <input
                  type="radio"
                  id="mode_percent"
                  name="input_mode"
                  value="percent"
                  class="data-input"
                  checked
                /><label for="mode_percent">Vía Rápida (%)</label>
                <input
                  type="radio"
                  id="mode_abs"
                  name="input_mode"
                  value="absolute"
                  class="data-input"
                /><label for="mode_abs">Absolutos (L)</label>
              </div>
              <div class="tooltip-container">
                <i class="tooltip-icon">?</i>
                <span class="tooltip-text"
                  >'Vía Rápida' permite usar los porcentajes que da el
                  espirómetro. 'Absolutos' calcula todo desde los valores en
                  litros.</span
                >
              </div>
            </div>
            <div
              id="percent_inputs"
              class="space-y-4"
              data-step="2"
              data-intro="Aquí introducirás los tres valores clave de la espirometría: el cociente FEV1/FVC, el FVC en % y el FEV1 en %."
            >
              <div>
                <label
                  for="fev1fvc_ratio"
                  class="font-medium text-gray-700 tooltip-container"
                  >Cociente FEV1/FVC (%) <i class="tooltip-icon">?</i
                  ><span class="tooltip-text"
                    >Indica obstrucción si es <70%. Es el parámetro más
                    importante para empezar la interpretación.</span
                  ></label
                >
                <input
                  type="number"
                  min="0"
                  id="fev1fvc_ratio"
                  placeholder="Ej: 68"
                  class="data-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                />
              </div>
              <div>
                <label
                  for="fvc_percent"
                  class="font-medium text-gray-700 tooltip-container"
                  >FVC (% del teórico) <i class="tooltip-icon">?</i
                  ><span class="tooltip-text"
                    >Capacidad Vital Forzada. Indica restricción si es
                    <80%.</span
                  ></label
                >
                <input
                  type="number"
                  min="0"
                  id="fvc_percent"
                  placeholder="Ej: 85"
                  class="data-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                />
              </div>
              <div>
                <label
                  for="fev1_percent"
                  class="font-medium text-gray-700 tooltip-container"
                  >FEV1 (% del teórico) <i class="tooltip-icon">?</i
                  ><span class="tooltip-text"
                    >Volumen Espiratorio Forzado en 1s. Sirve para graduar la
                    severidad de la obstrucción (Leve, Moderada, etc.).</span
                  ></label
                >
                <input
                  type="number"
                  min="0"
                  id="fev1_percent"
                  placeholder="Ej: 75"
                  class="data-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                />
              </div>
            </div>
            <div
              id="abs_inputs"
              class="hidden grid grid-cols-2 gap-x-4 gap-y-4"
            >
              <div>
                <label for="fvc_med">FVC Med (L)</label
                ><input
                  type="number"
                  min="0"
                  step="0.01"
                  id="fvc_med"
                  placeholder="Ej: 4.26"
                  class="data-input mt-1 w-full rounded-md"
                />
              </div>
              <div>
                <label for="fvc_teo">FVC Teo (L)</label
                ><input
                  type="number"
                  min="0"
                  step="0.01"
                  id="fvc_teo"
                  placeholder="Ej: 5.16"
                  class="data-input mt-1 w-full rounded-md"
                />
              </div>
              <div>
                <label for="fev1_med">FEV1 Med (L)</label
                ><input
                  type="number"
                  min="0"
                  step="0.01"
                  id="fev1_med"
                  placeholder="Ej: 3.09"
                  class="data-input mt-1 w-full rounded-md"
                />
              </div>
              <div>
                <label for="fev1_teo">FEV1 Teo (L)</label
                ><input
                  type="number"
                  min="0"
                  step="0.01"
                  id="fev1_teo"
                  placeholder="Ej: 4.09"
                  class="data-input mt-1 w-full rounded-md"
                />
              </div>
              <div
                class="col-span-2 mt-2 p-3 bg-slate-50 rounded-md grid grid-cols-3 gap-x-4"
              >
                <div>
                  <label class="text-sm font-semibold text-slate-600"
                    >Cociente FEV1/FVC</label
                  ><input
                    type="text"
                    id="auto_ratio"
                    readonly
                    class="mt-1 w-full rounded-md bg-slate-200 text-center font-bold text-slate-700"
                  />
                </div>
                <div>
                  <label class="text-sm font-semibold text-slate-600"
                    >FVC % Teórico</label
                  ><input
                    type="text"
                    id="auto_fvc_percent"
                    readonly
                    class="mt-1 w-full rounded-md bg-slate-200 text-center font-bold text-slate-700"
                  />
                </div>
                <div>
                  <label class="text-sm font-semibold text-slate-600"
                    >FEV1 % Teórico</label
                  ><input
                    type="text"
                    id="auto_fev1_percent"
                    readonly
                    class="mt-1 w-full rounded-md bg-slate-200 text-center font-bold text-slate-700"
                  />
                </div>
              </div>
            </div>
            <div
              id="realtime_warning"
              class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-800 rounded-md text-sm font-medium"
            ></div>
            <div
              class="mt-6 border-t pt-4"
              data-step="3"
              data-intro="Si necesitas evaluar la respuesta a un broncodilatador, marca esta casilla. Es fundamental en la primera espirometría diagnóstica."
            >
              <input
                type="checkbox"
                id="pbd_check"
                class="h-5 w-5 rounded data-input"
              /><label for="pbd_check" class="ml-3 text-lg font-medium"
                >Evaluar Prueba Broncodilatadora (PBD)</label
              >
              <div id="pbd_input_container" class="mt-4 hidden space-y-4"></div>
            </div>
          </div>

          <div
            class="step-card"
            data-step="4"
            data-intro="¡Un paso crucial! Antes de interpretar, debes asegurar que la técnica fue correcta. Comprueba aquí la aceptabilidad y reproducibilidad de las maniobras."
          >
            <div class="flex justify-between items-center">
              <h2 class="step-title mb-0 border-b-0 pb-0">
                <span class="step-number">2</span>Guía Interactiva de Calidad
              </h2>
              <div class="flex items-center space-x-2">
                <label
                  for="pediatric_mode"
                  class="text-sm font-medium text-gray-700"
                  >Modo Pediátrico (<10 años)</label
                >
                <input
                  type="checkbox"
                  id="pediatric_mode"
                  class="h-4 w-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300"
                />
              </div>
            </div>
            <p class="text-gray-600 my-4">
              Evalúe las curvas de su informe. Una técnica correcta y
              reproducible es imprescindible para una interpretación válida.
            </p>
            <h3 class="font-semibold text-lg text-gray-800">
              Aceptabilidad de la Maniobra
            </h3>
            <div class="quality-inspector">
              <div>
                <h4 class="font-semibold">A. Comienzo</h4>
                <p class="text-sm text-gray-500 mt-1">
                  <strong>Qué mirar:</strong> Ascenso inicial.
                </p>
                <div class="mt-2 space-y-2">
                  <label
                    ><input
                      type="radio"
                      name="start"
                      value="yes"
                      class="quality-input"
                    />
                    Rápido y sin dudar</label
                  ><br /><label
                    ><input
                      type="radio"
                      name="start"
                      value="no"
                      class="quality-input"
                    />
                    Lento o con titubeos</label
                  >
                </div>
                <div id="start_feedback" class="quality-feedback hidden"></div>
              </div>
              <div class="w-20 h-20 bg-gray-50 rounded-md p-1">
                <svg id="start_svg" viewBox="0 0 100 80">
                  <path
                    id="start_path"
                    d="M 10 70 C 25 15, 40 10, 90 8"
                    stroke="#3B82F6"
                    stroke-width="2"
                    fill="none"
                  />
                </svg>
              </div>
            </div>
            <div class="quality-inspector">
              <div>
                <h4 class="font-semibold">B. Morfología</h4>
                <p class="text-sm text-gray-500 mt-1">
                  <strong>Qué mirar:</strong> Trayecto de la curva F-V.
                </p>
                <div class="mt-2 space-y-2">
                  <label
                    ><input
                      type="radio"
                      name="morphology"
                      value="yes"
                      class="quality-input"
                    />
                    Pico único y suave</label
                  ><br /><label
                    ><input
                      type="radio"
                      name="morphology"
                      value="no"
                      class="quality-input"
                    />
                    Con tos o artefactos</label
                  >
                </div>
                <div
                  id="morphology_feedback"
                  class="quality-feedback hidden"
                ></div>
              </div>
              <div class="w-20 h-20 bg-gray-50 rounded-md p-1">
                <svg id="morphology_svg" viewBox="0 0 100 80">
                  <path
                    id="morphology_path"
                    d="M 10 70 C 15 10, 40 10, 90 65"
                    stroke="#3B82F6"
                    stroke-width="2"
                    fill="none"
                  />
                </svg>
              </div>
            </div>
            <div class="quality-inspector">
              <div>
                <h4 class="font-semibold flex items-center">
                  C. Finalización
                  <span
                    id="pediatric_note"
                    class="hidden ml-2 text-xs bg-blue-100 text-blue-800 font-medium px-2 py-0.5 rounded-full"
                    >Umbral: 3s</span
                  >
                </h4>
                <p class="text-sm text-gray-500 mt-1">
                  <strong>Qué mirar:</strong> Final de la curva V-T.
                </p>
                <div class="mt-2 space-y-2">
                  <label
                    ><input
                      type="radio"
                      name="end"
                      value="yes"
                      class="quality-input"
                    />
                    <span id="end_duration_label">>6s</span> y con meseta</label
                  ><br /><label
                    ><input
                      type="radio"
                      name="end"
                      value="no"
                      class="quality-input"
                    />
                    Corte brusco o <<span id="end_duration_label_short"
                      >6s</span
                    ></label
                  >
                </div>
                <div id="end_feedback" class="quality-feedback hidden"></div>
              </div>
              <div class="w-20 h-20 bg-gray-50 rounded-md p-1">
                <svg id="end_svg" viewBox="0 0 100 80">
                  <path
                    id="end_path"
                    d="M 10 70 C 25 15, 40 10, 90 8"
                    stroke="#3B82F6"
                    stroke-width="2"
                    fill="none"
                  />
                </svg>
              </div>
            </div>

            <h3 class="font-semibold text-lg text-gray-800 mt-6 border-t pt-4">
              Reproducibilidad de la Sesión
            </h3>
            <div id="repro_pre_container">
              <p class="text-sm font-medium text-gray-700">Maniobras Pre-BD</p>
              <div class="grid grid-cols-2 gap-4 mt-2">
                <div>
                  <label for="fvc1" class="text-sm">Mejor FVC (L)</label
                  ><input
                    type="number"
                    min="0"
                    step="0.01"
                    id="fvc1"
                    class="data-input mt-1 w-full rounded-md"
                  />
                </div>
                <div>
                  <label for="fvc2" class="text-sm">2ª Mejor FVC (L)</label
                  ><input
                    type="number"
                    min="0"
                    step="0.01"
                    id="fvc2"
                    class="data-input mt-1 w-full rounded-md"
                  />
                </div>
                <div>
                  <label for="fev1_1" class="text-sm">Mejor FEV1 (L)</label
                  ><input
                    type="number"
                    min="0"
                    step="0.01"
                    id="fev1_1"
                    class="data-input mt-1 w-full rounded-md"
                  />
                </div>
                <div>
                  <label for="fev1_2" class="text-sm">2ª Mejor FEV1 (L)</label
                  ><input
                    type="number"
                    min="0"
                    step="0.01"
                    id="fev1_2"
                    class="data-input mt-1 w-full rounded-md"
                  />
                </div>
              </div>
            </div>
            <div
              id="reproducibility_result"
              class="mt-2 text-center font-bold p-2 rounded-md text-sm"
            ></div>

            <div id="repro_post_container" class="hidden mt-4">
              <p class="text-sm font-medium text-gray-700">
                Maniobras Post-BD (Opcional)
              </p>
              <div class="grid grid-cols-2 gap-4 mt-2">
                <div>
                  <label for="fvc1_post" class="text-sm">Mejor FVC (L)</label
                  ><input
                    type="number"
                    min="0"
                    step="0.01"
                    id="fvc1_post"
                    class="data-input mt-1 w-full rounded-md"
                  />
                </div>
                <div>
                  <label for="fvc2_post" class="text-sm">2ª Mejor FVC (L)</label
                  ><input
                    type="number"
                    min="0"
                    step="0.01"
                    id="fvc2_post"
                    class="data-input mt-1 w-full rounded-md"
                  />
                </div>
                <div>
                  <label for="fev1_1_post" class="text-sm">Mejor FEV1 (L)</label
                  ><input
                    type="number"
                    min="0"
                    step="0.01"
                    id="fev1_1_post"
                    class="data-input mt-1 w-full rounded-md"
                  />
                </div>
                <div>
                  <label for="fev1_2_post" class="text-sm"
                    >2ª Mejor FEV1 (L)</label
                  ><input
                    type="number"
                    min="0"
                    step="0.01"
                    id="fev1_2_post"
                    class="data-input mt-1 w-full rounded-md"
                  />
                </div>
              </div>
              <div
                id="reproducibility_result_post"
                class="mt-2 text-center font-bold p-2 rounded-md text-sm"
              ></div>
            </div>
          </div>
        </div>
        <div>
          <div class="step-card">
            <h2 class="step-title">
              <span class="step-number">3</span>Visualización y Diagnóstico
            </h2>
            <div
              id="results_container"
              class="opacity-50"
              data-step="5"
              data-intro="Una vez introducidos los datos, aquí verás la magia: las curvas se dibujarán, aparecerá la interpretación del patrón y el algoritmo diagnóstico paso a paso."
            >
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="curve-container p-3">
                  <h3 class="font-medium text-center text-gray-700 mb-2">
                    Curva Flujo-Volumen
                  </h3>
                  <div
                    class="h-48 flex items-center justify-center curve-grid relative"
                  >
                    <svg
                      width="100%"
                      height="100%"
                      viewBox="0 0 220 140"
                      preserveAspectRatio="xMidYMid meet"
                    >
                      <g transform="translate(20, 130) scale(1, -1)">
                        <path
                          d="M0,0 H200 M0,0 V120"
                          stroke="#94A3B8"
                          stroke-width="1.5"
                        />
                        <text
                          class="axis-label"
                          transform="scale(1,-1)"
                          x="80"
                          y="-120"
                        >
                          Volumen (L)
                        </text>
                        <text
                          class="axis-label"
                          transform="rotate(90) scale(-1,1)"
                          x="40"
                          y="15"
                        >
                          Flujo (L/s)
                        </text>
                        <path
                          d="M0,0 C20,100 80,90 180,5"
                          class="curve-path"
                          id="flowVolumePathPost"
                          fill="none"
                          stroke="#FBBF24"
                          stroke-width="2.5"
                          stroke-dasharray="4"
                        />
                        <path
                          d="M0,0 C20,100 80,90 180,5"
                          class="curve-path"
                          id="flowVolumePath"
                          fill="none"
                          stroke="#3B82F6"
                          stroke-width="2.5"
                        />
                      </g>
                    </svg>
                  </div>
                  <div
                    id="fv_explanation"
                    class="text-xs text-gray-600 mt-2 p-1 h-16"
                  ></div>
                </div>
                <div class="curve-container p-3">
                  <h3 class="font-medium text-center text-gray-700 mb-2">
                    Curva Volumen-Tiempo
                  </h3>
                  <div
                    class="h-48 flex items-center justify-center curve-grid relative"
                  >
                    <svg
                      width="100%"
                      height="100%"
                      viewBox="0 0 220 140"
                      preserveAspectRatio="xMidYMid meet"
                    >
                      <g transform="translate(20, 130) scale(1, -1)">
                        <path
                          d="M0,0 H200 M0,0 V120"
                          stroke="#94A3B8"
                          stroke-width="1.5"
                        />
                        <path
                          id="lln_line"
                          d="M0,84 H180"
                          stroke="#475569"
                          stroke-width="1"
                          stroke-dasharray="4"
                        />
                        <text
                          id="lln_label"
                          class="axis-label"
                          transform="scale(1,-1)"
                          x="185"
                          y="-80"
                        >
                          LLN
                        </text>
                        <path
                          d="M100,0 V-5"
                          stroke="#94A3B8"
                          stroke-width="1"
                        />
                        <text
                          class="axis-label"
                          transform="scale(1,-1)"
                          x="95"
                          y="15"
                          id="time_axis_label"
                        >
                          6s
                        </text>
                        <text
                          class="axis-label"
                          transform="scale(1,-1)"
                          x="80"
                          y="-120"
                        >
                          Tiempo (s)
                        </text>
                        <text
                          class="axis-label"
                          transform="rotate(90) scale(-1,1)"
                          x="40"
                          y="15"
                        >
                          Volumen (L)
                        </text>
                        <path
                          d="M0,0 C20,80 80,100 180,105"
                          class="curve-path"
                          id="volumeTimePathPost"
                          fill="none"
                          stroke="#FBBF24"
                          stroke-width="2.5"
                          stroke-dasharray="4"
                        />
                        <path
                          d="M0,0 C20,80 80,100 180,105"
                          class="curve-path"
                          id="volumeTimePath"
                          fill="none"
                          stroke="#10B981"
                          stroke-width="2.5"
                        />
                      </g>
                    </svg>
                  </div>
                  <div
                    id="vt_explanation"
                    class="text-xs text-gray-600 mt-2 p-1 h-16"
                  ></div>
                </div>
              </div>
              <div
                id="pbd_legend"
                class="hidden text-xs mt-2 flex justify-center items-center gap-4"
              >
                <div>
                  <span
                    class="inline-block w-4 h-0.5 bg-blue-500 mr-1 align-middle"
                  ></span>
                  Pre-BD
                </div>
                <div>
                  <span
                    class="inline-block w-4 h-0.5 border-t-2 border-dashed border-amber-400 mr-1 align-middle"
                  ></span>
                  Post-BD
                </div>
              </div>

              <div id="interpretation_section" class="mt-4" aria-live="polite">
                <p class="text-center text-gray-500 py-8">
                  Introduzca los datos para ver la interpretación.
                </p>
              </div>

              <div id="algorithm_section" class="hidden mt-4">
                <h4 class="font-bold">Algoritmo Diagnóstico Aplicado</h4>
                <div
                  id="algorithm_path_container"
                  class="mt-2 bg-gray-50 p-3 rounded-md"
                ></div>
              </div>

              <div class="mt-4 border-t pt-4">
                <button
                  id="copy_summary_button"
                  class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <i class="fa-regular fa-clipboard"></i>
                  <span>Copiar Resumen para HCE</span>
                </button>
                <textarea id="summary_for_copy" class="hidden"></textarea>
              </div>
            </div>
          </div>
          <div
            class="step-card"
            data-step="6"
            data-intro="Para practicar y aprender, selecciona uno de los casos clínicos del manual. Se cargarán automáticamente sus datos para que puedas analizar la interpretación."
          >
            <h2 class="step-title">
              <span class="step-number">4</span>Biblioteca de Casos Clínicos
            </h2>
            <p class="text-gray-600 mb-2">
              Seleccione un caso para cargar sus datos en los campos de arriba y
              ver la interpretación.
            </p>
            <select
              id="case_library_select"
              class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50"
            >
              <option value="-1">-- Seleccione un escenario clínico --</option>
            </select>
            <div
              id="case_description_container"
              class="mt-4 case-description hidden"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <div id="resetModalBackdrop" class="modal-backdrop">
      <div class="modal">
        <h3 class="modal-title">Confirmar Acción</h3>
        <p class="modal-body">
          ¿Estás seguro de que deseas reiniciar todos los campos? Se perderán
          los datos introducidos.
        </p>
        <div class="modal-footer">
          <button id="cancelResetBtn" class="modal-btn-secondary">
            Cancelar
          </button>
          <button id="confirmResetBtn" class="modal-btn-danger">
            Confirmar Reinicio
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- BIBLIOTECA DE CASOS ---
        const caseLibrary = [
          // Casos Válidos
          {
            title: "1. Paciente Sano",
            description:
              "Varón de 35 años, no fumador, asintomático. Espirometría de rutina.",
            values: {
              percent: { ratio: 85, fvc: 98, fev1: 102 },
              absolute: {
                fvc_med: 4.9,
                fvc_teo: 5.0,
                fev1_med: 4.17,
                fev1_teo: 4.09,
              },
            },
            quality: { start: "yes", morphology: "yes", end: "yes" },
            reproducibility: {
              fvc1: 4.9,
              fvc2: 4.85,
              fev1_1: 4.17,
              fev1_2: 4.1,
            },
          },
          {
            title: "2. Obstrucción Leve (EPOC Inicial)",
            description:
              "Mujer de 55 años, fumadora de 20 paq/año. Presenta tos matutina ocasional.",
            values: {
              percent: { ratio: 68, fvc: 90, fev1: 85 },
              absolute: {
                fvc_med: 3.15,
                fvc_teo: 3.5,
                fev1_med: 2.14,
                fev1_teo: 2.52,
              },
            },
            quality: { start: "yes", morphology: "yes", end: "yes" },
            reproducibility: {
              fvc1: 3.15,
              fvc2: 3.09,
              fev1_1: 2.14,
              fev1_2: 2.1,
            },
          },
          {
            title: "3. Obstrucción Grave con PBD Positiva (Asma)",
            description:
              "Joven de 22 años, atópico, con crisis de sibilancias y tos nocturna. Se realiza PBD.",
            values: {
              percent: { ratio: 61, fvc: 84, fev1: 59 },
              absolute: {
                fvc_med: 3.78,
                fvc_teo: 4.5,
                fev1_med: 2.31,
                fev1_teo: 3.91,
              },
            },
            pbd: { fev1_pre: 2.31, fev1_post: 2.73, fvc_post: 4.0 },
            quality: { start: "yes", morphology: "yes", end: "yes" },
            reproducibility: {
              fvc1: 3.78,
              fvc2: 3.7,
              fev1_1: 2.31,
              fev1_2: 2.25,
            },
          },
          {
            title: "4. Obstrucción Moderada con PBD Negativa (EPOC)",
            description:
              "Varón de 65 años, exfumador, disnea de esfuerzo. Se realiza PBD.",
            values: {
              percent: { ratio: 58, fvc: 85, fev1: 62 },
              absolute: {
                fvc_med: 3.4,
                fvc_teo: 4.0,
                fev1_med: 1.97,
                fev1_teo: 3.18,
              },
            },
            pbd: { fev1_pre: 1.97, fev1_post: 2.08 },
            quality: { start: "yes", morphology: "yes", end: "yes" },
            reproducibility: {
              fvc1: 3.4,
              fvc2: 3.35,
              fev1_1: 1.97,
              fev1_2: 1.9,
            },
          },
          {
            title: "5. Patrón Sugestivo de Restricción",
            description:
              "Mujer de 60 años con fibrosis pulmonar conocida. Disnea progresiva.",
            values: {
              percent: { ratio: 83, fvc: 68, fev1: 70 },
              absolute: {
                fvc_med: 1.84,
                fvc_teo: 2.7,
                fev1_med: 1.52,
                fev1_teo: 2.17,
              },
            },
            quality: { start: "yes", morphology: "yes", end: "yes" },
            reproducibility: {
              fvc1: 1.84,
              fvc2: 1.8,
              fev1_1: 1.52,
              fev1_2: 1.49,
            },
          },
          {
            title: "6. Patrón Mixto que normaliza FVC con PBD",
            description:
              "Paciente con EPOC y atrapamiento aéreo. La FVC mejora tras BD, cambiando el patrón de mixto a obstructivo puro.",
            values: {
              percent: { ratio: 58, fvc: 66, fev1: 49 },
              absolute: {
                fvc_med: 2.21,
                fvc_teo: 3.33,
                fev1_med: 1.28,
                fev1_teo: 2.61,
              },
            },
            pbd: { fev1_pre: 1.28, fev1_post: 1.62, fvc_post: 2.9 },
            quality: { start: "yes", morphology: "yes", end: "yes" },
            reproducibility: {
              fvc1: 2.21,
              fvc2: 2.18,
              fev1_1: 1.28,
              fev1_2: 1.25,
            },
          },
          // Casos con Mala Técnica
          {
            title: "7. MALA TÉCNICA: Inicio Lento",
            description:
              "Paciente que no comprende la instrucción de soplar de forma explosiva, iniciando la maniobra con lentitud.",
            values: {
              percent: { ratio: 75, fvc: 95, fev1: 78 },
              absolute: {
                fvc_med: 4.28,
                fvc_teo: 4.5,
                fev1_med: 3.21,
                fev1_teo: 4.11,
              },
            },
            quality: { start: "no", morphology: "yes", end: "yes" },
          },
          {
            title: "8. MALA TÉCNICA: Tos en el primer segundo",
            description:
              "Paciente que sufre un acceso de tos justo al inicio de la espiración forzada.",
            values: {
              percent: { ratio: 65, fvc: 88, fev1: 60 },
              absolute: {
                fvc_med: 3.96,
                fvc_teo: 4.5,
                fev1_med: 2.57,
                fev1_teo: 4.28,
              },
            },
            quality: { start: "yes", morphology: "no", end: "yes" },
          },
          {
            title: "9. MALA TÉCNICA: Finalización Brusca",
            description:
              "Paciente que interrumpe la espiración a los 4 segundos, sin alcanzar una meseta.",
            values: {
              percent: { ratio: 81, fvc: 75, fev1: 80 },
              absolute: {
                fvc_med: 3.38,
                fvc_teo: 4.5,
                fev1_med: 2.73,
                fev1_teo: 3.41,
              },
            },
            quality: { start: "yes", morphology: "yes", end: "no" },
          },
          {
            title: "10. MALA TÉCNICA: No Reproducible",
            description:
              "Paciente realiza tres maniobras aceptables, pero la variabilidad entre ellas es demasiado alta, invalidando la sesión.",
            values: {
              percent: { ratio: 82, fvc: 91, fev1: 95 },
              absolute: {
                fvc_med: 4.1,
                fvc_teo: 4.5,
                fev1_med: 3.5,
                fev1_teo: 3.68,
              },
            },
            quality: { start: "yes", morphology: "yes", end: "yes" },
            reproducibility: {
              fvc1: 4.1,
              fvc2: 3.85,
              fev1_1: 3.5,
              fev1_2: 3.55,
            },
          },
        ];

        const selectCase = document.getElementById("case_library_select");
        const descriptionContainer = document.getElementById(
          "case_description_container"
        );

        caseLibrary.forEach((caseItem, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = caseItem.title;
          selectCase.appendChild(option);
        });

        const resetButton = document.getElementById("reset_button");

        selectCase.addEventListener("change", (e) => {
          const caseIndex = parseInt(e.target.value);
          if (caseIndex < 0) {
            descriptionContainer.classList.add("hidden");
            [
              "fev1fvc_ratio",
              "fvc_percent",
              "fev1_percent",
              "fvc_med",
              "fvc_teo",
              "fev1_med",
              "fev1_teo",
              "fvc1",
              "fvc2",
              "fev1_1",
              "fev1_2",
              "fvc1_post",
              "fvc2_post",
              "fev1_1_post",
              "fev1_2_post",
            ].forEach((id) => {
              if (document.getElementById(id))
                document.getElementById(id).value = "";
            });
            loadCase(null);
            return;
          }
          const selectedCase = caseLibrary[caseIndex];
          descriptionContainer.textContent = selectedCase.description;
          descriptionContainer.classList.remove("hidden");
          loadCase(selectedCase);
        });

        function loadCase(caseData) {
          [
            "fvc1",
            "fvc2",
            "fev1_1",
            "fev1_2",
            "fvc1_post",
            "fvc2_post",
            "fev1_1_post",
            "fev1_2_post",
          ].forEach((id) => {
            if (document.getElementById(id))
              document.getElementById(id).value = "";
          });
          if (!caseData) {
            pbdCheck.checked = false;
            document
              .querySelectorAll(".quality-input")
              .forEach((radio) => (radio.checked = false));
            document
              .querySelectorAll(".quality-feedback")
              .forEach((el) => el.classList.add("hidden"));
            renderPBDInputs();
            debounceAndInterpret();
            return;
          }
          document.getElementById("fev1fvc_ratio").value =
            caseData.values.percent.ratio;
          document.getElementById("fvc_percent").value =
            caseData.values.percent.fvc;
          document.getElementById("fev1_percent").value =
            caseData.values.percent.fev1;
          document.getElementById("fvc_med").value =
            caseData.values.absolute.fvc_med;
          document.getElementById("fvc_teo").value =
            caseData.values.absolute.fvc_teo;
          document.getElementById("fev1_med").value =
            caseData.values.absolute.fev1_med;
          document.getElementById("fev1_teo").value =
            caseData.values.absolute.fev1_teo;
          if (caseData.reproducibility) {
            document.getElementById("fvc1").value =
              caseData.reproducibility.fvc1;
            document.getElementById("fvc2").value =
              caseData.reproducibility.fvc2;
            document.getElementById("fev1_1").value =
              caseData.reproducibility.fev1_1;
            document.getElementById("fev1_2").value =
              caseData.reproducibility.fev1_2;
          }
          pbdCheck.checked = !!caseData.pbd;
          renderPBDInputs();
          if (caseData.pbd) {
            setTimeout(() => {
              if (document.getElementById("fev1_pre"))
                document.getElementById("fev1_pre").value =
                  caseData.pbd.fev1_pre;
              if (document.getElementById("fev1_post"))
                document.getElementById("fev1_post").value =
                  caseData.pbd.fev1_post;
              if (document.getElementById("fvc_post"))
                document.getElementById("fvc_post").value =
                  caseData.pbd.fvc_post || "";
              debounceAndInterpret();
            }, 10);
          }
          document.querySelector(
            `input[name="start"][value="${caseData.quality.start}"]`
          ).checked = true;
          document.querySelector(
            `input[name="morphology"][value="${caseData.quality.morphology}"]`
          ).checked = true;
          document.querySelector(
            `input[name="end"][value="${caseData.quality.end}"]`
          ).checked = true;
          document
            .querySelectorAll(".quality-input")
            .forEach((radio) => radio.dispatchEvent(new Event("change")));
          debounceAndInterpret();
        }

        document.querySelectorAll('input[type="number"]').forEach((el) => {
          el.addEventListener("input", () => {
            if (el.value.includes(",")) el.value = el.value.replace(",", ".");
          });
        });

        const allInputs = document.querySelectorAll(
          ".data-input, .quality-input"
        );
        const modeRadios = document.querySelectorAll(
          'input[name="input_mode"]'
        );
        const pbdCheck = document.getElementById("pbd_check");
        const pbdContainer = document.getElementById("pbd_input_container");
        const pediatricMode = document.getElementById("pediatric_mode");
        const copyButton = document.getElementById("copy_summary_button");
        let debounceTimer;

        function debounceAndInterpret() {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(interpretSpirometry, 50);
        }

        allInputs.forEach((input) => {
          input.addEventListener("input", debounceAndInterpret);
          input.addEventListener("change", debounceAndInterpret);
        });

        modeRadios.forEach((radio) =>
          radio.addEventListener("change", () => {
            const isAbs = radio.value === "absolute";
            document
              .getElementById("abs_inputs")
              .classList.toggle("hidden", !isAbs);
            document
              .getElementById("percent_inputs")
              .classList.toggle("hidden", isAbs);
            renderPBDInputs();
            updateLiveCalculations(); // Recalcular al cambiar de modo
          })
        );
        pbdCheck.addEventListener("change", renderPBDInputs);

        pediatricMode.addEventListener("change", () => {
          const isPediatric = pediatricMode.checked;
          document
            .getElementById("pediatric_note")
            .classList.toggle("hidden", !isPediatric);
          document.getElementById("end_duration_label").textContent =
            isPediatric ? ">3s" : ">6s";
          document.getElementById("end_duration_label_short").textContent =
            isPediatric ? "3s" : "6s";
          document.getElementById("time_axis_label").textContent = isPediatric
            ? "3s"
            : "6s";
        });

        function renderPBDInputs() {
          const reproPostContainer = document.getElementById(
            "repro_post_container"
          );
          pbdContainer.classList.toggle("hidden", !pbdCheck.checked);
          reproPostContainer.classList.toggle("hidden", !pbdCheck.checked);
          pbdContainer.innerHTML = "";
          if (pbdCheck.checked) {
            pbdContainer.innerHTML = `<div class="col-span-2 grid grid-cols-2 gap-x-4 gap-y-4">
                                              <div><label for="fev1_pre" class="font-medium text-gray-700">FEV1 Pre-BD (L)</label><input type="number" min="0" step="0.01" id="fev1_pre" class="data-input mt-1 block w-full rounded-md"></div>
                                              <div><label for="fev1_post" class="font-medium text-gray-700">FEV1 Post-BD (L)</label><input type="number" min="0" step="0.01" id="fev1_post" class="data-input mt-1 block w-full rounded-md"></div>
                                              <div class="col-span-2"><label for="fvc_post" class="font-medium text-gray-700">FVC Post-BD (L) (Opcional)</label><input type="number" min="0" step="0.01" id="fvc_post" class="data-input mt-1 block w-full rounded-md"></div>
                                          </div>`;
            const fev1_pre_input = document.getElementById("fev1_pre");
            const fev1_med_val = document.getElementById("fev1_med")?.value;
            if (fev1_pre_input && fev1_med_val && !fev1_pre_input.value)
              fev1_pre_input.value = fev1_med_val;

            pbdContainer.querySelectorAll(".data-input").forEach((input) => {
              input.addEventListener("input", debounceAndInterpret);
              input.addEventListener("change", debounceAndInterpret);
            });
          }
          debounceAndInterpret();
        }

        const qualitySections = [
          {
            name: "start",
            pathEl: document.getElementById("start_path"),
            feedbackEl: document.getElementById("start_feedback"),
            correct: "M 10 70 C 25 15, 40 10, 90 8",
            incorrect: "M 10 70 C 40 65, 50 20, 90 8",
          },
          {
            name: "morphology",
            pathEl: document.getElementById("morphology_path"),
            feedbackEl: document.getElementById("morphology_feedback"),
            correct: "M 10 70 C 15 10, 40 10, 90 65",
            incorrect: "M 10 70 C 15 10, 30 15, 40 40 C 45 15, 55 20, 90 65",
          },
          {
            name: "end",
            pathEl: document.getElementById("end_path"),
            feedbackEl: document.getElementById("end_feedback"),
            correct: "M 10 70 C 25 15, 40 10, 90 8",
            incorrect: "M 10 70 C 25 15, 40 10, 60 8",
          },
        ];
        qualitySections.forEach((section) => {
          document
            .querySelectorAll(`input[name="${section.name}"]`)
            .forEach((radio) => {
              radio.addEventListener("change", () => {
                const isCorrect = radio.value === "yes";
                section.pathEl.setAttribute(
                  "d",
                  isCorrect ? section.correct : section.incorrect
                );
                section.feedbackEl.innerHTML = isCorrect
                  ? "<strong>Correcto:</strong> Criterio cumplido."
                  : "<strong>Atención:</strong> Compromete la validez.";
                section.feedbackEl.className = `quality-feedback ${
                  isCorrect ? "feedback-correct" : "feedback-incorrect"
                }`;
                section.feedbackEl.classList.remove("hidden");
                debounceAndInterpret();
              });
            });
        });

        function comprobar_reproducibilidad(v1, v2) {
          const a = parseFloat(v1),
            b = parseFloat(v2);
          if ([a, b].some(isNaN) || Math.max(a, b) <= 0)
            return { ok: null, diff_ml: NaN };
          const diff_ml = Math.abs(a - b);
          // El manual indica 200ml, pero el estándar ATS/ERS más común es 150ml. Usaremos 150ml para ser más estrictos.
          const ok = diff_ml <= 0.15;
          return { ok: ok, diff_ml: diff_ml };
        }

        function updateLiveCalculations() {
          const fvc_med = parseFloat(document.getElementById("fvc_med").value);
          const fvc_teo = parseFloat(document.getElementById("fvc_teo").value);
          const fev1_med = parseFloat(
            document.getElementById("fev1_med").value
          );
          const fev1_teo = parseFloat(
            document.getElementById("fev1_teo").value
          );
          const warningEl = document.getElementById("realtime_warning");

          let fvc_p = NaN,
            fev1_p = NaN,
            ratio = NaN;

          if (!isNaN(fvc_med) && !isNaN(fvc_teo) && fvc_teo > 0)
            fvc_p = (fvc_med / fvc_teo) * 100;
          if (!isNaN(fev1_med) && !isNaN(fev1_teo) && fev1_teo > 0)
            fev1_p = (fev1_med / fev1_teo) * 100;
          if (!isNaN(fvc_med) && !isNaN(fev1_med) && fvc_med > 0)
            ratio = (fev1_med / fvc_med) * 100;

          document.getElementById("auto_fvc_percent").value = isNaN(fvc_p)
            ? ""
            : fvc_p.toFixed(0) + "%";
          document.getElementById("auto_fev1_percent").value = isNaN(fev1_p)
            ? ""
            : fev1_p.toFixed(0) + "%";
          document.getElementById("auto_ratio").value = isNaN(ratio)
            ? ""
            : ratio.toFixed(0) + "%";

          if (!isNaN(fvc_med) && !isNaN(fev1_med) && fev1_med > fvc_med) {
            warningEl.textContent =
              "⚠️ Advertencia: El FEV1 medido es mayor que la FVC medida. Por favor, revise los valores.";
            warningEl.classList.remove("hidden");
          } else {
            warningEl.classList.add("hidden");
          }
        }

        function applyInputColorCoding() {
          const ratioEl = document.getElementById("fev1fvc_ratio");
          const fvcEl = document.getElementById("fvc_percent");

          [ratioEl, fvcEl].forEach((el) =>
            el.classList.remove("input-normal", "input-borderline")
          );

          const ratioVal = parseFloat(ratioEl.value);
          const fvcVal = parseFloat(fvcEl.value);

          if (!isNaN(ratioVal)) {
            ratioEl.classList.add(
              ratioVal < 70 ? "input-borderline" : "input-normal"
            );
          }
          if (!isNaN(fvcVal)) {
            fvcEl.classList.add(
              fvcVal < 80 ? "input-borderline" : "input-normal"
            );
          }
        }

        document
          .querySelectorAll("#abs_inputs input")
          .forEach((el) =>
            el.addEventListener("input", updateLiveCalculations)
          );
        document
          .querySelectorAll("#percent_inputs input")
          .forEach((el) => el.addEventListener("input", applyInputColorCoding));

        function interpretSpirometry() {
          const interpretationSection = document.getElementById(
            "interpretation_section"
          );
          const resultsContainer = document.getElementById("results_container");
          const algorithmSection = document.getElementById("algorithm_section");

          copyButton.disabled = true;
          algorithmSection.classList.add("hidden");

          let fvc_percent, ratio_percent, fev1_percent;
          let dataComplete = false;
          const mode = document.querySelector(
            'input[name="input_mode"]:checked'
          ).value;
          if (mode === "percent") {
            fvc_percent = parseFloat(
              document.getElementById("fvc_percent").value
            );
            ratio_percent = parseFloat(
              document.getElementById("fev1fvc_ratio").value
            );
            fev1_percent = parseFloat(
              document.getElementById("fev1_percent").value
            );
            dataComplete =
              !isNaN(fvc_percent) &&
              !isNaN(ratio_percent) &&
              !isNaN(fev1_percent);
            applyInputColorCoding();
          } else {
            const fvc_med = parseFloat(
              document.getElementById("fvc_med").value
            );
            const fvc_teo = parseFloat(
              document.getElementById("fvc_teo").value
            );
            const fev1_med = parseFloat(
              document.getElementById("fev1_med").value
            );
            const fev1_teo = parseFloat(
              document.getElementById("fev1_teo").value
            );
            if (
              ![fvc_med, fvc_teo, fev1_med, fev1_teo].some(isNaN) &&
              fvc_teo > 0 &&
              fvc_med > 0 &&
              fev1_teo > 0
            ) {
              fvc_percent = (fvc_med / fvc_teo) * 100;
              ratio_percent = (fev1_med / fvc_med) * 100;
              fev1_percent = (fev1_med / fev1_teo) * 100;
              dataComplete = true;
            }
            updateLiveCalculations();
          }
          if (!dataComplete) {
            resultsContainer.classList.add("opacity-50");
            interpretationSection.innerHTML = `<p class="text-center text-gray-500 py-8">Introduzca los datos o seleccione un caso de la biblioteca.</p>`;
            updateCurves(null);
            return;
          }

          let incoherencias = [];
          if (
            document
              .getElementById("realtime_warning")
              .classList.contains("hidden") === false
          ) {
            incoherencias.push(
              document.getElementById("realtime_warning").textContent
            );
          }

          if (incoherencias.length) {
            interpretationSection.innerHTML = `<div class="quality-warning mb-4"><strong>Datos incoherentes:</strong><br>${incoherencias.join(
              "<br>"
            )}</div>`;
            return;
          }

          resultsContainer.classList.remove("opacity-50");

          let pattern,
            patternClass,
            explanation = "",
            severity = "";
          let isObstructive = ratio_percent < 70;
          let isRestrictive = fvc_percent < 80;

          const fvc1 = parseFloat(document.getElementById("fvc1").value);
          const fvc2 = parseFloat(document.getElementById("fvc2").value);
          const fev1_1 = parseFloat(document.getElementById("fev1_1").value);
          const fev1_2 = parseFloat(document.getElementById("fev1_2").value);
          const r_fvc = comprobar_reproducibilidad(fvc1, fvc2);
          const r_fev1 = comprobar_reproducibilidad(fev1_1, fev1_2);
          let isReproducible = null;
          const reproducibilityResultEl = document.getElementById(
            "reproducibility_result"
          );
          if (r_fvc.ok !== null && r_fev1.ok !== null) {
            isReproducible = r_fvc.ok && r_fev1.ok;
            const txt = `FVC: Δ ${(r_fvc.diff_ml * 1000).toFixed(
              0
            )} ml · FEV1: Δ ${(r_fev1.diff_ml * 1000).toFixed(0)} ml ${
              isReproducible
                ? " → Reproducible (≤150 ml)"
                : " → NO reproducible"
            }`;
            reproducibilityResultEl.innerHTML = txt;
            reproducibilityResultEl.className = `mt-4 text-center font-bold p-2 rounded-md text-sm ${
              isReproducible
                ? "bg-green-100 text-green-800"
                : "bg-yellow-100 text-yellow-800"
            }`;
          } else {
            reproducibilityResultEl.textContent = "";
            reproducibilityResultEl.className =
              "mt-4 text-center font-bold p-2 rounded-md text-sm";
          }

          const q_start = document.querySelector(
            'input[name="start"]:checked'
          )?.value;
          const q_morph = document.querySelector(
            'input[name="morphology"]:checked'
          )?.value;
          const q_end = document.querySelector(
            'input[name="end"]:checked'
          )?.value;
          const es_aceptable =
            q_start === "yes" && q_morph === "yes" && q_end === "yes";

          const no_repro_comprobada = r_fvc.ok === null || r_fev1.ok === null;
          if (
            !es_aceptable ||
            isReproducible === false ||
            no_repro_comprobada
          ) {
            const motivos = [
              !es_aceptable
                ? "• Maniobra no aceptable (inicio/morfología/finalización)."
                : "",
              no_repro_comprobada
                ? "• Falta comprobar reproducibilidad (introduzca las dos mejores FVC y FEV1)."
                : "",
              isReproducible === false
                ? "• Sesión no reproducible (Δ ≤150 ml requerido)."
                : "",
            ]
              .filter(Boolean)
              .join("<br>");
            interpretationSection.innerHTML = `<div class="quality-warning mb-4"><strong>No interpretable:</strong><br>${motivos}</div>`;
            updateCurves({ ratio_percent, fvc_percent }); // still show pre curve
            return;
          }

          let pbdHtml = "";
          let postData = null;
          if (pbdCheck.checked) {
            let esPositiva = false;
            let textoPbd = "";
            const fev1_pre = parseFloat(
              document.getElementById("fev1_pre")?.value
            );
            const fev1_post = parseFloat(
              document.getElementById("fev1_post")?.value
            );
            const fvc_post = parseFloat(
              document.getElementById("fvc_post")?.value
            );
            const fvc_med = parseFloat(
              document.getElementById("fvc_med")?.value
            );
            const fvc_teo = parseFloat(
              document.getElementById("fvc_teo")?.value
            );
            const fev1_teo = parseFloat(
              document.getElementById("fev1_teo")?.value
            );

            if (!isNaN(fev1_pre) && !isNaN(fev1_post) && fev1_pre > 0) {
              const delta_ml = (fev1_post - fev1_pre) * 1000;
              const denom = (fev1_post + fev1_pre) / 2;
              const delta_pct_media =
                denom > 0 ? ((fev1_post - fev1_pre) / denom) * 100 : NaN;
              esPositiva =
                !isNaN(delta_pct_media) &&
                delta_pct_media >= 12 &&
                delta_ml >= 200;
              textoPbd = `Cambio FEV1: <strong>${Math.round(
                delta_ml
              )} ml</strong> y <strong>${delta_pct_media.toFixed(
                1
              )}%</strong> (según fórmula del manual) → <strong class="${
                esPositiva ? "text-green-700" : "text-yellow-700"
              }">${esPositiva ? "PBD POSITIVA" : "PBD NEGATIVA"}</strong>`;

              let postPatternHTML = "";
              const fvc_final_bd = !isNaN(fvc_post) ? fvc_post : fvc_med;

              if (
                !isNaN(fvc_final_bd) &&
                !isNaN(fvc_teo) &&
                fvc_teo > 0 &&
                !isNaN(fev1_teo) &&
                fev1_teo > 0
              ) {
                const ratio_post = (fev1_post / fvc_final_bd) * 100;
                const fvc_pct_post = (fvc_final_bd / fvc_teo) * 100;
                postData = {
                  ratio_percent: ratio_post,
                  fvc_percent: fvc_pct_post,
                }; // Datos para la curva POST

                const isObstructive_post = ratio_post < 70;
                const isRestrictive_post = fvc_pct_post < 80;
                let pattern_post = "NORMAL";
                if (isObstructive_post && isRestrictive_post)
                  pattern_post = "MIXTO";
                else if (isObstructive_post) pattern_post = "OBSTRUCTIVO";
                else if (isRestrictive_post)
                  pattern_post = "SUG. DE RESTRICCIÓN";
                postPatternHTML = `<p class="mt-2">Patrón Post-BD: <strong>${pattern_post}</strong> (Cociente: ${ratio_post.toFixed(
                  0
                )}%, FVC: ${fvc_pct_post.toFixed(0)}%)</p>`;

                if (isObstructive_post) {
                  const fev1_pct_post = (fev1_post / fev1_teo) * 100;
                  if (fev1_pct_post >= 80) severity = "Leve (GOLD 1)";
                  else if (fev1_pct_post >= 50) severity = "Moderada (GOLD 2)";
                  else if (fev1_pct_post >= 30) severity = "Grave (GOLD 3)";
                  else severity = "Muy Grave (GOLD 4)";
                } else {
                  severity = "";
                }
              }

              pbdHtml = `<div class="bg-gray-50 p-3 rounded-md mt-4"><h4 class="font-bold">Prueba Broncodilatadora</h4><p class="text-sm mt-1">${textoPbd}</p>${postPatternHTML}</div>`;
            } else {
              pbdHtml = `<div class="bg-gray-50 p-3 rounded-md mt-4"><h4 class="font-bold">Prueba Broncodilatadora</h4><p class="text-sm mt-1">Introduzca FEV1 pre y post...</p></div>`;
            }
          }

          if (!pbdCheck.checked && isObstructive) {
            if (fev1_percent >= 80) severity = "Leve (GOLD 1)";
            else if (fev1_percent >= 50) severity = "Moderada (GOLD 2)";
            else if (fev1_percent >= 30) severity = "Grave (GOLD 3)";
            else severity = "Muy Grave (GOLD 4)";
          } else if (!isObstructive) {
            severity = "";
          }

          updateCurves({ ratio_percent, fvc_percent }, postData);

          if (isObstructive && isRestrictive) {
            pattern = "PATRÓN MIXTO";
            patternClass = "pattern-mixed";
            explanation = `<p>Cociente (${ratio_percent.toFixed(
              0
            )}%) < 70% indica <strong>obstrucción</strong>.</p><p>FVC (${fvc_percent.toFixed(
              0
            )}%) < 80% sugiere <strong>restricción</strong>.</p>${
              severity
                ? `<p>Severidad Obstrucción (Post-BD o basal si no hay PBD): <strong>${severity}</strong>.</p>`
                : ""
            }`;
          } else if (isObstructive) {
            pattern = "PATRÓN OBSTRUCTIVO";
            patternClass = "pattern-obstructive";
            explanation = `<p>Cociente (${ratio_percent.toFixed(
              0
            )}%) < 70% indica <strong>obstrucción</strong>.</p><p>FVC (${fvc_percent.toFixed(
              0
            )}%) ≥ 80% es normal.</p>${
              severity
                ? `<p>Severidad (Post-BD o basal si no hay PBD): <strong>${severity}</strong>.</p>`
                : ""
            }`;
          } else if (isRestrictive) {
            pattern = "PATRÓN SUGESTIVO DE RESTRICCIÓN";
            patternClass = "pattern-restrictive";
            explanation = `<p>Cociente (${ratio_percent.toFixed(
              0
            )}%) ≥ 70% es normal.</p><p>FVC (${fvc_percent.toFixed(
              0
            )}%) < 80% es <strong>sugestivo de restricción</strong>.</p><p class="text-sm mt-1">Para confirmación se requiere medir la Capacidad Pulmonar Total (CPT).</p>`;
          } else {
            pattern = "ESPIROMETRÍA NORMAL";
            patternClass = "pattern-normal";
            explanation = `<p>Todos los parámetros están dentro de la normalidad.</p>`;
          }

          let finalHtml = `<div class="interpretation ${patternClass}">${pattern}</div>
                                  <div class="bg-gray-50 p-3 rounded-md"><h4 class="font-bold">Justificación</h4><div class="mt-1 text-sm text-gray-700">${explanation}</div></div>
                                  ${pbdHtml}`;
          if (!pbdCheck.checked) {
            finalHtml += `<div class="mt-2 text-sm text-center text-gray-500"><strong>Recuerde: Debe realizarse la PBD en la primera espirometría diagnóstica.</strong></div>`;
          }
          finalHtml += `<div class="clinical-pearl">
                                  <p class="font-semibold text-blue-800">Píldora Clínica</p>
                                  <p class="text-sm text-blue-700 mt-1">Recuerde siempre correlacionar estos hallazgos con la clínica del paciente. Una PBD positiva es muy sugerente de asma, pero su ausencia no la descarta.</p>
                                 </div>`;
          interpretationSection.innerHTML = finalHtml;
          copyButton.disabled = false;
          renderAlgorithmPath(
            isObstructive,
            isRestrictive,
            ratio_percent,
            fvc_percent
          );
        }

        function renderAlgorithmPath(
          isObstructive,
          isRestrictive,
          ratio_percent,
          fvc_percent
        ) {
          const container = document.getElementById("algorithm_path_container");
          const algorithmSection = document.getElementById("algorithm_section");
          let pathHtml = '<div class="font-mono text-sm leading-7">';
          pathHtml +=
            "<div><strong>✅ ¿Curva Válida y Reproducible? → SÍ</strong></div>";
          pathHtml += '<div class="pl-5">';

          if (isObstructive) {
            pathHtml += `<strong>➡️ ¿FEV₁/FVC &lt; 70%? → SÍ (Tu valor: ${ratio_percent.toFixed(
              0
            )}%) → OBSTRUCCIÓN</strong>`;
            pathHtml += '<div class="pl-5">';
            if (isRestrictive) {
              pathHtml += `<strong>➡️ ¿FVC &lt; 80%? → SÍ (Tu valor: ${fvc_percent.toFixed(
                0
              )}%)</strong>`;
              pathHtml += '<div class="pl-10">';
              pathHtml += "<strong>➡️ Resultado: PATRÓN MIXTO</strong>";
              pathHtml += "</div>";
            } else {
              pathHtml += `<strong>➡️ ¿FVC &lt; 80%? → NO (Tu valor: ${fvc_percent.toFixed(
                0
              )}%)</strong>`;
              pathHtml += '<div class="pl-10">';
              pathHtml += "<strong>➡️ Resultado: PATRÓN OBSTRUCTIVO</strong>";
              pathHtml += "</div>";
            }
            pathHtml += "</div>";
            pathHtml +=
              '<div class="text-gray-400"><span>➡️ ¿FEV₁/FVC ≥ 70%? → NO OBSTRUCCIÓN</span></div>';
          } else {
            // Not Obstructive
            pathHtml += `<div class="text-gray-400"><span>➡️ ¿FEV₁/FVC &lt; 70%? → OBSTRUCCIÓN</span></div>`;
            pathHtml += `<strong>➡️ ¿FEV₁/FVC ≥ 70%? → SÍ (Tu valor: ${ratio_percent.toFixed(
              0
            )}%) → NO OBSTRUCCIÓN</strong>`;
            pathHtml += '<div class="pl-5">';
            if (isRestrictive) {
              pathHtml += `<strong>➡️ ¿FVC &lt; 80%? → SÍ (Tu valor: ${fvc_percent.toFixed(
                0
              )}%)</strong>`;
              pathHtml += '<div class="pl-10">';
              pathHtml +=
                "<strong>➡️ Resultado: PATRÓN SUGESTIVO DE RESTRICCIÓN</strong>";
              pathHtml += "</div>";
            } else {
              pathHtml += `<strong>➡️ ¿FVC &lt; 80%? → NO (Tu valor: ${fvc_percent.toFixed(
                0
              )}%)</strong>`;
              pathHtml += '<div class="pl-10">';
              pathHtml += "<strong>➡️ Resultado: ESPIROMETRÍA NORMAL</strong>";
              pathHtml += "</div>";
            }
            pathHtml += "</div>";
          }

          pathHtml += "</div></div>";
          container.innerHTML = pathHtml;
          algorithmSection.classList.remove("hidden");
        }

        copyButton.addEventListener("click", () => {
          const summaryText = document.getElementById("summary_for_copy");

          let pattern_text = "No interpretable";
          let quality_text = "Calidad: ";
          const q_start = document.querySelector(
            'input[name="start"]:checked'
          )?.value;
          const q_morph = document.querySelector(
            'input[name="morphology"]:checked'
          )?.value;
          const q_end = document.querySelector(
            'input[name="end"]:checked'
          )?.value;
          const es_aceptable =
            q_start === "yes" && q_morph === "yes" && q_end === "yes";

          const fvc1 = parseFloat(document.getElementById("fvc1").value);
          const fvc2 = parseFloat(document.getElementById("fvc2").value);
          const fev1_1 = parseFloat(document.getElementById("fev1_1").value);
          const fev1_2 = parseFloat(document.getElementById("fev1_2").value);
          const r_fvc = comprobar_reproducibilidad(fvc1, fvc2);
          const r_fev1 = comprobar_reproducibilidad(fev1_1, fev1_2);
          let isReproducible = null;
          if (r_fvc.ok !== null && r_fev1.ok !== null) {
            isReproducible = r_fvc.ok && r_fev1.ok;
          }

          if (es_aceptable && isReproducible) {
            quality_text += "Aceptable y Reproducible.";
            pattern_text =
              document.querySelector(".interpretation")?.textContent || "Error";
          } else {
            let errors = [];
            if (!es_aceptable) errors.push("No Aceptable");
            if (isReproducible === false) errors.push("No Reproducible");
            else if (isReproducible === null)
              errors.push("Reprod. no comprobada");
            quality_text += errors.join(" y ");
          }

          let fev1fvc_ratio, fvc_percent, fev1_percent;
          const mode = document.querySelector(
            'input[name="input_mode"]:checked'
          ).value;
          if (mode === "percent") {
            fev1fvc_ratio = document.getElementById("fev1fvc_ratio").value;
            fvc_percent = document.getElementById("fvc_percent").value;
            fev1_percent = document.getElementById("fev1_percent").value;
          } else {
            fev1fvc_ratio = document
              .getElementById("auto_ratio")
              .value.replace("%", "");
            fvc_percent = document
              .getElementById("auto_fvc_percent")
              .value.replace("%", "");
            fev1_percent = document
              .getElementById("auto_fev1_percent")
              .value.replace("%", "");
          }

          let pbd_text = "";
          if (pbdCheck.checked) {
            const fev1_pre = parseFloat(
              document.getElementById("fev1_pre")?.value
            );
            const fev1_post = parseFloat(
              document.getElementById("fev1_post")?.value
            );
            if (!isNaN(fev1_pre) && !isNaN(fev1_post) && fev1_pre > 0) {
              const delta_ml = (fev1_post - fev1_pre) * 1000;
              const denom = (fev1_post + fev1_pre) / 2;
              const delta_pct_media =
                denom > 0 ? ((fev1_post - fev1_pre) / denom) * 100 : NaN;
              const esPositiva =
                !isNaN(delta_pct_media) &&
                delta_pct_media >= 12 &&
                delta_ml >= 200;
              pbd_text = `\nPBD: ${
                esPositiva ? "Positiva" : "Negativa"
              } (Δ ${Math.round(delta_ml)}ml, ${delta_pct_media.toFixed(1)}%).`;
            }
          }

          let textForCopy =
            `ESPIROMETRÍA:\n--------------------------------------\n` +
            `FEV1/FVC: ${fev1fvc_ratio}%, FVC: ${fvc_percent}%, FEV1: ${fev1_percent}%\n` +
            `Interpretación: ${pattern_text}\n` +
            `${quality_text}` +
            `${pbd_text}`;

          summaryText.value = textForCopy.trim();
          summaryText.classList.remove("hidden");
          summaryText.select();
          document.execCommand("copy");
          summaryText.classList.add("hidden");

          const originalText = copyButton.innerHTML;
          copyButton.innerHTML = `<i class="fa-solid fa-check"></i> <span>¡Copiado!</span>`;
          setTimeout(() => {
            copyButton.innerHTML = originalText;
          }, 2000);
        });

        // MODIFICACIÓN updateCurves PARA PBD
        function updateCurves(preData, postData = null) {
          const flowPathEl = document.getElementById("flowVolumePath");
          const volTimePathEl = document.getElementById("volumeTimePath");
          const flowPathPostEl = document.getElementById("flowVolumePathPost");
          const volTimePathPostEl =
            document.getElementById("volumeTimePathPost");

          const fv_explanation = document.getElementById("fv_explanation");
          const vt_explanation = document.getElementById("vt_explanation");
          const llnLine = document.getElementById("lln_line");
          const llnLabel = document.getElementById("lln_label");
          const pbdLegend = document.getElementById("pbd_legend");

          const drawCurve = (data, isPost = false) => {
            if (!data || isNaN(data.ratio_percent) || isNaN(data.fvc_percent)) {
              return;
            }
            const { ratio_percent, fvc_percent } = data;

            const isObstructive = ratio_percent < 70;
            const isRestrictive = fvc_percent < 80;

            if (!isPost) {
              fv_explanation.innerHTML = isObstructive
                ? '<strong>Signo de obstrucción:</strong> Se observa una "muesca" o concavidad en la rama descendente.'
                : isRestrictive
                ? '<strong>Morfología de restricción:</strong> La forma es normal, pero "en miniatura" (más estrecha).'
                : "<strong>Morfología normal:</strong> Pico inicial rápido y un descenso casi rectilíneo y suave.";
              vt_explanation.innerHTML = isObstructive
                ? "<strong>Signo de obstrucción:</strong> La curva tarda más en alcanzar la meseta. La pendiente inicial es menos pronunciada."
                : isRestrictive
                ? "<strong>Signo de restricción:</strong> La curva es más baja, ya que el volumen total (FVC) está disminuido."
                : "<strong>Morfología normal:</strong> Ascenso rápido inicial y meseta alcanzada en pocos segundos.";
            }

            const ratio_norm = Math.max(0.1, (ratio_percent - 30) / 50);
            const fvc_norm = Math.max(0.1, (fvc_percent - 20) / 80);

            const flow_peak_y = 100 * Math.min(1, fvc_norm * 1.2);
            const flow_mid_y = 90 - (1 - ratio_norm) * 70;
            const flow_end_x = 180 * fvc_norm;
            const flowPath = `M0,0 C${20 * fvc_norm},${flow_peak_y} ${
              80 * fvc_norm
            },${flow_mid_y} ${flow_end_x},5`;

            const vol_end_y = 105 * fvc_norm;
            const vol_mid_y = 100 * fvc_norm * (0.4 + ratio_norm * 0.6);
            const volPath = `M0,0 C${30 * (2 - ratio_norm)},${vol_mid_y} 80,${
              100 * fvc_norm
            } 180,${vol_end_y}`;

            if (isPost) {
              flowPathPostEl.setAttribute("d", flowPath);
              volTimePathPostEl.setAttribute("d", volPath);
            } else {
              flowPathEl.setAttribute("d", flowPath);
              volTimePathEl.setAttribute("d", volPath);
            }
          };

          if (!preData) {
            const defaultPathFV = "M0,0 C20,100 80,90 180,5";
            const defaultPathVT = "M0,0 C20,80 80,100 180,105";
            flowPathEl.setAttribute("d", defaultPathFV);
            volTimePathEl.setAttribute("d", defaultPathVT);
            flowPathPostEl.setAttribute("d", "M0,0");
            volTimePathPostEl.setAttribute("d", "M0,0");
            fv_explanation.innerHTML =
              "Representa la velocidad del aire (flujo) frente al volumen exhalado.";
            vt_explanation.innerHTML =
              "Representa el volumen de aire exhalado a lo largo del tiempo.";
            llnLine.classList.add("hidden");
            llnLabel.classList.add("hidden");
            pbdLegend.classList.add("hidden");
            return;
          }

          llnLine.classList.remove("hidden");
          llnLabel.classList.remove("hidden");

          drawCurve(preData, false);

          if (postData) {
            drawCurve(postData, true);
            pbdLegend.classList.remove("hidden");
          } else {
            flowPathPostEl.setAttribute("d", "M0,0");
            volTimePathPostEl.setAttribute("d", "M0,0");
            pbdLegend.classList.add("hidden");
          }
        }

        // Lógica para el Tutorial Interactivo (Intro.js)
        const startTutorialButton = document.getElementById("startTutorialBtn");

        // Función que inicia el tutorial
        function iniciarTutorial() {
          introJs()
            .setOptions({
              nextLabel: "Siguiente >",
              prevLabel: "< Anterior",
              doneLabel: "¡Entendido!",
              exitOnOverlayClick: false,
            })
            .start();
        }

        // 1. Asigna la función al clic del botón
        startTutorialButton.addEventListener("click", iniciarTutorial);

        // 2. Comprueba si el tutorial ya se ha visto antes en este navegador
        if (!localStorage.getItem("spirometryAssistantTourVisto")) {
          // Si no se ha visto, espera medio segundo y lánzalo automáticamente
          setTimeout(() => {
            iniciarTutorial();
            // Guarda un registro para no volver a mostrarlo en el futuro
            localStorage.setItem("spirometryAssistantTourVisto", "true");
          }, 500);
        }

        // Lógica para controlar el modal de reinicio
        const resetModalBackdrop =
          document.getElementById("resetModalBackdrop");
        const cancelResetBtn = document.getElementById("cancelResetBtn");
        const confirmResetBtn = document.getElementById("confirmResetBtn");

        const openResetModal = () => resetModalBackdrop.classList.add("show");
        const closeResetModal = () =>
          resetModalBackdrop.classList.remove("show");

        resetButton.addEventListener("click", openResetModal);
        cancelResetBtn.addEventListener("click", closeResetModal);
        resetModalBackdrop.addEventListener("click", (event) => {
          if (event.target === resetModalBackdrop) {
            closeResetModal();
          }
        });

        confirmResetBtn.addEventListener("click", () => {
          // Esta es la acción original del botón de reinicio
          selectCase.value = "-1";
          selectCase.dispatchEvent(new Event("change"));
          closeResetModal();
        });
      });
    </script>
  </body>
</html>
